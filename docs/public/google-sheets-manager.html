<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Sheets Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f4f8; min-height: 100vh; }
    
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #34a853 100%);
      color: white;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 20px; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 10px; }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-primary { background: #1a73e8; color: white; }
    .btn-primary:hover { background: #1557b0; }
    .btn-success { background: #34a853; color: white; }
    .btn-success:hover { background: #2d9249; }
    .btn-secondary { background: white; color: #333; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #f5f5f5; }
    .btn-danger { background: #ea4335; color: white; }
    .btn-danger:hover { background: #d33426; }
    .btn-warning { background: #fbbc04; color: #333; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      padding: 14px 20px;
      border-bottom: 1px solid #e8e8e8;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fafbfc;
    }
    .card-header h2 { font-size: 15px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 20px; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; }
    .form-label .required { color: #ea4335; }
    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      transition: all 0.2s;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.12);
    }
    .form-hint { font-size: 11px; color: #888; margin-top: 4px; }
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      resize: vertical;
      min-height: 120px;
    }
    
    .config-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
    .config-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
    }
    .config-card:hover { border-color: #1a73e8; box-shadow: 0 4px 12px rgba(26,115,232,0.15); }
    .config-card.active { border-color: #34a853; background: #f0fdf4; }
    .config-name { font-size: 15px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .config-details { font-size: 12px; color: #666; line-height: 1.6; }
    .config-details code { background: #e8e8e8; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
    .config-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    
    .table-toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .table-info { font-size: 13px; color: #666; margin-left: auto; }
    .table-wrapper { overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px; max-height: 500px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th, .data-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e8e8e8;
      white-space: nowrap;
    }
    .data-table th {
      background: #f1f5f9;
      font-weight: 600;
      color: #334155;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .data-table th .col-letter { font-size: 10px; color: #94a3b8; display: block; }
    .data-table tr:hover { background: #f8fafc; }
    .data-table .row-num { background: #f8fafc; color: #64748b; text-align: center; width: 50px; font-size: 11px; }
    .data-table .cell-editable { cursor: pointer; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .data-table .cell-editable:hover { background: #e0f2fe; }
    .data-table .cell-input {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid #1a73e8;
      border-radius: 4px;
      font-size: 13px;
      outline: none;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.connected { background: #dcfce7; color: #166534; }
    .status-badge.disconnected { background: #fee2e2; color: #991b1b; }
    .status-badge.loading { background: #dbeafe; color: #1e40af; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .connected .status-dot { background: #22c55e; }
    .disconnected .status-dot { background: #ef4444; }
    .loading .status-dot { background: #3b82f6; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    
    .empty-state { text-align: center; padding: 48px 20px; color: #64748b; }
    .empty-state .icon { font-size: 56px; margin-bottom: 16px; opacity: 0.6; }
    .empty-state h3 { font-size: 16px; color: #334155; margin-bottom: 8px; }
    
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e8e8e8;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; line-height: 1; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid #e8e8e8; display: flex; justify-content: flex-end; gap: 10px; }
    
    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 14px 16px;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .info-box.warning { background: #fef3c7; border-color: #fcd34d; }
    .info-box.success { background: #dcfce7; border-color: #86efac; }
    .info-box code { background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e8e8e8; }
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .tab:hover { color: #1a73e8; }
    .tab.active { color: #1a73e8; }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: #1a73e8;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 400px;
    }
    .toast.success { background: #22c55e; }
    .toast.error { background: #ef4444; }
    .toast.info { background: #3b82f6; }
    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      gap: 16px;
    }
    .spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: #1a73e8; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 14px; color: #666; }
    
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 8px 12px;
    }
    .search-box input {
      border: none;
      background: none;
      outline: none;
      font-size: 13px;
      width: 180px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Google Sheets Manager</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="location.href='/trigger-builder.html'">‚Üê Quay l·∫°i</button>
      <button class="btn btn-success" onclick="showAddModal()">‚ûï Th√™m Sheet m·ªõi</button>
    </div>
  </div>

  <div class="main">
    <!-- Danh s√°ch Sheets -->
    <div class="card">
      <div class="card-header">
        <h2>üìã Danh s√°ch Google Sheets ƒë√£ k·∫øt n·ªëi</h2>
        <button class="btn btn-secondary btn-sm" onclick="loadConfigs()">üîÑ L√†m m·ªõi</button>
      </div>
      <div class="card-body">
        <div id="configGrid" class="config-grid">
          <div class="empty-state">
            <div class="icon">üìÑ</div>
            <h3>Ch∆∞a c√≥ Sheet n√†o</h3>
            <p>Nh·∫•n "Th√™m Sheet m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Viewer -->
    <div class="card" id="dataCard" style="display:none;">
      <div class="card-header">
        <h2 id="dataTitle">üìä D·ªØ li·ªáu Sheet</h2>
        <div style="display:flex;gap:10px;align-items:center;">
          <div id="connectionStatus" class="status-badge disconnected">
            <span class="status-dot"></span>
            <span>Ch∆∞a k·∫øt n·ªëi</span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="table-toolbar">
          <button class="btn btn-success btn-sm" onclick="refreshSheetData()">üîÑ L√†m m·ªõi</button>
          <button class="btn btn-primary btn-sm" onclick="showAddRowModal()">‚ûï Th√™m h√†ng</button>
          <div class="search-box">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." onkeyup="filterTable()">
          </div>
          <div class="table-info" id="tableInfo">0 h√†ng</div>
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="dataTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- H∆∞·ªõng d·∫´n -->
    <div class="card">
      <div class="card-header">
        <h2>üìñ H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t Google Apps Script</h2>
      </div>
      <div class="card-body">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('tab1', this)">üìù B∆∞·ªõc 1: Code</button>
          <button class="tab" onclick="switchTab('tab2', this)">üöÄ B∆∞·ªõc 2: Deploy</button>
          <button class="tab" onclick="switchTab('tab3', this)">‚úÖ B∆∞·ªõc 3: S·ª≠ d·ª•ng</button>
        </div>
        
        <div id="tab1" class="tab-content active">
          <div class="info-box">
            <strong>1.</strong> M·ªü Google Sheets c·ªßa b·∫°n<br>
            <strong>2.</strong> V√†o <code>Extensions</code> ‚Üí <code>Apps Script</code><br>
            <strong>3.</strong> X√≥a code c≈© v√† paste code b√™n d∆∞·ªõi<br>
            <strong>4.</strong> Nh·∫•n <code>Ctrl+S</code> ƒë·ªÉ l∆∞u
          </div>
          <div class="form-group">
            <label class="form-label">üìù Google Apps Script Code (Copy to√†n b·ªô)</label>
            <textarea class="form-textarea" id="scriptCode" readonly style="height:400px;">function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const params = e.parameter;
  const action = params.action;
  const sheetName = params.sheet || 'Sheet1';
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(sheetName);
    
    if (!sheet && action !== 'getSheets') {
      return jsonResponse({ success: false, error: 'Sheet not found: ' + sheetName });
    }
    
    let result;
    
    switch(action) {
      case 'getSheets':
        const sheets = ss.getSheets().map(s => ({
          name: s.getName(),
          index: s.getIndex(),
          rowCount: s.getLastRow(),
          colCount: s.getLastColumn()
        }));
        result = { success: true, sheets: sheets, spreadsheetName: ss.getName() };
        break;
        
      case 'getData':
        const lastRow = sheet.getLastRow();
        const lastCol = sheet.getLastColumn();
        if (lastRow === 0 || lastCol === 0) {
          result = { success: true, headers: [], rows: [], totalRows: 0 };
          break;
        }
        const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
        const headers = data[0] || [];
        const rows = data.slice(1).map((row, idx) => ({
          rowIndex: idx + 2,
          cells: row
        }));
        result = { success: true, headers: headers, rows: rows, totalRows: rows.length, columns: headers.map((h, i) => ({ index: i + 1, name: h, letter: String.fromCharCode(65 + i) })) };
        break;
        
      case 'addRow':
        const rowData = JSON.parse(params.data || '[]');
        sheet.appendRow(rowData);
        result = { success: true, message: 'Row added', rowNumber: sheet.getLastRow() };
        break;
        
      case 'updateCell':
        const uRow = parseInt(params.row);
        const uCol = parseInt(params.col);
        const uValue = params.value || '';
        sheet.getRange(uRow, uCol).setValue(uValue);
        result = { success: true, message: 'Cell updated', row: uRow, col: uCol };
        break;
        
      case 'updateRow':
        const updRow = parseInt(params.row);
        const updData = JSON.parse(params.data || '[]');
        if (updData.length > 0) {
          sheet.getRange(updRow, 1, 1, updData.length).setValues([updData]);
        }
        result = { success: true, message: 'Row updated', row: updRow };
        break;
        
      case 'deleteRow':
        const delRow = parseInt(params.row);
        sheet.deleteRow(delRow);
        result = { success: true, message: 'Row deleted' };
        break;
        
      case 'findRows':
        const searchCol = parseInt(params.col) || 1;
        const searchVal = (params.value || '').toLowerCase();
        const operator = params.operator || 'equals';
        const allData = sheet.getDataRange().getValues();
        const headers2 = allData[0] || [];
        const foundRows = [];
        
        for (let i = 1; i < allData.length; i++) {
          const cellVal = String(allData[i][searchCol - 1] || '').toLowerCase();
          let match = false;
          
          switch(operator) {
            case 'equals': match = cellVal === searchVal; break;
            case 'not_equals': match = cellVal !== searchVal; break;
            case 'contains': match = cellVal.includes(searchVal); break;
            case 'not_contains': match = !cellVal.includes(searchVal); break;
            case 'starts_with': match = cellVal.startsWith(searchVal); break;
            case 'ends_with': match = cellVal.endsWith(searchVal); break;
            case 'is_empty': match = cellVal.trim() === ''; break;
            case 'is_not_empty': match = cellVal.trim() !== ''; break;
            default: match = cellVal === searchVal;
          }
          
          if (match) {
            foundRows.push({ rowIndex: i + 1, cells: allData[i] });
          }
        }
        result = { success: true, headers: headers2, rows: foundRows, count: foundRows.length };
        break;
        
      default:
        result = { success: false, error: 'Unknown action: ' + action };
    }
    
    return jsonResponse(result);
    
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function jsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}</textarea>
            <button class="btn btn-primary" style="margin-top:10px;" onclick="copyCode()">üìã Copy Code</button>
          </div>
        </div>
        
        <div id="tab2" class="tab-content">
          <div class="info-box">
            <strong>1.</strong> Trong Apps Script, nh·∫•n <code>Deploy</code> ‚Üí <code>New deployment</code><br>
            <strong>2.</strong> Ch·ªçn type: <code>Web app</code><br>
            <strong>3.</strong> Description: nh·∫≠p m√¥ t·∫£ b·∫•t k·ª≥<br>
            <strong>4.</strong> Execute as: <code>Me</code><br>
            <strong>5.</strong> Who has access: <code>Anyone</code><br>
            <strong>6.</strong> Nh·∫•n <code>Deploy</code> v√† copy URL
          </div>
          <div class="info-box warning">
            <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> M·ªói l·∫ßn s·ª≠a code, c·∫ßn Deploy l·∫°i v·ªõi "New deployment" ƒë·ªÉ thay ƒë·ªïi c√≥ hi·ªáu l·ª±c!
          </div>
        </div>
        
        <div id="tab3" class="tab-content">
          <div class="info-box success">
            <strong>‚úÖ Ho√†n t·∫•t!</strong> B√¢y gi·ªù b·∫°n c√≥ th·ªÉ:<br>
            ‚Ä¢ Nh·∫•n "Th√™m Sheet m·ªõi" v√† paste Script URL<br>
            ‚Ä¢ Test k·∫øt n·ªëi ƒë·ªÉ ki·ªÉm tra<br>
            ‚Ä¢ Xem, th√™m, s·ª≠a, x√≥a d·ªØ li·ªáu tr·ª±c ti·∫øp<br>
            ‚Ä¢ S·ª≠ d·ª•ng trong Flow Builder v·ªõi block "Google Sheet Data"
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Config Modal -->
  <div id="configModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">‚ûï Th√™m Google Sheet</h3>
        <button class="modal-close" onclick="closeModal('configModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">üìù T√™n hi·ªÉn th·ªã <span class="required">*</span></label>
          <input type="text" class="form-input" id="cfgName" placeholder="VD: Danh s√°ch kh√°ch h√†ng">
        </div>
        
        <div class="form-group">
          <label class="form-label">üîó Script URL <span class="required">*</span></label>
          <input type="text" class="form-input" id="cfgScriptURL" placeholder="https://script.google.com/macros/s/.../exec">
          <div class="form-hint">URL l·∫•y t·ª´ b∆∞·ªõc Deploy Web App ·ªü tr√™n</div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">üìÑ T√™n Sheet (Tab)</label>
            <input type="text" class="form-input" id="cfgSheetName" placeholder="Sheet1" value="Sheet1">
            <div class="form-hint">T√™n tab sheet trong file Google Sheets</div>
          </div>
          
          <div class="form-group">
            <label class="form-label">üîë API Key (t√πy ch·ªçn)</label>
            <input type="text" class="form-input" id="cfgApiKey" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">üìä Spreadsheet ID (t√πy ch·ªçn)</label>
          <input type="text" class="form-input" id="cfgSpreadsheetId" placeholder="ID l·∫•y t·ª´ URL c·ªßa Google Sheet">
          <div class="form-hint">docs.google.com/spreadsheets/d/<strong style="color:#1a73e8;">[SPREADSHEET_ID]</strong>/edit</div>
        </div>
        
        <input type="hidden" id="cfgEditId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('configModal')">H·ªßy</button>
        <button class="btn btn-warning" onclick="testConnection()">üîå Test k·∫øt n·ªëi</button>
        <button class="btn btn-success" onclick="saveConfig()">üíæ L∆∞u c·∫•u h√¨nh</button>
      </div>
    </div>
  </div>

  <!-- Add Row Modal -->
  <div id="addRowModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h3>‚ûï Th√™m h√†ng m·ªõi</h3>
        <button class="modal-close" onclick="closeModal('addRowModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="addRowFields"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addRowModal')">H·ªßy</button>
        <button class="btn btn-success" onclick="submitAddRow()">‚ûï Th√™m h√†ng</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">ƒêang x·ª≠ l√Ω...</div>
  </div>

  <script>
    // ========================================
    // STATE
    // ========================================
    let configs = [];
    let currentConfig = null;
    let currentData = { headers: [], rows: [] };
    let ws = null;

    // ========================================
    // INIT
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      setupWebSocket();
      loadConfigs();
    });

    // ========================================
    // WEBSOCKET
    // ========================================
    // Use same port as HTTP server
    
    function setupWebSocket() {
      try {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const hostname = location.hostname || 'localhost';
        const wsUrl = protocol + '//' + (location.host || 'localhost:3000');
        console.log('üîå Connecting to:', wsUrl);
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
          console.log('‚úÖ WebSocket connected');
          ws.send(JSON.stringify({ type: 'get_google_sheet_configs' }));
        };
        
        ws.onmessage = function(e) {
          try {
            const msg = JSON.parse(e.data);
            console.log('üì® WS message:', msg.type);
            handleMessage(msg);
          } catch (err) {}
        };
        
        ws.onclose = function() {
          console.log('‚ùå WebSocket disconnected');
          setTimeout(setupWebSocket, 3000);
        };
        
        ws.onerror = function(err) {
          console.error('‚ùå WebSocket error:', err);
        };
      } catch (e) {
        console.error('WebSocket error:', e);
      }
    }

    function handleMessage(msg) {
      switch (msg.type) {
        case 'google_sheet_configs':
          // Normalize: convert configID to id for consistency
          configs = (msg.configs || []).map(cfg => ({
            ...cfg,
            id: cfg.configID || cfg.id
          }));
          console.log('üìó Loaded', configs.length, 'configs from database');
          renderConfigs();
          break;
        case 'google_sheet_config_saved':
          toast('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh!', 'success');
          closeModal('configModal');
          // Reload configs without migration
          ws.send(JSON.stringify({ type: 'get_google_sheet_configs' }));
          break;
        case 'google_sheet_config_deleted':
          toast('üóëÔ∏è ƒê√£ x√≥a c·∫•u h√¨nh', 'success');
          ws.send(JSON.stringify({ type: 'get_google_sheet_configs' }));
          break;
        case 'error':
          console.error('‚ùå Server error:', msg.message);
          toast('‚ùå ' + (msg.message || 'L·ªói server'), 'error');
          break;
        case 'current_user':
          // Ignore user info
          break;
        default:
          console.log('üì® Unhandled message:', msg.type);
      }
    }

    var migrationDone = false; // Flag to prevent re-migration
    
    function loadConfigs() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        // First, check if there's local data to migrate (only once)
        if (!migrationDone) {
          const stored = localStorage.getItem('gsheet_configs');
          if (stored) {
            try {
              const localConfigs = JSON.parse(stored);
              if (localConfigs && localConfigs.length > 0) {
                console.log('üì¶ Migrating', localConfigs.length, 'configs from localStorage to database...');
                // Migrate each config
                localConfigs.forEach(cfg => {
                  ws.send(JSON.stringify({
                    type: 'save_google_sheet_config',
                    config: cfg,
                    editIndex: -1
                  }));
                });
                // Clear localStorage after migration
                localStorage.removeItem('gsheet_configs');
                toast('üì¶ ƒê√£ migrate ' + localConfigs.length + ' config t·ª´ localStorage', 'info');
              }
            } catch (e) {
              console.error('Migration error:', e);
            }
          }
          migrationDone = true;
        }
        
        ws.send(JSON.stringify({ type: 'get_google_sheet_configs' }));
      } else {
        const stored = localStorage.getItem('gsheet_configs');
        configs = stored ? JSON.parse(stored) : [];
        renderConfigs();
      }
    }

    function saveToStorage() {
      localStorage.setItem('gsheet_configs', JSON.stringify(configs));
    }

    // ========================================
    // RENDER
    // ========================================
    function renderConfigs() {
      const container = document.getElementById('configGrid');
      
      if (configs.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="icon">üìÑ</div>
            <h3>Ch∆∞a c√≥ Sheet n√†o</h3>
            <p>Nh·∫•n "Th√™m Sheet m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = configs.map((cfg, idx) => `
        <div class="config-card ${currentConfig && currentConfig.id === cfg.id ? 'active' : ''}">
          <div class="config-name">üìä ${escapeHtml(cfg.name)}</div>
          <div class="config-details">
            <div>üìÑ Sheet: <code>${escapeHtml(cfg.sheetName || 'Sheet1')}</code></div>
            <div>üîó ${cfg.scriptURL ? '‚úÖ ƒê√£ c·∫•u h√¨nh' : '‚ùå Ch∆∞a c√≥ URL'}</div>
            ${cfg.spreadsheetId ? `<div>üÜî ID: <code>${cfg.spreadsheetId.substring(0, 12)}...</code></div>` : ''}
          </div>
          <div class="config-actions">
            <button class="btn btn-primary btn-sm" onclick="viewData(${idx})">üëÅÔ∏è Xem</button>
            <button class="btn btn-secondary btn-sm" onclick="editConfig(${idx})">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-danger btn-sm" onclick="deleteConfig(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function renderTable() {
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      const info = document.getElementById('tableInfo');
      
      if (!currentData.headers.length) {
        thead.innerHTML = '';
        tbody.innerHTML = '<tr><td colspan="20" style="text-align:center;padding:40px;color:#888;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        info.textContent = '0 h√†ng';
        return;
      }
      
      let th = '<tr><th class="row-num">#</th>';
      currentData.headers.forEach((h, i) => {
        const letter = String.fromCharCode(65 + i);
        th += `<th>${escapeHtml(h || 'C·ªôt ' + letter)}<span class="col-letter">${letter} (c·ªôt ${i+1})</span></th>`;
      });
      th += '<th style="width:60px;">X√≥a</th></tr>';
      thead.innerHTML = th;
      
      let tb = '';
      currentData.rows.forEach((row, idx) => {
        const rowNum = row.rowIndex || (idx + 2);
        tb += `<tr><td class="row-num">${rowNum}</td>`;
        row.cells.forEach((cell, colIdx) => {
          tb += `<td class="cell-editable" onclick="editCell(${rowNum}, ${colIdx + 1}, this)">${escapeHtml(String(cell ?? ''))}</td>`;
        });
        tb += `<td><button class="btn btn-danger btn-sm" onclick="deleteRow(${rowNum})" style="padding:4px 8px;">üóëÔ∏è</button></td></tr>`;
      });
      
      tbody.innerHTML = tb || '<tr><td colspan="' + (currentData.headers.length + 2) + '" style="text-align:center;padding:40px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
      info.textContent = currentData.rows.length + ' h√†ng';
    }

    // ========================================
    // CONFIG CRUD
    // ========================================
    function showAddModal() {
      document.getElementById('modalTitle').textContent = '‚ûï Th√™m Google Sheet';
      document.getElementById('cfgName').value = '';
      document.getElementById('cfgScriptURL').value = '';
      document.getElementById('cfgSheetName').value = 'Sheet1';
      document.getElementById('cfgApiKey').value = '';
      document.getElementById('cfgSpreadsheetId').value = '';
      document.getElementById('cfgEditId').value = '';
      document.getElementById('configModal').style.display = 'flex';
    }

    function editConfig(idx) {
      const cfg = configs[idx];
      document.getElementById('modalTitle').textContent = '‚úèÔ∏è S·ª≠a c·∫•u h√¨nh';
      document.getElementById('cfgName').value = cfg.name || '';
      document.getElementById('cfgScriptURL').value = cfg.scriptURL || '';
      document.getElementById('cfgSheetName').value = cfg.sheetName || 'Sheet1';
      document.getElementById('cfgApiKey').value = cfg.apiKey || '';
      document.getElementById('cfgSpreadsheetId').value = cfg.spreadsheetId || '';
      document.getElementById('cfgEditId').value = idx;
      document.getElementById('configModal').style.display = 'flex';
    }

    async function testConnection() {
      const url = document.getElementById('cfgScriptURL').value.trim();
      if (!url) {
        toast('‚ùå Vui l√≤ng nh·∫≠p Script URL', 'error');
        return;
      }
      
      showLoading(true, 'ƒêang test k·∫øt n·ªëi...');
      
      try {
        const res = await fetch(url + '?action=getSheets');
        const data = await res.json();
        
        if (data.success) {
          const names = data.sheets.map(s => s.name).join(', ');
          toast(`‚úÖ K·∫øt n·ªëi OK! Sheets: ${names}`, 'success');
        } else {
          toast('‚ùå ' + (data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
        }
      } catch (err) {
        toast('‚ùå L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
      }
      
      showLoading(false);
    }

    function saveConfig() {
      const name = document.getElementById('cfgName').value.trim();
      const scriptURL = document.getElementById('cfgScriptURL').value.trim();
      const sheetName = document.getElementById('cfgSheetName').value.trim() || 'Sheet1';
      const apiKey = document.getElementById('cfgApiKey').value.trim();
      const spreadsheetId = document.getElementById('cfgSpreadsheetId').value.trim();
      const editIdx = document.getElementById('cfgEditId').value;
      
      if (!name || !scriptURL) {
        toast('‚ùå Vui l√≤ng nh·∫≠p T√™n v√† Script URL', 'error');
        return;
      }
      
      const cfg = {
        id: editIdx !== '' ? configs[editIdx].id : Date.now(),
        name,
        scriptURL,
        sheetName,
        apiKey,
        spreadsheetId,
        createdAt: editIdx !== '' ? configs[editIdx].createdAt : Date.now(),
        updatedAt: Date.now()
      };
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'save_google_sheet_config',
          config: cfg,
          editIndex: editIdx !== '' ? parseInt(editIdx) : -1
        }));
      } else {
        if (editIdx !== '') {
          configs[editIdx] = cfg;
        } else {
          configs.push(cfg);
        }
        saveToStorage();
        toast('‚úÖ ƒê√£ l∆∞u!', 'success');
        closeModal('configModal');
        renderConfigs();
      }
    }

    function deleteConfig(idx) {
      if (!confirm('X√≥a "' + configs[idx].name + '"?')) return;
      
      const deletedId = configs[idx].id;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'delete_google_sheet_config',
          configId: deletedId
        }));
      } else {
        configs.splice(idx, 1);
        saveToStorage();
        toast('üóëÔ∏è ƒê√£ x√≥a', 'success');
        renderConfigs();
      }
      
      if (currentConfig && currentConfig.id === deletedId) {
        currentConfig = null;
        document.getElementById('dataCard').style.display = 'none';
      }
    }

    // ========================================
    // DATA CRUD
    // ========================================
    async function viewData(idx) {
      currentConfig = configs[idx];
      document.getElementById('dataTitle').textContent = 'üìä ' + currentConfig.name + ' - ' + currentConfig.sheetName;
      document.getElementById('dataCard').style.display = 'block';
      renderConfigs();
      await refreshSheetData();
      
      document.getElementById('dataCard').scrollIntoView({ behavior: 'smooth' });
    }

    async function refreshSheetData() {
      if (!currentConfig) return;
      
      showLoading(true, 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...');
      setStatus('loading');
      
      try {
        const url = `${currentConfig.scriptURL}?action=getData&sheet=${encodeURIComponent(currentConfig.sheetName || 'Sheet1')}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          currentData = { headers: data.headers || [], rows: data.rows || [] };
          renderTable();
          setStatus('connected');
          toast(`‚úÖ ƒê√£ t·∫£i ${data.totalRows || 0} h√†ng`, 'success');
        } else {
          setStatus('disconnected');
          toast('‚ùå ' + (data.error || 'L·ªói'), 'error');
        }
      } catch (err) {
        setStatus('disconnected');
        toast('‚ùå ' + err.message, 'error');
      }
      
      showLoading(false);
    }

    function showAddRowModal() {
      if (!currentData.headers.length) {
        toast('‚ùå Ch∆∞a c√≥ headers', 'error');
        return;
      }
      
      document.getElementById('addRowFields').innerHTML = currentData.headers.map((h, i) => `
        <div class="form-group">
          <label class="form-label">${escapeHtml(h || 'C·ªôt ' + String.fromCharCode(65 + i))}</label>
          <input type="text" class="form-input add-row-field" data-col="${i}">
        </div>
      `).join('');
      
      document.getElementById('addRowModal').style.display = 'flex';
    }

    async function submitAddRow() {
      const rowData = Array.from(document.querySelectorAll('.add-row-field')).map(inp => inp.value);
      
      showLoading(true, 'ƒêang th√™m h√†ng...');
      
      try {
        const url = `${currentConfig.scriptURL}?action=addRow&sheet=${encodeURIComponent(currentConfig.sheetName)}&data=${encodeURIComponent(JSON.stringify(rowData))}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          toast(`‚úÖ ƒê√£ th√™m h√†ng #${data.rowNumber}`, 'success');
          closeModal('addRowModal');
          await refreshSheetData();
        } else {
          toast('‚ùå ' + (data.error || 'L·ªói'), 'error');
        }
      } catch (err) {
        toast('‚ùå ' + err.message, 'error');
      }
      
      showLoading(false);
    }

    async function editCell(row, col, td) {
      const oldVal = td.textContent;
      const input = document.createElement('input');
      input.className = 'cell-input';
      input.value = oldVal;
      td.innerHTML = '';
      td.appendChild(input);
      input.focus();
      input.select();
      
      const save = async () => {
        const newVal = input.value;
        if (newVal === oldVal) { td.textContent = oldVal; return; }
        
        td.innerHTML = '<span style="color:#888;">‚è≥</span>';
        
        try {
          const url = `${currentConfig.scriptURL}?action=updateCell&sheet=${encodeURIComponent(currentConfig.sheetName)}&row=${row}&col=${col}&value=${encodeURIComponent(newVal)}`;
          const res = await fetch(url);
          const data = await res.json();
          
          td.textContent = data.success ? newVal : oldVal;
          if (data.success) toast('‚úÖ ƒê√£ l∆∞u', 'success');
          else toast('‚ùå ' + (data.error || 'L·ªói'), 'error');
        } catch (err) {
          td.textContent = oldVal;
          toast('‚ùå ' + err.message, 'error');
        }
      };
      
      input.onblur = save;
      input.onkeydown = e => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') td.textContent = oldVal;
      };
    }

    async function deleteRow(row) {
      if (!confirm('X√≥a h√†ng #' + row + '?')) return;
      
      showLoading(true, 'ƒêang x√≥a...');
      
      try {
        const url = `${currentConfig.scriptURL}?action=deleteRow&sheet=${encodeURIComponent(currentConfig.sheetName)}&row=${row}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          toast('üóëÔ∏è ƒê√£ x√≥a', 'success');
          await refreshSheetData();
        } else {
          toast('‚ùå ' + (data.error || 'L·ªói'), 'error');
        }
      } catch (err) {
        toast('‚ùå ' + err.message, 'error');
      }
      
      showLoading(false);
    }

    function filterTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#tableBody tr');
      let visible = 0;
      
      rows.forEach(row => {
        const match = row.textContent.toLowerCase().includes(search);
        row.style.display = match ? '' : 'none';
        if (match) visible++;
      });
      
      document.getElementById('tableInfo').textContent = `${visible}/${currentData.rows.length} h√†ng`;
    }

    // ========================================
    // UTILS
    // ========================================
    function setStatus(status) {
      const el = document.getElementById('connectionStatus');
      el.className = 'status-badge ' + status;
      el.innerHTML = `<span class="status-dot"></span><span>${{connected:'‚úÖ ƒê√£ k·∫øt n·ªëi',disconnected:'‚ùå M·∫•t k·∫øt n·ªëi',loading:'‚è≥ ƒêang t·∫£i...'}[status]}</span>`;
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function showLoading(show, text) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      if (text) document.getElementById('loadingText').textContent = text;
    }

    function toast(msg, type) {
      document.querySelectorAll('.toast').forEach(t => t.remove());
      const t = document.createElement('div');
      t.className = 'toast ' + (type || 'info');
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3500);
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    function switchTab(tabId, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function copyCode() {
      document.getElementById('scriptCode').select();
      document.execCommand('copy');
      toast('‚úÖ ƒê√£ copy code!', 'success');
    }
  </script>
</body>
</html>