<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zalo Trigger Manager</title>
  <link rel="stylesheet" href="assets/style_trigger_manager.css" />
  <style>
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #f44336;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .notification-btn {
      position: relative;
    }

    .user-info-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 20px;
      padding: 8px 12px;
      background: #f5f7fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-uid {
      font-size: 10px;
      color: #999;
      font-family: monospace;
    }

    .user-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: #e8f5e9;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: #2e7d32;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .trigger-item-compact {
      padding: 10px 12px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      background: #fff;
    }

    .trigger-item-compact:hover {
      background: #f5f7fa;
      border-color: #e0e0e0;
    }

    .trigger-item-compact.active {
      background: #e3f2fd;
      border-color: #0084ff;
    }

    .trigger-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .trigger-main-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .trigger-icon-small {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      background: #e3f2fd;
    }

    .trigger-name-small {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trigger-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .trigger-item-compact:hover .trigger-actions {
      opacity: 1;
    }

    .action-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }

    .action-icon:hover {
      background: #e0e0e0;
    }

    .trigger-keywords-preview {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .trigger-time-created {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
    }

    .db-badge {
      background: #4caf50;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .flow-badge {
      background: #9c27b0;
      color: white;
      font-size: 9px;
      padding: 2px 5px;
      border-radius: 4px;
      margin-left: 4px;
    }

    .friends-selector {
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .friends-selector-loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }

    .friend-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }

    .friend-checkbox-item:hover {
      background: #f5f7fa;
    }

    .friend-checkbox-item:last-child {
      border-bottom: none;
    }

    .friend-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .friend-checkbox-item img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .friend-checkbox-info {
      flex: 1;
    }

    .friend-checkbox-name {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .friend-checkbox-uid {
      font-size: 10px;
      color: #999;
      font-family: monospace;
    }

    .selected-friends-summary {
      margin-top: 8px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 12px;
      color: #1976d2;
    }

    .friends-search-box {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    .friends-search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .response-input-wrapper {
      position: relative;
    }

    .emoji-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .emoji-btn:hover {
      background: #f0f0f0;
    }

    .emoji-picker-container {
      position: absolute;
      bottom: 45px;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 280px;
      display: none;
    }

    .emoji-picker-container.show {
      display: block;
    }

    .emoji-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      flex-wrap: wrap;
    }

    .emoji-tab {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .emoji-tab:hover {
      background: #f0f0f0;
    }

    .emoji-tab.active {
      background: #e3f2fd;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      max-height: 150px;
      overflow-y: auto;
    }

    .emoji-item {
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      text-align: center;
    }

    .emoji-item:hover {
      background: #f0f0f0;
    }

    .delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .delete-modal.show {
      display: flex;
    }

    .delete-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      text-align: center;
    }

    .delete-modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .delete-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .delete-modal-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .delete-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .delete-modal-actions button {
      padding: 10px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .delete-modal-cancel {
      background: #f0f0f0;
      border: none;
      color: #333;
    }

    .delete-modal-confirm {
      background: #f44336;
      border: none;
      color: white;
    }

    .activity-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9998;
      display: none;
    }

    .activity-backdrop.show {
      display: block;
    }

    .activity-window {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      max-height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
    }

    .activity-window.show {
      display: block;
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #eee;
    }

    .activity-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .activity-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .activity-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 12px;
    }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f9f9f9;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .activity-icon.create {
      background: #e8f5e9;
    }

    .activity-icon.update {
      background: #e3f2fd;
    }

    .activity-icon.delete {
      background: #ffebee;
    }

    .activity-info {
      flex: 1;
    }

    .activity-action {
      font-size: 13px;
      font-weight: 600;
    }

    .activity-trigger {
      font-size: 12px;
      color: #666;
    }

    .activity-time {
      font-size: 11px;
      color: #999;
    }

    .activity-empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .mode-hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      padding: 8px;
      background: #f5f7fa;
      border-radius: 4px;
    }

    .mode-hint.flow {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    /* Built-in trigger modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-box {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* Variables Table */
    .variables-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .variables-table th {
      text-align: left;
      padding: 12px;
      background: #f5f7fa;
      border-bottom: 2px solid #e0e0e0;
      color: #37474f;
      font-weight: 600;
    }

    .variables-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      color: #333;
    }

    .variables-table tr:hover {
      background: #f9f9f9;
    }

    .var-name {
      font-family: monospace;
      color: #d81b60;
      background: #fce4ec;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .var-value {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .var-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.6;
      padding: 4px;
    }

    .var-action-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .var-tab {
      transition: all 0.2s;
    }

    .var-tab:hover {
      background: #f5f7fa;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <div class="header-title"><span class="icon">🤖</span><span>Bot-Auto</span></div>
      <div class="user-info-panel" id="userInfoPanel" style="display:none;">
        <div class="user-avatar" id="userAvatar">👤</div>
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-uid" id="userUID">UID: -</div>
        </div>
        <div class="user-status" id="userStatus"><span class="status-dot"></span><span class="status-text">Online</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="auto-reply-toggle-container" id="autoReplyToggleContainer">
        <span class="toggle-label"><span>🤖</span><span>Auto Reply</span></span>
        <label class="toggle-switch"><input type="checkbox" id="autoReplyToggle" onchange="toggleAutoReply()"
            disabled><span class="toggle-slider"></span></label>
        <span class="toggle-status loading" id="autoReplyStatus">...</span>
      </div>
      <button class="header-btn notification-btn" onclick="openActivityWindow()">
        <span>📋</span><span>Lịch sử</span>
        <span class="notification-badge" id="activityBadge" style="display:none;">0</span>
      </button>
      <a href="unified-manager.html" target="_blank" rel="noopener noreferrer" class="header-btn">
        <span>📊</span>
        <span>Data Manager</span>
      </a>
      <a href="dashboard.html" target="_blank" rel="noopener noreferrer" class="header-btn">
        <span>🏠</span>
        <span>Dashboard</span>
      </a>
      <!-- <button class="header-btn primary" onclick="showNewTriggerModal()"><span>➕</span><span>Tạo Trigger</span></button> -->
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Danh sách Trigger (<span id="triggerCount">0</span>)</h3>
        <div class="search-box"><span class="search-icon">🔍</span><input type="text" placeholder="Tìm kiếm..."
            id="searchInput" oninput="searchTriggers()"></div>
      </div>
      <div class="trigger-list" id="triggerList">
        <div style="text-align:center; padding:40px; color:#999;">📋 Đang tải...</div>
      </div>
    </div>
    <div class="canvas-area">
      <div class="canvas-header">
        <div class="canvas-title">
          <h2 id="canvasTitle">Chọn một trigger</h2>
          <span class="badge" id="canvasBadge" style="display:none;"></span>
          <span class="flow-badge" id="canvasFlowBadge" style="display:none;">FLOW</span>
        </div>
        <div class="canvas-actions" id="canvasActions" style="display:none;">
          <button class="header-btn" onclick="editCurrentTrigger()"><span>✏️</span><span>Sửa</span></button>
          <button class="header-btn" onclick="openTriggerBuilder()" id="btnOpenBuilder"
            style="display:none;"><span>⚙️</span><span>Flow Builder</span></button>
          <button class="header-btn" onclick="duplicateCurrentTrigger()"><span>📋</span><span>Nhân bản</span></button>
          <button class="header-btn btn-danger" onclick="showDeleteModal()"><span>🗑️</span><span>Xóa</span></button>
        </div>
      </div>
      <div class="canvas-content" id="canvasContent">
        <div class="empty-state">
          <div class="icon">🎯</div>
          <h3>Chọn trigger để xem chi tiết</h3><button class="btn btn-primary" onclick="showNewTriggerModal()">➕ Tạo
            mới</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRIGGER MODAL -->
  <div class="modal-overlay" id="triggerModal">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h3 id="modalTitle">Tạo Trigger Mới</h3><button class="modal-close" onclick="hideTriggerModal()">✕</button>
      </div>
      <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
        <div class="form-group"><label class="form-label">Tên trigger *</label><input type="text" class="form-input"
            id="triggerName" placeholder="VD: Hỏi giá sản phẩm"></div>

        <!-- Loại trigger (MỚI) -->
        <div class="form-group">
          <label class="form-label">🎯 Loại trigger</label>
          <select class="form-input" id="triggerType" onchange="onTriggerTypeChange()">
            <option value="keyword">📝 Từ khóa (keyword)</option>
            <option value="any_message">💬 Tin nhắn bất kì</option>
            <option value="any_file">📎 File/Ảnh bất kì</option>
          </select>
          <div class="mode-hint" id="triggerTypeHint">Kích hoạt khi tin nhắn chứa từ khóa bên dưới</div>
        </div>

        <!-- Từ khóa (ẩn khi chọn any_message hoặc any_file) -->
        <div class="form-group" id="keywordsGroup"><label class="form-label">Từ khóa *</label><input type="text"
            class="form-input" id="triggerKeywords" placeholder="VD: giá, báo giá (phân cách dấu phẩy)"></div>

        <!-- Chế độ chạy -->
        <div class="form-group">
          <label class="form-label">🚀 Chế độ chạy</label>
          <select class="form-input" id="triggerMode" onchange="onModeChange()">
            <option value="0">⚡ Gửi trực tiếp</option>
            <option value="1">🔄 Chạy theo quy trình (Flow)</option>
          </select>
          <div class="mode-hint" id="modeHint">Tin nhắn sẽ được gửi ngay lập tức khi khớp từ khóa</div>
        </div>

        <!-- Nội dung trả lời (chỉ hiện khi mode = 0) -->
        <div class="form-group" id="responseGroup">
          <label class="form-label">💬 Nội dung trả lời *</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="triggerResponse" rows="4" placeholder="Nội dung auto-reply"></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPicker(event)">😊</button>
            <div class="emoji-picker-container" id="emojiPickerContainer">
              <div class="emoji-tabs" id="emojiTabs"></div>
              <div class="emoji-grid" id="emojiGrid"></div>
            </div>
          </div>
        </div>

        <!-- Lịch hoạt động - Giờ -->
        <div class="form-group">
          <label class="form-label">⏰ Thời gian hoạt động</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:11px; color:#666;">Từ giờ</label><input type="time" class="form-input"
                id="triggerStartTime" value="00:00"></div>
            <div><label style="font-size:11px; color:#666;">Đến giờ</label><input type="time" class="form-input"
                id="triggerEndTime" value="23:59"></div>
          </div>
        </div>

        <!-- Lịch hoạt động - Ngày -->
        <div class="form-group">
          <label class="form-label">📅 Ngày hoạt động (tùy chọn)</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:11px; color:#666;">Từ ngày</label><input type="date" class="form-input"
                id="triggerDateStart"></div>
            <div><label style="font-size:11px; color:#666;">Đến ngày</label><input type="date" class="form-input"
                id="triggerDateEnd"></div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">Để trống nếu muốn hoạt động mọi ngày</div>
        </div>

        <!-- Scope -->
        <div class="form-group">
          <label class="form-label">👥 Áp dụng cho (Scope)</label>
          <select class="form-input" id="triggerScope" onchange="onScopeChange()">
            <option value="0">Tất cả mọi người (Everyone)</option>
            <option value="1">Chỉ người lạ (Stranger)</option>
            <option value="2">Bạn bè cụ thể (SpecificFriends)</option>
            <option value="3">Tất cả trừ một số người (FriendsExcept)</option>
          </select>
        </div>

        <!-- Friends Selector -->
        <div class="form-group" id="friendsSelectorGroup" style="display:none;">
          <label class="form-label" id="friendsSelectorLabel">Chọn bạn bè</label>
          <div class="friends-selector" id="friendsSelector">
            <div class="friends-selector-loading">Đang tải...</div>
          </div>
          <div class="selected-friends-summary" id="selectedFriendsSummary" style="display:none;">Đã chọn: <span
              id="selectedFriendsCount">0</span> người</div>
        </div>

        <div class="form-group"><label class="form-label">⏱️ Cooldown (giây)</label><input type="number"
            class="form-input" id="triggerCooldown" value="30" min="0"></div>
        <div class="form-group"><label class="form-label"><input type="checkbox" id="triggerEnabled" checked
              style="margin-right:6px;">Kích hoạt ngay</label></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTriggerModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveTrigger()" id="saveBtn">💾 Lưu</button>
      </div>
    </div>
  </div>


  <div class="modal"
    style="max-width: 900px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; border-radius: 12px;">
    <div class="modal-header"
      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px 20px; flex-shrink: 0;">
      <h3 style="color: #fff; margin: 0; font-weight: 600;">📊 Quản lý Biến (Variables)</h3>
      <button class="modal-close" onclick="closeVariablesModal()" style="color: #fff;">✕</button>
    </div>

    <div
      style="background: #f5f7fa; padding: 0 20px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 0; flex-shrink: 0;">
      <button id="tabStatic" class="var-tab" onclick="switchVarTab('static')"
        style="padding: 12px 20px; border: none; background: #fff; cursor: pointer; font-weight: 600; color: #667eea; border-bottom: 3px solid #667eea;">🔒
        Biến Tĩnh (Static)</button>
      <button id="tabDynamic" class="var-tab" onclick="switchVarTab('dynamic')"
        style="padding: 12px 20px; border: none; background: transparent; cursor: pointer; font-weight: 500; color: #666; border-bottom: none;">✏️
        Biến Động (Dynamic)</button>
    </div>

    <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">
      <!-- Static Vars -->
      <div id="staticVarsTab">
        <div
          style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #43a047;">
          <div style="font-weight: 600; color: #2e7d32; font-size: 13px;">💡 Biến tĩnh là gì?</div>
          <div style="font-size: 12px; color: #33691e; margin-top: 2px;">Tự động lấy giá trị từ Zalo API. Click để
            copy.</div>
        </div>
        <div id="staticVarsContent" style="display: grid; gap: 10px;">
          <div style="text-align: center; color: #999;">Đang tải...</div>
        </div>
      </div>

      <!-- Dynamic Vars -->
      <div id="dynamicVarsTab" style="display: none;">
        <div
          style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #1976d2;">
          <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #0d47a1;">➕ Thêm biến mới</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="newVarName" placeholder="Tên biến (VD: email)" class="form-input"
              style="flex: 1; min-width: 120px;">
            <input type="text" id="newVarValue" placeholder="Giá trị" class="form-input"
              style="flex: 2; min-width: 120px;">
            <select id="newVarType" class="form-input" style="width: auto;">
              <option value="text">text</option>
              <option value="number">number</option>
            </select>
            <button class="btn btn-primary" onclick="addManualVariable()">Thêm</button>
          </div>
        </div>
        <div id="variablesContent">
          <div style="text-align: center; color: #999;">Đang tải...</div>
        </div>
      </div>
    </div>

    <div class="modal-footer" style="padding: 12px 20px; background: #f9f9f9; flex-shrink: 0;">
      <button class="btn" onclick="refreshVariables()">🔄 Làm mới</button>
      <button class="btn btn-secondary" onclick="closeVariablesModal()">Đóng</button>
    </div>
  </div>


  <!-- DELETE MODAL -->
  <div class="delete-modal" id="deleteModal">
    <div class="delete-modal-content">
      <div class="delete-modal-icon">🗑️</div>
      <div class="delete-modal-title">Xóa Trigger</div>
      <div class="delete-modal-text">Bạn có chắc muốn xóa trigger "<span id="deleteTriggerName"></span>"?<br><small
          style="color:#f44336;">⚠️ Flow liên quan cũng sẽ bị xóa!</small></div>
      <div class="delete-modal-actions">
        <button class="delete-modal-cancel" onclick="hideDeleteModal()">Hủy</button>
        <button class="delete-modal-confirm" onclick="confirmDelete()">Xóa</button>
      </div>
    </div>
  </div>

  <!-- AUTO MESSAGE SETUP MODAL -->
  <div class="modal-backdrop" id="autoMessageModal" style="display:none;">
    <div class="modal-box" style="max-width:600px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;" id="autoMessageModalTitle">
          <span style="font-size:24px;">💬</span>
          Cài đặt Tự động gửi tin nhắn
        </h2>
      </div>
      <div class="modal-body">
        <div
          style="background:#f0f9ff; border-left:4px solid #2196f3; padding:12px; margin-bottom:16px; border-radius:4px;">
          <div style="font-weight:600; color:#1976d2; margin-bottom:4px;">📌 Chức năng</div>
          <div style="font-size:13px; color:#555;" id="autoMessageDesc">Tự động trả lời <strong>MỌI</strong> tin nhắn
            đến từ mọi người với
            nội dung bạn cài đặt.</div>
        </div>

        <div class="form-group">
          <label class="form-label">💬 Nội dung tự động trả lời *</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="autoMessageResponse" rows="6"
              placeholder="VD: Xin chào! Hiện tại tôi đang bận, sẽ phản hồi bạn sau.&#10;&#10;Hỗ trợ biến động:&#10;{name} - Tên người gửi&#10;{time} - Thời gian hiện tại"></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPickerForAutoMessage(event)">😊</button>
            <div class="emoji-picker-container" id="emojiPickerAutoMessage">
              <div class="emoji-tabs" id="emojiTabsAutoMessage"></div>
              <div class="emoji-grid" id="emojiGridAutoMessage"></div>
            </div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">
            💡 Có thể dùng biến: <code>{name}</code>, <code>{time}</code>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">⏱️ Thời gian chờ giữa các tin nhắn (giây)</label>
          <input type="number" class="form-input" id="autoMessageCooldown" min="0" value="30" placeholder="30">
          <div style="font-size:11px; color:#999; margin-top:4px;">
            💡 Thời gian tối thiểu giữa 2 lần trả lời cùng 1 người (0 = không giới hạn)
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="autoMessageEnabled" style="margin-right:6px;">
            Bật ngay sau khi lưu
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAutoMessageModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveAutoMessageSetup()">💾 Lưu</button>
      </div>
    </div>
  </div>

  <!-- AUTO ACCEPT FRIEND MODAL -->
  <div class="modal-backdrop" id="autoFriendModal" style="display:none;">
    <div class="modal-box" style="max-width:600px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;">
          <span style="font-size:24px;">👥</span>
          Cài đặt Chấp nhận kết bạn
        </h2>
      </div>
      <div class="modal-body">
        <div
          style="background:#f0f9ff; border-left:4px solid #4caf50; padding:12px; margin-bottom:16px; border-radius:4px;">
          <div style="font-weight:600; color:#388e3c; margin-bottom:4px;">📌 Chức năng</div>
          <div style="font-size:13px; color:#555;">Tự động chấp nhận <strong>MỌI</strong> lời mời kết bạn và gửi tin
            nhắn chào mừng (tùy chọn).</div>
        </div>

        <div class="form-group">
          <label class="form-label">💬 Tin nhắn chào mừng (tùy chọn)</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="autoFriendMessage" rows="6"
              placeholder="VD: Chào {name}! 👋&#10;Cảm ơn bạn đã kết bạn với mình.&#10;Nếu cần hỗ trợ, hãy nhắn tin cho mình nhé!&#10;&#10;Để trống nếu không muốn gửi tin nhắn."></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPickerForAutoFriend(event)">😊</button>
            <div class="emoji-picker-container" id="emojiPickerAutoFriend">
              <div class="emoji-tabs" id="emojiTabsAutoFriend"></div>
              <div class="emoji-grid" id="emojiGridAutoFriend"></div>
            </div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">
            💡 Có thể dùng biến: <code>{name}</code>, <code>{time}</code>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="autoFriendEnabled" style="margin-right:6px;">
            Bật ngay sau khi lưu
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAutoFriendModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveAutoFriendSetup()">💾 Lưu</button>
      </div>
    </div>
  </div>

  <!-- ACTIVITY WINDOW -->
  <div class="activity-backdrop" id="activityBackdrop" onclick="closeActivityWindow()"></div>
  <div class="activity-window" id="activityWindow">
    <div class="activity-header">
      <h3>📋 Lịch sử hoạt động</h3>
      <div>
        <button onclick="clearActivityLogs()"
          style="background:#ffebee; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:8px;">🗑️
          Xóa</button>
        <button class="activity-close" onclick="closeActivityWindow()">✕</button>
      </div>
    </div>
    <div class="activity-list" id="activityList"></div>
  </div>

  <script>
    // ================================================
    // EMOJI DATA
    // ================================================
    const EMOJI_DATA = {
      'Smileys': ['😀', '😁', '😂', '🤣', '😃', '😄', '😅', '😆', '😉', '😊', '😋', '😎', '😍', '🥰', '😘', '😗', '😙', '😚', '🙂', '🤗', '🤩', '🤔', '😐', '😑', '😶', '🙄', '😏', '😣', '😥', '😮', '🤐', '😯', '😪', '😫', '😴', '😌', '😛', '😜', '😝', '🤤', '😒', '😓', '😔', '😕', '🙃', '🤑', '😲', '🙁', '😖', '😞', '😟', '😤', '😢', '😭', '😨', '😩', '🤯', '😬', '😰', '😱', '🥵', '🥶', '😳', '🤪', '😵', '🥴', '😠', '😡', '🤬', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '😇', '🥳', '🥺', '🤠', '🤡', '🤥', '🤫', '🤭', '🧐', '🤓', '😈', '👿', '👹', '👺', '💀', '☠️', '👻', '👽', '👾', '🤖'],
      'Hands': ['👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄'],
      'Hearts': ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❤️‍🔥', '❤️‍🩹', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓'],
      'Objects': ['⌚', '📱', '📲', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '🕹️', '🗜️', '💽', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽️', '🎞️', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🧭', '⏱️', '⏲️', '⏰', '🕰️', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸', '💵', '💴', '💶', '💷', '🪙', '💰', '💳', '💎', '⚖️', '🪜', '🧰', '🪛', '🔧', '🔨', '⚒️', '🛠️', '⛏️', '🪚', '🔩', '⚙️', '🪤', '🧱', '⛓️', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡️', '⚔️', '🛡️', '🚬', '⚰️', '🪦', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳️', '🩹', '🩺', '💊', '💉', '🩸', '🧬', '🦠', '🧫', '🧪', '🌡️', '🧹', '🪠', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪥', '🪒', '🧽', '🪣', '🧴', '🛎️', '🔑', '🗝️', '🚪', '🪑', '🛋️', '🛏️', '🛌', '🧸', '🪆', '🖼️', '🪞', '🪟', '🛍️', '🛒', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🎊', '🎉', '🎎', '🏮', '🎐', '🧧', '✉️', '📩', '📨', '📧', '💌', '📥', '📤', '📦', '🏷️', '🪧', '📪', '📫', '📬', '📭', '📮', '📯', '📜', '📃', '📄', '📑', '🧾', '📊', '📈', '📉', '🗒️', '🗓️', '📆', '📅', '🗑️', '📇', '🗃️', '🗳️', '🗄️', '📋', '📁', '📂', '🗂️', '🗞️', '📰', '📓', '📔', '📒', '📕', '📗', '📘', '📙', '📚', '📖', '🔖', '🧷', '🔗', '📎', '🖇️', '📐', '📏', '🧮', '📌', '📍', '✂️', '🖊️', '🖋️', '✒️', '🖌️', '🖍️', '📝', '✏️', '🔍', '🔎', '🔏', '🔐', '🔒', '🔓']
    };
    let currentEmojiCategory = 'Smileys';

    const AutoReplyScope = { Everyone: 0, Stranger: 1, SpecificFriends: 2, FriendsExcept: 3 };
    const TriggerMode = { Direct: 0, Flow: 1 };

    var ws = null, triggers = [], currentTriggerId = null, editingTriggerId = null;
    var currentUser = null, friendsList = [], selectedFriendUids = [];
    var activityLogs = [], deleteTargetId = null, activityCount = 0;

    // Built-in triggers state (will be populated from database)
    const builtInTriggers = {
      autoReplyUser: {
        id: 'builtin_auto_reply_user',
        name: 'Tự động trả lời (Cá nhân)',
        description: 'Tự động trả lời tin nhắn 1-1',
        icon: '👤',
        enabled: false,
        response: '',
        cooldown: 30000,
        triggerID: null
      },
      autoReplyGroup: {
        id: 'builtin_auto_reply_group',
        name: 'Tự động trả lời (Nhóm)',
        description: 'Tự động trả lời tin nhắn nhóm',
        icon: '👨‍👩‍👧‍👦',
        enabled: false,
        response: '',
        cooldown: 30000,
        triggerID: null
      },
      autoAcceptFriend: {
        id: 'builtin_auto_friend',
        name: 'Chấp nhận kết bạn',
        description: 'Tự động đồng ý lời mời kết bạn',
        icon: '👥',
        enabled: false,
        welcomeMessage: '',
        triggerID: null
      },
      autoFile: {
        id: 'builtin_auto_file',
        name: 'Nhận diện file',
        description: 'Tự động trả lời khi nhận file/ảnh',
        icon: '📂',
        enabled: false,
        response: 'xlsx: Bạn đã gửi file Excel\npdf: Bạn đã gửi file PDF\ndefault: Đã nhận file của bạn',
        cooldown: 0,
        triggerID: null
      },
      selfTrigger: {
        id: 'builtin_self_trigger',
        name: 'Tự kích hoạt (Self-Trigger)',
        description: 'Tự động chạy flow/trả lời khi bạn gõ lệnh (Ví dụ: /test)',
        icon: '⚡',
        enabled: false,
        response: '',
        cooldown: 0,
        triggerID: null
      },
      aiConversation: {
        id: 'builtin_ai_conversation',
        name: 'AI Conversation',
        description: 'Trò chuyện liên tục với AI. Tự set lệnh bật/tắt',
        icon: '🤖',
        enabled: false,
        configId: null,
        commandOn: '/ai',
        commandOff: '/ai-off',
        systemPrompt: 'Bạn là trợ lý AI thân thiện. Trả lời ngắn gọn và hữu ích.',
        timeoutMinutes: 30,
        timeoutMessage: 'Hết thời gian trò chuyện.',
        saveHistory: true,
        triggerID: null
      }
    };

    // ================================================
    // WEBSOCKET
    // ================================================
    function connectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
      ws.onopen = () => {
        console.log('✅ WebSocket connected');
        setTimeout(() => {
          if (ws?.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_current_user' }));
            ws.send(JSON.stringify({ type: 'get_auto_reply_status' }));
            ws.send(JSON.stringify({ type: 'get_triggers' }));
            ws.send(JSON.stringify({ type: 'get_friends' }));
            ws.send(JSON.stringify({ type: 'get_activity_logs', limit: 100 }));
          }
        }, 200);
      };
      ws.onclose = () => { updateAutoReplyStatus('off', 'Offline'); setTimeout(connectWebSocket, 3000); };
      ws.onmessage = (e) => { try { handleWebSocketMessage(JSON.parse(e.data)); } catch (err) { console.error(err); } };
    }

    function handleWebSocketMessage(data) {
      console.log('📩', data.type);
      if (data.type === 'current_user') {
        currentUser = data.user;
        updateUserInfo(currentUser);
        // Load AI Conversation state for this user
        if (currentUser?.uid) {
          ws.send(JSON.stringify({
            type: 'get_builtin_trigger_state',
            userUID: currentUser.uid,
            triggerKey: 'builtin_ai_conversation'
          }));
        }
      }
      if (data.type === 'friends_list') { friendsList = data.friends || []; console.log('👥 Friends:', friendsList.length); }
      if (data.type === 'triggers_list' || data.type === 'auto_reply_status') {
        const list = data.triggers || data.scenarios || [];
        if (list.length > 0 || data.type === 'triggers_list') {
          const allTriggers = list.map(formatTrigger);

          // Separate built-in triggers from database
          // Separate built-in triggers from database
          const autoReplyUserTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_reply_user__');
          const autoReplyGroupTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_reply_group__');
          const autoFriendTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_friend__');
          const autoFileTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_file__');

          // Update built-in triggers state from database
          if (autoReplyUserTrigger) {
            builtInTriggers.autoReplyUser.enabled = autoReplyUserTrigger.enabled;
            builtInTriggers.autoReplyUser.response = autoReplyUserTrigger.response;
            builtInTriggers.autoReplyUser.triggerID = autoReplyUserTrigger.id;
            builtInTriggers.autoReplyUser.cooldown = autoReplyUserTrigger.cooldown || 30000;
          }

          if (autoReplyGroupTrigger) {
            builtInTriggers.autoReplyGroup.enabled = autoReplyGroupTrigger.enabled;
            builtInTriggers.autoReplyGroup.response = autoReplyGroupTrigger.response;
            builtInTriggers.autoReplyGroup.triggerID = autoReplyGroupTrigger.id;
            builtInTriggers.autoReplyGroup.cooldown = autoReplyGroupTrigger.cooldown || 30000;
          }

          if (autoFriendTrigger) {
            builtInTriggers.autoAcceptFriend.enabled = autoFriendTrigger.enabled;
            builtInTriggers.autoAcceptFriend.welcomeMessage = autoFriendTrigger.response;
            builtInTriggers.autoAcceptFriend.triggerID = autoFriendTrigger.id;
          }

          if (autoFileTrigger) {
            builtInTriggers.autoFile.enabled = autoFileTrigger.enabled;
            builtInTriggers.autoFile.response = autoFileTrigger.response;
            builtInTriggers.autoFile.triggerID = autoFileTrigger.id;
            builtInTriggers.autoFile.cooldown = autoFileTrigger.cooldown || 2000;
          }

          const selfTrigger = allTriggers.find(t => t.triggerKey === '__builtin_self_trigger__' || t.keyword_pattern === '/.*' || t.triggerKey === 'builtin_self_trigger');
          if (selfTrigger) {
            builtInTriggers.selfTrigger.enabled = selfTrigger.enabled;
            builtInTriggers.selfTrigger.response = selfTrigger.triggerContent || selfTrigger.response;
            builtInTriggers.selfTrigger.triggerID = selfTrigger.id;
            builtInTriggers.selfTrigger.setMode = selfTrigger.setMode || 0;
          }

          if (autoFriendTrigger) {
            builtInTriggers.autoAcceptFriend.enabled = autoFriendTrigger.enabled;
            builtInTriggers.autoAcceptFriend.welcomeMessage = autoFriendTrigger.response;
            builtInTriggers.autoAcceptFriend.triggerID = autoFriendTrigger.id;
          }

          // Remove built-in triggers from regular list (keep only user triggers)
          triggers = allTriggers.filter(t => !t.triggerKey || !t.triggerKey.startsWith('__builtin_'));

          renderTriggerList();
        }
        if (data.type === 'auto_reply_status') {
          const toggle = document.getElementById('autoReplyToggle');
          if (toggle) { toggle.checked = data.enabled; toggle.disabled = !currentUser?.uid; }
          updateAutoReplyStatus(data.enabled ? 'on' : 'off', data.enabled ? 'ON' : 'OFF');
        }
      }

      if (data.type === 'flows_list') {
        window.availableFlows = data.flows || [];
        if (document.getElementById('selfTriggerModal') && document.getElementById('selfTriggerModal').style.display !== 'none') {
          if (window.renderSelfTriggerRules) window.renderSelfTriggerRules();
        }
      }

      if (data.type === 'self_trigger_config') {
        const cfg = data.config;
        if (cfg) {
          const t = builtInTriggers.selfTrigger;
          t.enabled = cfg.enabled;
          t.response = cfg.triggerContent || cfg.response || '';

          // Sync Rules
          try {
            window.selfTriggerRules = [];
            const content = t.response;
            if (content && content.trim().startsWith('{')) {
              const config = JSON.parse(content);
              if (config.rules && Array.isArray(config.rules)) {
                window.selfTriggerRules = config.rules;
              } else if (config.command) {
                window.selfTriggerRules.push({
                  command: config.command,
                  type: (cfg.setMode === 1) ? 'flow' : 'text',
                  value: (cfg.setMode === 1) ? t.triggerID : config.response
                });
              }
            }
            if (window.selfTriggerRules.length === 0) {
              window.selfTriggerRules.push({ command: '', type: 'text', value: '' });
            }
          } catch (e) { }

          const enInput = document.getElementById('selfTriggerEnabled');
          if (document.getElementById('selfTriggerModal').style.display !== 'none') {
            if (enInput) enInput.checked = t.enabled;
            if (window.renderSelfTriggerRules) window.renderSelfTriggerRules();
          }
          renderTriggerList();
        }
      }
      if (data.type === 'trigger_created' || data.type === 'scenario_added') {
        const newTrigger = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        // Check if it's a built-in trigger
        if (newTrigger.triggerKey === '__builtin_auto_reply_user__') {
          builtInTriggers.autoReplyUser.triggerID = newTrigger.id;
          builtInTriggers.autoReplyUser.enabled = newTrigger.enabled;
          builtInTriggers.autoReplyUser.response = newTrigger.response;
        } else if (newTrigger.triggerKey === '__builtin_auto_reply_group__') {
          builtInTriggers.autoReplyGroup.triggerID = newTrigger.id;
          builtInTriggers.autoReplyGroup.enabled = newTrigger.enabled;
          builtInTriggers.autoReplyGroup.response = newTrigger.response;
        } else if (newTrigger.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.triggerID = newTrigger.id;
          builtInTriggers.autoAcceptFriend.enabled = newTrigger.enabled;
          builtInTriggers.autoAcceptFriend.welcomeMessage = newTrigger.response;
        } else if (newTrigger.triggerKey === '__builtin_auto_file__') {
          builtInTriggers.autoFile.triggerID = newTrigger.id;
          builtInTriggers.autoFile.enabled = newTrigger.enabled;
          builtInTriggers.autoFile.response = newTrigger.response;
        } else {
          // Regular user trigger
          triggers.push(newTrigger);
        }

        renderTriggerList();
        showToast('✅ Đã tạo trigger!', 'success');
        if ((data.trigger || data.scenario).setMode === 1) {
          showToast('🔄 Flow đã được tạo - Mở Flow Builder để thiết kế', 'info');
        }
      }
      if (data.type === 'trigger_updated' || data.type === 'scenario_updated') {
        const t = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        // Check if it's a built-in trigger
        if (t.triggerKey === '__builtin_auto_reply_user__') {
          builtInTriggers.autoReplyUser.enabled = t.enabled;
          builtInTriggers.autoReplyUser.response = t.response;
        } else if (t.triggerKey === '__builtin_auto_reply_group__') {
          builtInTriggers.autoReplyGroup.enabled = t.enabled;
          builtInTriggers.autoReplyGroup.response = t.response;
        } else if (t.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.enabled = t.enabled;
          builtInTriggers.autoAcceptFriend.welcomeMessage = t.response;
        } else if (t.triggerKey === '__builtin_auto_file__') {
          builtInTriggers.autoFile.enabled = t.enabled;
          builtInTriggers.autoFile.response = t.response;
        } else {
          const i = triggers.findIndex(x => x.id === t.id);
          if (i !== -1) { triggers[i] = t; if (currentTriggerId === t.id) displayTrigger(t); }
        }

        renderTriggerList();
        showToast('✅ Đã cập nhật!', 'success');
      }
      if (data.type === 'trigger_deleted' || data.type === 'scenario_deleted') { triggers = triggers.filter(t => t.id !== data.id); renderTriggerList(); if (currentTriggerId === data.id) showEmptyState(); showToast('✅ Đã xóa!', 'success'); }
      if (data.type === 'trigger_toggled' || data.type === 'scenario_toggled') {
        const t = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        // Check if it's a built-in trigger
        if (t.triggerKey === '__builtin_auto_reply_user__') {
          builtInTriggers.autoReplyUser.enabled = t.enabled;
        } else if (t.triggerKey === '__builtin_auto_reply_group__') {
          builtInTriggers.autoReplyGroup.enabled = t.enabled;
        } else if (t.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.enabled = t.enabled;
        } else {
          const i = triggers.findIndex(x => x.id === t.id);
          if (i !== -1) { triggers[i] = t; if (currentTriggerId === t.id) displayTrigger(t); }
        }

        renderTriggerList();
      }
      if (data.type === 'trigger_error') { showToast('❌ ' + (data.message || 'Lỗi'), 'error'); }
      if (data.type === 'activity_logs') { activityLogs = data.logs || []; renderActivityList(); }
      if (data.type === 'activity_log') { activityLogs.unshift(data.activity); activityCount++; updateActivityBadge(); renderActivityList(); }
      if (data.type === 'activity_logs_cleared') { activityLogs = []; renderActivityList(); showToast('✅ Đã xóa lịch sử', 'success'); }

      // AI Configs
      if (data.type === 'ai_configs') {
        populateAIConfigDropdown(data.configs || []);
      }

      // Built-in trigger state
      if (data.type === 'builtin_trigger_state') {
        console.log('📥 Received builtin_trigger_state:', data);
        if (data.triggerKey === 'builtin_ai_conversation') {
          if (data.state) {
            console.log('🔄 Merging AI Conversation state:', data.state);
            Object.assign(builtInTriggers.aiConversation, data.state);
            renderTriggerList();
          } else {
            console.log('ℹ️ No saved state for AI Conversation yet');
          }
        }
      }

      if (data.type === 'builtin_trigger_state_saved') {
        console.log('✅ Built-in trigger state saved:', data.triggerKey);
      }
    }

    function formatTrigger(t) {
      // Xử lý timestamp - có thể là số hoặc string
      let timeCreated = t.timeCreated || t.createdAt;
      let timeUpdate = t.timeUpdate || t.updatedAt;

      // Nếu là string dạng ISO, chuyển thành timestamp
      if (typeof timeCreated === 'string') timeCreated = new Date(timeCreated).getTime();
      if (typeof timeUpdate === 'string') timeUpdate = new Date(timeUpdate).getTime();

      // Nếu vẫn không hợp lệ, dùng Date.now()
      if (!timeCreated || isNaN(timeCreated)) timeCreated = Date.now();
      if (!timeUpdate || isNaN(timeUpdate)) timeUpdate = Date.now();

      return {
        id: t.triggerID || t.id,
        name: t.triggerName || t.name || 'Untitled',
        triggerType: t.triggerType || 'keyword',  // MỚI: loại trigger
        triggerKey: t.triggerKey || '',  // Keep raw triggerKey for built-in detection
        keywords: t.triggerKey ? t.triggerKey.split(',').map(k => k.trim()) : (t.keywords || []),
        response: t.triggerContent || t.response || '',
        enabled: t.enabled === true || t.enabled === 1,
        scope: t.scope ?? 0,
        uids: t.uids || [],
        schedule: { startTime: t.timeStartActive || t.schedule?.startTime || '00:00', endTime: t.timeEndActive || t.schedule?.endTime || '23:59' },
        dateStart: t.dateStartActive || null,
        dateEnd: t.dateEndActive || null,
        cooldown: t.cooldown || 30000,
        timeCreated: timeCreated,
        timeUpdate: timeUpdate,
        userUID: t.triggerUserID || t.userUID,
        setMode: t.setMode ?? 0,
        flow: t.flow || null,
        icon: (t.setMode === 1) ? '🔄' : '🔑'
      };
    }

    // ================================================
    // UI HELPERS
    // ================================================
    function updateUserInfo(user) {
      const panel = document.getElementById('userInfoPanel');
      if (!user) { panel.style.display = 'none'; return; }
      panel.style.display = 'flex';
      document.getElementById('userAvatar').textContent = user.name ? user.name.charAt(0).toUpperCase() : '👤';
      document.getElementById('userName').textContent = user.name || 'Unknown';
      document.getElementById('userUID').textContent = 'UID: ' + (user.uid || '-');
    }

    function updateAutoReplyStatus(state, text) { const s = document.getElementById('autoReplyStatus'); if (s) { s.className = 'toggle-status ' + state; s.textContent = text; } }
    function toggleAutoReply() {
      const t = document.getElementById('autoReplyToggle');
      if (!t) return;
      const newState = t.checked;
      updateAutoReplyStatus(newState ? 'on' : 'off', newState ? 'ON' : 'OFF'); // Optimistic
      if (ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'set_auto_reply', enabled: newState }));
      } else {
        t.checked = !newState; // Revert
        updateAutoReplyStatus(!newState ? 'on' : 'off', !newState ? 'ON' : 'OFF');
        showToast('❌ Mất kết nối!', 'error');
      }
    }

    function formatDateTime(ts) {
      if (!ts || isNaN(ts)) return 'N/A';
      const d = new Date(ts);
      if (isNaN(d.getTime())) return 'N/A';
      return d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function formatTimeAgo(ts) {
      if (!ts || isNaN(ts)) return '';
      const d = Date.now() - ts;
      if (d < 0) return 'Vừa xong';
      const m = Math.floor(d / 60000), h = Math.floor(d / 3600000), dd = Math.floor(d / 86400000);
      if (m < 1) return 'Vừa xong';
      if (m < 60) return m + ' phút trước';
      if (h < 24) return h + ' giờ trước';
      if (dd < 7) return dd + ' ngày trước';
      return formatDateTime(ts);
    }
    function getScopeText(s) { return ['Tất cả', 'Người lạ', 'Bạn bè cụ thể', 'Tất cả trừ'][s] || 'N/A'; }
    function getModeText(m) { return m === 1 ? '🔄 Chạy theo Flow' : '⚡ Gửi trực tiếp'; }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }
    function showToast(msg, type = 'info') { const t = document.createElement('div'); t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:' + (type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3') + ';color:white;padding:12px 20px;border-radius:8px;z-index:10001;'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => { t.remove(); }, 3000); }

    // ================================================
    // EMOJI PICKER
    // ================================================
    function toggleEmojiPicker(e) {
      e.preventDefault();
      e.stopPropagation();
      const container = document.getElementById('emojiPickerContainer');
      const isVisible = container.classList.contains('show');
      if (isVisible) {
        container.classList.remove('show');
      } else {
        renderEmojiPicker();
        container.classList.add('show');
      }
    }

    function renderEmojiPicker() {
      // Render tabs
      const tabsHtml = Object.keys(EMOJI_DATA).map(cat =>
        `<button class="emoji-tab ${cat === currentEmojiCategory ? 'active' : ''}" onclick="selectEmojiCategory('${cat}')">${EMOJI_DATA[cat][0]}</button>`
      ).join('');
      document.getElementById('emojiTabs').innerHTML = tabsHtml;

      // Render emoji grid
      renderEmojiGrid();
    }

    function selectEmojiCategory(cat) {
      currentEmojiCategory = cat;
      document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderEmojiGrid();
    }

    function renderEmojiGrid() {
      const emojis = EMOJI_DATA[currentEmojiCategory] || [];
      const gridHtml = emojis.map(e => `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`).join('');
      document.getElementById('emojiGrid').innerHTML = gridHtml;
    }

    function insertEmoji(emoji) {
      const textarea = document.getElementById('triggerResponse');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      // Đóng picker
      document.getElementById('emojiPickerContainer').classList.remove('show');
    }

    // Đóng emoji picker khi click ra ngoài
    document.addEventListener('click', function (e) {
      const container = document.getElementById('emojiPickerContainer');
      const btn = document.querySelector('.emoji-btn');
      if (container && !container.contains(e.target) && e.target !== btn) {
        container.classList.remove('show');
      }
    });

    // ================================================
    // RENDER TRIGGER LIST
    // ================================================
    function renderTriggerList() {
      const c = document.getElementById('triggerList');

      let html = '';

      // ===== BUILT-IN TRIGGERS (Special section) =====
      html += renderBuiltInTriggers();

      // ===== USER TRIGGERS =====
      if (triggers.length === 0) {
        html += '<div style="text-align:center; padding:40px; color:#999;">📋 Chưa có trigger<br><button onclick="showNewTriggerModal()" style="margin-top:10px; padding:8px 16px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer;">➕ Tạo mới</button></div>';
        c.innerHTML = html;
        document.getElementById('triggerCount').textContent = '0';
        return;
      }

      const active = triggers.filter(t => t.enabled), inactive = triggers.filter(t => !t.enabled);
      if (active.length > 0) { html += '<div class="trigger-group"><div class="trigger-group-title">✅ Đang hoạt động (' + active.length + ')</div>' + active.map(renderTriggerItem).join('') + '</div>'; }
      if (inactive.length > 0) { html += '<div class="trigger-group"><div class="trigger-group-title">⏸️ Tạm dừng (' + inactive.length + ')</div>' + inactive.map(renderTriggerItem).join('') + '</div>'; }
      html += '<button class="new-trigger-btn" onclick="showNewTriggerModal()">➕ Tạo trigger mới</button>';
      c.innerHTML = html;
      document.getElementById('triggerCount').textContent = triggers.length;
    }

    function renderBuiltInTriggers() {
      return `
        <div class="trigger-group" style="margin-bottom: 24px; border: 1px solid #e0e0e0; border-radius: 14px; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.06); overflow: hidden;">
          <div class="trigger-group-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 20px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;">
            ⚙️ Triggers Mặc Định
          </div>
          <div style="padding: 16px;">
            ${renderBuiltInTriggerItem(builtInTriggers.autoReplyUser)}
            ${renderBuiltInTriggerItem(builtInTriggers.autoReplyGroup)}
            ${renderBuiltInTriggerItem(builtInTriggers.autoAcceptFriend)}
            ${renderBuiltInTriggerItem(builtInTriggers.autoFile)}
            ${renderBuiltInTriggerItem(builtInTriggers.selfTrigger)}
            ${renderBuiltInTriggerItem(builtInTriggers.aiConversation)}
          </div>
        </div>
      `;
    }

    function renderBuiltInTriggerItem(trigger) {
      const statusColor = trigger.enabled ? '#4caf50' : '#ccc';
      const statusText = trigger.enabled ? 'BẬT' : 'TẮT';

      return `
        <div class="trigger-item-compact" onclick="toggleBuiltInTrigger('${trigger.id}')"
          style="cursor: pointer; background: ${trigger.enabled ? '#f0f9ff' : '#fafafa'}; border: 1px solid ${trigger.enabled ? '#b3d9ff' : '#eee'}; display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 10px; min-height: 64px; border-radius: 10px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">

          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 20px; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            ${trigger.icon}
          </div>

          <div style="flex: 1; min-width: 0; overflow: hidden;">
            <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(trigger.name)}</div>
            <div style="font-size: 11px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(trigger.description || '')}</div>
          </div>

          <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
            <span style="font-size: 10px; padding: 3px 10px; background: ${statusColor}; color: white; border-radius: 10px; font-weight: 600; white-space: nowrap;">${statusText}</span>
            <button class="action-icon" onclick="event.stopPropagation(); setupBuiltInTrigger('${trigger.id}')" title="Cài đặt" style="width: 32px; height: 32px; font-size: 15px; color: #667eea; background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">⚙️</button>
          </div>
        </div>
      `;
    }

    // ================================================
    // BUILT-IN TRIGGER ACTIONS
    // ================================================
    function toggleBuiltInTrigger(triggerId) {
      console.log('🔘 toggleBuiltInTrigger called:', triggerId);

      let trigger;
      if (triggerId === 'builtin_auto_reply_user') trigger = builtInTriggers.autoReplyUser;
      else if (triggerId === 'builtin_auto_reply_group') trigger = builtInTriggers.autoReplyGroup;
      else if (triggerId === 'builtin_auto_friend') trigger = builtInTriggers.autoAcceptFriend;
      else if (triggerId === 'builtin_auto_file') trigger = builtInTriggers.autoFile;
      else if (triggerId === 'builtin_self_trigger') trigger = builtInTriggers.selfTrigger;
      else if (triggerId === 'builtin_ai_conversation') trigger = builtInTriggers.aiConversation;

      if (!trigger) {
        console.error('Trigger not found for ID:', triggerId);
        return;
      }
      console.log('🔘 Trigger state:', trigger);

      // Special handling for AI Conversation (no triggerID needed, uses separate state)
      if (triggerId === 'builtin_ai_conversation') {
        // Check if configured
        if (!trigger.configId && !trigger.enabled) {
          showToast('⚠️ Vui lòng cấu hình AI Conversation trước! Click nút ⚙️ để thiết lập.', 'warning');
          setupBuiltInTrigger(triggerId);
          return;
        }

        // Toggle state
        trigger.enabled = !trigger.enabled;
        console.log('🔘 AI Conversation toggled to:', trigger.enabled);

        // Save state to backend
        ws.send(JSON.stringify({
          type: 'save_builtin_trigger_state',
          userUID: currentUser.uid,
          triggerKey: 'builtin_ai_conversation',
          stateData: {
            configId: trigger.configId,
            commandOn: trigger.commandOn,
            commandOff: trigger.commandOff,
            systemPrompt: trigger.systemPrompt,
            timeoutMinutes: trigger.timeoutMinutes,
            timeoutMessage: trigger.timeoutMessage,
            saveHistory: trigger.saveHistory,
            enabled: trigger.enabled
          }
        }));

        renderTriggerList();
        showToast(trigger.enabled ? '✅ Đã bật ' + trigger.name : '⏸️ Đã tắt ' + trigger.name, 'success');
        return;
      }

      // For other triggers: Check if configured
      if (!trigger.triggerID) {
        console.log('🔘 Not created yet, opening setup modal');
        showToast('⚠️ Vui lòng cấu hình trigger trước! Click nút ⚙️ để thiết lập.', 'warning');
        setupBuiltInTrigger(triggerId);
        return;
      }

      if (!trigger.response && !trigger.welcomeMessage) {
        console.log('🔘 No config, opening setup modal');
        showToast('⚠️ Vui lòng cấu hình nội dung trước! Click nút ⚙️ để thiết lập.', 'warning');
        setupBuiltInTrigger(triggerId);
        return;
      }

      // Toggle trạng thái
      trigger.enabled = !trigger.enabled;
      console.log('🔘 Toggled to:', trigger.enabled);

      // Gửi toggle request
      ws.send(JSON.stringify({
        type: 'toggle_trigger',
        id: trigger.triggerID
      }));

      renderTriggerList();
      showToast(trigger.enabled ? '✅ Đã bật ' + trigger.name : '⏸️ Đã tắt ' + trigger.name, 'success');
    }

    function setupBuiltInTrigger(triggerId) {
      console.log('⚙️ setupBuiltInTrigger called:', triggerId);
      if (triggerId === 'builtin_auto_reply_user' || triggerId === 'builtin_auto_reply_group') {
        showAutoMessageSetup(triggerId);
      } else if (triggerId === 'builtin_auto_friend') {
        showAutoFriendSetup();
      } else if (triggerId === 'builtin_auto_file') {
        showAutoFileSetup();
      } else if (triggerId === 'builtin_self_trigger') {
        if (typeof showSelfTriggerModal === 'function') showSelfTriggerModal();
        else alert('Tính năng đang cập nhật...');
      } else if (triggerId === 'builtin_ai_conversation') {
        showAIConversationSetup();
      }
    }

    // ================================================
    // AUTO MESSAGE SETUP MODAL
    // ================================================
    function showAutoMessageSetup(triggerId) {
      console.log('💬 showAutoMessageSetup called for:', triggerId);

      // Store current editing id
      document.getElementById('autoMessageModal').dataset.triggerId = triggerId;

      let trigger;
      if (triggerId === 'builtin_auto_reply_user') {
        trigger = builtInTriggers.autoReplyUser;
        document.getElementById('autoMessageModalTitle').textContent = '💬 Cài đặt Trả lời tự động (Cá nhân)';
        document.getElementById('autoMessageDesc').textContent = 'Tự động trả lời tin nhắn từ người dùng (1-on-1).';
      } else {
        trigger = builtInTriggers.autoReplyGroup;
        document.getElementById('autoMessageModalTitle').textContent = '👨‍👩‍👧‍👦 Cài đặt Trả lời tự động (Nhóm)';
        document.getElementById('autoMessageDesc').textContent = 'Tự động trả lời tin nhắn từ nhóm chat.';
      }

      // Populate form với dữ liệu hiện tại
      document.getElementById('autoMessageResponse').value = trigger.response || '';
      document.getElementById('autoMessageEnabled').checked = trigger.enabled;
      // Cooldown: convert from ms to seconds for display
      document.getElementById('autoMessageCooldown').value = Math.floor((trigger.cooldown || 30000) / 1000);

      // Show modal
      document.getElementById('autoMessageModal').style.display = 'flex';
      console.log('💬 Modal should be visible now');
    }

    function hideAutoMessageModal() {
      document.getElementById('autoMessageModal').style.display = 'none';
    }

    function saveAutoMessageSetup() {
      const response = document.getElementById('autoMessageResponse').value.trim();
      const enabled = document.getElementById('autoMessageEnabled').checked;
      const cooldownSeconds = parseInt(document.getElementById('autoMessageCooldown').value) || 30;
      const cooldownMs = cooldownSeconds * 1000; // Convert to milliseconds

      if (!response) {
        showToast('❌ Vui lòng nhập nội dung trả lời!', 'error');
        return;
      }

      if (!currentUser?.uid) {
        showToast('❌ Chưa đăng nhập!', 'error');
        return;
      }

      // Update state
      if (triggerId === 'builtin_auto_reply_user') {
        builtInTriggers.autoReplyUser.response = response;
        builtInTriggers.autoReplyUser.enabled = enabled;
        builtInTriggers.autoReplyUser.cooldown = cooldownMs;
        saveBuiltInTriggerState('builtin_auto_reply_user', builtInTriggers.autoReplyUser);
      } else {
        builtInTriggers.autoReplyGroup.response = response;
        builtInTriggers.autoReplyGroup.enabled = enabled;
        builtInTriggers.autoReplyGroup.cooldown = cooldownMs;
        saveBuiltInTriggerState('builtin_auto_reply_group', builtInTriggers.autoReplyGroup);
      }

      // Hide modal and update UI
      hideAutoMessageModal();
      renderTriggerList();
      showToast('✅ Đã lưu cài đặt Tự động gửi tin nhắn!', 'success');
    }

    function toggleEmojiPickerForAutoMessage(event) {
      event.stopPropagation();
      const picker = document.getElementById('emojiPickerAutoMessage');
      const isVisible = picker.style.display === 'block';

      // Close all emoji pickers
      document.querySelectorAll('.emoji-picker-container').forEach(p => p.style.display = 'none');

      if (!isVisible) {
        picker.style.display = 'block';
        // Initialize emoji picker if not already done
        if (!picker.dataset.initialized) {
          initEmojiPickerForElement('AutoMessage');
          picker.dataset.initialized = 'true';
        }
      }
    }

    // ================================================
    // AUTO ACCEPT FRIEND SETUP MODAL
    // ================================================
    function showAutoFriendSetup() {
      const trigger = builtInTriggers.autoAcceptFriend;

      // Populate form với dữ liệu hiện tại
      document.getElementById('autoFriendMessage').value = trigger.welcomeMessage || '';
      document.getElementById('autoFriendEnabled').checked = trigger.enabled;

      // Show modal
      document.getElementById('autoFriendModal').style.display = 'flex';
    }

    function hideAutoFriendModal() {
      document.getElementById('autoFriendModal').style.display = 'none';
    }

    function saveAutoFriendSetup() {
      const welcomeMessage = document.getElementById('autoFriendMessage').value.trim();
      const enabled = document.getElementById('autoFriendEnabled').checked;

      if (!currentUser?.uid) {
        showToast('❌ Chưa đăng nhập!', 'error');
        return;
      }

      // Update state (tin nhắn chào mừng là tùy chọn)
      builtInTriggers.autoAcceptFriend.welcomeMessage = welcomeMessage;
      builtInTriggers.autoAcceptFriend.enabled = enabled;

      // Save to database
      saveBuiltInTriggerState('builtin_auto_friend', builtInTriggers.autoAcceptFriend);

      // Hide modal and update UI
      hideAutoFriendModal();
      renderTriggerList();
      showToast('✅ Đã lưu cài đặt Chấp nhận kết bạn!', 'success');
    }

    // ================================================
    // AUTO FILE SETUP MODAL
    // ================================================
    function showAutoFileSetup() {
      const trigger = builtInTriggers.autoFile;

      // Populate form
      document.getElementById('autoFileResponse').value = trigger.response || '';
      document.getElementById('autoFileEnabled').checked = trigger.enabled;

      document.getElementById('autoFileModal').style.display = 'flex';
    }

    function hideAutoFileModal() {
      document.getElementById('autoFileModal').style.display = 'none';
    }

    function saveAutoFileSetup() {
      const response = document.getElementById('autoFileResponse').value.trim();
      const enabled = document.getElementById('autoFileEnabled').checked;

      if (!response && enabled) {
        showToast('⚠️ Bạn nên nhập nội dung trả lời để trigger hoạt động hiệu quả', 'info');
      }

      if (!currentUser?.uid) {
        showToast('❌ Chưa đăng nhập!', 'error');
        return;
      }

      // Update state
      builtInTriggers.autoFile.response = response;
      builtInTriggers.autoFile.enabled = enabled;
      builtInTriggers.autoFile.cooldown = 2000;

      // Save to database
      saveBuiltInTriggerState('builtin_auto_file', builtInTriggers.autoFile);

      // Hide modal and update UI
      hideAutoFileModal();
      renderTriggerList();
      showToast('✅ Đã lưu cài đặt Nhận diện file!', 'success');
    }

    function toggleEmojiPickerForAutoFriend(event) {
      event.stopPropagation();
      const picker = document.getElementById('emojiPickerAutoFriend');
      const isVisible = picker.style.display === 'block';

      // Close all emoji pickers
      document.querySelectorAll('.emoji-picker-container').forEach(p => p.style.display = 'none');

      if (!isVisible) {
        picker.style.display = 'block';
        // Initialize emoji picker if not already done
        if (!picker.dataset.initialized) {
          initEmojiPickerForElement('AutoFriend');
          picker.dataset.initialized = 'true';
        }
      }
    }

    function initEmojiPickerForElement(suffix) {
      const tabsContainer = document.getElementById('emojiTabs' + suffix);
      const gridContainer = document.getElementById('emojiGrid' + suffix);

      // Render tabs
      tabsContainer.innerHTML = Object.keys(EMOJI_DATA).map(cat =>
        '<button class="emoji-tab ' + (cat === currentEmojiCategory ? 'active' : '') + '" onclick="switchEmojiCategory' + suffix + '(\'' + cat + '\')">' + cat + '</button>'
      ).join('');

      // Render grid
      switchEmojiCategory(currentEmojiCategory, suffix);
    }

    function switchEmojiCategoryAutoMessage(category) {
      switchEmojiCategory(category, 'AutoMessage');
    }

    function switchEmojiCategoryAutoFriend(category) {
      switchEmojiCategory(category, 'AutoFriend');
    }

    function switchEmojiCategory(category, suffix) {
      currentEmojiCategory = category;
      const gridContainer = document.getElementById('emojiGrid' + (suffix || ''));
      const tabsContainer = document.getElementById('emojiTabs' + (suffix || ''));

      // Update tabs
      tabsContainer.querySelectorAll('.emoji-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === category);
      });

      // Update grid
      gridContainer.innerHTML = EMOJI_DATA[category].map(emoji =>
        '<button class="emoji-item" onclick="insertEmoji' + (suffix || '') + '(\'' + emoji + '\')">' + emoji + '</button>'
      ).join('');
    }

    function insertEmojiAutoMessage(emoji) {
      const textarea = document.getElementById('autoMessageResponse');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      document.getElementById('emojiPickerAutoMessage').style.display = 'none';
    }

    function insertEmojiAutoFriend(emoji) {
      const textarea = document.getElementById('autoFriendMessage');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      document.getElementById('emojiPickerAutoFriend').style.display = 'none';
    }

    function saveBuiltInTriggerState(triggerId, trigger) {
      if (!currentUser?.uid) {
        showToast('❌ Chưa đăng nhập!', 'error');
        return;
      }

      // Xác định triggerKey đặc biệt
      let specialKey = '';
      if (triggerId === 'builtin_auto_reply_user') specialKey = '__builtin_auto_reply_user__';
      else if (triggerId === 'builtin_auto_reply_group') specialKey = '__builtin_auto_reply_group__';
      else if (triggerId === 'builtin_auto_friend') specialKey = '__builtin_auto_friend__';
      else if (triggerId === 'builtin_auto_file') specialKey = '__builtin_auto_file__';

      // Nếu đã có triggerID trong DB, gửi update với đầy đủ data
      if (trigger.triggerID) {
        ws.send(JSON.stringify({
          type: 'update_trigger',
          id: trigger.triggerID,
          updates: {
            triggerName: trigger.name,
            enabled: trigger.enabled,
            triggerContent: trigger.response || trigger.welcomeMessage,
            cooldown: trigger.cooldown,
            triggerKey: specialKey
          }
        }));
      } else {
        // Tạo mới
        ws.send(JSON.stringify({
          type: 'create_trigger',
          name: trigger.name,
          triggerKey: specialKey,
          content: trigger.response || trigger.welcomeMessage || '',
          enabled: trigger.enabled,
          scope: 0,
          uids: [],
          cooldown: trigger.cooldown || 30000,
          startTime: '00:00',
          endTime: '23:59',
          userUID: currentUser.uid,
          keywords: []
        }));
      }
    }

    function renderTriggerItem(t) {
      const flowBadge = t.setMode === 1 ? '<span class="flow-badge">FLOW</span>' : '';
      return '<div class="trigger-item-compact ' + (currentTriggerId === t.id ? 'active' : '') + '" data-trigger-id="' + t.id + '"><div class="trigger-header-row" onclick="selectTrigger(' + t.id + ')"><div class="trigger-main-info"><div class="trigger-icon-small">' + t.icon + '</div><div style="flex:1;min-width:0;"><div class="trigger-name-small">' + escapeHtml(t.name) + ' ' + flowBadge + '</div><div class="trigger-keywords-preview">' + escapeHtml(t.keywords.slice(0, 3).join(', ')) + '</div><div class="trigger-time-created">🕐 ' + formatTimeAgo(t.timeCreated) + '</div></div></div><div class="trigger-actions" onclick="event.stopPropagation()"><button class="action-icon" onclick="editTrigger(' + t.id + ')">✏️</button><button class="action-icon" onclick="showDeleteModalFor(' + t.id + ')">🗑️</button></div><div class="trigger-status ' + (t.enabled ? 'active' : '') + '" onclick="event.stopPropagation(); toggleTriggerStatus(' + t.id + ')"></div></div></div>';
    }

    function selectTrigger(id) { const t = triggers.find(x => x.id === id); if (!t) return; currentTriggerId = id; document.querySelectorAll('.trigger-item-compact').forEach(e => e.classList.remove('active')); const el = document.querySelector('[data-trigger-id="' + id + '"]'); if (el) el.classList.add('active'); displayTrigger(t); }

    function displayTrigger(t) {
      document.getElementById('canvasTitle').textContent = t.name;
      const badge = document.getElementById('canvasBadge'); badge.textContent = t.enabled ? 'Đang hoạt động' : 'Tạm dừng'; badge.className = 'badge ' + (t.enabled ? 'active' : 'inactive'); badge.style.display = 'inline-block';
      const flowBadge = document.getElementById('canvasFlowBadge'); flowBadge.style.display = t.setMode === 1 ? 'inline-block' : 'none';
      document.getElementById('canvasActions').style.display = 'flex';
      document.getElementById('btnOpenBuilder').style.display = t.setMode === 1 ? 'inline-flex' : 'none';

      let uidsDisplay = t.uids?.length > 0 ? t.uids.map(uid => { const f = friendsList.find(x => x.userId === uid); return f ? f.displayName : uid; }).join(', ') : '';

      document.getElementById('canvasContent').innerHTML = '<div class="trigger-card"><div class="trigger-card-header"><div class="trigger-card-icon general">' + t.icon + '</div><div class="trigger-card-info"><h3>' + escapeHtml(t.name) + '</h3><p style="font-size:11px;color:#999;">ID: ' + t.id + '</p></div></div>' +
        (t.keywords.length > 0 ? '<div class="trigger-section"><div class="section-label">🔑 Từ khóa</div><div class="keyword-list">' + t.keywords.map(k => '<span class="keyword-chip">' + escapeHtml(k) + '</span>').join('') + '</div></div>' : '') +
        '<div class="trigger-section"><div class="section-label">🚀 Chế độ</div><div class="info-value">' + getModeText(t.setMode) + (t.setMode === 1 ? ' - <a href="#" onclick="openTriggerBuilder();return false;" style="color:#9c27b0;">Mở Flow Builder</a>' : '') + '</div></div>' +
        (t.setMode === 0 ? '<div class="trigger-section"><div class="section-label">💬 Trả lời</div><div class="response-box">' + escapeHtml(t.response) + '</div></div>' : '') +
        '<div class="trigger-section"><div class="section-label">ℹ️ Thông tin</div>' +
        '<div class="info-item"><span class="info-label">Trạng thái:</span><span class="info-value">' + (t.enabled ? '✅ Hoạt động' : '⏸️ Tạm dừng') + '</span></div>' +
        '<div class="info-item"><span class="info-label">Scope:</span><span class="info-value">' + getScopeText(t.scope) + '</span></div>' +
        (uidsDisplay ? '<div class="info-item"><span class="info-label">UIDs:</span><span class="info-value" style="font-size:11px;">' + uidsDisplay + '</span></div>' : '') +
        '<div class="info-item"><span class="info-label">Giờ:</span><span class="info-value">' + t.schedule.startTime + ' - ' + t.schedule.endTime + '</span></div>' +
        (t.dateStart || t.dateEnd ? '<div class="info-item"><span class="info-label">Ngày:</span><span class="info-value">' + (t.dateStart || '...') + ' → ' + (t.dateEnd || '...') + '</span></div>' : '') +
        '<div class="info-item"><span class="info-label">Cooldown:</span><span class="info-value">' + (t.cooldown / 1000) + 's</span></div>' +
        '<div class="info-item"><span class="info-label">Tạo lúc:</span><span class="info-value">' + formatDateTime(t.timeCreated) + '</span></div>' +
        '<div class="info-item"><span class="info-label">Cập nhật:</span><span class="info-value">' + formatDateTime(t.timeUpdate) + '</span></div></div></div>';
    }

    function showEmptyState() {
      document.getElementById('canvasTitle').textContent = 'Chọn một trigger';
      document.getElementById('canvasBadge').style.display = 'none';
      document.getElementById('canvasFlowBadge').style.display = 'none';
      document.getElementById('canvasActions').style.display = 'none';
      currentTriggerId = null;
      document.getElementById('canvasContent').innerHTML = '<div class="empty-state"><div class="icon">🎯</div><h3>Chọn trigger để xem</h3><button class="btn btn-primary" onclick="showNewTriggerModal()">➕ Tạo mới</button></div>';
    }

    // ================================================
    // OPEN TRIGGER BUILDER
    // ================================================
    function openTriggerBuilder() {
      if (!currentTriggerId) {
        showToast('❌ Vui lòng chọn trigger trước!', 'error');
        return;
      }
      const t = triggers.find(x => x.id === currentTriggerId);
      if (!t) return;
      if (t.setMode !== 1) {
        showToast('❌ Trigger này không ở chế độ Flow!', 'error');
        return;
      }
      window.open('trigger-builder.html?trigger=' + currentTriggerId, '_blank');
    }

    // ================================================
    // MODE CHANGE
    // ================================================
    function onModeChange() {
      const mode = parseInt(document.getElementById('triggerMode').value);
      const responseGroup = document.getElementById('responseGroup');
      const modeHint = document.getElementById('modeHint');

      if (mode === 1) {
        responseGroup.style.display = 'none';
        modeHint.className = 'mode-hint flow';
        modeHint.innerHTML = '🔄 Workflow sẽ được tạo tự động. Sau khi lưu, mở <strong>Flow Builder</strong> để thiết kế quy trình.';
      } else {
        responseGroup.style.display = 'block';
        modeHint.className = 'mode-hint';
        modeHint.textContent = 'Tin nhắn sẽ được gửi ngay lập tức khi khớp từ khóa';
      }
    }

    // ================================================
    // TRIGGER TYPE CHANGE (MỚI)
    // ================================================
    function onTriggerTypeChange() {
      const type = document.getElementById('triggerType').value;
      const keywordsGroup = document.getElementById('keywordsGroup');
      const hint = document.getElementById('triggerTypeHint');

      if (type === 'keyword') {
        keywordsGroup.style.display = 'block';
        hint.textContent = 'Kích hoạt khi tin nhắn chứa từ khóa bên dưới';
      } else if (type === 'any_message') {
        keywordsGroup.style.display = 'none';
        hint.textContent = '💬 Kích hoạt với TẤT CẢ tin nhắn (text, sticker, ...)';
      } else if (type === 'any_file') {
        keywordsGroup.style.display = 'none';
        hint.textContent = '📎 Kích hoạt khi nhận File hoặc Ảnh';
      }
    }

    // ================================================
    // SCOPE CHANGE
    // ================================================
    function onScopeChange() {
      const scope = parseInt(document.getElementById('triggerScope').value);
      const g = document.getElementById('friendsSelectorGroup');
      if (scope === 2 || scope === 3) {
        g.style.display = 'block';
        document.getElementById('friendsSelectorLabel').textContent = scope === 2 ? 'Chọn bạn bè sẽ nhận' : 'Chọn bạn bè sẽ KHÔNG nhận';
        renderFriendsSelector();
      }
      else { g.style.display = 'none'; }
    }

    function renderFriendsSelector() {
      const c = document.getElementById('friendsSelector');
      if (friendsList.length === 0) { c.innerHTML = '<div class="friends-selector-loading">Không có bạn bè<br><button onclick="ws.send(JSON.stringify({type:\'get_friends\'}))">🔄 Tải lại</button></div>'; return; }
      c.innerHTML = '<div class="friends-search-box"><input type="text" placeholder="🔍 Tìm kiếm..." oninput="filterFriends(this.value)"></div><div id="friendsListContainer">' + friendsList.map(f => '<label class="friend-checkbox-item"><input type="checkbox" value="' + f.userId + '" ' + (selectedFriendUids.includes(f.userId) ? 'checked' : '') + ' onchange="onFriendCheck(this)"><img src="' + (f.avatar || 'https://via.placeholder.com/36') + '" onerror="this.src=\'https://via.placeholder.com/36\'"><div class="friend-checkbox-info"><div class="friend-checkbox-name">' + escapeHtml(f.displayName) + '</div><div class="friend-checkbox-uid">' + f.userId + '</div></div></label>').join('') + '</div>';
      updateSelectedSummary();
    }

    function filterFriends(q) { const lq = q.toLowerCase(); document.querySelectorAll('#friendsListContainer .friend-checkbox-item').forEach(e => { const n = e.querySelector('.friend-checkbox-name')?.textContent.toLowerCase() || ''; e.style.display = n.includes(lq) ? 'flex' : 'none'; }); }
    function onFriendCheck(cb) { if (cb.checked) { if (!selectedFriendUids.includes(cb.value)) selectedFriendUids.push(cb.value); } else { selectedFriendUids = selectedFriendUids.filter(u => u !== cb.value); } updateSelectedSummary(); }
    function updateSelectedSummary() { const s = document.getElementById('selectedFriendsSummary'); if (selectedFriendUids.length > 0) { s.style.display = 'block'; document.getElementById('selectedFriendsCount').textContent = selectedFriendUids.length; } else { s.style.display = 'none'; } }

    // ================================================
    // MODAL FUNCTIONS
    // ================================================
    function showNewTriggerModal() {
      editingTriggerId = null; selectedFriendUids = [];
      document.getElementById('modalTitle').textContent = 'Tạo Trigger Mới';
      document.getElementById('triggerName').value = '';
      document.getElementById('triggerType').value = 'keyword';  // MỚI: reset loại trigger
      document.getElementById('triggerKeywords').value = '';
      document.getElementById('triggerResponse').value = '';
      document.getElementById('triggerEnabled').checked = true;
      document.getElementById('triggerStartTime').value = '00:00';
      document.getElementById('triggerEndTime').value = '23:59';
      document.getElementById('triggerDateStart').value = '';
      document.getElementById('triggerDateEnd').value = '';
      document.getElementById('triggerScope').value = '0';
      document.getElementById('friendsSelectorGroup').style.display = 'none';
      document.getElementById('triggerCooldown').value = '30';
      document.getElementById('triggerMode').value = '0';
      document.getElementById('keywordsGroup').style.display = 'block';  // MỚI: hiện lại field keywords
      onTriggerTypeChange();  // MỚI
      onModeChange();
      document.getElementById('saveBtn').textContent = '💾 Lưu';
      document.getElementById('triggerModal').classList.add('show');
    }

    function editTrigger(id) {
      const t = triggers.find(x => x.id === id); if (!t) return;
      editingTriggerId = id; selectedFriendUids = t.uids ? [...t.uids] : [];
      document.getElementById('modalTitle').textContent = 'Chỉnh sửa Trigger';
      document.getElementById('triggerName').value = t.name;
      document.getElementById('triggerType').value = t.triggerType || 'keyword';  // MỚI: load loại trigger
      document.getElementById('triggerKeywords').value = t.keywords.join(', ');
      document.getElementById('triggerResponse').value = t.response;
      document.getElementById('triggerEnabled').checked = t.enabled;
      document.getElementById('triggerStartTime').value = t.schedule.startTime;
      document.getElementById('triggerEndTime').value = t.schedule.endTime;
      document.getElementById('triggerDateStart').value = t.dateStart || '';
      document.getElementById('triggerDateEnd').value = t.dateEnd || '';
      document.getElementById('triggerScope').value = t.scope.toString();
      document.getElementById('triggerCooldown').value = Math.floor(t.cooldown / 1000);
      document.getElementById('triggerMode').value = t.setMode.toString();
      onTriggerTypeChange();  // MỚI: cập nhật UI theo loại trigger
      onModeChange();
      onScopeChange();
      document.getElementById('saveBtn').textContent = '💾 Cập nhật';
      document.getElementById('triggerModal').classList.add('show');
    }

    function editCurrentTrigger() { if (currentTriggerId) editTrigger(currentTriggerId); }
    function hideTriggerModal() { document.getElementById('triggerModal').classList.remove('show'); editingTriggerId = null; selectedFriendUids = []; document.getElementById('emojiPickerContainer').classList.remove('show'); }

    function saveTrigger() {
      const name = document.getElementById('triggerName').value.trim();
      const triggerType = document.getElementById('triggerType').value;  // MỚI
      const kw = document.getElementById('triggerKeywords').value.trim().split(',').map(k => k.trim().toLowerCase()).filter(k => k);
      const resp = document.getElementById('triggerResponse').value.trim();
      const scope = parseInt(document.getElementById('triggerScope').value);
      const setMode = parseInt(document.getElementById('triggerMode').value);

      if (!name) { showToast('❌ Nhập tên!', 'error'); return; }
      // MỚI: Chỉ validate từ khóa khi loại = keyword
      if (triggerType === 'keyword' && kw.length === 0) { showToast('❌ Nhập từ khóa!', 'error'); return; }
      if (setMode === 0 && !resp) { showToast('❌ Nhập nội dung trả lời!', 'error'); return; }
      if ((scope === 2 || scope === 3) && selectedFriendUids.length === 0) { showToast('❌ Chọn bạn bè!', 'error'); return; }
      if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('❌ Chưa kết nối!', 'error'); return; }

      const data = {
        triggerName: name,
        triggerType: triggerType,  // MỚI: loại trigger (keyword / any_message / any_file)
        triggerKey: triggerType === 'keyword' ? kw.join(',') : '',  // MỚI: chỉ lưu key khi loại = keyword
        triggerContent: setMode === 0 ? resp : '',
        timeStartActive: document.getElementById('triggerStartTime').value || '00:00',
        timeEndActive: document.getElementById('triggerEndTime').value || '23:59',
        dateStartActive: document.getElementById('triggerDateStart').value || null,
        dateEndActive: document.getElementById('triggerDateEnd').value || null,
        scope: scope,
        uids: (scope === 2 || scope === 3) ? selectedFriendUids : null,
        cooldown: (parseInt(document.getElementById('triggerCooldown').value) || 30) * 1000,
        enabled: document.getElementById('triggerEnabled').checked,
        setMode: setMode
      };

      if (editingTriggerId) {
        data.id = editingTriggerId;
        data.triggerID = editingTriggerId;
        ws.send(JSON.stringify({ type: 'update_trigger', trigger: data }));
      }
      else {
        ws.send(JSON.stringify({ type: 'create_trigger', trigger: data }));
      }
      hideTriggerModal();
    }

    // ================================================
    // DELETE MODAL
    // ================================================
    function showDeleteModal() { if (currentTriggerId) showDeleteModalFor(currentTriggerId); }
    function showDeleteModalFor(id) {
      const t = triggers.find(x => x.id === id); if (!t) return;
      deleteTargetId = id;
      document.getElementById('deleteTriggerName').textContent = t.name;
      document.getElementById('deleteModal').classList.add('show');
    }
    function hideDeleteModal() { document.getElementById('deleteModal').classList.remove('show'); deleteTargetId = null; }
    function confirmDelete() {
      if (!deleteTargetId || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'delete_trigger', id: deleteTargetId }));
      hideDeleteModal();
    }

    function duplicateCurrentTrigger() {
      if (!currentTriggerId) return;
      const t = triggers.find(x => x.id === currentTriggerId);
      if (!t) return;
      editingTriggerId = null;
      selectedFriendUids = t.uids ? [...t.uids] : [];
      document.getElementById('modalTitle').textContent = 'Nhân bản';
      document.getElementById('triggerName').value = t.name + ' (Copy)';
      document.getElementById('triggerKeywords').value = t.keywords.join(', ');
      document.getElementById('triggerResponse').value = t.response;
      document.getElementById('triggerEnabled').checked = false;
      document.getElementById('triggerScope').value = t.scope.toString();
      document.getElementById('triggerMode').value = t.setMode.toString();
      onModeChange();
      onScopeChange();
      document.getElementById('saveBtn').textContent = '💾 Tạo bản sao';
      document.getElementById('triggerModal').classList.add('show');
    }

    function toggleTriggerStatus(id) { if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'toggle_trigger', id: id })); }
    function searchTriggers() { const q = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.trigger-item-compact').forEach(e => { const n = e.querySelector('.trigger-name-small')?.textContent.toLowerCase() || ''; const k = e.querySelector('.trigger-keywords-preview')?.textContent.toLowerCase() || ''; e.style.display = (n.includes(q) || k.includes(q)) ? 'block' : 'none'; }); }

    // ================================================
    // ACTIVITY WINDOW
    // ================================================
    function openActivityWindow() {
      document.getElementById('activityBackdrop').classList.add('show');
      document.getElementById('activityWindow').classList.add('show');
      activityCount = 0; updateActivityBadge();
      if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'get_activity_logs', limit: 100 }));
    }
    function closeActivityWindow() {
      document.getElementById('activityBackdrop').classList.remove('show');
      document.getElementById('activityWindow').classList.remove('show');
    }
    function updateActivityBadge() {
      const b = document.getElementById('activityBadge');
      if (activityCount > 0) { b.textContent = activityCount > 99 ? '99+' : activityCount; b.style.display = 'block'; }
      else { b.style.display = 'none'; }
    }
    function clearActivityLogs() { if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'clear_activity_logs' })); }
    function renderActivityList() {
      const c = document.getElementById('activityList');
      if (activityLogs.length === 0) { c.innerHTML = '<div class="activity-empty">📋 Chưa có hoạt động<br><small style="color:#aaa;">Lịch sử sẽ hiển thị khi bạn tạo/sửa/xóa trigger</small></div>'; return; }
      c.innerHTML = activityLogs.map(log => {
        const icons = { CREATE: '➕', UPDATE: '✏️', DELETE: '🗑️', ENABLE: '✅', DISABLE: '⏸️', AUTO_REPLY: '🤖' };
        const actionTexts = { CREATE: 'Tạo mới', UPDATE: 'Cập nhật', DELETE: 'Xóa', ENABLE: 'Bật', DISABLE: 'Tắt', AUTO_REPLY: 'Auto Reply' };
        const action = log.action || 'UNKNOWN';
        return '<div class="activity-item"><div class="activity-icon ' + action.toLowerCase() + '">' + (icons[action] || '📋') + '</div><div class="activity-info"><div class="activity-action">' + (actionTexts[action] || action) + '</div><div class="activity-trigger">' + escapeHtml(log.triggerName || log.trigger?.triggerName || 'N/A') + '</div><div class="activity-time">' + formatDateTime(log.timestamp) + '</div></div></div>';
      }).join('');
    }

    // ================================================
    // INIT================================================
    // INIT
    // ================================================
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('triggerModal').addEventListener('click', (e) => { if (e.target.id === 'triggerModal') hideTriggerModal(); });
      connectWebSocket();
    });
  </script>
  <script src="assets/auto-reconnect.js"></script>
  <!-- AUTO FILE MODAL -->
  <div class="modal-overlay" id="autoFileModal" style="display:none; z-index:10002;">
    <div class="modal" style="width:500px; max-width:90%;">
      <div class="modal-header">
        <h3>⚙️ Cài đặt Nhận diện file</h3><button class="modal-close" onclick="hideAutoFileModal()">✕</button>
      </div>
      <div class="modal-body">
        <div style="background:#e3f2fd; border:1px solid #90caf9; padding:12px; border-radius:8px; margin-bottom:16px;">
          <h4 style="margin:0 0 8px 0; color:#1565c0; font-size:14px;">ℹ️ Hướng dẫn</h4>
          <p style="margin:0; font-size:12px; line-height:1.5; color:#333;">
            Tự động trả lời khi nhận được file hoặc ảnh. Bạn có thể cấu hình trả lời riêng cho từng loại file.<br><br>
            <strong>Cú pháp cấu hình (mỗi dòng một loại):</strong><br>
            <code
              style="background:white; padding:2px 4px; border-radius:4px;">xlsx: Nội dung trả lời cho excel</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">pdf: Nội dung trả lời cho pdf</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">image: Nội dung khi nhận ảnh</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">default: Nội dung mặc định</code><br>
          <div style="margin-top:8px;">
            <strong>Biến hỗ trợ:</strong>
            <code style="color:#e91e63;">{name}</code>,
            <code style="color:#e91e63;">{ext}</code>,
            <code style="color:#e91e63;">{content}</code> (Đọc nội dung file Excel),
            <code style="color:#e91e63;">{print}</code> (In PDF, Ảnh, Word, Excel),
            <code style="color:#e91e63;">{confirm_print}</code> (Hỏi trước khi in)
          </div>
          </p>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="autoFileEnabled" style="width:18px; height:18px; margin-right:8px;">
            <span style="font-weight:600;">Bật tính năng này</span>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label">Nội dung trả lời</label>
          <textarea class="form-input" id="autoFileResponse" rows="8"
            placeholder="xlsx: Bạn đã gửi file Excel...&#10;pdf: Bạn đã gửi file PDF...&#10;default: Đã nhận được file"></textarea>
          <div class="trigger-keywords-preview" style="margin-top:6px;">Trả lời khác nhau tùy theo đuôi file nhận được.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAutoFileModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveAutoFileSetup()">Lưu cài đặt</button>
      </div>
    </div>
  </div>

  <!-- SELF TRIGGER MODAL - Enhanced UI -->
  <div class="modal-backdrop" id="selfTriggerModal" style="display:none; z-index:10001;">
    <div class="modal-box"
      style="max-width:850px; width:92%; border-radius:16px; box-shadow: 0 25px 80px rgba(0,0,0,0.25); border:none; overflow:hidden;">
      <div class="modal-header"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px 24px; border:none;">
        <h2 style="margin:0; font-size:20px; display:flex; align-items:center; gap:10px; color:#fff; font-weight:600;">
          <span style="font-size:28px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2));">⚡</span>
          Tự kích hoạt (Self-Trigger) - Đa Kịch Bản
        </h2>
      </div>
      <div class="modal-body" style="padding:24px; background:#fafbfc;">
        <div
          style="background:linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left:4px solid #ffc107; padding:16px 18px; margin-bottom:20px; border-radius:8px; box-shadow: 0 2px 8px rgba(255,193,7,0.15);">
          <div style="font-weight:700; color:#e65100; margin-bottom:6px; font-size:14px;">✨ Chức năng</div>
          <div style="font-size:13px; color:#5d4037; line-height:1.5;">
            Kích hoạt khi <strong style="color:#d84315;">BẠN (Me)</strong> nhắn tin bắt đầu bằng lệnh.
            Hệ thống ưu tiên khớp lệnh dài trước (VD: <code
              style="background:#fff3e0; padding:2px 6px; border-radius:4px; color:#e65100;">/hi 2</code> ưu tiên hơn
            <code style="background:#fff3e0; padding:2px 6px; border-radius:4px; color:#e65100;">/hi</code>).
          </div>
        </div>

        <label class="form-label"
          style="font-weight:600; font-size:14px; color:#37474f; margin-bottom:10px; display:block;">📋 Danh sách quy
          tắc (Rules)</label>
        <div
          style="max-height:350px; overflow-y:auto; border:1px solid #e0e0e0; margin-bottom:12px; border-radius:10px; background:#fff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);">
          <table class="table table-striped" style="margin-bottom:0; width:100%;">
            <thead
              style="position:sticky; top:0; background:linear-gradient(180deg, #f5f7fa 0%, #e8ecef 100%); z-index:1; border-bottom:2px solid #ddd;">
              <tr>
                <th style="width:22%; padding:12px 10px; font-size:12px; font-weight:600; color:#455a64;">🏷️ Lệnh</th>
                <th style="width:20%; padding:12px 10px; font-size:12px; font-weight:600; color:#455a64;">⚙️ Hành động
                </th>
                <th style="width:48%; padding:12px 10px; font-size:12px; font-weight:600; color:#455a64;">📝 Nội dung /
                  Flow</th>
                <th style="width:10%; padding:12px 10px;"></th>
              </tr>
            </thead>
            <tbody id="selfTriggerRulesBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm" onclick="addSelfTriggerRule()"
          style="background:linear-gradient(135deg, #43a047 0%, #2e7d32 100%); color:#fff; border:none; padding:8px 16px; border-radius:8px; font-weight:500; cursor:pointer; box-shadow: 0 3px 10px rgba(46,125,50,0.3); transition: all 0.2s ease;">
          ➕ Thêm quy tắc
        </button>

        <div class="form-group" style="margin-top:20px; padding-top:18px; border-top:1px solid #e0e0e0;">
          <label class="form-label" style="display:flex; align-items:center; gap:10px; font-size:14px; cursor:pointer;">
            <input type="checkbox" id="selfTriggerEnabled" style="width:18px; height:18px; accent-color:#667eea;">
            <span style="font-weight:500;">Kích hoạt tính năng này</span>
          </label>
        </div>

        <div
          style="margin-top:14px; font-size:12px; color:#78909c; background:#eceff1; padding:10px 14px; border-radius:6px;">
          💡 <strong>Lưu ý:</strong> Nếu chọn "Chạy Flow", hãy đảm bảo Flow đó đã được tạo và đang hoạt động.
        </div>
      </div>
      <div class="modal-footer"
        style="background:#f5f7fa; padding:16px 24px; border-top:1px solid #e0e0e0; display:flex; justify-content:flex-end; gap:12px;">
        <button class="btn btn-secondary" onclick="document.getElementById('selfTriggerModal').style.display='none'"
          style="padding:10px 20px; border-radius:8px; font-weight:500;">Hủy</button>
        <button class="btn btn-primary" onclick="saveSelfTriggerSetup()"
          style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; padding:10px 24px; border-radius:8px; font-weight:600; color:#fff; cursor:pointer; box-shadow: 0 4px 15px rgba(102,126,234,0.4); transition: all 0.2s ease;">
          💾 Lưu Cấu Hình
        </button>
      </div>
    </div>
  </div>

  <script>
    window.availableFlows = [];
    window.selfTriggerRules = [];

    window.showSelfTriggerModal = function () {
      if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        window.ws.send(JSON.stringify({ type: 'get_self_trigger' }));
        window.ws.send(JSON.stringify({ type: 'get_all_flows' }));
      }

      const trigger = builtInTriggers.selfTrigger;
      window.selfTriggerRules = [];

      try {
        const content = trigger.response || trigger.triggerContent || '{}';
        if (content.trim().startsWith('{')) {
          const config = JSON.parse(content);
          if (config.rules && Array.isArray(config.rules)) {
            window.selfTriggerRules = config.rules;
          } else if (config.command) {
            // Legacy Migration
            window.selfTriggerRules.push({
              command: config.command,
              type: (trigger.setMode === 1) ? 'flow' : 'text',
              value: (trigger.setMode === 1) ? trigger.triggerID : config.response // Warning: value for flow legacy is tricky, might need manual re-select
            });
            // Note: Legacy Flow Mode relied on triggerID->Flow mapping. 
            // New Flow Mode relies on direct FlowID. 
            // We might not have FlowID here easily. User might need to re-select.
          }
        } else if (content) {
          // Simple text legacy
          window.selfTriggerRules.push({
            command: '/test', // Default guess? or empty
            type: 'text',
            value: content
          });
        }
      } catch (e) { console.error('Error parsing self trigger:', e); }

      if (window.selfTriggerRules.length === 0) {
        window.selfTriggerRules.push({ command: '', type: 'text', value: '' });
      }

      document.getElementById('selfTriggerEnabled').checked = trigger.enabled;

      renderSelfTriggerRules();
      document.getElementById('selfTriggerModal').style.display = 'flex';
    };

    window.renderSelfTriggerRules = function () {
      const tbody = document.getElementById('selfTriggerRulesBody');
      tbody.innerHTML = '';
      window.selfTriggerRules.forEach((rule, index) => {
        const tr = document.createElement('tr');

        // Command Input
        const tdCmd = document.createElement('td');
        tdCmd.style.padding = '4px';
        const inputCmd = document.createElement('input');
        inputCmd.className = 'form-input';
        inputCmd.value = rule.command || '';
        inputCmd.placeholder = '/lenh';
        inputCmd.oninput = (e) => { rule.command = e.target.value; };
        tdCmd.appendChild(inputCmd);

        // Type Select
        const tdType = document.createElement('td');
        tdType.style.padding = '4px';
        const selectType = document.createElement('select');
        selectType.className = 'form-select';
        selectType.innerHTML = `<option value="text">💬 Trả lời Text</option><option value="flow">🔀 Chạy Flow</option>`;
        selectType.value = rule.type || 'text';
        selectType.onchange = (e) => {
          rule.type = e.target.value;
          // Reset value if type changed to avoid confusion? Or keep?
          // rule.value = ''; 
          renderSelfTriggerRules();
        };
        tdType.appendChild(selectType);

        // Value Input
        const tdVal = document.createElement('td');
        tdVal.style.padding = '4px';

        if (rule.type === 'flow') {
          const selectFlow = document.createElement('select');
          selectFlow.className = 'form-select';
          let options = '<option value="">-- Chọn Flow --</option>';
          (window.availableFlows || []).forEach(f => {
            const selected = (String(f.flowID) === String(rule.value)) ? 'selected' : '';
            options += `<option value="${f.flowID}" ${selected}>${f.flowName}</option>`;
          });
          selectFlow.innerHTML = options;
          selectFlow.onchange = (e) => { rule.value = e.target.value; };
          tdVal.appendChild(selectFlow);
        } else {
          const inputText = document.createElement('input');
          inputText.className = 'form-input';
          inputText.value = rule.value || '';
          inputText.placeholder = 'Nội dung tin nhắn...';
          inputText.oninput = (e) => { rule.value = e.target.value; };
          tdVal.appendChild(inputText);
        }

        // Delete
        const tdDel = document.createElement('td');
        tdDel.style.textAlign = 'center';
        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-sm';
        btnDel.style.color = '#f44336';
        btnDel.innerHTML = '🗑️';
        btnDel.onclick = () => {
          window.selfTriggerRules.splice(index, 1);
          renderSelfTriggerRules();
        };
        tdDel.appendChild(btnDel);

        tr.appendChild(tdCmd);
        tr.appendChild(tdType);
        tr.appendChild(tdVal);
        tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
    };

    window.addSelfTriggerRule = function () {
      window.selfTriggerRules.push({ command: '', type: 'text', value: '' });
      renderSelfTriggerRules();
    };

    window.saveSelfTriggerSetup = function () {
      const en = document.getElementById('selfTriggerEnabled').checked;

      // Filter empty rules
      const validRules = window.selfTriggerRules.filter(r => r.command && r.command.trim() !== '');

      const config = {
        rules: validRules
      };

      const jsonContent = JSON.stringify(config);

      // Update Local
      builtInTriggers.selfTrigger.response = jsonContent;
      builtInTriggers.selfTrigger.enabled = en;

      if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        window.ws.send(JSON.stringify({
          type: 'set_self_trigger',
          config: {
            triggerContent: jsonContent,
            enabled: en,
            setMode: 0 // New Logic handles mode internally per rule
          }
        }));
        if (typeof showToast === 'function') showToast('✅ Đã lưu Cấu hình Self Trigger', 'success');
      } else {
        if (typeof showToast === 'function') showToast('❌ Mất kết nối WebSocket', 'error');
      }

      document.getElementById('selfTriggerModal').style.display = 'none';
      if (window.renderTriggerList) window.renderTriggerList();
    };

    if (typeof window.openFlowBuilder !== 'function') {
      window.openFlowBuilder = function (triggerId) {
        window.open('flow-builder.html?triggerId=' + triggerId, '_blank');
      };
    }

    // ================================================
    // AI CONVERSATION SETUP
    // ================================================
    let aiConfigsCache = [];

    function showAIConversationSetup() {
      const trigger = builtInTriggers.aiConversation;

      // Request AI configs from server
      ws.send(JSON.stringify({ type: 'get_ai_configs' }));

      // Populate form with current values
      document.getElementById('aiConvEnabled').checked = trigger.enabled;
      document.getElementById('aiConvCommandOn').value = trigger.commandOn || '/ai';
      document.getElementById('aiConvCommandOff').value = trigger.commandOff || '/ai-off';
      document.getElementById('aiConvSystemPrompt').value = trigger.systemPrompt || '';
      document.getElementById('aiConvTimeout').value = trigger.timeoutMinutes || 30;
      document.getElementById('aiConvTimeoutMsg').value = trigger.timeoutMessage || '';
      document.getElementById('aiConvSaveHistory').checked = trigger.saveHistory !== false;

      // Show modal
      document.getElementById('aiConversationModal').style.display = 'flex';

      // Will populate AI config dropdown when response arrives
    }

    function hideAIConversationModal() {
      document.getElementById('aiConversationModal').style.display = 'none';
    }

    function saveAIConversationSetup() {
      const configId = parseInt(document.getElementById('aiConvConfigId').value);
      const commandOn = document.getElementById('aiConvCommandOn').value.trim();
      const commandOff = document.getElementById('aiConvCommandOff').value.trim();
      const systemPrompt = document.getElementById('aiConvSystemPrompt').value.trim();
      const timeoutMinutes = parseInt(document.getElementById('aiConvTimeout').value) || 30;
      const timeoutMessage = document.getElementById('aiConvTimeoutMsg').value.trim();
      const saveHistory = document.getElementById('aiConvSaveHistory').checked;
      const enabled = document.getElementById('aiConvEnabled').checked;

      if (!configId && enabled) {
        showToast('⚠️ Vui lòng chọn AI Config!', 'warning');
        return;
      }

      if ((!commandOn || !commandOff) && enabled) {
        showToast('⚠️ Vui lòng nhập lệnh bật/tắt!', 'warning');
        return;
      }

      if (!currentUser?.uid) {
        showToast('❌ Chưa đăng nhập!', 'error');
        return;
      }

      // Update state
      builtInTriggers.aiConversation.configId = configId;
      builtInTriggers.aiConversation.commandOn = commandOn;
      builtInTriggers.aiConversation.commandOff = commandOff;
      builtInTriggers.aiConversation.systemPrompt = systemPrompt;
      builtInTriggers.aiConversation.timeoutMinutes = timeoutMinutes;
      builtInTriggers.aiConversation.timeoutMessage = timeoutMessage;
      builtInTriggers.aiConversation.saveHistory = saveHistory;
      builtInTriggers.aiConversation.enabled = enabled;

      // Save to database via WebSocket
      ws.send(JSON.stringify({
        type: 'save_builtin_trigger_state',
        userUID: currentUser.uid,
        triggerKey: 'builtin_ai_conversation',
        stateData: {
          configId,
          commandOn,
          commandOff,
          systemPrompt,
          timeoutMinutes,
          timeoutMessage,
          saveHistory,
          enabled
        }
      }));

      // Hide modal and update UI
      hideAIConversationModal();
      renderTriggerList();
      showToast('✅ Đã lưu cài đặt AI Conversation!', 'success');
    }

    function populateAIConfigDropdown(configs) {
      aiConfigsCache = configs || [];
      const select = document.getElementById('aiConvConfigId');
      if (!select) return;

      const currentConfigId = builtInTriggers.aiConversation.configId;

      select.innerHTML = '<option value="">-- Chọn AI Config --</option>' +
        configs.map(cfg =>
          `<option value="${cfg.id || cfg.configID}" ${(cfg.id === currentConfigId || cfg.configID === currentConfigId) ? 'selected' : ''}>${escapeHtml(cfg.name)} (${cfg.model})</option>`
        ).join('');
    }
  </script>

  <!-- AI CONVERSATION MODAL -->
  <div class="modal-overlay" id="aiConversationModal" style="display:none; z-index:10002;">
    <div class="modal" style="width:600px; max-width:90%;">
      <div class="modal-header">
        <h3>🤖 Cài đặt AI Conversation</h3>
        <button class="modal-close" onclick="hideAIConversationModal()">✕</button>
      </div>
      <div class="modal-body">
        <div style="background:#e3f2fd; border:1px solid #90caf9; padding:12px; border-radius:8px; margin-bottom:16px;">
          <h4 style="margin:0 0 8px 0; color:#1565c0; font-size:14px;">ℹ️ Hướng dẫn</h4>
          <p style="margin:0; font-size:12px; line-height:1.6; color:#333;">
            Trò chuyện liên tục với AI. User gửi lệnh → AI mode bật → Mọi tin nhắn tiếp theo được AI trả lời tự động.<br><br>
            <strong>Tự set lệnh điều khiển:</strong> Bạn có thể đặt bất kỳ lệnh nào (/ai, /chat, /bot, v.v.)<br>
            <strong>Timeout:</strong> Tự động tắt sau X phút không nhận tin nhắn
          </p>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="aiConvEnabled" style="width:18px; height:18px; margin-right:8px;">
            <span style="font-weight:600;">Bật tính năng này</span>
          </label>
        </div>

        <div class="form-row" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group" style="margin:0;">
            <label class="form-label">Lệnh BẬT AI <span style="color:red;">*</span></label>
            <input type="text" class="form-input" id="aiConvCommandOn" placeholder="/ai" value="/ai">
            <div class="trigger-keywords-preview" style="margin-top:6px; font-size:11px;">User gửi lệnh này → Bật AI mode</div>
          </div>
          <div class="form-group" style="margin:0;">
            <label class="form-label">Lệnh TẮT AI <span style="color:red;">*</span></label>
            <input type="text" class="form-input" id="aiConvCommandOff" placeholder="/ai-off" value="/ai-off">
            <div class="trigger-keywords-preview" style="margin-top:6px; font-size:11px;">User gửi lệnh này → Tắt AI mode</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Chọn AI Config <span style="color:red;">*</span></label>
          <select class="form-input" id="aiConvConfigId">
            <option value="">-- Chọn AI config --</option>
          </select>
          <div class="trigger-keywords-preview" style="margin-top:6px;">
            Cấu hình AI từ <a href="/ai-manager.html" target="_blank" style="color:#667eea;">AI Models Manager</a>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">System Prompt</label>
          <textarea class="form-input" id="aiConvSystemPrompt" rows="4"
            placeholder="Bạn là trợ lý AI thân thiện. Trả lời ngắn gọn và hữu ích."></textarea>
          <div class="trigger-keywords-preview" style="margin-top:6px;">Định nghĩa cách AI sẽ trả lời</div>
        </div>

        <div class="form-group">
          <label class="form-label">Timeout (phút)</label>
          <input type="number" class="form-input" id="aiConvTimeout" value="30" min="1" max="1440">
          <div class="trigger-keywords-preview" style="margin-top:6px;">Tự động tắt AI mode sau X phút không chat</div>
        </div>

        <div class="form-group">
          <label class="form-label">Tin nhắn khi timeout</label>
          <input type="text" class="form-input" id="aiConvTimeoutMsg"
            placeholder="Hết thời gian. Gửi /ai để tiếp tục!">
          <div class="trigger-keywords-preview" style="margin-top:6px;">Thông báo khi AI mode tự động tắt</div>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="aiConvSaveHistory" style="width:18px; height:18px; margin-right:8px;" checked>
            <span style="font-weight:500;">Lưu lịch sử hội thoại (20 tin nhắn cuối)</span>
          </label>
          <div class="trigger-keywords-preview" style="margin-top:6px;">AI sẽ nhớ ngữ cảnh cuộc trò chuyện</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAIConversationModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveAIConversationSetup()">Lưu cài đặt</button>
      </div>
    </div>
  </div>

</body>

</html>