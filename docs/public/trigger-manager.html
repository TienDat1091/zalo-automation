<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zalo Trigger Manager</title>
  <link rel="stylesheet" href="assets/style_trigger_manager.css" />
  <style>
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #f44336;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .notification-btn {
      position: relative;
    }

    .user-info-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 20px;
      padding: 8px 12px;
      background: #f5f7fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-uid {
      font-size: 10px;
      color: #999;
      font-family: monospace;
    }

    .user-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: #e8f5e9;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: #2e7d32;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .trigger-item-compact {
      padding: 10px 12px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      background: #fff;
    }

    .trigger-item-compact:hover {
      background: #f5f7fa;
      border-color: #e0e0e0;
    }

    .trigger-item-compact.active {
      background: #e3f2fd;
      border-color: #0084ff;
    }

    .trigger-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .trigger-main-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .trigger-icon-small {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      background: #e3f2fd;
    }

    .trigger-name-small {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trigger-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .trigger-item-compact:hover .trigger-actions {
      opacity: 1;
    }

    .action-icon {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }

    .action-icon:hover {
      background: #e0e0e0;
    }

    .trigger-keywords-preview {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .trigger-time-created {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
    }

    .db-badge {
      background: #4caf50;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }

    .flow-badge {
      background: #9c27b0;
      color: white;
      font-size: 9px;
      padding: 2px 5px;
      border-radius: 4px;
      margin-left: 4px;
    }

    .friends-selector {
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .friends-selector-loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }

    .friend-checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
    }

    .friend-checkbox-item:hover {
      background: #f5f7fa;
    }

    .friend-checkbox-item:last-child {
      border-bottom: none;
    }

    .friend-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .friend-checkbox-item img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .friend-checkbox-info {
      flex: 1;
    }

    .friend-checkbox-name {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    .friend-checkbox-uid {
      font-size: 10px;
      color: #999;
      font-family: monospace;
    }

    .selected-friends-summary {
      margin-top: 8px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 12px;
      color: #1976d2;
    }

    .friends-search-box {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    .friends-search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .response-input-wrapper {
      position: relative;
    }

    .emoji-btn {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .emoji-btn:hover {
      background: #f0f0f0;
    }

    .emoji-picker-container {
      position: absolute;
      bottom: 45px;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      width: 280px;
      display: none;
    }

    .emoji-picker-container.show {
      display: block;
    }

    .emoji-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      flex-wrap: wrap;
    }

    .emoji-tab {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .emoji-tab:hover {
      background: #f0f0f0;
    }

    .emoji-tab.active {
      background: #e3f2fd;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      max-height: 150px;
      overflow-y: auto;
    }

    .emoji-item {
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      text-align: center;
    }

    .emoji-item:hover {
      background: #f0f0f0;
    }

    .delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .delete-modal.show {
      display: flex;
    }

    .delete-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      text-align: center;
    }

    .delete-modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .delete-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .delete-modal-text {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .delete-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .delete-modal-actions button {
      padding: 10px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .delete-modal-cancel {
      background: #f0f0f0;
      border: none;
      color: #333;
    }

    .delete-modal-confirm {
      background: #f44336;
      border: none;
      color: white;
    }

    .activity-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9998;
      display: none;
    }

    .activity-backdrop.show {
      display: block;
    }

    .activity-window {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      max-height: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
    }

    .activity-window.show {
      display: block;
    }

    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #eee;
    }

    .activity-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .activity-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .activity-list {
      max-height: 500px;
      overflow-y: auto;
      padding: 12px;
    }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f9f9f9;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .activity-icon.create {
      background: #e8f5e9;
    }

    .activity-icon.update {
      background: #e3f2fd;
    }

    .activity-icon.delete {
      background: #ffebee;
    }

    .activity-info {
      flex: 1;
    }

    .activity-action {
      font-size: 13px;
      font-weight: 600;
    }

    .activity-trigger {
      font-size: 12px;
      color: #666;
    }

    .activity-time {
      font-size: 11px;
      color: #999;
    }

    .activity-empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .mode-hint {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      padding: 8px;
      background: #f5f7fa;
      border-radius: 4px;
    }

    .mode-hint.flow {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    /* Built-in trigger modals */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-box {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-left">
      <div class="header-title"><span class="icon">ü§ñ</span><span>Bot-Auto</span></div>
      <div class="user-info-panel" id="userInfoPanel" style="display:none;">
        <div class="user-avatar" id="userAvatar">üë§</div>
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-uid" id="userUID">UID: -</div>
        </div>
        <div class="user-status" id="userStatus"><span class="status-dot"></span><span class="status-text">Online</span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="auto-reply-toggle-container" id="autoReplyToggleContainer">
        <span class="toggle-label"><span>ü§ñ</span><span>Auto Reply</span></span>
        <label class="toggle-switch"><input type="checkbox" id="autoReplyToggle" onchange="toggleAutoReply()"
            disabled><span class="toggle-slider"></span></label>
        <span class="toggle-status loading" id="autoReplyStatus">...</span>
      </div>
      <button class="header-btn notification-btn" onclick="openActivityWindow()">
        <span>üìã</span><span>L·ªãch s·ª≠</span>
        <span class="notification-badge" id="activityBadge" style="display:none;">0</span>
      </button>
      <a href="unified-manager.html" target="_blank" rel="noopener noreferrer" class="header-btn">
        <span>üìä</span>
        <span>Data Manager</span>
      </a>
      <a href="dashboard.html" target="_blank" rel="noopener noreferrer" class="header-btn">
        <span>üè†</span>
        <span>Dashboard</span>
      </a>
      <!-- <button class="header-btn primary" onclick="showNewTriggerModal()"><span>‚ûï</span><span>T·∫°o Trigger</span></button> -->
    </div>
  </div>

  <div class="main-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Danh s√°ch Trigger (<span id="triggerCount">0</span>)</h3>
        <div class="search-box"><span class="search-icon">üîç</span><input type="text" placeholder="T√¨m ki·∫øm..."
            id="searchInput" oninput="searchTriggers()"></div>
      </div>
      <div class="trigger-list" id="triggerList">
        <div style="text-align:center; padding:40px; color:#999;">üìã ƒêang t·∫£i...</div>
      </div>
    </div>
    <div class="canvas-area">
      <div class="canvas-header">
        <div class="canvas-title">
          <h2 id="canvasTitle">Ch·ªçn m·ªôt trigger</h2>
          <span class="badge" id="canvasBadge" style="display:none;"></span>
          <span class="flow-badge" id="canvasFlowBadge" style="display:none;">FLOW</span>
        </div>
        <div class="canvas-actions" id="canvasActions" style="display:none;">
          <button class="header-btn" onclick="editCurrentTrigger()"><span>‚úèÔ∏è</span><span>S·ª≠a</span></button>
          <button class="header-btn" onclick="openTriggerBuilder()" id="btnOpenBuilder"
            style="display:none;"><span>‚öôÔ∏è</span><span>Flow Builder</span></button>
          <button class="header-btn" onclick="duplicateCurrentTrigger()"><span>üìã</span><span>Nh√¢n b·∫£n</span></button>
          <button class="header-btn btn-danger" onclick="showDeleteModal()"><span>üóëÔ∏è</span><span>X√≥a</span></button>
        </div>
      </div>
      <div class="canvas-content" id="canvasContent">
        <div class="empty-state">
          <div class="icon">üéØ</div>
          <h3>Ch·ªçn trigger ƒë·ªÉ xem chi ti·∫øt</h3><button class="btn btn-primary" onclick="showNewTriggerModal()">‚ûï T·∫°o
            m·ªõi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TRIGGER MODAL -->
  <div class="modal-overlay" id="triggerModal">
    <div class="modal" style="max-width:600px;">
      <div class="modal-header">
        <h3 id="modalTitle">T·∫°o Trigger M·ªõi</h3><button class="modal-close" onclick="hideTriggerModal()">‚úï</button>
      </div>
      <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
        <div class="form-group"><label class="form-label">T√™n trigger *</label><input type="text" class="form-input"
            id="triggerName" placeholder="VD: H·ªèi gi√° s·∫£n ph·∫©m"></div>

        <!-- Lo·∫°i trigger (M·ªöI) -->
        <div class="form-group">
          <label class="form-label">üéØ Lo·∫°i trigger</label>
          <select class="form-input" id="triggerType" onchange="onTriggerTypeChange()">
            <option value="keyword">üìù T·ª´ kh√≥a (keyword)</option>
            <option value="any_message">üí¨ Tin nh·∫Øn b·∫•t k√¨</option>
            <option value="any_file">üìé File/·∫¢nh b·∫•t k√¨</option>
          </select>
          <div class="mode-hint" id="triggerTypeHint">K√≠ch ho·∫°t khi tin nh·∫Øn ch·ª©a t·ª´ kh√≥a b√™n d∆∞·ªõi</div>
        </div>

        <!-- T·ª´ kh√≥a (·∫©n khi ch·ªçn any_message ho·∫∑c any_file) -->
        <div class="form-group" id="keywordsGroup"><label class="form-label">T·ª´ kh√≥a *</label><input type="text"
            class="form-input" id="triggerKeywords" placeholder="VD: gi√°, b√°o gi√° (ph√¢n c√°ch d·∫•u ph·∫©y)"></div>

        <!-- Ch·∫ø ƒë·ªô ch·∫°y -->
        <div class="form-group">
          <label class="form-label">üöÄ Ch·∫ø ƒë·ªô ch·∫°y</label>
          <select class="form-input" id="triggerMode" onchange="onModeChange()">
            <option value="0">‚ö° G·ª≠i tr·ª±c ti·∫øp</option>
            <option value="1">üîÑ Ch·∫°y theo quy tr√¨nh (Flow)</option>
          </select>
          <div class="mode-hint" id="modeHint">Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c g·ª≠i ngay l·∫≠p t·ª©c khi kh·ªõp t·ª´ kh√≥a</div>
        </div>

        <!-- N·ªôi dung tr·∫£ l·ªùi (ch·ªâ hi·ªán khi mode = 0) -->
        <div class="form-group" id="responseGroup">
          <label class="form-label">üí¨ N·ªôi dung tr·∫£ l·ªùi *</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="triggerResponse" rows="4" placeholder="N·ªôi dung auto-reply"></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPicker(event)">üòä</button>
            <div class="emoji-picker-container" id="emojiPickerContainer">
              <div class="emoji-tabs" id="emojiTabs"></div>
              <div class="emoji-grid" id="emojiGrid"></div>
            </div>
          </div>
        </div>

        <!-- L·ªãch ho·∫°t ƒë·ªông - Gi·ªù -->
        <div class="form-group">
          <label class="form-label">‚è∞ Th·ªùi gian ho·∫°t ƒë·ªông</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:11px; color:#666;">T·ª´ gi·ªù</label><input type="time" class="form-input"
                id="triggerStartTime" value="00:00"></div>
            <div><label style="font-size:11px; color:#666;">ƒê·∫øn gi·ªù</label><input type="time" class="form-input"
                id="triggerEndTime" value="23:59"></div>
          </div>
        </div>

        <!-- L·ªãch ho·∫°t ƒë·ªông - Ng√†y -->
        <div class="form-group">
          <label class="form-label">üìÖ Ng√†y ho·∫°t ƒë·ªông (t√πy ch·ªçn)</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:11px; color:#666;">T·ª´ ng√†y</label><input type="date" class="form-input"
                id="triggerDateStart"></div>
            <div><label style="font-size:11px; color:#666;">ƒê·∫øn ng√†y</label><input type="date" class="form-input"
                id="triggerDateEnd"></div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën ho·∫°t ƒë·ªông m·ªçi ng√†y</div>
        </div>

        <!-- Scope -->
        <div class="form-group">
          <label class="form-label">üë• √Åp d·ª•ng cho (Scope)</label>
          <select class="form-input" id="triggerScope" onchange="onScopeChange()">
            <option value="0">T·∫•t c·∫£ m·ªçi ng∆∞·ªùi (Everyone)</option>
            <option value="1">Ch·ªâ ng∆∞·ªùi l·∫° (Stranger)</option>
            <option value="2">B·∫°n b√® c·ª• th·ªÉ (SpecificFriends)</option>
            <option value="3">T·∫•t c·∫£ tr·ª´ m·ªôt s·ªë ng∆∞·ªùi (FriendsExcept)</option>
          </select>
        </div>

        <!-- Friends Selector -->
        <div class="form-group" id="friendsSelectorGroup" style="display:none;">
          <label class="form-label" id="friendsSelectorLabel">Ch·ªçn b·∫°n b√®</label>
          <div class="friends-selector" id="friendsSelector">
            <div class="friends-selector-loading">ƒêang t·∫£i...</div>
          </div>
          <div class="selected-friends-summary" id="selectedFriendsSummary" style="display:none;">ƒê√£ ch·ªçn: <span
              id="selectedFriendsCount">0</span> ng∆∞·ªùi</div>
        </div>

        <div class="form-group"><label class="form-label">‚è±Ô∏è Cooldown (gi√¢y)</label><input type="number"
            class="form-input" id="triggerCooldown" value="30" min="0"></div>
        <div class="form-group"><label class="form-label"><input type="checkbox" id="triggerEnabled" checked
              style="margin-right:6px;">K√≠ch ho·∫°t ngay</label></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTriggerModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveTrigger()" id="saveBtn">üíæ L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- DELETE MODAL -->
  <div class="delete-modal" id="deleteModal">
    <div class="delete-modal-content">
      <div class="delete-modal-icon">üóëÔ∏è</div>
      <div class="delete-modal-title">X√≥a Trigger</div>
      <div class="delete-modal-text">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a trigger "<span id="deleteTriggerName"></span>"?<br><small
          style="color:#f44336;">‚ö†Ô∏è Flow li√™n quan c≈©ng s·∫Ω b·ªã x√≥a!</small></div>
      <div class="delete-modal-actions">
        <button class="delete-modal-cancel" onclick="hideDeleteModal()">H·ªßy</button>
        <button class="delete-modal-confirm" onclick="confirmDelete()">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- AUTO MESSAGE SETUP MODAL -->
  <div class="modal-backdrop" id="autoMessageModal" style="display:none;">
    <div class="modal-box" style="max-width:600px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;">
          <span style="font-size:24px;">üí¨</span>
          C√†i ƒë·∫∑t T·ª± ƒë·ªông g·ª≠i tin nh·∫Øn
        </h2>
      </div>
      <div class="modal-body">
        <div
          style="background:#f0f9ff; border-left:4px solid #2196f3; padding:12px; margin-bottom:16px; border-radius:4px;">
          <div style="font-weight:600; color:#1976d2; margin-bottom:4px;">üìå Ch·ª©c nƒÉng</div>
          <div style="font-size:13px; color:#555;">T·ª± ƒë·ªông tr·∫£ l·ªùi <strong>M·ªåI</strong> tin nh·∫Øn ƒë·∫øn t·ª´ m·ªçi ng∆∞·ªùi v·ªõi
            n·ªôi dung b·∫°n c√†i ƒë·∫∑t.</div>
        </div>

        <div class="form-group">
          <label class="form-label">üí¨ N·ªôi dung t·ª± ƒë·ªông tr·∫£ l·ªùi *</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="autoMessageResponse" rows="6"
              placeholder="VD: Xin ch√†o! Hi·ªán t·∫°i t√¥i ƒëang b·∫≠n, s·∫Ω ph·∫£n h·ªìi b·∫°n sau.&#10;&#10;H·ªó tr·ª£ bi·∫øn ƒë·ªông:&#10;{name} - T√™n ng∆∞·ªùi g·ª≠i&#10;{time} - Th·ªùi gian hi·ªán t·∫°i"></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPickerForAutoMessage(event)">üòä</button>
            <div class="emoji-picker-container" id="emojiPickerAutoMessage">
              <div class="emoji-tabs" id="emojiTabsAutoMessage"></div>
              <div class="emoji-grid" id="emojiGridAutoMessage"></div>
            </div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">
            üí° C√≥ th·ªÉ d√πng bi·∫øn: <code>{name}</code>, <code>{time}</code>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">‚è±Ô∏è Th·ªùi gian ch·ªù gi·ªØa c√°c tin nh·∫Øn (gi√¢y)</label>
          <input type="number" class="form-input" id="autoMessageCooldown" min="0" value="30" placeholder="30">
          <div style="font-size:11px; color:#999; margin-top:4px;">
            üí° Th·ªùi gian t·ªëi thi·ªÉu gi·ªØa 2 l·∫ßn tr·∫£ l·ªùi c√πng 1 ng∆∞·ªùi (0 = kh√¥ng gi·ªõi h·∫°n)
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="autoMessageEnabled" style="margin-right:6px;">
            B·∫≠t ngay sau khi l∆∞u
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAutoMessageModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveAutoMessageSetup()">üíæ L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- AUTO ACCEPT FRIEND MODAL -->
  <div class="modal-backdrop" id="autoFriendModal" style="display:none;">
    <div class="modal-box" style="max-width:600px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:18px; display:flex; align-items:center; gap:8px;">
          <span style="font-size:24px;">üë•</span>
          C√†i ƒë·∫∑t Ch·∫•p nh·∫≠n k·∫øt b·∫°n
        </h2>
      </div>
      <div class="modal-body">
        <div
          style="background:#f0f9ff; border-left:4px solid #4caf50; padding:12px; margin-bottom:16px; border-radius:4px;">
          <div style="font-weight:600; color:#388e3c; margin-bottom:4px;">üìå Ch·ª©c nƒÉng</div>
          <div style="font-size:13px; color:#555;">T·ª± ƒë·ªông ch·∫•p nh·∫≠n <strong>M·ªåI</strong> l·ªùi m·ªùi k·∫øt b·∫°n v√† g·ª≠i tin
            nh·∫Øn ch√†o m·ª´ng (t√πy ch·ªçn).</div>
        </div>

        <div class="form-group">
          <label class="form-label">üí¨ Tin nh·∫Øn ch√†o m·ª´ng (t√πy ch·ªçn)</label>
          <div class="response-input-wrapper">
            <textarea class="form-input" id="autoFriendMessage" rows="6"
              placeholder="VD: Ch√†o {name}! üëã&#10;C·∫£m ∆°n b·∫°n ƒë√£ k·∫øt b·∫°n v·ªõi m√¨nh.&#10;N·∫øu c·∫ßn h·ªó tr·ª£, h√£y nh·∫Øn tin cho m√¨nh nh√©!&#10;&#10;ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën g·ª≠i tin nh·∫Øn."></textarea>
            <button type="button" class="emoji-btn" onclick="toggleEmojiPickerForAutoFriend(event)">üòä</button>
            <div class="emoji-picker-container" id="emojiPickerAutoFriend">
              <div class="emoji-tabs" id="emojiTabsAutoFriend"></div>
              <div class="emoji-grid" id="emojiGridAutoFriend"></div>
            </div>
          </div>
          <div style="font-size:11px; color:#999; margin-top:4px;">
            üí° C√≥ th·ªÉ d√πng bi·∫øn: <code>{name}</code>, <code>{time}</code>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="autoFriendEnabled" style="margin-right:6px;">
            B·∫≠t ngay sau khi l∆∞u
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAutoFriendModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveAutoFriendSetup()">üíæ L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- ACTIVITY WINDOW -->
  <div class="activity-backdrop" id="activityBackdrop" onclick="closeActivityWindow()"></div>
  <div class="activity-window" id="activityWindow">
    <div class="activity-header">
      <h3>üìã L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
      <div>
        <button onclick="clearActivityLogs()"
          style="background:#ffebee; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:8px;">üóëÔ∏è
          X√≥a</button>
        <button class="activity-close" onclick="closeActivityWindow()">‚úï</button>
      </div>
    </div>
    <div class="activity-list" id="activityList"></div>
  </div>

  <script>
    // ================================================
    // EMOJI DATA
    // ================================================
    const EMOJI_DATA = {
      'Smileys': ['üòÄ', 'üòÅ', 'üòÇ', 'ü§£', 'üòÉ', 'üòÑ', 'üòÖ', 'üòÜ', 'üòâ', 'üòä', 'üòã', 'üòé', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üôÇ', 'ü§ó', 'ü§©', 'ü§î', 'üòê', 'üòë', 'üò∂', 'üôÑ', 'üòè', 'üò£', 'üò•', 'üòÆ', 'ü§ê', 'üòØ', 'üò™', 'üò´', 'üò¥', 'üòå', 'üòõ', 'üòú', 'üòù', 'ü§§', 'üòí', 'üòì', 'üòî', 'üòï', 'üôÉ', 'ü§ë', 'üò≤', 'üôÅ', 'üòñ', 'üòû', 'üòü', 'üò§', 'üò¢', 'üò≠', 'üò®', 'üò©', 'ü§Ø', 'üò¨', 'üò∞', 'üò±', 'ü•µ', 'ü•∂', 'üò≥', 'ü§™', 'üòµ', 'ü•¥', 'üò†', 'üò°', 'ü§¨', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'üòá', 'ü•≥', 'ü•∫', 'ü§†', 'ü§°', 'ü§•', 'ü§´', 'ü§≠', 'üßê', 'ü§ì', 'üòà', 'üëø', 'üëπ', 'üë∫', 'üíÄ', '‚ò†Ô∏è', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ'],
      'Hands': ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ'],
      'Hearts': ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì'],
      'Objects': ['‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 'üóúÔ∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'ü™õ', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'ü™ö', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', 'ü™¶', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'ü©∏', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'ü™†', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ', 'üßº', 'ü™•', 'ü™í', 'üßΩ', 'ü™£', 'üß¥', 'üõéÔ∏è', 'üîë', 'üóùÔ∏è', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõå', 'üß∏', 'ü™Ü', 'üñºÔ∏è', 'ü™û', 'ü™ü', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 'ü™Ö', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'üéê', 'üßß', '‚úâÔ∏è', 'üì©', 'üì®', 'üìß', 'üíå', 'üì•', 'üì§', 'üì¶', 'üè∑Ô∏è', 'ü™ß', 'üì™', 'üì´', 'üì¨', 'üì≠', 'üìÆ', 'üìØ', 'üìú', 'üìÉ', 'üìÑ', 'üìë', 'üßæ', 'üìä', 'üìà', 'üìâ', 'üóíÔ∏è', 'üóìÔ∏è', 'üìÜ', 'üìÖ', 'üóëÔ∏è', 'üìá', 'üóÉÔ∏è', 'üó≥Ô∏è', 'üóÑÔ∏è', 'üìã', 'üìÅ', 'üìÇ', 'üóÇÔ∏è', 'üóûÔ∏è', 'üì∞', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîñ', 'üß∑', 'üîó', 'üìé', 'üñáÔ∏è', 'üìê', 'üìè', 'üßÆ', 'üìå', 'üìç', '‚úÇÔ∏è', 'üñäÔ∏è', 'üñãÔ∏è', '‚úíÔ∏è', 'üñåÔ∏è', 'üñçÔ∏è', 'üìù', '‚úèÔ∏è', 'üîç', 'üîé', 'üîè', 'üîê', 'üîí', 'üîì']
    };
    let currentEmojiCategory = 'Smileys';

    const AutoReplyScope = { Everyone: 0, Stranger: 1, SpecificFriends: 2, FriendsExcept: 3 };
    const TriggerMode = { Direct: 0, Flow: 1 };

    let ws = null, triggers = [], currentTriggerId = null, editingTriggerId = null;
    let currentUser = null, friendsList = [], selectedFriendUids = [];
    let activityLogs = [], deleteTargetId = null, activityCount = 0;

    // Built-in triggers state (will be populated from database)
    const builtInTriggers = {
      autoMessage: {
        id: 'builtin_auto_message',
        name: 'T·ª± ƒë·ªông g·ª≠i tin nh·∫Øn',
        description: 'T·ª± ƒë·ªông tr·∫£ l·ªùi m·ªçi tin nh·∫Øn theo k·ªãch b·∫£n',
        icon: 'üí¨',
        enabled: false,
        response: '',
        cooldown: 30000, // Default 30 seconds in ms
        triggerID: null
      },
      autoAcceptFriend: {
        id: 'builtin_auto_friend',
        name: 'Ch·∫•p nh·∫≠n k·∫øt b·∫°n',
        description: 'T·ª± ƒë·ªông ƒë·ªìng √Ω l·ªùi m·ªùi k·∫øt b·∫°n',
        icon: 'üë•',
        enabled: false,
        welcomeMessage: '',
        triggerID: null
      },
      autoFile: {
        id: 'builtin_auto_file',
        name: 'Nh·∫≠n di·ªán file',
        description: 'T·ª± ƒë·ªông tr·∫£ l·ªùi khi nh·∫≠n file/·∫£nh',
        icon: 'üìÇ',
        enabled: false,
        response: 'xlsx: B·∫°n ƒë√£ g·ª≠i file Excel\npdf: B·∫°n ƒë√£ g·ª≠i file PDF\ndefault: ƒê√£ nh·∫≠n file c·ªßa b·∫°n',
        cooldown: 0,
        triggerID: null
      }
    };

    // ================================================
    // WEBSOCKET
    // ================================================
    function connectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
        setTimeout(() => {
          if (ws?.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_current_user' }));
            ws.send(JSON.stringify({ type: 'get_auto_reply_status' }));
            ws.send(JSON.stringify({ type: 'get_triggers' }));
            ws.send(JSON.stringify({ type: 'get_friends' }));
            ws.send(JSON.stringify({ type: 'get_activity_logs', limit: 100 }));
          }
        }, 200);
      };
      ws.onclose = () => { updateAutoReplyStatus('off', 'Offline'); setTimeout(connectWebSocket, 3000); };
      ws.onmessage = (e) => { try { handleWebSocketMessage(JSON.parse(e.data)); } catch (err) { console.error(err); } };
    }

    function handleWebSocketMessage(data) {
      console.log('üì©', data.type);
      if (data.type === 'current_user') { currentUser = data.user; updateUserInfo(currentUser); }
      if (data.type === 'friends_list') { friendsList = data.friends || []; console.log('üë• Friends:', friendsList.length); }
      if (data.type === 'triggers_list' || data.type === 'auto_reply_status') {
        const list = data.triggers || data.scenarios || [];
        if (list.length > 0 || data.type === 'triggers_list') {
          const allTriggers = list.map(formatTrigger);

          // Separate built-in triggers from database
          const autoMessageTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_message__');
          const autoFriendTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_friend__');
          const autoFileTrigger = allTriggers.find(t => t.triggerKey === '__builtin_auto_file__');

          // Update built-in triggers state from database
          if (autoMessageTrigger) {
            builtInTriggers.autoMessage.enabled = autoMessageTrigger.enabled;
            builtInTriggers.autoMessage.response = autoMessageTrigger.response;
            builtInTriggers.autoMessage.triggerID = autoMessageTrigger.id;
            builtInTriggers.autoMessage.cooldown = autoMessageTrigger.cooldown || 30000;
          }

          if (autoFriendTrigger) {
            builtInTriggers.autoAcceptFriend.enabled = autoFriendTrigger.enabled;
            builtInTriggers.autoAcceptFriend.welcomeMessage = autoFriendTrigger.response;
            builtInTriggers.autoAcceptFriend.triggerID = autoFriendTrigger.id;
          }

          if (autoFileTrigger) {
            builtInTriggers.autoFile.enabled = autoFileTrigger.enabled;
            builtInTriggers.autoFile.response = autoFileTrigger.response;
            builtInTriggers.autoFile.triggerID = autoFileTrigger.id;
            builtInTriggers.autoFile.cooldown = autoFileTrigger.cooldown || 2000;
          }

          if (autoFriendTrigger) {
            builtInTriggers.autoAcceptFriend.enabled = autoFriendTrigger.enabled;
            builtInTriggers.autoAcceptFriend.welcomeMessage = autoFriendTrigger.response;
            builtInTriggers.autoAcceptFriend.triggerID = autoFriendTrigger.id;
          }

          // Remove built-in triggers from regular list (keep only user triggers)
          triggers = allTriggers.filter(t => !t.triggerKey || !t.triggerKey.startsWith('__builtin_'));

          renderTriggerList();
        }
        if (data.type === 'auto_reply_status') {
          const toggle = document.getElementById('autoReplyToggle');
          if (toggle) { toggle.checked = data.enabled; toggle.disabled = !currentUser?.uid; }
          updateAutoReplyStatus(data.enabled ? 'on' : 'off', data.enabled ? 'ON' : 'OFF');
        }
      }
      if (data.type === 'trigger_created' || data.type === 'scenario_added') {
        const newTrigger = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        if (newTrigger.triggerKey === '__builtin_auto_message__') {
          builtInTriggers.autoMessage.triggerID = newTrigger.id;
          builtInTriggers.autoMessage.enabled = newTrigger.enabled;
          builtInTriggers.autoMessage.response = newTrigger.response;
        } else if (newTrigger.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.triggerID = newTrigger.id;
          builtInTriggers.autoAcceptFriend.enabled = newTrigger.enabled;
          builtInTriggers.autoAcceptFriend.welcomeMessage = newTrigger.response;
        } else if (newTrigger.triggerKey === '__builtin_auto_file__') {
          builtInTriggers.autoFile.triggerID = newTrigger.id;
          builtInTriggers.autoFile.enabled = newTrigger.enabled;
          builtInTriggers.autoFile.response = newTrigger.response;
        } else {
          // Regular user trigger
          triggers.push(newTrigger);
        }

        renderTriggerList();
        showToast('‚úÖ ƒê√£ t·∫°o trigger!', 'success');
        if ((data.trigger || data.scenario).setMode === 1) {
          showToast('üîÑ Flow ƒë√£ ƒë∆∞·ª£c t·∫°o - M·ªü Flow Builder ƒë·ªÉ thi·∫øt k·∫ø', 'info');
        }
      }
      if (data.type === 'trigger_updated' || data.type === 'scenario_updated') {
        const t = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        if (t.triggerKey === '__builtin_auto_message__') {
          builtInTriggers.autoMessage.enabled = t.enabled;
          builtInTriggers.autoMessage.response = t.response;
        } else if (t.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.enabled = t.enabled;
          builtInTriggers.autoAcceptFriend.welcomeMessage = t.response;
        } else if (t.triggerKey === '__builtin_auto_file__') {
          builtInTriggers.autoFile.enabled = t.enabled;
          builtInTriggers.autoFile.response = t.response;
        } else {
          const i = triggers.findIndex(x => x.id === t.id);
          if (i !== -1) { triggers[i] = t; if (currentTriggerId === t.id) displayTrigger(t); }
        }

        renderTriggerList();
        showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t!', 'success');
      }
      if (data.type === 'trigger_deleted' || data.type === 'scenario_deleted') { triggers = triggers.filter(t => t.id !== data.id); renderTriggerList(); if (currentTriggerId === data.id) showEmptyState(); showToast('‚úÖ ƒê√£ x√≥a!', 'success'); }
      if (data.type === 'trigger_toggled' || data.type === 'scenario_toggled') {
        const t = formatTrigger(data.trigger || data.scenario);

        // Check if it's a built-in trigger
        if (t.triggerKey === '__builtin_auto_message__') {
          builtInTriggers.autoMessage.enabled = t.enabled;
        } else if (t.triggerKey === '__builtin_auto_friend__') {
          builtInTriggers.autoAcceptFriend.enabled = t.enabled;
        } else {
          const i = triggers.findIndex(x => x.id === t.id);
          if (i !== -1) { triggers[i] = t; if (currentTriggerId === t.id) displayTrigger(t); }
        }

        renderTriggerList();
      }
      if (data.type === 'trigger_error') { showToast('‚ùå ' + (data.message || 'L·ªói'), 'error'); }
      if (data.type === 'activity_logs') { activityLogs = data.logs || []; renderActivityList(); }
      if (data.type === 'activity_log') { activityLogs.unshift(data.activity); activityCount++; updateActivityBadge(); renderActivityList(); }
      if (data.type === 'activity_logs_cleared') { activityLogs = []; renderActivityList(); showToast('‚úÖ ƒê√£ x√≥a l·ªãch s·ª≠', 'success'); }
    }

    function formatTrigger(t) {
      // X·ª≠ l√Ω timestamp - c√≥ th·ªÉ l√† s·ªë ho·∫∑c string
      let timeCreated = t.timeCreated || t.createdAt;
      let timeUpdate = t.timeUpdate || t.updatedAt;

      // N·∫øu l√† string d·∫°ng ISO, chuy·ªÉn th√†nh timestamp
      if (typeof timeCreated === 'string') timeCreated = new Date(timeCreated).getTime();
      if (typeof timeUpdate === 'string') timeUpdate = new Date(timeUpdate).getTime();

      // N·∫øu v·∫´n kh√¥ng h·ª£p l·ªá, d√πng Date.now()
      if (!timeCreated || isNaN(timeCreated)) timeCreated = Date.now();
      if (!timeUpdate || isNaN(timeUpdate)) timeUpdate = Date.now();

      return {
        id: t.triggerID || t.id,
        name: t.triggerName || t.name || 'Untitled',
        triggerType: t.triggerType || 'keyword',  // M·ªöI: lo·∫°i trigger
        triggerKey: t.triggerKey || '',  // Keep raw triggerKey for built-in detection
        keywords: t.triggerKey ? t.triggerKey.split(',').map(k => k.trim()) : (t.keywords || []),
        response: t.triggerContent || t.response || '',
        enabled: t.enabled === true || t.enabled === 1,
        scope: t.scope ?? 0,
        uids: t.uids || [],
        schedule: { startTime: t.timeStartActive || t.schedule?.startTime || '00:00', endTime: t.timeEndActive || t.schedule?.endTime || '23:59' },
        dateStart: t.dateStartActive || null,
        dateEnd: t.dateEndActive || null,
        cooldown: t.cooldown || 30000,
        timeCreated: timeCreated,
        timeUpdate: timeUpdate,
        userUID: t.triggerUserID || t.userUID,
        setMode: t.setMode ?? 0,
        flow: t.flow || null,
        icon: (t.setMode === 1) ? 'üîÑ' : 'üîë'
      };
    }

    // ================================================
    // UI HELPERS
    // ================================================
    function updateUserInfo(user) {
      const panel = document.getElementById('userInfoPanel');
      if (!user) { panel.style.display = 'none'; return; }
      panel.style.display = 'flex';
      document.getElementById('userAvatar').textContent = user.name ? user.name.charAt(0).toUpperCase() : 'üë§';
      document.getElementById('userName').textContent = user.name || 'Unknown';
      document.getElementById('userUID').textContent = 'UID: ' + (user.uid || '-');
    }

    function updateAutoReplyStatus(state, text) { const s = document.getElementById('autoReplyStatus'); if (s) { s.className = 'toggle-status ' + state; s.textContent = text; } }
    function toggleAutoReply() { const t = document.getElementById('autoReplyToggle'); if (t && ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'set_auto_reply', enabled: t.checked })); }

    function formatDateTime(ts) {
      if (!ts || isNaN(ts)) return 'N/A';
      const d = new Date(ts);
      if (isNaN(d.getTime())) return 'N/A';
      return d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function formatTimeAgo(ts) {
      if (!ts || isNaN(ts)) return '';
      const d = Date.now() - ts;
      if (d < 0) return 'V·ª´a xong';
      const m = Math.floor(d / 60000), h = Math.floor(d / 3600000), dd = Math.floor(d / 86400000);
      if (m < 1) return 'V·ª´a xong';
      if (m < 60) return m + ' ph√∫t tr∆∞·ªõc';
      if (h < 24) return h + ' gi·ªù tr∆∞·ªõc';
      if (dd < 7) return dd + ' ng√†y tr∆∞·ªõc';
      return formatDateTime(ts);
    }
    function getScopeText(s) { return ['T·∫•t c·∫£', 'Ng∆∞·ªùi l·∫°', 'B·∫°n b√® c·ª• th·ªÉ', 'T·∫•t c·∫£ tr·ª´'][s] || 'N/A'; }
    function getModeText(m) { return m === 1 ? 'üîÑ Ch·∫°y theo Flow' : '‚ö° G·ª≠i tr·ª±c ti·∫øp'; }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }
    function showToast(msg, type = 'info') { const t = document.createElement('div'); t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:' + (type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3') + ';color:white;padding:12px 20px;border-radius:8px;z-index:10001;'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => { t.remove(); }, 3000); }

    // ================================================
    // EMOJI PICKER
    // ================================================
    function toggleEmojiPicker(e) {
      e.preventDefault();
      e.stopPropagation();
      const container = document.getElementById('emojiPickerContainer');
      const isVisible = container.classList.contains('show');
      if (isVisible) {
        container.classList.remove('show');
      } else {
        renderEmojiPicker();
        container.classList.add('show');
      }
    }

    function renderEmojiPicker() {
      // Render tabs
      const tabsHtml = Object.keys(EMOJI_DATA).map(cat =>
        `<button class="emoji-tab ${cat === currentEmojiCategory ? 'active' : ''}" onclick="selectEmojiCategory('${cat}')">${EMOJI_DATA[cat][0]}</button>`
      ).join('');
      document.getElementById('emojiTabs').innerHTML = tabsHtml;

      // Render emoji grid
      renderEmojiGrid();
    }

    function selectEmojiCategory(cat) {
      currentEmojiCategory = cat;
      document.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderEmojiGrid();
    }

    function renderEmojiGrid() {
      const emojis = EMOJI_DATA[currentEmojiCategory] || [];
      const gridHtml = emojis.map(e => `<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`).join('');
      document.getElementById('emojiGrid').innerHTML = gridHtml;
    }

    function insertEmoji(emoji) {
      const textarea = document.getElementById('triggerResponse');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      // ƒê√≥ng picker
      document.getElementById('emojiPickerContainer').classList.remove('show');
    }

    // ƒê√≥ng emoji picker khi click ra ngo√†i
    document.addEventListener('click', function (e) {
      const container = document.getElementById('emojiPickerContainer');
      const btn = document.querySelector('.emoji-btn');
      if (container && !container.contains(e.target) && e.target !== btn) {
        container.classList.remove('show');
      }
    });

    // ================================================
    // RENDER TRIGGER LIST
    // ================================================
    function renderTriggerList() {
      const c = document.getElementById('triggerList');

      let html = '';

      // ===== BUILT-IN TRIGGERS (Special section) =====
      html += renderBuiltInTriggers();

      // ===== USER TRIGGERS =====
      if (triggers.length === 0) {
        html += '<div style="text-align:center; padding:40px; color:#999;">üìã Ch∆∞a c√≥ trigger<br><button onclick="showNewTriggerModal()" style="margin-top:10px; padding:8px 16px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer;">‚ûï T·∫°o m·ªõi</button></div>';
        c.innerHTML = html;
        document.getElementById('triggerCount').textContent = '0';
        return;
      }

      const active = triggers.filter(t => t.enabled), inactive = triggers.filter(t => !t.enabled);
      if (active.length > 0) { html += '<div class="trigger-group"><div class="trigger-group-title">‚úÖ ƒêang ho·∫°t ƒë·ªông (' + active.length + ')</div>' + active.map(renderTriggerItem).join('') + '</div>'; }
      if (inactive.length > 0) { html += '<div class="trigger-group"><div class="trigger-group-title">‚è∏Ô∏è T·∫°m d·ª´ng (' + inactive.length + ')</div>' + inactive.map(renderTriggerItem).join('') + '</div>'; }
      html += '<button class="new-trigger-btn" onclick="showNewTriggerModal()">‚ûï T·∫°o trigger m·ªõi</button>';
      c.innerHTML = html;
      document.getElementById('triggerCount').textContent = triggers.length;
    }

    function renderBuiltInTriggers() {
      return `
        <div class="trigger-group" style="margin-bottom: 24px; border: 1px solid #e0e0e0; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden;">
          <div class="trigger-group-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
            ‚öôÔ∏è Triggers M·∫∑c ƒê·ªãnh
          </div>
          <div style="padding: 12px;">
            ${renderBuiltInTriggerItem(builtInTriggers.autoMessage)}
            ${renderBuiltInTriggerItem(builtInTriggers.autoAcceptFriend)}
            ${renderBuiltInTriggerItem(builtInTriggers.autoFile)}
          </div>
        </div>
      `;
    }

    function renderBuiltInTriggerItem(trigger) {
      const statusColor = trigger.enabled ? '#4caf50' : '#ccc';
      const statusText = trigger.enabled ? 'B·∫¨T' : 'T·∫ÆT';
      const statusIcon = trigger.enabled ? '‚úÖ' : '‚≠ï';

      return `
        <div class="trigger-item-compact" onclick="toggleBuiltInTrigger('${trigger.id}')" style="cursor: pointer; background: ${trigger.enabled ? '#f0f9ff' : '#fafafa'}; border: 1px solid ${trigger.enabled ? '#b3d9ff' : '#eee'}; display: flex; align-items: flex-start; gap: 12px; padding: 12px; margin-bottom: 8px;">
          <div class="trigger-icon-small" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 18px; width: 40px; height: 40px; border-radius: 10px;">
            ${trigger.icon}
          </div>
          
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
              <div style="font-weight: 600; color: #333; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                ${escapeHtml(trigger.name)}
              </div>
              <span style="font-size: 10px; padding: 3px 8px; background: ${statusColor}; color: white; border-radius: 12px; font-weight: 600; white-space: nowrap;">${statusIcon} ${statusText}</span>
            </div>
            
            <div class="trigger-keywords-preview" style="white-space: normal; line-height: 1.4; color: #666;">${escapeHtml(trigger.description)}</div>
          </div>

          <div class="trigger-actions" onclick="event.stopPropagation()" style="align-self: center;">
            <button class="action-icon" onclick="setupBuiltInTrigger('${trigger.id}')" title="C√†i ƒë·∫∑t" style="width: 32px; height: 32px; font-size: 16px; color: #667eea;">‚öôÔ∏è</button>
          </div>
        </div>
      `;
    }

    // ================================================
    // BUILT-IN TRIGGER ACTIONS
    // ================================================
    function toggleBuiltInTrigger(triggerId) {
      console.log('üîò toggleBuiltInTrigger called:', triggerId);

      let trigger;
      if (triggerId === 'builtin_auto_message') trigger = builtInTriggers.autoMessage;
      else if (triggerId === 'builtin_auto_friend') trigger = builtInTriggers.autoAcceptFriend;
      else if (triggerId === 'builtin_auto_file') trigger = builtInTriggers.autoFile;

      if (!trigger) {
        console.error('Trigger not found for ID:', triggerId);
        return;
      }
      console.log('üîò Trigger state:', trigger);

      // N·∫øu ch∆∞a c√≥ triggerID (ch∆∞a t·∫°o trong DB) ‚Üí y√™u c·∫ßu setup
      if (!trigger.triggerID) {
        console.log('üîò Not created yet, opening setup modal');
        setupBuiltInTrigger(triggerId);
        return;
      }

      // N·∫øu ch∆∞a c√≥ config (response/welcomeMessage r·ªóng) ‚Üí y√™u c·∫ßu setup
      if (!trigger.response && !trigger.welcomeMessage) {
        console.log('üîò No config, opening setup modal');
        setupBuiltInTrigger(triggerId);
        return;
      }

      // Toggle tr·∫°ng th√°i
      trigger.enabled = !trigger.enabled;
      console.log('üîò Toggled to:', trigger.enabled);

      // G·ª≠i toggle request (d√πng toggle_trigger thay v√¨ update_trigger)
      ws.send(JSON.stringify({
        type: 'toggle_trigger',
        id: trigger.triggerID
      }));

      renderTriggerList();
      showToast(trigger.enabled ? '‚úÖ ƒê√£ b·∫≠t ' + trigger.name : '‚è∏Ô∏è ƒê√£ t·∫Øt ' + trigger.name, 'success');
    }

    function setupBuiltInTrigger(triggerId) {
      console.log('‚öôÔ∏è setupBuiltInTrigger called:', triggerId);
      if (triggerId === 'builtin_auto_message') {
        showAutoMessageSetup();
      } else if (triggerId === 'builtin_auto_friend') {
        showAutoFriendSetup();
      } else if (triggerId === 'builtin_auto_file') {
        showAutoFileSetup();
      }
    }

    // ================================================
    // AUTO MESSAGE SETUP MODAL
    // ================================================
    function showAutoMessageSetup() {
      console.log('üí¨ showAutoMessageSetup called');
      const trigger = builtInTriggers.autoMessage;

      // Populate form v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
      document.getElementById('autoMessageResponse').value = trigger.response || '';
      document.getElementById('autoMessageEnabled').checked = trigger.enabled;
      // Cooldown: convert from ms to seconds for display
      document.getElementById('autoMessageCooldown').value = Math.floor((trigger.cooldown || 30000) / 1000);

      // Show modal
      document.getElementById('autoMessageModal').style.display = 'flex';
      console.log('üí¨ Modal should be visible now');
    }

    function hideAutoMessageModal() {
      document.getElementById('autoMessageModal').style.display = 'none';
    }

    function saveAutoMessageSetup() {
      const response = document.getElementById('autoMessageResponse').value.trim();
      const enabled = document.getElementById('autoMessageEnabled').checked;
      const cooldownSeconds = parseInt(document.getElementById('autoMessageCooldown').value) || 30;
      const cooldownMs = cooldownSeconds * 1000; // Convert to milliseconds

      if (!response) {
        showToast('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi!', 'error');
        return;
      }

      if (!currentUser?.uid) {
        showToast('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
        return;
      }

      // Update state
      builtInTriggers.autoMessage.response = response;
      builtInTriggers.autoMessage.enabled = enabled;
      builtInTriggers.autoMessage.cooldown = cooldownMs;

      // Save to database
      saveBuiltInTriggerState('builtin_auto_message', builtInTriggers.autoMessage);

      // Hide modal and update UI
      hideAutoMessageModal();
      renderTriggerList();
      showToast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t T·ª± ƒë·ªông g·ª≠i tin nh·∫Øn!', 'success');
    }

    function toggleEmojiPickerForAutoMessage(event) {
      event.stopPropagation();
      const picker = document.getElementById('emojiPickerAutoMessage');
      const isVisible = picker.style.display === 'block';

      // Close all emoji pickers
      document.querySelectorAll('.emoji-picker-container').forEach(p => p.style.display = 'none');

      if (!isVisible) {
        picker.style.display = 'block';
        // Initialize emoji picker if not already done
        if (!picker.dataset.initialized) {
          initEmojiPickerForElement('AutoMessage');
          picker.dataset.initialized = 'true';
        }
      }
    }

    // ================================================
    // AUTO ACCEPT FRIEND SETUP MODAL
    // ================================================
    function showAutoFriendSetup() {
      const trigger = builtInTriggers.autoAcceptFriend;

      // Populate form v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
      document.getElementById('autoFriendMessage').value = trigger.welcomeMessage || '';
      document.getElementById('autoFriendEnabled').checked = trigger.enabled;

      // Show modal
      document.getElementById('autoFriendModal').style.display = 'flex';
    }

    function hideAutoFriendModal() {
      document.getElementById('autoFriendModal').style.display = 'none';
    }

    function saveAutoFriendSetup() {
      const welcomeMessage = document.getElementById('autoFriendMessage').value.trim();
      const enabled = document.getElementById('autoFriendEnabled').checked;

      if (!currentUser?.uid) {
        showToast('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
        return;
      }

      // Update state (tin nh·∫Øn ch√†o m·ª´ng l√† t√πy ch·ªçn)
      builtInTriggers.autoAcceptFriend.welcomeMessage = welcomeMessage;
      builtInTriggers.autoAcceptFriend.enabled = enabled;

      // Save to database
      saveBuiltInTriggerState('builtin_auto_friend', builtInTriggers.autoAcceptFriend);

      // Hide modal and update UI
      hideAutoFriendModal();
      renderTriggerList();
      showToast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t Ch·∫•p nh·∫≠n k·∫øt b·∫°n!', 'success');
    }

    // ================================================
    // AUTO FILE SETUP MODAL
    // ================================================
    function showAutoFileSetup() {
      const trigger = builtInTriggers.autoFile;

      // Populate form
      document.getElementById('autoFileResponse').value = trigger.response || '';
      document.getElementById('autoFileEnabled').checked = trigger.enabled;

      document.getElementById('autoFileModal').style.display = 'flex';
    }

    function hideAutoFileModal() {
      document.getElementById('autoFileModal').style.display = 'none';
    }

    function saveAutoFileSetup() {
      const response = document.getElementById('autoFileResponse').value.trim();
      const enabled = document.getElementById('autoFileEnabled').checked;

      if (!response && enabled) {
        showToast('‚ö†Ô∏è B·∫°n n√™n nh·∫≠p n·ªôi dung tr·∫£ l·ªùi ƒë·ªÉ trigger ho·∫°t ƒë·ªông hi·ªáu qu·∫£', 'info');
      }

      if (!currentUser?.uid) {
        showToast('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
        return;
      }

      // Update state
      builtInTriggers.autoFile.response = response;
      builtInTriggers.autoFile.enabled = enabled;
      builtInTriggers.autoFile.cooldown = 2000;

      // Save to database
      saveBuiltInTriggerState('builtin_auto_file', builtInTriggers.autoFile);

      // Hide modal and update UI
      hideAutoFileModal();
      renderTriggerList();
      showToast('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t Nh·∫≠n di·ªán file!', 'success');
    }

    function toggleEmojiPickerForAutoFriend(event) {
      event.stopPropagation();
      const picker = document.getElementById('emojiPickerAutoFriend');
      const isVisible = picker.style.display === 'block';

      // Close all emoji pickers
      document.querySelectorAll('.emoji-picker-container').forEach(p => p.style.display = 'none');

      if (!isVisible) {
        picker.style.display = 'block';
        // Initialize emoji picker if not already done
        if (!picker.dataset.initialized) {
          initEmojiPickerForElement('AutoFriend');
          picker.dataset.initialized = 'true';
        }
      }
    }

    function initEmojiPickerForElement(suffix) {
      const tabsContainer = document.getElementById('emojiTabs' + suffix);
      const gridContainer = document.getElementById('emojiGrid' + suffix);

      // Render tabs
      tabsContainer.innerHTML = Object.keys(EMOJI_DATA).map(cat =>
        '<button class="emoji-tab ' + (cat === currentEmojiCategory ? 'active' : '') + '" onclick="switchEmojiCategory' + suffix + '(\'' + cat + '\')">' + cat + '</button>'
      ).join('');

      // Render grid
      switchEmojiCategory(currentEmojiCategory, suffix);
    }

    function switchEmojiCategoryAutoMessage(category) {
      switchEmojiCategory(category, 'AutoMessage');
    }

    function switchEmojiCategoryAutoFriend(category) {
      switchEmojiCategory(category, 'AutoFriend');
    }

    function switchEmojiCategory(category, suffix) {
      currentEmojiCategory = category;
      const gridContainer = document.getElementById('emojiGrid' + (suffix || ''));
      const tabsContainer = document.getElementById('emojiTabs' + (suffix || ''));

      // Update tabs
      tabsContainer.querySelectorAll('.emoji-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === category);
      });

      // Update grid
      gridContainer.innerHTML = EMOJI_DATA[category].map(emoji =>
        '<button class="emoji-item" onclick="insertEmoji' + (suffix || '') + '(\'' + emoji + '\')">' + emoji + '</button>'
      ).join('');
    }

    function insertEmojiAutoMessage(emoji) {
      const textarea = document.getElementById('autoMessageResponse');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      document.getElementById('emojiPickerAutoMessage').style.display = 'none';
    }

    function insertEmojiAutoFriend(emoji) {
      const textarea = document.getElementById('autoFriendMessage');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      textarea.value = text.substring(0, start) + emoji + text.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
      document.getElementById('emojiPickerAutoFriend').style.display = 'none';
    }

    function saveBuiltInTriggerState(triggerId, trigger) {
      if (!currentUser?.uid) {
        showToast('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!', 'error');
        return;
      }

      // X√°c ƒë·ªãnh triggerKey ƒë·∫∑c bi·ªát
      let specialKey = '';
      if (triggerId === 'builtin_auto_message') specialKey = '__builtin_auto_message__';
      else if (triggerId === 'builtin_auto_friend') specialKey = '__builtin_auto_friend__';
      else if (triggerId === 'builtin_auto_file') specialKey = '__builtin_auto_file__';

      // N·∫øu ƒë√£ c√≥ triggerID trong DB, g·ª≠i update v·ªõi ƒë·∫ßy ƒë·ªß data
      if (trigger.triggerID) {
        ws.send(JSON.stringify({
          type: 'update_trigger',
          id: trigger.triggerID,
          updates: {
            triggerName: trigger.name,
            enabled: trigger.enabled,
            triggerContent: trigger.response || trigger.welcomeMessage,
            cooldown: trigger.cooldown,
            triggerKey: specialKey
          }
        }));
      } else {
        // T·∫°o m·ªõi
        ws.send(JSON.stringify({
          type: 'create_trigger',
          name: trigger.name,
          triggerKey: specialKey,
          content: trigger.response || trigger.welcomeMessage || '',
          enabled: trigger.enabled,
          scope: 0,
          uids: [],
          cooldown: trigger.cooldown || 30000,
          startTime: '00:00',
          endTime: '23:59',
          userUID: currentUser.uid,
          keywords: []
        }));
      }
    }

    function renderTriggerItem(t) {
      const flowBadge = t.setMode === 1 ? '<span class="flow-badge">FLOW</span>' : '';
      return '<div class="trigger-item-compact ' + (currentTriggerId === t.id ? 'active' : '') + '" data-trigger-id="' + t.id + '"><div class="trigger-header-row" onclick="selectTrigger(' + t.id + ')"><div class="trigger-main-info"><div class="trigger-icon-small">' + t.icon + '</div><div style="flex:1;min-width:0;"><div class="trigger-name-small">' + escapeHtml(t.name) + ' ' + flowBadge + '</div><div class="trigger-keywords-preview">' + escapeHtml(t.keywords.slice(0, 3).join(', ')) + '</div><div class="trigger-time-created">üïê ' + formatTimeAgo(t.timeCreated) + '</div></div></div><div class="trigger-actions" onclick="event.stopPropagation()"><button class="action-icon" onclick="editTrigger(' + t.id + ')">‚úèÔ∏è</button><button class="action-icon" onclick="showDeleteModalFor(' + t.id + ')">üóëÔ∏è</button></div><div class="trigger-status ' + (t.enabled ? 'active' : '') + '" onclick="event.stopPropagation(); toggleTriggerStatus(' + t.id + ')"></div></div></div>';
    }

    function selectTrigger(id) { const t = triggers.find(x => x.id === id); if (!t) return; currentTriggerId = id; document.querySelectorAll('.trigger-item-compact').forEach(e => e.classList.remove('active')); const el = document.querySelector('[data-trigger-id="' + id + '"]'); if (el) el.classList.add('active'); displayTrigger(t); }

    function displayTrigger(t) {
      document.getElementById('canvasTitle').textContent = t.name;
      const badge = document.getElementById('canvasBadge'); badge.textContent = t.enabled ? 'ƒêang ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng'; badge.className = 'badge ' + (t.enabled ? 'active' : 'inactive'); badge.style.display = 'inline-block';
      const flowBadge = document.getElementById('canvasFlowBadge'); flowBadge.style.display = t.setMode === 1 ? 'inline-block' : 'none';
      document.getElementById('canvasActions').style.display = 'flex';
      document.getElementById('btnOpenBuilder').style.display = t.setMode === 1 ? 'inline-flex' : 'none';

      let uidsDisplay = t.uids?.length > 0 ? t.uids.map(uid => { const f = friendsList.find(x => x.userId === uid); return f ? f.displayName : uid; }).join(', ') : '';

      document.getElementById('canvasContent').innerHTML = '<div class="trigger-card"><div class="trigger-card-header"><div class="trigger-card-icon general">' + t.icon + '</div><div class="trigger-card-info"><h3>' + escapeHtml(t.name) + '</h3><p style="font-size:11px;color:#999;">ID: ' + t.id + '</p></div></div>' +
        (t.keywords.length > 0 ? '<div class="trigger-section"><div class="section-label">üîë T·ª´ kh√≥a</div><div class="keyword-list">' + t.keywords.map(k => '<span class="keyword-chip">' + escapeHtml(k) + '</span>').join('') + '</div></div>' : '') +
        '<div class="trigger-section"><div class="section-label">üöÄ Ch·∫ø ƒë·ªô</div><div class="info-value">' + getModeText(t.setMode) + (t.setMode === 1 ? ' - <a href="#" onclick="openTriggerBuilder();return false;" style="color:#9c27b0;">M·ªü Flow Builder</a>' : '') + '</div></div>' +
        (t.setMode === 0 ? '<div class="trigger-section"><div class="section-label">üí¨ Tr·∫£ l·ªùi</div><div class="response-box">' + escapeHtml(t.response) + '</div></div>' : '') +
        '<div class="trigger-section"><div class="section-label">‚ÑπÔ∏è Th√¥ng tin</div>' +
        '<div class="info-item"><span class="info-label">Tr·∫°ng th√°i:</span><span class="info-value">' + (t.enabled ? '‚úÖ Ho·∫°t ƒë·ªông' : '‚è∏Ô∏è T·∫°m d·ª´ng') + '</span></div>' +
        '<div class="info-item"><span class="info-label">Scope:</span><span class="info-value">' + getScopeText(t.scope) + '</span></div>' +
        (uidsDisplay ? '<div class="info-item"><span class="info-label">UIDs:</span><span class="info-value" style="font-size:11px;">' + uidsDisplay + '</span></div>' : '') +
        '<div class="info-item"><span class="info-label">Gi·ªù:</span><span class="info-value">' + t.schedule.startTime + ' - ' + t.schedule.endTime + '</span></div>' +
        (t.dateStart || t.dateEnd ? '<div class="info-item"><span class="info-label">Ng√†y:</span><span class="info-value">' + (t.dateStart || '...') + ' ‚Üí ' + (t.dateEnd || '...') + '</span></div>' : '') +
        '<div class="info-item"><span class="info-label">Cooldown:</span><span class="info-value">' + (t.cooldown / 1000) + 's</span></div>' +
        '<div class="info-item"><span class="info-label">T·∫°o l√∫c:</span><span class="info-value">' + formatDateTime(t.timeCreated) + '</span></div>' +
        '<div class="info-item"><span class="info-label">C·∫≠p nh·∫≠t:</span><span class="info-value">' + formatDateTime(t.timeUpdate) + '</span></div></div></div>';
    }

    function showEmptyState() {
      document.getElementById('canvasTitle').textContent = 'Ch·ªçn m·ªôt trigger';
      document.getElementById('canvasBadge').style.display = 'none';
      document.getElementById('canvasFlowBadge').style.display = 'none';
      document.getElementById('canvasActions').style.display = 'none';
      currentTriggerId = null;
      document.getElementById('canvasContent').innerHTML = '<div class="empty-state"><div class="icon">üéØ</div><h3>Ch·ªçn trigger ƒë·ªÉ xem</h3><button class="btn btn-primary" onclick="showNewTriggerModal()">‚ûï T·∫°o m·ªõi</button></div>';
    }

    // ================================================
    // OPEN TRIGGER BUILDER
    // ================================================
    function openTriggerBuilder() {
      if (!currentTriggerId) {
        showToast('‚ùå Vui l√≤ng ch·ªçn trigger tr∆∞·ªõc!', 'error');
        return;
      }
      const t = triggers.find(x => x.id === currentTriggerId);
      if (!t) return;
      if (t.setMode !== 1) {
        showToast('‚ùå Trigger n√†y kh√¥ng ·ªü ch·∫ø ƒë·ªô Flow!', 'error');
        return;
      }
      window.open('trigger-builder.html?trigger=' + currentTriggerId, '_blank');
    }

    // ================================================
    // MODE CHANGE
    // ================================================
    function onModeChange() {
      const mode = parseInt(document.getElementById('triggerMode').value);
      const responseGroup = document.getElementById('responseGroup');
      const modeHint = document.getElementById('modeHint');

      if (mode === 1) {
        responseGroup.style.display = 'none';
        modeHint.className = 'mode-hint flow';
        modeHint.innerHTML = 'üîÑ Workflow s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông. Sau khi l∆∞u, m·ªü <strong>Flow Builder</strong> ƒë·ªÉ thi·∫øt k·∫ø quy tr√¨nh.';
      } else {
        responseGroup.style.display = 'block';
        modeHint.className = 'mode-hint';
        modeHint.textContent = 'Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c g·ª≠i ngay l·∫≠p t·ª©c khi kh·ªõp t·ª´ kh√≥a';
      }
    }

    // ================================================
    // TRIGGER TYPE CHANGE (M·ªöI)
    // ================================================
    function onTriggerTypeChange() {
      const type = document.getElementById('triggerType').value;
      const keywordsGroup = document.getElementById('keywordsGroup');
      const hint = document.getElementById('triggerTypeHint');

      if (type === 'keyword') {
        keywordsGroup.style.display = 'block';
        hint.textContent = 'K√≠ch ho·∫°t khi tin nh·∫Øn ch·ª©a t·ª´ kh√≥a b√™n d∆∞·ªõi';
      } else if (type === 'any_message') {
        keywordsGroup.style.display = 'none';
        hint.textContent = 'üí¨ K√≠ch ho·∫°t v·ªõi T·∫§T C·∫¢ tin nh·∫Øn (text, sticker, ...)';
      } else if (type === 'any_file') {
        keywordsGroup.style.display = 'none';
        hint.textContent = 'üìé K√≠ch ho·∫°t khi nh·∫≠n File ho·∫∑c ·∫¢nh';
      }
    }

    // ================================================
    // SCOPE CHANGE
    // ================================================
    function onScopeChange() {
      const scope = parseInt(document.getElementById('triggerScope').value);
      const g = document.getElementById('friendsSelectorGroup');
      if (scope === 2 || scope === 3) {
        g.style.display = 'block';
        document.getElementById('friendsSelectorLabel').textContent = scope === 2 ? 'Ch·ªçn b·∫°n b√® s·∫Ω nh·∫≠n' : 'Ch·ªçn b·∫°n b√® s·∫Ω KH√îNG nh·∫≠n';
        renderFriendsSelector();
      }
      else { g.style.display = 'none'; }
    }

    function renderFriendsSelector() {
      const c = document.getElementById('friendsSelector');
      if (friendsList.length === 0) { c.innerHTML = '<div class="friends-selector-loading">Kh√¥ng c√≥ b·∫°n b√®<br><button onclick="ws.send(JSON.stringify({type:\'get_friends\'}))">üîÑ T·∫£i l·∫°i</button></div>'; return; }
      c.innerHTML = '<div class="friends-search-box"><input type="text" placeholder="üîç T√¨m ki·∫øm..." oninput="filterFriends(this.value)"></div><div id="friendsListContainer">' + friendsList.map(f => '<label class="friend-checkbox-item"><input type="checkbox" value="' + f.userId + '" ' + (selectedFriendUids.includes(f.userId) ? 'checked' : '') + ' onchange="onFriendCheck(this)"><img src="' + (f.avatar || 'https://via.placeholder.com/36') + '" onerror="this.src=\'https://via.placeholder.com/36\'"><div class="friend-checkbox-info"><div class="friend-checkbox-name">' + escapeHtml(f.displayName) + '</div><div class="friend-checkbox-uid">' + f.userId + '</div></div></label>').join('') + '</div>';
      updateSelectedSummary();
    }

    function filterFriends(q) { const lq = q.toLowerCase(); document.querySelectorAll('#friendsListContainer .friend-checkbox-item').forEach(e => { const n = e.querySelector('.friend-checkbox-name')?.textContent.toLowerCase() || ''; e.style.display = n.includes(lq) ? 'flex' : 'none'; }); }
    function onFriendCheck(cb) { if (cb.checked) { if (!selectedFriendUids.includes(cb.value)) selectedFriendUids.push(cb.value); } else { selectedFriendUids = selectedFriendUids.filter(u => u !== cb.value); } updateSelectedSummary(); }
    function updateSelectedSummary() { const s = document.getElementById('selectedFriendsSummary'); if (selectedFriendUids.length > 0) { s.style.display = 'block'; document.getElementById('selectedFriendsCount').textContent = selectedFriendUids.length; } else { s.style.display = 'none'; } }

    // ================================================
    // MODAL FUNCTIONS
    // ================================================
    function showNewTriggerModal() {
      editingTriggerId = null; selectedFriendUids = [];
      document.getElementById('modalTitle').textContent = 'T·∫°o Trigger M·ªõi';
      document.getElementById('triggerName').value = '';
      document.getElementById('triggerType').value = 'keyword';  // M·ªöI: reset lo·∫°i trigger
      document.getElementById('triggerKeywords').value = '';
      document.getElementById('triggerResponse').value = '';
      document.getElementById('triggerEnabled').checked = true;
      document.getElementById('triggerStartTime').value = '00:00';
      document.getElementById('triggerEndTime').value = '23:59';
      document.getElementById('triggerDateStart').value = '';
      document.getElementById('triggerDateEnd').value = '';
      document.getElementById('triggerScope').value = '0';
      document.getElementById('friendsSelectorGroup').style.display = 'none';
      document.getElementById('triggerCooldown').value = '30';
      document.getElementById('triggerMode').value = '0';
      document.getElementById('keywordsGroup').style.display = 'block';  // M·ªöI: hi·ªán l·∫°i field keywords
      onTriggerTypeChange();  // M·ªöI
      onModeChange();
      document.getElementById('saveBtn').textContent = 'üíæ L∆∞u';
      document.getElementById('triggerModal').classList.add('show');
    }

    function editTrigger(id) {
      const t = triggers.find(x => x.id === id); if (!t) return;
      editingTriggerId = id; selectedFriendUids = t.uids ? [...t.uids] : [];
      document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a Trigger';
      document.getElementById('triggerName').value = t.name;
      document.getElementById('triggerType').value = t.triggerType || 'keyword';  // M·ªöI: load lo·∫°i trigger
      document.getElementById('triggerKeywords').value = t.keywords.join(', ');
      document.getElementById('triggerResponse').value = t.response;
      document.getElementById('triggerEnabled').checked = t.enabled;
      document.getElementById('triggerStartTime').value = t.schedule.startTime;
      document.getElementById('triggerEndTime').value = t.schedule.endTime;
      document.getElementById('triggerDateStart').value = t.dateStart || '';
      document.getElementById('triggerDateEnd').value = t.dateEnd || '';
      document.getElementById('triggerScope').value = t.scope.toString();
      document.getElementById('triggerCooldown').value = Math.floor(t.cooldown / 1000);
      document.getElementById('triggerMode').value = t.setMode.toString();
      onTriggerTypeChange();  // M·ªöI: c·∫≠p nh·∫≠t UI theo lo·∫°i trigger
      onModeChange();
      onScopeChange();
      document.getElementById('saveBtn').textContent = 'üíæ C·∫≠p nh·∫≠t';
      document.getElementById('triggerModal').classList.add('show');
    }

    function editCurrentTrigger() { if (currentTriggerId) editTrigger(currentTriggerId); }
    function hideTriggerModal() { document.getElementById('triggerModal').classList.remove('show'); editingTriggerId = null; selectedFriendUids = []; document.getElementById('emojiPickerContainer').classList.remove('show'); }

    function saveTrigger() {
      const name = document.getElementById('triggerName').value.trim();
      const triggerType = document.getElementById('triggerType').value;  // M·ªöI
      const kw = document.getElementById('triggerKeywords').value.trim().split(',').map(k => k.trim().toLowerCase()).filter(k => k);
      const resp = document.getElementById('triggerResponse').value.trim();
      const scope = parseInt(document.getElementById('triggerScope').value);
      const setMode = parseInt(document.getElementById('triggerMode').value);

      if (!name) { showToast('‚ùå Nh·∫≠p t√™n!', 'error'); return; }
      // M·ªöI: Ch·ªâ validate t·ª´ kh√≥a khi lo·∫°i = keyword
      if (triggerType === 'keyword' && kw.length === 0) { showToast('‚ùå Nh·∫≠p t·ª´ kh√≥a!', 'error'); return; }
      if (setMode === 0 && !resp) { showToast('‚ùå Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi!', 'error'); return; }
      if ((scope === 2 || scope === 3) && selectedFriendUids.length === 0) { showToast('‚ùå Ch·ªçn b·∫°n b√®!', 'error'); return; }
      if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('‚ùå Ch∆∞a k·∫øt n·ªëi!', 'error'); return; }

      const data = {
        triggerName: name,
        triggerType: triggerType,  // M·ªöI: lo·∫°i trigger (keyword / any_message / any_file)
        triggerKey: triggerType === 'keyword' ? kw.join(',') : '',  // M·ªöI: ch·ªâ l∆∞u key khi lo·∫°i = keyword
        triggerContent: setMode === 0 ? resp : '',
        timeStartActive: document.getElementById('triggerStartTime').value || '00:00',
        timeEndActive: document.getElementById('triggerEndTime').value || '23:59',
        dateStartActive: document.getElementById('triggerDateStart').value || null,
        dateEndActive: document.getElementById('triggerDateEnd').value || null,
        scope: scope,
        uids: (scope === 2 || scope === 3) ? selectedFriendUids : null,
        cooldown: (parseInt(document.getElementById('triggerCooldown').value) || 30) * 1000,
        enabled: document.getElementById('triggerEnabled').checked,
        setMode: setMode
      };

      if (editingTriggerId) {
        data.id = editingTriggerId;
        data.triggerID = editingTriggerId;
        ws.send(JSON.stringify({ type: 'update_trigger', trigger: data }));
      }
      else {
        ws.send(JSON.stringify({ type: 'create_trigger', trigger: data }));
      }
      hideTriggerModal();
    }

    // ================================================
    // DELETE MODAL
    // ================================================
    function showDeleteModal() { if (currentTriggerId) showDeleteModalFor(currentTriggerId); }
    function showDeleteModalFor(id) {
      const t = triggers.find(x => x.id === id); if (!t) return;
      deleteTargetId = id;
      document.getElementById('deleteTriggerName').textContent = t.name;
      document.getElementById('deleteModal').classList.add('show');
    }
    function hideDeleteModal() { document.getElementById('deleteModal').classList.remove('show'); deleteTargetId = null; }
    function confirmDelete() {
      if (!deleteTargetId || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'delete_trigger', id: deleteTargetId }));
      hideDeleteModal();
    }

    function duplicateCurrentTrigger() {
      if (!currentTriggerId) return;
      const t = triggers.find(x => x.id === currentTriggerId);
      if (!t) return;
      editingTriggerId = null;
      selectedFriendUids = t.uids ? [...t.uids] : [];
      document.getElementById('modalTitle').textContent = 'Nh√¢n b·∫£n';
      document.getElementById('triggerName').value = t.name + ' (Copy)';
      document.getElementById('triggerKeywords').value = t.keywords.join(', ');
      document.getElementById('triggerResponse').value = t.response;
      document.getElementById('triggerEnabled').checked = false;
      document.getElementById('triggerScope').value = t.scope.toString();
      document.getElementById('triggerMode').value = t.setMode.toString();
      onModeChange();
      onScopeChange();
      document.getElementById('saveBtn').textContent = 'üíæ T·∫°o b·∫£n sao';
      document.getElementById('triggerModal').classList.add('show');
    }

    function toggleTriggerStatus(id) { if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'toggle_trigger', id: id })); }
    function searchTriggers() { const q = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.trigger-item-compact').forEach(e => { const n = e.querySelector('.trigger-name-small')?.textContent.toLowerCase() || ''; const k = e.querySelector('.trigger-keywords-preview')?.textContent.toLowerCase() || ''; e.style.display = (n.includes(q) || k.includes(q)) ? 'block' : 'none'; }); }

    // ================================================
    // ACTIVITY WINDOW
    // ================================================
    function openActivityWindow() {
      document.getElementById('activityBackdrop').classList.add('show');
      document.getElementById('activityWindow').classList.add('show');
      activityCount = 0; updateActivityBadge();
      if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'get_activity_logs', limit: 100 }));
    }
    function closeActivityWindow() {
      document.getElementById('activityBackdrop').classList.remove('show');
      document.getElementById('activityWindow').classList.remove('show');
    }
    function updateActivityBadge() {
      const b = document.getElementById('activityBadge');
      if (activityCount > 0) { b.textContent = activityCount > 99 ? '99+' : activityCount; b.style.display = 'block'; }
      else { b.style.display = 'none'; }
    }
    function clearActivityLogs() { if (ws?.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'clear_activity_logs' })); }
    function renderActivityList() {
      const c = document.getElementById('activityList');
      if (activityLogs.length === 0) { c.innerHTML = '<div class="activity-empty">üìã Ch∆∞a c√≥ ho·∫°t ƒë·ªông<br><small style="color:#aaa;">L·ªãch s·ª≠ s·∫Ω hi·ªÉn th·ªã khi b·∫°n t·∫°o/s·ª≠a/x√≥a trigger</small></div>'; return; }
      c.innerHTML = activityLogs.map(log => {
        const icons = { CREATE: '‚ûï', UPDATE: '‚úèÔ∏è', DELETE: 'üóëÔ∏è', ENABLE: '‚úÖ', DISABLE: '‚è∏Ô∏è', AUTO_REPLY: 'ü§ñ' };
        const actionTexts = { CREATE: 'T·∫°o m·ªõi', UPDATE: 'C·∫≠p nh·∫≠t', DELETE: 'X√≥a', ENABLE: 'B·∫≠t', DISABLE: 'T·∫Øt', AUTO_REPLY: 'Auto Reply' };
        const action = log.action || 'UNKNOWN';
        return '<div class="activity-item"><div class="activity-icon ' + action.toLowerCase() + '">' + (icons[action] || 'üìã') + '</div><div class="activity-info"><div class="activity-action">' + (actionTexts[action] || action) + '</div><div class="activity-trigger">' + escapeHtml(log.triggerName || log.trigger?.triggerName || 'N/A') + '</div><div class="activity-time">' + formatDateTime(log.timestamp) + '</div></div></div>';
      }).join('');
    }

    // ================================================
    // INIT
    // ================================================
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('triggerModal').addEventListener('click', (e) => { if (e.target.id === 'triggerModal') hideTriggerModal(); });
      connectWebSocket();
    });
  </script>
  <script src="assets/auto-reconnect.js"></script>
  <!-- AUTO FILE MODAL -->
  <div class="modal-overlay" id="autoFileModal" style="display:none; z-index:10002;">
    <div class="modal" style="width:500px; max-width:90%;">
      <div class="modal-header">
        <h3>‚öôÔ∏è C√†i ƒë·∫∑t Nh·∫≠n di·ªán file</h3><button class="modal-close" onclick="hideAutoFileModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div style="background:#e3f2fd; border:1px solid #90caf9; padding:12px; border-radius:8px; margin-bottom:16px;">
          <h4 style="margin:0 0 8px 0; color:#1565c0; font-size:14px;">‚ÑπÔ∏è H∆∞·ªõng d·∫´n</h4>
          <p style="margin:0; font-size:12px; line-height:1.5; color:#333;">
            T·ª± ƒë·ªông tr·∫£ l·ªùi khi nh·∫≠n ƒë∆∞·ª£c file ho·∫∑c ·∫£nh. B·∫°n c√≥ th·ªÉ c·∫•u h√¨nh tr·∫£ l·ªùi ri√™ng cho t·ª´ng lo·∫°i file.<br><br>
            <strong>C√∫ ph√°p c·∫•u h√¨nh (m·ªói d√≤ng m·ªôt lo·∫°i):</strong><br>
            <code
              style="background:white; padding:2px 4px; border-radius:4px;">xlsx: N·ªôi dung tr·∫£ l·ªùi cho excel</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">pdf: N·ªôi dung tr·∫£ l·ªùi cho pdf</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">image: N·ªôi dung khi nh·∫≠n ·∫£nh</code><br>
            <code style="background:white; padding:2px 4px; border-radius:4px;">default: N·ªôi dung m·∫∑c ƒë·ªãnh</code><br>
          <div style="margin-top:8px;">
            <strong>Bi·∫øn h·ªó tr·ª£:</strong>
            <code style="color:#e91e63;">{name}</code>,
            <code style="color:#e91e63;">{ext}</code>,
            <code style="color:#e91e63;">{content}</code> (ƒê·ªçc n·ªôi dung file Excel),
            <code style="color:#e91e63;">{print}</code> (In PDF, ·∫¢nh, Word, Excel),
            <code style="color:#e91e63;">{confirm_print}</code> (H·ªèi tr∆∞·ªõc khi in)
          </div>
          </p>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="autoFileEnabled" style="width:18px; height:18px; margin-right:8px;">
            <span style="font-weight:600;">B·∫≠t t√≠nh nƒÉng n√†y</span>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label">N·ªôi dung tr·∫£ l·ªùi</label>
          <textarea class="form-input" id="autoFileResponse" rows="8"
            placeholder="xlsx: B·∫°n ƒë√£ g·ª≠i file Excel...&#10;pdf: B·∫°n ƒë√£ g·ª≠i file PDF...&#10;default: ƒê√£ nh·∫≠n ƒë∆∞·ª£c file"></textarea>
          <div class="trigger-keywords-preview" style="margin-top:6px;">Tr·∫£ l·ªùi kh√°c nhau t√πy theo ƒëu√¥i file nh·∫≠n ƒë∆∞·ª£c.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="hideAutoFileModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveAutoFileSetup()">L∆∞u c√†i ƒë·∫∑t</button>
      </div>
    </div>
  </div>

</body>

</html>