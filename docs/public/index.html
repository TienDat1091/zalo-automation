<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zalo Login</title>
  <link rel="stylesheet" href="assets/style_index.css" />
</head>

<body>
  <div class="box">
    <h2>ğŸ” Zalo Login</h2>
    <p class="subtitle">QuÃ©t mÃ£ QR Ä‘á»ƒ Ä‘Äƒng nháº­p</p>

    <div class="qr-container">
      <img id="qr" src="/qr.png?t=0" alt="QR Code" />
    </div>

    <div class="loading">
      <div class="spinner"></div>
      <span id="statusText">Äang chá» quÃ©t mÃ£...</span>
    </div>

    <!-- IP Display -->
    <div
      style="margin-top: 15px; font-size: 14px; color: #666; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px;">
      ğŸŒ IP cá»§a báº¡n: <strong id="myIP">Äang kiá»ƒm tra...</strong>
    </div>

    <div class="status" id="statusBox" style="display: none;"></div>

    <div class="instructions">
      <strong>ğŸ“± HÆ°á»›ng dáº«n:</strong>
      <ol>
        <li>Má»Ÿ á»©ng dá»¥ng <strong>Zalo</strong></li>
        <li>Chá»n <strong>CÃ i Ä‘áº·t</strong> â†’ <strong>Thiáº¿t bá»‹ Ä‘Ã£ Ä‘Äƒng nháº­p</strong></li>
        <li>Nháº¥n <strong>ÄÄƒng nháº­p thiáº¿t bá»‹ má»›i</strong></li>
        <li>QuÃ©t mÃ£ QR trÃªn mÃ n hÃ¬nh</li>
      </ol>
    </div>
  </div>

  <script src="assets/websocket-helper.js"></script>
  <script>
    const ws = createWebSocket();
    const qrImg = document.querySelector('#qr');
    const statusText = document.querySelector('#statusText');
    const statusBox = document.querySelector('#statusBox');
    const myIpEl = document.querySelector('#myIP');
    let qrRefreshInterval;

    // Fetch Client IP
    fetch('/api/my-ip')
      .then(res => res.json())
      .then(data => {
        myIpEl.textContent = data.ip;
        console.log('My IP:', data.ip);
      })
      .catch(err => {
        myIpEl.textContent = 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
      });

    // Xá»­ lÃ½ khi WebSocket káº¿t ná»‘i
    ws.onopen = () => {
      console.log('âœ… ÄÃ£ káº¿t ná»‘i WebSocket');
      updateStatus('Äang chá» quÃ©t mÃ£...', 'waiting');

      // Check if this is a takeover login request
      const urlParams = new URLSearchParams(window.location.search);
      const isTakeover = urlParams.get('takeover') === 'pending';

      if (isTakeover) {
        console.log('ğŸ”„ Takeover mode - requesting new QR...');
        updateStatus('ğŸ”„ Äang táº¡o mÃ£ QR má»›i...', 'waiting');
        ws.send(JSON.stringify({ type: 'request_takeover_login' }));
        // Clean URL
        window.history.replaceState({}, document.title, '/');
      }

      // Auto refresh QR má»—i 3 giÃ¢y náº¿u chÆ°a login
      qrRefreshInterval = setInterval(() => {
        if (document.body.dataset.logged !== 'true') {
          qrImg.src = '/qr.png?t=' + Date.now();
        }
      }, 3000);
    };

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);

      if (data.type === 'current_user') {
        console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng:', data.user.name);
        document.body.dataset.logged = 'true';
        clearInterval(qrRefreshInterval);

        updateStatus('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...', 'success');

        // Chuyá»ƒn sang dashboard sau 1 giÃ¢y
        setTimeout(() => {
          const params = new URLSearchParams({
            name: data.user.name,
            uid: data.user.uid,
            avatar: data.user.avatar || ''
          });
          location.href = './dashboard.html?' + params.toString();
        }, 100);
      }
    };

    ws.onerror = (error) => {
      console.error('âŒ Lá»—i WebSocket:', error);
      updateStatus('Lá»—i káº¿t ná»‘i! Äang thá»­ káº¿t ná»‘i láº¡i...', 'error');
    };

    ws.onclose = () => {
      console.log('âš ï¸ WebSocket Ä‘Ã£ Ä‘Ã³ng');
      if (document.body.dataset.logged !== 'true') {
        updateStatus('Máº¥t káº¿t ná»‘i! Vui lÃ²ng táº£i láº¡i trang.', 'error');
        clearInterval(qrRefreshInterval);
      }
    };

    function updateStatus(message, type) {
      statusText.textContent = message;

      if (type === 'success') {
        statusBox.style.display = 'block';
        statusBox.className = 'status success';
        statusBox.textContent = message;
        document.querySelector('.loading').style.display = 'none';
      } else if (type === 'error') {
        statusBox.style.display = 'block';
        statusBox.className = 'status';
        statusBox.style.background = '#f8d7da';
        statusBox.style.color = '#721c24';
        statusBox.style.border = '1px solid #f5c6cb';
        statusBox.textContent = message;
      }
    }

    // Xá»­ lÃ½ lá»—i load áº£nh QR
    qrImg.onerror = () => {
      console.log('â³ QR chÆ°a sáºµn sÃ ng, Ä‘ang thá»­ láº¡i...');
      setTimeout(() => {
        qrImg.src = '/qr.png?t=' + Date.now();
      }, 1000);
    };
  </script>
</body>

</html>