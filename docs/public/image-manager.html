<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üñºÔ∏è Image Manager Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-stats { display: flex; gap: 24px; font-size: 14px; color: #666; }
    .header-stats .stat { display: flex; align-items: center; gap: 6px; }
    .header-stats .stat-value { font-weight: 600; color: #333; }
    .header-actions { display: flex; gap: 12px; }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary { background: #f0f0f0; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }

    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .upload-zone {
      border: 3px dashed #ddd;
      border-radius: 16px;
      padding: 48px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #fafafa;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .upload-zone .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.6; }
    .upload-zone h3 { font-size: 18px; color: #333; margin-bottom: 8px; }
    .upload-zone p { font-size: 14px; color: #888; }
    .upload-zone input[type="file"] { display: none; }

    .upload-note {
      margin-top: 12px;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 8px;
      font-size: 13px;
      color: #2e7d32;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    .image-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #eee;
      transition: all 0.3s ease;
      position: relative;
    }
    .image-card:hover {
      border-color: #667eea;
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
      transform: translateY(-4px);
    }
    .image-card.selected {
      border-color: #11998e;
      box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.2);
    }

    .image-card .image-preview {
      width: 100%;
      height: 160px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: zoom-in;
      position: relative;
    }
    .image-card .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .image-card:hover .image-preview img { transform: scale(1.05); }

    .image-card .zoom-hint {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .image-card:hover .zoom-hint { opacity: 1; }

    .image-card .image-dimensions {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: monospace;
    }

    .image-card .select-checkbox {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }
    .image-card:hover .select-checkbox,
    .image-card.selected .select-checkbox { opacity: 1; }
    .image-card.selected .select-checkbox { background: #11998e; color: white; }

    .image-card .image-info { padding: 12px; }
    .image-card .image-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .image-card .image-var {
      font-family: monospace;
      font-size: 12px;
      background: #e8f5e9;
      color: #2e7d32;
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 8px;
    }
    .image-card .image-meta { font-size: 11px; color: #888; }

    .image-card .image-actions {
      padding: 8px 12px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
    }
    .image-card .image-actions button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-copy { background: #e3f2fd; color: #1976d2; }
    .btn-copy:hover { background: #bbdefb; }
    .btn-edit { background: #fff3e0; color: #ef6c00; }
    .btn-edit:hover { background: #ffe0b2; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }

    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }

    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-box { flex: 1; min-width: 250px; position: relative; }
    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
    }
    .search-box input:focus { outline: none; border-color: #667eea; }
    .search-box .icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: 0.5;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal { transform: scale(1); }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { font-size: 20px; color: #333; }
    .modal-close {
      width: 36px; height: 36px;
      border: none;
      background: #f5f5f5;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
    }
    .modal-body { padding: 24px; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
    }
    .form-input:focus { outline: none; border-color: #667eea; }
    .form-hint { font-size: 12px; color: #888; margin-top: 6px; }
    .preview-image {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      background: #f5f5f5;
      margin-bottom: 16px;
    }

    .upload-progress { margin-top: 20px; }
    .progress-item {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .progress-item .thumbnail { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; }
    .progress-item .info { flex: 1; }
    .progress-item .name { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    .progress-bar { height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; }
    .progress-bar .fill { height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); transition: width 0.3s; }
    .progress-item .status { font-size: 12px; color: #888; }
    .progress-item.success .status { color: #10b981; }
    .progress-item.error .status { color: #ef4444; }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .toast {
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin-bottom: 12px;
      animation: slideIn 0.3s ease;
      min-width: 300px;
    }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.info { border-left: 4px solid #3b82f6; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ========== LIGHTBOX WITH ZOOM ========== */
    .lightbox {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .lightbox.active { opacity: 1; visibility: visible; }

    .lightbox-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(0,0,0,0.5);
      color: white;
    }
    .lightbox-info { display: flex; align-items: center; gap: 20px; font-size: 14px; }
    .lightbox-info .name {
      font-weight: 600;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .lightbox-info .dimensions {
      font-family: monospace;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 4px;
    }
    .lightbox-info .size { opacity: 0.8; }
    .lightbox-controls { display: flex; gap: 8px; }

    .lightbox-btn {
      width: 40px; height: 40px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lightbox-btn:hover { background: rgba(255,255,255,0.2); }

    .lightbox-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }
    .lightbox-body.dragging { cursor: grabbing; }

    .lightbox-image-container {
      position: relative;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }
    .lightbox-image-container img {
      max-width: none;
      max-height: none;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }

    .lightbox-footer {
      padding: 12px 24px;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
    }
    .zoom-slider { display: flex; align-items: center; gap: 12px; color: white; }
    .zoom-slider input[type="range"] {
      width: 200px;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      cursor: pointer;
    }
    .zoom-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      background: white;
      border-radius: 50%;
      cursor: pointer;
    }
    .zoom-level { font-family: monospace; min-width: 50px; text-align: center; }
    .lightbox-hint { color: rgba(255,255,255,0.6); font-size: 12px; }

    .connection-badge {
      position: fixed;
      bottom: 20px; left: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }
    .connection-badge.connected { background: #d1fae5; color: #059669; }
    .connection-badge.disconnected { background: #fee2e2; color: #dc2626; }

    .bulk-actions {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      display: none;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .bulk-actions.active { display: flex; }
    .bulk-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.2);
      color: white;
      font-size: 13px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 16px; text-align: center; }
      .images-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
      .lightbox-info .name { max-width: 150px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üñºÔ∏è Image Manager</h1>
        <div class="header-stats">
          <div class="stat"><span>üì∑ T·ªïng ·∫£nh:</span><span class="stat-value" id="totalImages">0</span></div>
          <div class="stat"><span>üíæ Dung l∆∞·ª£ng:</span><span class="stat-value" id="totalSize">0 KB</span></div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshImages()">üîÑ L√†m m·ªõi</button>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">‚ûï T·∫£i ·∫£nh l√™n</button>
      </div>
    </div>

    <div class="card">
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
        <div class="icon">üì§</div>
        <h3>K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h3>
        <p>H·ªó tr·ª£: JPG, PNG, GIF, WebP (T·ªëi ƒëa 10MB/·∫£nh)</p>
        <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileSelect(event)">
      </div>
      <div class="upload-note">‚ú® <strong>Ch·∫•t l∆∞·ª£ng g·ªëc:</strong> ·∫¢nh ƒë∆∞·ª£c l∆∞u nguy√™n b·∫£n, kh√¥ng n√©n, kh√¥ng resize.</div>
      <div class="upload-progress" id="uploadProgress"></div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="search-box">
          <span class="icon">üîç</span>
          <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ·∫£nh..." oninput="filterImages()">
        </div>
      </div>
      <div class="bulk-actions" id="bulkActions">
        <span>ƒê√£ ch·ªçn: <span class="count" id="selectedCount">0</span> ·∫£nh</span>
        <button onclick="bulkDelete()">üóëÔ∏è X√≥a</button>
        <button onclick="clearSelection()">‚úñÔ∏è B·ªè ch·ªçn</button>
      </div>
      <div class="images-grid" id="imagesContainer"></div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h2>‚úèÔ∏è Ch·ªânh s·ª≠a ·∫£nh</h2>
        <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editImageId">
        <img class="preview-image" id="editPreview" src="">
        <div class="form-group">
          <label>T√™n ·∫£nh</label>
          <input type="text" class="form-input" id="editName" placeholder="VD: ·∫¢nh ch√†o m·ª´ng">
        </div>
        <div class="form-group">
          <label>T√™n bi·∫øn</label>
          <input type="text" class="form-input" id="editVarName" placeholder="VD: img_welcome">
          <div class="form-hint">S·ª≠ d·ª•ng trong Flow: <code>{img_welcome}</code></div>
        </div>
        <div class="form-group">
          <label>M√¥ t·∫£</label>
          <textarea class="form-input" id="editDescription" rows="2" placeholder="M√¥ t·∫£ ng·∫Øn..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editModal')">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveImageEdit()">üíæ L∆∞u</button>
      </div>
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <div class="lightbox-header">
      <div class="lightbox-info">
        <span class="name" id="lightboxName">-</span>
        <span class="dimensions" id="lightboxDimensions">-</span>
        <span class="size" id="lightboxSize">-</span>
      </div>
      <div class="lightbox-controls">
        <button class="lightbox-btn" onclick="zoomIn()" title="Zoom In (+)">‚ûï</button>
        <button class="lightbox-btn" onclick="zoomOut()" title="Zoom Out (-)">‚ûñ</button>
        <button class="lightbox-btn" onclick="resetZoom()" title="Reset (0)">üîÑ</button>
        <button class="lightbox-btn" onclick="fitToScreen()" title="Fit (F)">‚¨ú</button>
        <button class="lightbox-btn" onclick="viewOriginal()" title="Original (1)">1:1</button>
        <button class="lightbox-btn" onclick="closeLightbox()" title="Close (Esc)">‚úï</button>
      </div>
    </div>
    <div class="lightbox-body" id="lightboxBody">
      <div class="lightbox-image-container" id="imageContainer">
        <img id="lightboxImg" src="" draggable="false">
      </div>
    </div>
    <div class="lightbox-footer">
      <div class="zoom-slider">
        <span>üîç</span>
        <input type="range" id="zoomSlider" min="10" max="500" value="100" oninput="setZoom(this.value)">
        <span class="zoom-level" id="zoomLevel">100%</span>
      </div>
      <div class="lightbox-hint">Scroll ƒë·ªÉ zoom ‚Ä¢ K√©o ƒë·ªÉ di chuy·ªÉn ‚Ä¢ Double-click zoom 100%</div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  <div class="connection-badge disconnected" id="connectionBadge">
    <span>‚óè</span><span id="connectionText">ƒêang k·∫øt n·ªëi...</span>
  </div>

  <script>
    var API_BASE_URL = 'http://' + (location.hostname || 'localhost') + ':3000';
    var ws = null;
    var images = [];
    var selectedImages = new Set();
    var currentZoom = 100;
    var panX = 0, panY = 0;
    var isDragging = false;
    var dragStartX = 0, dragStartY = 0;

    document.addEventListener('DOMContentLoaded', function() {
      setupWebSocket();
      setupDragDrop();
      setupLightboxEvents();
    });

    // Use same port as HTTP server
    function setupWebSocket() {
      try {
        var wsUrl = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + (location.hostname || 'localhost') + ':' + WS_PORT;
        ws = new WebSocket(wsUrl);
        ws.onopen = function() {
          updateConnectionBadge(true);
          ws.send(JSON.stringify({ type: 'get_images' }));
        };
        ws.onmessage = function(e) {
          try { handleMessage(JSON.parse(e.data)); } catch(err) {}
        };
        ws.onclose = function() {
          updateConnectionBadge(false);
          setTimeout(setupWebSocket, 3000);
        };
      } catch(e) {}
    }

    function handleMessage(msg) {
      switch(msg.type) {
        case 'images_list':
          images = msg.images || [];
          renderImages();
          updateStats();
          break;
        case 'image_uploaded':
          toast('‚úÖ ƒê√£ t·∫£i l√™n: ' + msg.image.name, 'success');
          ws.send(JSON.stringify({ type: 'get_images' }));
          break;
        case 'image_updated':
          toast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t!', 'success');
          closeModal('editModal');
          ws.send(JSON.stringify({ type: 'get_images' }));
          break;
        case 'image_deleted':
        case 'images_deleted':
          toast('üóëÔ∏è ƒê√£ x√≥a', 'success');
          clearSelection();
          ws.send(JSON.stringify({ type: 'get_images' }));
          break;
        case 'error':
          toast('‚ùå ' + msg.message, 'error');
          break;
      }
    }

    function updateConnectionBadge(connected) {
      var badge = document.getElementById('connectionBadge');
      badge.className = 'connection-badge ' + (connected ? 'connected' : 'disconnected');
      document.getElementById('connectionText').textContent = connected ? 'ƒê√£ k·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi';
    }

    function setupDragDrop() {
      var zone = document.getElementById('uploadZone');
      ['dragenter','dragover','dragleave','drop'].forEach(function(e) {
        zone.addEventListener(e, function(ev) { ev.preventDefault(); ev.stopPropagation(); });
      });
      ['dragenter','dragover'].forEach(function(e) {
        zone.addEventListener(e, function() { zone.classList.add('dragover'); });
      });
      ['dragleave','drop'].forEach(function(e) {
        zone.addEventListener(e, function() { zone.classList.remove('dragover'); });
      });
      zone.addEventListener('drop', function(e) { handleFiles(e.dataTransfer.files); });
    }

    function handleFileSelect(e) {
      handleFiles(e.target.files);
      e.target.value = '';
    }

    function handleFiles(files) {
      var progress = document.getElementById('uploadProgress');
      progress.innerHTML = '';
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        if (!file.type.startsWith('image/')) { toast('‚ùå ' + file.name + ' kh√¥ng ph·∫£i ·∫£nh', 'error'); continue; }
        if (file.size > 10*1024*1024) { toast('‚ùå ' + file.name + ' qu√° l·ªõn', 'error'); continue; }
        var fid = 'file_' + Date.now() + '_' + i;
        (function(f, id) {
          var tr = new FileReader();
          tr.onload = function(e) {
            progress.innerHTML += '<div class="progress-item" id="'+id+'"><img class="thumbnail" src="'+e.target.result+'"><div class="info"><div class="name">'+escapeHtml(f.name)+'</div><div class="progress-bar"><div class="fill" style="width:0%"></div></div></div><div class="status">ƒêang t·∫£i...</div></div>';
            uploadOriginalFile(f, id);
          };
          tr.readAsDataURL(f);
        })(file, fid);
      }
    }

    function uploadOriginalFile(file, fileId) {
      var reader = new FileReader();
      reader.onload = function(e) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'upload_image',
            fileId: fileId,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            data: e.target.result
          }));
          updateUploadProgress(fileId, 100, 'success');
        } else {
          updateUploadProgress(fileId, 0, 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    function updateUploadProgress(fid, pct, status) {
      var item = document.getElementById(fid);
      if (!item) return;
      item.querySelector('.progress-bar .fill').style.width = pct + '%';
      var st = item.querySelector('.status');
      if (status === 'success') { item.classList.add('success'); st.textContent = '‚úÖ Ho√†n t·∫•t'; setTimeout(function(){item.remove();}, 2000); }
      else if (status === 'error') { item.classList.add('error'); st.textContent = '‚ùå L·ªói'; }
      else { st.textContent = pct + '%'; }
    }

    function renderImages() {
      var c = document.getElementById('imagesContainer');
      var s = document.getElementById('searchInput').value.toLowerCase();
      var f = images.filter(function(i) {
        if (!s) return true;
        return (i.name||'').toLowerCase().includes(s) || (i.variableName||'').toLowerCase().includes(s);
      });
      if (f.length === 0) {
        c.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">üñºÔ∏è</div><h3>'+(images.length===0?'Ch∆∞a c√≥ ·∫£nh':'Kh√¥ng t√¨m th·∫•y')+'</h3></div>';
        return;
      }
      c.innerHTML = f.map(function(img) {
        var sel = selectedImages.has(img.id);
        var url = API_BASE_URL + '/api/images/' + img.id;
        var dim = (img.width && img.height) ? img.width + '√ó' + img.height : '';
        return '<div class="image-card'+(sel?' selected':'')+'" data-id="'+img.id+'">'+
          '<div class="select-checkbox" onclick="toggleSelect(event,'+img.id+')">'+(sel?'‚úì':'')+'</div>'+
          (dim?'<div class="image-dimensions">'+dim+'</div>':'')+
          '<div class="image-preview" onclick="openLightbox('+img.id+')">'+
            '<img src="'+escapeHtml(url)+'" alt="'+escapeHtml(img.name)+'" loading="lazy">'+
            '<div class="zoom-hint">üîç Click ƒë·ªÉ zoom</div>'+
          '</div>'+
          '<div class="image-info">'+
            '<div class="image-name">'+escapeHtml(img.name)+'</div>'+
            (img.variableName?'<div class="image-var">{'+escapeHtml(img.variableName)+'}</div>':'')+
            '<div class="image-meta">'+formatFileSize(img.fileSize)+' ‚Ä¢ '+formatDate(img.createdAt)+'</div>'+
          '</div>'+
          '<div class="image-actions">'+
            '<button class="btn-copy" onclick="copyImageUrl('+img.id+')">üìã Copy</button>'+
            '<button class="btn-edit" onclick="editImage('+img.id+')">‚úèÔ∏è</button>'+
            '<button class="btn-delete" onclick="deleteImage('+img.id+')">üóëÔ∏è</button>'+
          '</div>'+
        '</div>';
      }).join('');
    }

    function updateStats() {
      document.getElementById('totalImages').textContent = images.length;
      document.getElementById('totalSize').textContent = formatFileSize(images.reduce(function(s,i){return s+(i.fileSize||0);},0));
    }
    function filterImages() { renderImages(); }

    function toggleSelect(e, id) {
      e.stopPropagation();
      selectedImages.has(id) ? selectedImages.delete(id) : selectedImages.add(id);
      renderImages();
      updateBulkActions();
    }
    function updateBulkActions() {
      var b = document.getElementById('bulkActions');
      b.classList.toggle('active', selectedImages.size > 0);
      document.getElementById('selectedCount').textContent = selectedImages.size;
    }
    function clearSelection() { selectedImages.clear(); renderImages(); updateBulkActions(); }
    function bulkDelete() {
      if (!selectedImages.size || !confirm('X√≥a '+selectedImages.size+' ·∫£nh?')) return;
      if (ws) ws.send(JSON.stringify({ type:'delete_images', imageIds:Array.from(selectedImages) }));
    }

    function editImage(id) {
      var img = images.find(function(i){return i.id===id;});
      if (!img) return;
      document.getElementById('editImageId').value = id;
      document.getElementById('editPreview').src = API_BASE_URL + '/api/images/' + id;
      document.getElementById('editName').value = img.name || '';
      document.getElementById('editVarName').value = img.variableName || '';
      document.getElementById('editDescription').value = img.description || '';
      openModal('editModal');
    }
    function saveImageEdit() {
      var id = parseInt(document.getElementById('editImageId').value);
      var name = document.getElementById('editName').value.trim();
      var varName = document.getElementById('editVarName').value.trim();
      if (!name) { toast('‚ùå Nh·∫≠p t√™n ·∫£nh', 'error'); return; }
      if (ws) ws.send(JSON.stringify({
        type: 'update_image',
        imageId: id,
        name: name,
        variableName: varName,
        description: document.getElementById('editDescription').value.trim()
      }));
    }
    function deleteImage(id) {
      if (!confirm('X√≥a ·∫£nh n√†y?')) return;
      if (ws) ws.send(JSON.stringify({ type:'delete_image', imageId:id }));
    }
    function copyImageUrl(id) {
      navigator.clipboard.writeText(API_BASE_URL + '/api/images/' + id).then(function(){toast('üìã ƒê√£ copy!','success');});
    }
    function refreshImages() {
      if (ws) { ws.send(JSON.stringify({ type:'get_images' })); toast('üîÑ ƒêang l√†m m·ªõi...','info'); }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // ========== LIGHTBOX WITH ZOOM ==========
    function setupLightboxEvents() {
      var body = document.getElementById('lightboxBody');
      body.addEventListener('wheel', function(e) {
        e.preventDefault();
        setZoom(currentZoom + (e.deltaY > 0 ? -15 : 15));
      }, { passive: false });
      body.addEventListener('dblclick', function() {
        currentZoom === 100 ? setZoom(200) : resetZoom();
      });
      body.addEventListener('mousedown', function(e) {
        if (e.button !== 0) return;
        isDragging = true;
        dragStartX = e.clientX - panX;
        dragStartY = e.clientY - panY;
        body.classList.add('dragging');
      });
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        panX = e.clientX - dragStartX;
        panY = e.clientY - dragStartY;
        updateTransform();
      });
      document.addEventListener('mouseup', function() {
        isDragging = false;
        var b = document.getElementById('lightboxBody');
        if (b) b.classList.remove('dragging');
      });
    }

    function openLightbox(imageId) {
      var img = images.find(function(i){return i.id===imageId;});
      if (!img) return;
      var url = API_BASE_URL + '/api/images/' + imageId;
      document.getElementById('lightboxName').textContent = img.name || 'Untitled';
      document.getElementById('lightboxDimensions').textContent = (img.width && img.height) ? img.width + ' √ó ' + img.height + ' px' : 'Loading...';
      document.getElementById('lightboxSize').textContent = formatFileSize(img.fileSize);
      var limg = document.getElementById('lightboxImg');
      limg.onload = function() {
        if (!img.width || !img.height) {
          document.getElementById('lightboxDimensions').textContent = limg.naturalWidth + ' √ó ' + limg.naturalHeight + ' px';
        }
        fitToScreen();
      };
      limg.src = url;
      currentZoom = 100; panX = 0; panY = 0;
      document.getElementById('lightbox').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
      document.body.style.overflow = '';
    }

    function setZoom(v) {
      currentZoom = Math.min(500, Math.max(10, v));
      document.getElementById('zoomSlider').value = currentZoom;
      document.getElementById('zoomLevel').textContent = Math.round(currentZoom) + '%';
      updateTransform();
    }
    function zoomIn() { setZoom(currentZoom + 25); }
    function zoomOut() { setZoom(currentZoom - 25); }
    function resetZoom() { currentZoom = 100; panX = 0; panY = 0; setZoom(100); }
    function fitToScreen() {
      var img = document.getElementById('lightboxImg');
      var body = document.getElementById('lightboxBody');
      if (!img.naturalWidth) return;
      var scale = Math.min((body.clientWidth-40)/img.naturalWidth, (body.clientHeight-40)/img.naturalHeight, 1) * 100;
      panX = 0; panY = 0;
      setZoom(scale);
    }
    function viewOriginal() { panX = 0; panY = 0; setZoom(100); }
    function updateTransform() {
      document.getElementById('imageContainer').style.transform = 'translate('+panX+'px,'+panY+'px) scale('+(currentZoom/100)+')';
    }

    document.addEventListener('keydown', function(e) {
      var lb = document.getElementById('lightbox').classList.contains('active');
      if (e.key === 'Escape') { lb ? closeLightbox() : closeModal('editModal'); }
      if (lb) {
        if (e.key === '+' || e.key === '=') { e.preventDefault(); zoomIn(); }
        if (e.key === '-') { e.preventDefault(); zoomOut(); }
        if (e.key === '0') { e.preventDefault(); resetZoom(); }
        if (e.key === '1') { e.preventDefault(); viewOriginal(); }
        if (e.key.toLowerCase() === 'f') { e.preventDefault(); fitToScreen(); }
      }
    });

    function escapeHtml(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
    function formatFileSize(b) {
      if (!b) return '0 B';
      var k = 1024, s = ['B','KB','MB','GB'], i = Math.floor(Math.log(b)/Math.log(k));
      return (b/Math.pow(k,i)).toFixed(1) + ' ' + s[i];
    }
    function formatDate(t) { return t ? new Date(t).toLocaleDateString('vi-VN') : ''; }
    function toast(m, t) {
      var c = document.getElementById('toastContainer');
      var d = document.createElement('div');
      d.className = 'toast ' + (t||'info');
      d.innerHTML = m;
      c.appendChild(d);
      setTimeout(function() { d.style.opacity='0'; setTimeout(function(){d.remove();},300); }, 3000);
    }
  </script>
</body>
</html>