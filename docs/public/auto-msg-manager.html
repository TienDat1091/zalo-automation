<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Tin nh·∫Øn T·ª± ƒë·ªông - Zalo Automation</title>
    <link rel="stylesheet" href="/assets/style_bank_manager.css">
    <style>
        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .routine-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .routine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .routine-info h3 {
            margin: 0;
            font-size: 18px;
            color: #1e3a5f;
        }

        .routine-info p {
            margin: 5px 0 0;
            font-size: 13px;
            color: #666;
        }

        .routine-time {
            background: #e3f2fd;
            color: #007bff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .integration-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .int-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: #f5f5f5;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .int-badge.active {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .routine-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        /* Integration Config UI */
        .config-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .config-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .switch-label {
            font-size: 13px;
            color: #444;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>ü§ñ Qu·∫£n l√Ω Tin nh·∫Øn T·ª± ƒë·ªông</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openRoutineModal()">+ T·∫°o Routine m·ªõi</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="routine-grid" id="routinesList">
            <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i danh s√°ch routines...</p>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Routine -->
    <div class="modal-overlay" id="routineModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="modalTitle">Thi·∫øt l·∫≠p Routine m·ªõi</h3>
                <button class="modal-close" onclick="closeRoutineModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRoutineId">

                <div class="form-group">
                    <label>T√™n Routine (vd: Ch√†o bu·ªïi s√°ng)</label>
                    <input type="text" class="form-control" id="routineName" placeholder="Nh·∫≠p t√™n routine...">
                </div>

                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Khung gi·ªù ch·∫°y (HH:mm)</label>
                        <input type="time" class="form-control" id="atTime">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>T·∫ßn su·∫•t</label>
                        <select class="form-control" id="frequency">
                            <option value="daily">H√†ng ng√†y</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ng∆∞·ªùi nh·∫≠n / Nh√≥m</label>
                    <select class="form-control" id="targetSelect">
                        <option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>
                    </select>
                </div>

                <div class="config-section">
                    <div class="config-title">üõ†Ô∏è C√°c module t√≠ch h·ª£p</div>

                    <div class="switch-group">
                        <span class="switch-label">üå§Ô∏è Th√¥ng tin th·ªùi ti·∫øt</span>
                        <label class="uh-toggle-switch">
                            <input type="checkbox" id="int-weather">
                            <span class="uh-toggle-slider"></span>
                        </label>
                    </div>

                    <div class="switch-group">
                        <span class="switch-label">üå¨Ô∏è Ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠</span>
                        <label class="uh-toggle-switch">
                            <input type="checkbox" id="int-air">
                            <span class="uh-toggle-slider"></span>
                        </label>
                    </div>

                    <div class="switch-group">
                        <span class="switch-label">üì∞ Tin t·ª©c m·ªõi nh·∫•t (RSS)</span>
                        <label class="uh-toggle-switch">
                            <input type="checkbox" id="int-news">
                            <span class="uh-toggle-slider"></span>
                        </label>
                    </div>

                    <div class="switch-group">
                        <span class="switch-label">üìä L·∫•y d·ªØ li·ªáu Google Sheet</span>
                        <label class="uh-toggle-switch">
                            <input type="checkbox" id="int-gsheet" onchange="toggleGSheetConfig()">
                            <span class="uh-toggle-slider"></span>
                        </label>
                    </div>

                    <div id="gsheet-config"
                        style="display:none; margin-top:10px; padding-left:10px; border-left:2px solid #ddd;">
                        <select class="form-control" id="gsheet-id">
                            <option value="">-- Ch·ªçn c·∫•u h√¨nh Sheet --</option>
                        </select>
                    </div>

                    <div class="switch-group">
                        <span class="switch-label">‚ö° Ch·∫°y K·ªãch b·∫£n (Flow Builder)</span>
                        <label class="uh-toggle-switch">
                            <input type="checkbox" id="int-flow" onchange="toggleFlowConfig()">
                            <span class="uh-toggle-slider"></span>
                        </label>
                    </div>

                    <div id="flow-config"
                        style="display:none; margin-top:10px; padding-left:10px; border-left:2px solid #ddd;">
                        <select class="form-control" id="flow-id">
                            <option value="">-- Ch·ªçn k·ªãch b·∫£n --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>L·ªùi nh·∫Øn t√πy ch·ªânh k√®m theo</label>
                    <textarea class="form-control" id="customMsg" rows="3"
                        placeholder="Ch√∫c m·ªôt ng√†y t·ªët l√†nh..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeRoutineModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveRoutine()">üíæ L∆∞u Routine</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let routines = [];
        let cachedFriends = [];
        let cachedGroups = [];
        let cachedFlows = [];
        let cachedSheets = [];

        function connectWS() {
            ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'get_automation_routines' }));
                ws.send(JSON.stringify({ type: 'get_friends' }));
                ws.send(JSON.stringify({ type: 'get_groups' }));
                ws.send(JSON.stringify({ type: 'get_all_flows' }));
                ws.send(JSON.stringify({ type: 'get_google_sheet_configs' }));
            };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                switch (data.type) {
                    case 'automation_routines_list':
                        routines = data.routines;
                        renderRoutines();
                        break;
                    case 'friends_list':
                        cachedFriends = data.friends || [];
                        updateTargetSelect();
                        break;
                    case 'groups_list':
                        cachedGroups = data.groups || [];
                        updateTargetSelect();
                        break;
                    case 'flows_list':
                        cachedFlows = data.flows || [];
                        updateFlowSelect();
                        break;
                    case 'google_sheet_configs':
                        cachedSheets = data.configs || [];
                        updateSheetSelect();
                        break;
                }
            };
            ws.onclose = () => setTimeout(connectWS, 3000);
        }

        function updateTargetSelect() {
            const select = document.getElementById('targetSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi nh·∫≠n --</option>';

            const fg = document.createElement('optgroup'); fg.label = 'üë§ B·∫°n b√®';
            cachedFriends.forEach(f => fg.innerHTML += `<option value="${f.userId}" data-name="${f.displayName}">${f.displayName}</option>`);
            select.appendChild(fg);

            const gg = document.createElement('optgroup'); gg.label = 'üë™ Nh√≥m';
            cachedGroups.forEach(g => gg.innerHTML += `<option value="${g.id}" data-name="${g.name}">${g.name}</option>`);
            select.appendChild(gg);

            if (currentVal) select.value = currentVal;
        }

        function updateFlowSelect() {
            const select = document.getElementById('flow-id');
            select.innerHTML = '<option value="">-- Ch·ªçn k·ªãch b·∫£n --</option>';
            cachedFlows.forEach(f => select.innerHTML += `<option value="${f.flowID}">${f.flowName}</option>`);
        }

        function updateSheetSelect() {
            const select = document.getElementById('gsheet-id');
            select.innerHTML = '<option value="">-- Ch·ªçn c·∫•u h√¨nh Sheet --</option>';
            cachedSheets.forEach(s => select.innerHTML += `<option value="${s.configID}">${s.name}</option>`);
        }

        function renderRoutines() {
            const list = document.getElementById('routinesList');
            if (routines.length === 0) {
                list.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #999;">
                    <div style="font-size: 40px; margin-bottom: 10px;">‚è∞</div>
                    <p>Ch∆∞a c√≥ Routine t·ª± ƒë·ªông n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p.</p>
                </div>`;
                return;
            }

            list.innerHTML = routines.map(r => `
                <div class="routine-card">
                    <div class="routine-header">
                        <div class="routine-info">
                            <h3>${escapeHtml(r.routineName)}</h3>
                            <p>ƒê·∫øn: <b>${escapeHtml(r.targetName)}</b></p>
                        </div>
                        <div class="routine-time">${r.atTime}</div>
                    </div>

                    <div class="integration-badges">
                        ${r.integrations.weather ? '<span class="int-badge active">üå§Ô∏è Th·ªùi ti·∫øt</span>' : ''}
                        ${r.integrations.air ? '<span class="int-badge active">üå¨Ô∏è Kh√¥ng kh√≠</span>' : ''}
                        ${r.integrations.news ? '<span class="int-badge active">üì∞ Tin t·ª©c</span>' : ''}
                        ${r.integrations.googleSheet ? '<span class="int-badge active">üìä G-Sheet</span>' : ''}
                        ${r.integrations.flowId ? '<span class="int-badge active">‚ö° Flow</span>' : ''}
                    </div>

                    <div class="routine-footer">
                        <div class="status-toggle">
                            <label class="uh-toggle-switch">
                                <input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="toggleRoutine(${r.id}, this.checked)">
                                <span class="uh-toggle-slider"></span>
                            </label>
                            <span>${r.enabled ? 'ƒêang b·∫≠t' : 'ƒê√£ t·∫Øt'}</span>
                        </div>
                        <div class="actions">
                            <button class="action-btn" onclick="editRoutine(${r.id})" style="color: #2196f3">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="deleteRoutine(${r.id})" style="color: #f44336">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleGSheetConfig() {
            document.getElementById('gsheet-config').style.display = document.getElementById('int-gsheet').checked ? 'block' : 'none';
        }

        function toggleFlowConfig() {
            document.getElementById('flow-config').style.display = document.getElementById('int-flow').checked ? 'block' : 'none';
        }

        function openRoutineModal() {
            document.getElementById('modalTitle').textContent = 'Thi·∫øt l·∫≠p Routine m·ªõi';
            document.getElementById('editRoutineId').value = '';
            document.getElementById('routineName').value = '';
            document.getElementById('atTime').value = '07:30';
            document.getElementById('targetSelect').value = '';
            document.getElementById('int-weather').checked = true;
            document.getElementById('int-air').checked = true;
            document.getElementById('int-news').checked = true;
            document.getElementById('int-gsheet').checked = false;
            document.getElementById('int-flow').checked = false;
            document.getElementById('customMsg').value = '';
            toggleGSheetConfig();
            toggleFlowConfig();
            document.getElementById('routineModal').classList.add('active');
        }

        function editRoutine(id) {
            const r = routines.find(x => x.id === id);
            if (!r) return;

            document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a Routine';
            document.getElementById('editRoutineId').value = r.id;
            document.getElementById('routineName').value = r.routineName;
            document.getElementById('atTime').value = r.atTime;
            document.getElementById('targetSelect').value = r.targetId;
            document.getElementById('int-weather').checked = !!r.integrations.weather;
            document.getElementById('int-air').checked = !!r.integrations.air;
            document.getElementById('int-news').checked = !!r.integrations.news;
            document.getElementById('int-gsheet').checked = !!r.integrations.googleSheet;
            document.getElementById('gsheet-id').value = r.integrations.gsheetId || '';
            document.getElementById('int-flow').checked = !!r.integrations.flowId;
            document.getElementById('flow-id').value = r.integrations.flowId || '';
            document.getElementById('customMsg').value = r.integrations.customMessage || '';

            toggleGSheetConfig();
            toggleFlowConfig();
            document.getElementById('routineModal').classList.add('active');
        }

        function closeRoutineModal() {
            document.getElementById('routineModal').classList.remove('active');
        }

        function saveRoutine() {
            const name = document.getElementById('routineName').value;
            const time = document.getElementById('atTime').value;
            const target = document.getElementById('targetSelect');
            const editId = document.getElementById('editRoutineId').value;

            if (!name || !time || !target.value) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin c∆° b·∫£n!');
                return;
            }

            const routine = {
                routineName: name,
                atTime: time,
                targetId: target.value,
                targetName: target.options[target.selectedIndex].dataset.name,
                integrations: {
                    weather: document.getElementById('int-weather').checked,
                    air: document.getElementById('int-air').checked,
                    news: document.getElementById('int-news').checked,
                    googleSheet: document.getElementById('int-gsheet').checked,
                    gsheetId: document.getElementById('gsheet-id').value,
                    flowId: document.getElementById('int-flow').checked ? document.getElementById('flow-id').value : null,
                    customMessage: document.getElementById('customMsg').value
                }
            };

            if (editId) {
                ws.send(JSON.stringify({ type: 'update_automation_routine', id: parseInt(editId), updates: routine }));
            } else {
                ws.send(JSON.stringify({ type: 'create_automation_routine', routine }));
            }
            closeRoutineModal();
        }

        function toggleRoutine(id, enabled) {
            ws.send(JSON.stringify({ type: 'update_automation_routine', id, updates: { enabled } }));
        }

        function deleteRoutine(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a routine n√†y?')) {
                ws.send(JSON.stringify({ type: 'delete_automation_routine', id }));
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', connectWS);
    </script>
</body>

</html>