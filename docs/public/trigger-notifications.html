<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîî Th√¥ng b√°o - Zalo Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      overflow: hidden;
      height: 100vh;
    }
    
    .header {
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-sm {
      padding: 6px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-sm:hover {
      background: #f5f7fa;
      border-color: #0084ff;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      transition: all 0.2s;
    }
    
    .tab:hover {
      background: #f5f7fa;
      color: #0084ff;
    }
    
    .tab.active {
      color: #0084ff;
      border-bottom-color: #0084ff;
      background: #f5f9ff;
    }
    
    .tab-content {
      display: none;
      height: calc(100vh - 100px);
      overflow-y: auto;
      padding: 12px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .activity-item {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #e0e0e0;
      transition: all 0.2s;
    }
    
    .activity-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .activity-item.create {
      border-left-color: #4caf50;
    }
    
    .activity-item.update {
      border-left-color: #2196f3;
    }
    
    .activity-item.delete {
      border-left-color: #f44336;
    }
    
    .activity-item.message {
      border-left-color: #ff9800;
    }
    
    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .activity-type {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .activity-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-create {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .badge-update {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge-delete {
      background: #ffebee;
      color: #c62828;
    }
    
    .badge-message {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .activity-time {
      font-size: 11px;
      color: #999;
    }
    
    .activity-content {
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
    
    .activity-trigger-code {
      background: #f5f7fa;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #333;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .activity-details {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
    }
    
    .detail-row {
      display: flex;
      gap: 8px;
      font-size: 11px;
      margin-bottom: 4px;
    }
    
    .detail-label {
      font-weight: 600;
      color: #666;
      min-width: 80px;
    }
    
    .detail-value {
      color: #333;
      flex: 1;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .filter-bar {
      background: white;
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .filter-bar select,
    .filter-bar input {
      padding: 6px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 12px;
      outline: none;
    }
    
    .filter-bar select:focus,
    .filter-bar input:focus {
      border-color: #0084ff;
    }
    
    .stats-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .stat-box {
      flex: 1;
      background: white;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #0084ff;
    }
    
    .stat-label {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-title">
      <span>üîî</span>
      <span>Th√¥ng b√°o & L·ªãch s·ª≠</span>
    </div>
    <div class="header-actions">
      <button class="btn-sm" onclick="clearAllActivities()">
        <span>üóëÔ∏è</span> X√≥a t·∫•t c·∫£
      </button>
      <button class="btn-sm" onclick="window.close()">
        <span>‚úï</span> ƒê√≥ng
      </button>
    </div>
  </div>
  
  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('messages')">
      <span>üí¨</span> Tin nh·∫Øn (<span id="messagesCount">0</span>)
    </div>
    <div class="tab" onclick="switchTab('crud')">
      <span>üìù</span> CRUD (<span id="crudCount">0</span>)
    </div>
    <div class="tab" onclick="switchTab('all')">
      <span>üìã</span> T·∫•t c·∫£ (<span id="allCount">0</span>)
    </div>
  </div>
  
  <!-- Tab Content: Messages -->
  <div id="messagesTab" class="tab-content active">
    <div class="filter-bar">
      <select id="messageFilter" onchange="filterActivities()">
        <option value="all">T·∫•t c·∫£</option>
        <option value="today">H√¥m nay</option>
        <option value="week">Tu·∫ßn n√†y</option>
      </select>
      <input type="text" 
             id="messageSearch" 
             placeholder="T√¨m ki·∫øm..." 
             oninput="filterActivities()">
    </div>
    
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value" id="totalMessages">0</div>
        <div class="stat-label">T·ªïng tin nh·∫Øn</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="todayMessages">0</div>
        <div class="stat-label">H√¥m nay</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="repliedMessages">0</div>
        <div class="stat-label">ƒê√£ reply</div>
      </div>
    </div>
    
    <div id="messagesList">
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: CRUD -->
  <div id="crudTab" class="tab-content">
    <div class="filter-bar">
      <select id="crudFilter" onchange="filterActivities()">
        <option value="all">T·∫•t c·∫£</option>
        <option value="create">T·∫°o m·ªõi</option>
        <option value="update">C·∫≠p nh·∫≠t</option>
        <option value="delete">X√≥a</option>
      </select>
      <input type="text" 
             id="crudSearch" 
             placeholder="T√¨m trigger..." 
             oninput="filterActivities()">
    </div>
    
    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-value" id="totalCreated">0</div>
        <div class="stat-label">ƒê√£ t·∫°o</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="totalUpdated">0</div>
        <div class="stat-label">ƒê√£ s·ª≠a</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="totalDeleted">0</div>
        <div class="stat-label">ƒê√£ x√≥a</div>
      </div>
    </div>
    
    <div id="crudList">
      <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông CRUD n√†o</p>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: All -->
  <div id="allTab" class="tab-content">
    <div class="filter-bar">
      <select id="allFilter" onchange="filterActivities()">
        <option value="all">T·∫•t c·∫£ ho·∫°t ƒë·ªông</option>
        <option value="messages">Ch·ªâ tin nh·∫Øn</option>
        <option value="crud">Ch·ªâ CRUD</option>
      </select>
      <input type="text" 
             id="allSearch" 
             placeholder="T√¨m ki·∫øm..." 
             oninput="filterActivities()">
    </div>
    
    <div id="allList">
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>
      </div>
    </div>
  </div>

  <script>
    let activities = [];
    let currentTab = 'messages';
    let ws = null;
    
    // Connect WebSocket
    function connectWebSocket() {
      const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = wsProtocol + '//' + (window.opener ? window.opener.location.host : location.host);
      console.log('üîå Connecting:', wsUrl);

      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('‚úÖ Connected');
        ws.send(JSON.stringify({ type: 'get_activity_log' }));
      };
      
      ws.onclose = () => {
        console.log('‚ùå Disconnected');
        setTimeout(connectWebSocket, 3000);
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };
    }
    
    function handleMessage(data) {
      console.log('üì©', data.type);
      
      // Load activity log
      if (data.type === 'activity_log') {
        activities = data.activities || [];
        renderActivities();
        updateCounts();
      }
      
      // New message
      if (data.type === 'new_message' || data.type === 'auto_reply_new_message') {
        const activity = {
          id: Date.now(),
          type: 'message',
          action: 'received',
          timestamp: Date.now(),
          data: {
            senderName: data.senderName || 'Ng∆∞·ªùi d√πng',
            senderId: data.uid,
            content: data.content,
            replied: data.type === 'auto_reply_new_message',
            trigger: data.matchedKeyword || null
          }
        };
        
        activities.unshift(activity);
        renderActivities();
        updateCounts();
        saveToLocalStorage();
      }
      
      // Trigger CRUD
      if (data.type === 'trigger_created' || data.type === 'trigger_updated' || data.type === 'trigger_deleted') {
        const action = data.type.replace('trigger_', '');
        const activity = {
          id: Date.now(),
          type: 'crud',
          action: action,
          timestamp: Date.now(),
          data: data.trigger || { id: data.id, name: 'Unknown' }
        };
        
        activities.unshift(activity);
        renderActivities();
        updateCounts();
        saveToLocalStorage();
      }
    }
    
    function switchTab(tab) {
      currentTab = tab;
      
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'messages') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('messagesTab').classList.add('active');
      } else if (tab === 'crud') {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('crudTab').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[2].classList.add('active');
        document.getElementById('allTab').classList.add('active');
      }
      
      filterActivities();
    }
    
    function renderActivities() {
      renderMessages();
      renderCRUD();
      renderAll();
    }
    
    function renderMessages() {
      const messages = activities.filter(a => a.type === 'message');
      const container = document.getElementById('messagesList');
      
      if (messages.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p></div>';
        return;
      }
      
      container.innerHTML = messages.map(a => `
        <div class="activity-item message">
          <div class="activity-header">
            <div class="activity-type">
              <span>üí¨</span>
              <span>${a.data.senderName}</span>
              ${a.data.replied ? '<span class="activity-badge badge-create">ƒê√É REPLY</span>' : '<span class="activity-badge badge-message">M·ªöI</span>'}
            </div>
            <div class="activity-time">${formatTime(a.timestamp)}</div>
          </div>
          <div class="activity-content">
            ${escapeHtml(a.data.content)}
          </div>
          ${a.data.trigger ? `
          <div class="activity-details">
            <div class="detail-row">
              <span class="detail-label">üîë Trigger:</span>
              <span class="detail-value">${a.data.trigger}</span>
            </div>
          </div>
          ` : ''}
        </div>
      `).join('');
    }
    
    function renderCRUD() {
      const cruds = activities.filter(a => a.type === 'crud');
      const container = document.getElementById('crudList');
      
      if (cruds.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông CRUD n√†o</p></div>';
        return;
      }
      
      container.innerHTML = cruds.map(a => {
        const actionIcon = a.action === 'created' ? '‚ûï' : a.action === 'updated' ? '‚úèÔ∏è' : 'üóëÔ∏è';
        const actionText = a.action === 'created' ? 'T·∫°o m·ªõi' : a.action === 'updated' ? 'C·∫≠p nh·∫≠t' : 'X√≥a';
        const badgeClass = a.action === 'created' ? 'badge-create' : a.action === 'updated' ? 'badge-update' : 'badge-delete';
        
        return `
          <div class="activity-item ${a.action}">
            <div class="activity-header">
              <div class="activity-type">
                <span>${actionIcon}</span>
                <span>${actionText} trigger</span>
                <span class="activity-badge ${badgeClass}">${actionText.toUpperCase()}</span>
              </div>
              <div class="activity-time">${formatTime(a.timestamp)}</div>
            </div>
            <div class="activity-content">
              <strong>${escapeHtml(a.data.name || 'Unknown')}</strong>
            </div>
            ${a.data.id ? `
            <div class="activity-trigger-code">
              <div><strong>Trigger ID:</strong> ${a.data.id}</div>
              ${a.data.keywords ? `<div><strong>Keywords:</strong> ${a.data.keywords.join(', ')}</div>` : ''}
              ${a.data.enabled !== undefined ? `<div><strong>Status:</strong> ${a.data.enabled ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}</div>` : ''}
            </div>
            ` : ''}
            ${a.data.schedule || a.data.targeting ? `
            <div class="activity-details">
              ${a.data.schedule ? `
              <div class="detail-row">
                <span class="detail-label">‚è∞ L·ªãch:</span>
                <span class="detail-value">${a.data.schedule.startTime} - ${a.data.schedule.endTime}</span>
              </div>
              ` : ''}
              ${a.data.targeting ? `
              <div class="detail-row">
                <span class="detail-label">üë• Target:</span>
                <span class="detail-value">${getTargetText(a.data.targeting)}</span>
              </div>
              ` : ''}
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function renderAll() {
      const container = document.getElementById('allList');
      
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p></div>';
        return;
      }
      
      container.innerHTML = activities.map(a => {
        if (a.type === 'message') {
          return `
            <div class="activity-item message">
              <div class="activity-header">
                <div class="activity-type">
                  <span>üí¨</span>
                  <span>${a.data.senderName}</span>
                  ${a.data.replied ? '<span class="activity-badge badge-create">REPLIED</span>' : '<span class="activity-badge badge-message">NEW</span>'}
                </div>
                <div class="activity-time">${formatTime(a.timestamp)}</div>
              </div>
              <div class="activity-content">${escapeHtml(a.data.content)}</div>
            </div>
          `;
        } else {
          const actionIcon = a.action === 'created' ? '‚ûï' : a.action === 'updated' ? '‚úèÔ∏è' : 'üóëÔ∏è';
          const badgeClass = a.action === 'created' ? 'badge-create' : a.action === 'updated' ? 'badge-update' : 'badge-delete';
          return `
            <div class="activity-item ${a.action}">
              <div class="activity-header">
                <div class="activity-type">
                  <span>${actionIcon}</span>
                  <span>${a.action} trigger: ${escapeHtml(a.data.name || 'Unknown')}</span>
                  <span class="activity-badge ${badgeClass}">${a.action.toUpperCase()}</span>
                </div>
                <div class="activity-time">${formatTime(a.timestamp)}</div>
              </div>
            </div>
          `;
        }
      }).join('');
    }
    
    function updateCounts() {
      const messages = activities.filter(a => a.type === 'message');
      const cruds = activities.filter(a => a.type === 'crud');
      
      document.getElementById('messagesCount').textContent = messages.length;
      document.getElementById('crudCount').textContent = cruds.length;
      document.getElementById('allCount').textContent = activities.length;
      
      // Messages stats
      document.getElementById('totalMessages').textContent = messages.length;
      const today = Date.now() - 24 * 60 * 60 * 1000;
      document.getElementById('todayMessages').textContent = messages.filter(m => m.timestamp > today).length;
      document.getElementById('repliedMessages').textContent = messages.filter(m => m.data.replied).length;
      
      // CRUD stats
      document.getElementById('totalCreated').textContent = cruds.filter(c => c.action === 'created').length;
      document.getElementById('totalUpdated').textContent = cruds.filter(c => c.action === 'updated').length;
      document.getElementById('totalDeleted').textContent = cruds.filter(c => c.action === 'deleted').length;
      
      // Update opener badge if exists
      if (window.opener) {
        try {
          const badge = window.opener.document.getElementById('notificationBadge');
          if (badge) {
            const unread = messages.filter(m => !m.data.replied).length;
            if (unread > 0) {
              badge.textContent = unread > 99 ? '99+' : unread;
              badge.style.display = 'block';
            }
          }
        } catch (e) {
          console.log('Cannot update opener badge');
        }
      }
    }
    
    function filterActivities() {
      // Implement filtering logic here
      renderActivities();
    }
    
    function clearAllActivities() {
      if (confirm('X√≥a t·∫•t c·∫£ l·ªãch s·ª≠?')) {
        activities = [];
        renderActivities();
        updateCounts();
        saveToLocalStorage();
      }
    }
    
    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'V·ª´a xong';
      if (diff < 3600000) return Math.floor(diff / 60000) + ' ph√∫t tr∆∞·ªõc';
      if (diff < 86400000) return Math.floor(diff / 3600000) + ' gi·ªù tr∆∞·ªõc';
      
      const date = new Date(timestamp);
      return date.toLocaleString('vi-VN');
    }
    
    function getTargetText(targeting) {
      if (!targeting) return 'T·∫•t c·∫£';
      if (targeting.type === 'all') return 'T·∫•t c·∫£ ng∆∞·ªùi d√πng';
      if (targeting.type === 'new') return 'Ch·ªâ ng∆∞·ªùi l·∫°';
      if (targeting.type === 'friends') return 'Ch·ªâ b·∫°n b√®';
      if (targeting.type === 'specific') return 'Ng∆∞·ªùi c·ª• th·ªÉ (' + (targeting.userIds?.length || 0) + ')';
      return 'Kh√¥ng r√µ';
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function saveToLocalStorage() {
      try {
        localStorage.setItem('zalo_activities', JSON.stringify(activities.slice(0, 100))); // Keep last 100
      } catch (e) {
        console.log('Cannot save to localStorage');
      }
    }
    
    function loadFromLocalStorage() {
      try {
        const stored = localStorage.getItem('zalo_activities');
        if (stored) {
          activities = JSON.parse(stored);
          renderActivities();
          updateCounts();
        }
      } catch (e) {
        console.log('Cannot load from localStorage');
      }
    }
    
    // Initialize
    loadFromLocalStorage();
    connectWebSocket();
  </script>
</body>
</html>