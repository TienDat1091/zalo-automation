<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ªïng Thanh To√°n - Zalo Bot</title>
    <link rel="stylesheet" href="/assets/style_bank_manager.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>üí≥ C·ªïng Thanh To√°n</h1>
            <div class="header-actions">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('statistics')">üìä Th·ªëng k√™</button>
                    <button class="tab" onclick="switchTab('transactions')">üìã Transactions</button>
                    <button class="tab" onclick="switchTab('gates')">üè¶ Payment Gates</button>
                    <button class="tab" onclick="switchTab('sepay')">‚ö° SEPAY Config</button>
                    <button class="tab" onclick="switchTab('bank-api')">üîß Bank API Lookup</button>
                </div>
                <a href="/unified-manager.html" class="btn btn-primary">
                    <span>üè†</span>
                    <span>Dashboard</span>
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Stats Summary Cards -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="icon blue">üìã</div>
                <div class="value" id="totalTransactions">0</div>
                <div class="label">T·ªïng giao d·ªãch</div>
            </div>
            <div class="stat-card">
                <div class="icon orange">‚è≥</div>
                <div class="value" id="waitingCount">0</div>
                <div class="label">ƒêang ch·ªù</div>
            </div>
            <div class="stat-card">
                <div class="icon green">‚úÖ</div>
                <div class="value" id="paidCount">0</div>
                <div class="label">ƒê√£ thanh to√°n</div>
            </div>
            <div class="stat-card">
                <div class="icon green">üí∞</div>
                <div class="value" id="totalAmount">0ƒë</div>
                <div class="label">T·ªïng thu</div>
            </div>
            <div class="stat-card">
                <div class="icon purple">üìà</div>
                <div class="value" id="successRate">0%</div>
                <div class="label">T·ª∑ l·ªá th√†nh c√¥ng</div>
            </div>
        </div>

        <!-- Tab: Statistics -->
        <div id="tab-statistics" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>üìä Th·ªëng k√™ giao d·ªãch</h2>
                    <button class="btn btn-outline" onclick="loadStatistics()">üîÑ L√†m m·ªõi</button>
                </div>
                <div class="card-body">
                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <div>
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: #555;">üèÜ Top kh√°ch h√†ng (Thanh to√°n
                                nhi·ªÅu nh·∫•t)</h3>
                            <canvas id="topUsersChart" style="max-height: 400px;"></canvas>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: #555;">üìÖ Doanh thu theo th√°ng</h3>
                            <canvas id="monthlyChart" style="max-height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Transactions (Simplified - View & Delete only) -->
        <div id="tab-transactions" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>üìã Danh s√°ch giao d·ªãch</h2>
                    <button class="btn btn-outline" onclick="loadTransactions()">üîÑ L√†m m·ªõi</button>
                </div>
                <div class="filter-bar">
                    <input type="text" id="searchTransaction" placeholder="üîç T√¨m m√£ giao d·ªãch..."
                        oninput="filterTransactions()">
                    <select id="filterStatus" onchange="filterTransactions()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="WAITING">ƒêang ch·ªù</option>
                        <option value="PAID">ƒê√£ thanh to√°n</option>
                        <option value="EXPIRED">H·∫øt h·∫°n</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>M√£ GD</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Kh√°ch h√†ng</th>
                                    <th>S·ªë ti·ªÅn</th>
                                    <th>Th·ªùi gian t·∫°o</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <div class="icon">üìã</div>
                                            <h3>Ch∆∞a c√≥ giao d·ªãch n√†o</h3>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Payment Gates (with SEPAY Integration) -->
        <div id="tab-gates" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>üè¶ C·ªïng thanh to√°n</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn btn-outline" onclick="loadPaymentGates()">üîÑ L√†m m·ªõi</button>
                        <button class="btn btn-primary" onclick="openCreateGate()" style="background: #6366f1;">+ Th√™m
                            c·ªïng</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="gatesGrid" class="gates-grid">
                        <div class="empty-state">
                            <div class="icon">üè¶</div>
                            <h3>Ch∆∞a c√≥ c·ªïng thanh to√°n n√†o</h3>
                            <p>Th√™m c·ªïng thanh to√°n ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n ti·ªÅn</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: SEPAY Config -->
        <div id="tab-sepay" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">‚ö°</span>
                        <h2 style="margin: 0;">C·∫•u h√¨nh SEPAY</h2>
                    </div>
                    <button class="btn btn-outline" onclick="testSepayConnection()">üîå Test k·∫øt n·ªëi</button>
                </div>
                <div class="sepay-config-grid">
                    <div class="form-group">
                        <label>Account ID</label>
                        <input type="text" id="sepayAccountId" class="form-control" placeholder="Nh·∫≠p Account ID">
                    </div>
                    <div class="form-group">
                        <label>API Token</label>
                        <input type="password" id="sepayToken" class="form-control" placeholder="Nh·∫≠p API Token"
                            value="MIGYJCVUTLD0XPGSYFRXGW14MENB76PFLEJTUUNFK6C3ZDALWKSBTFO5TJGPNEUH">
                    </div>
                    <div class="form-group full-width">
                        <label>Webhook URL (Copy ƒë·ªãa ch·ªâ n√†y v√†o SEPAY dashboard)</label>
                        <div class="input-with-button">
                            <input type="text" id="webhookUrl" class="form-control" readonly>
                            <button class="btn btn-primary" onclick="copyWebhookUrl()">üìã Copy</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <button class="btn btn-success btn-lg" onclick="saveSepayConfig()">üíæ L∆∞u c·∫•u h√¨nh</button>
                </div>
            </div>
        </div>

        <!-- Tab: Bank API Lookup Config -->
        <div id="tab-bank-api" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">üîß</span>
                        <h2 style="margin: 0;">C·∫•u h√¨nh API Ki·ªÉm tra ng√¢n h√†ng</h2>
                    </div>
                </div>
                <div class="card-body">
                    <div class="info-box" style="margin: 24px;">
                        <strong>T·∫°i sao c·∫ßn c·∫•u h√¨nh n√†y?</strong><br>
                        ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c 100% khi kh√°ch h√†ng thanh to√°n, h·ªá th·ªëng c·∫ßn ki·ªÉm tra s·ªë t√†i kho·∫£n
                        tr·ª±c ti·∫øp v·ªõi ng√¢n h√†ng.
                        B·∫°n c√≥ th·ªÉ l·∫•y API Key mi·ªÖn ph√≠ t·∫°i <a href="https://vietqr.io/" target="_blank">VietQR.io</a>.
                    </div>
                    <div class="sepay-config-grid">
                        <div class="form-group">
                            <label>VietQR API Key <span style="color:red;">*</span></label>
                            <input type="password" id="vietqrApiKey" class="form-control"
                                placeholder="Nh·∫≠p API Key t·ª´ vietqr.io">
                        </div>
                        <div class="form-group">
                            <label>VietQR Client ID (T√πy ch·ªçn)</label>
                            <input type="text" id="vietqrClientId" class="form-control"
                                placeholder="Nh·∫≠p Client ID (n·∫øu c√≥)">
                        </div>
                    </div>
                    <div style="padding: 0 24px 24px 24px;">
                        <button class="btn btn-primary btn-lg" onclick="saveVietQRCredentials()"
                            style="background: #6366f1;">üíæ L∆∞u c·∫•u h√¨nh API</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Payment Gate -->
    <div id="gateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="gateModalTitle">Th√™m c·ªïng thanh to√°n</h2>
                <button class="close-btn" onclick="closeGateModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Payment Gate Form Fields -->
                <div class="form-group">
                    <label>T√™n c·ªïng <span style="color:red;">*</span></label>
                    <input type="text" id="gateName" class="form-control" placeholder="VD: T√†i kho·∫£n ch√≠nh">
                </div>
                <div class="form-group">
                    <label>Ch·ªçn ng√¢n h√†ng <span style="color:red;">*</span></label>
                    <select id="bankSelect" class="form-control" onchange="fillBankCode()">
                        <option value="">-- Ch·ªçn ng√¢n h√†ng --</option>
                        <option value="970405">Agribank</option>
                        <option value="970416">ACB</option>
                        <option value="970418">BIDV</option>
                        <option value="970415">VietinBank</option>
                        <option value="970436">Vietcombank</option>
                        <option value="970422">MB Bank</option>
                        <option value="970407">Techcombank</option>
                        <option value="970432">VPBank</option>
                        <option value="970423">TPBank</option>
                        <option value="970403">Sacombank</option>
                        <option value="970437">HDBank</option>
                        <option value="970441">VIB</option>
                        <option value="970443">SHB</option>
                        <option value="970431">Eximbank</option>
                        <option value="970426">MSB</option>
                        <option value="970406">DongA Bank</option>
                        <option value="970448">OCB</option>
                        <option value="970440">SeABank</option>
                        <option value="970419">NCB</option>
                        <option value="970424">Shinhan Bank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√£ ng√¢n h√†ng (BIN) <span style="color:red;">*</span></label>
                    <input type="text" id="bankCode" class="form-control" placeholder="T·ª± ƒë·ªông ƒëi·ªÅn" readonly>
                </div>
                <div class="form-group">
                    <label>S·ªë t√†i kho·∫£n <span style="color:red;">*</span></label>
                    <div class="input-with-button">
                        <input type="text" id="accountNumber" class="form-control" placeholder="VD: 102875037553"
                            oninput="resetVerification()">
                        <button class="btn btn-outline" onclick="verifyAccount()" id="btnVerify">üîç Ki·ªÉm tra</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>T√™n ch·ªß t√†i kho·∫£n <span style="color:red;">*</span></label>
                    <input type="text" id="accountName" class="form-control" placeholder="T·ª± ƒë·ªông ƒëi·ªÅn sau khi ki·ªÉm tra"
                        readonly>
                    <small id="verifyStatus" style="display:none; margin-top: 4px; font-weight: 500;"></small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="isDefault">
                        <span>ƒê·∫∑t l√†m c·ªïng m·∫∑c ƒë·ªãnh</span>
                    </label>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeGateModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="savePaymentGate()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <script src="/assets/websocket-helper.js"></script>
    <script>
        let allTransactions = [];
        let allGates = [];
        let topUsersChart = null;
        let monthlyChart = null;

        // Initialize
        window.onload = function () {
            loadStatistics();
            loadTransactions();
            loadPaymentGates();
            loadSepayConfig();
            loadVietQRStatus();

            const host = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
            document.getElementById('webhookUrl').value = `${protocol}://${host}${port ? ':' + port : ''}/api/sepay/webhook`;

            // WebSocket for realtime updates
            setupWebSocket();
        };

        // WebSocket Realtime Updates
        function setupWebSocket() {
            try {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}`;
                const ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('‚úÖ WebSocket connected for realtime updates');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        // Transaction created/updated
                        if (data.type === 'transaction_created' || data.type === 'transaction_updated') {
                            console.log('üîî Transaction update received');
                            loadTransactions();
                            loadStatistics();
                        }

                        // Payment received
                        if (data.type === 'payment_received') {
                            console.log('üí∞ Payment received');
                            loadTransactions();
                            loadStatistics();
                        }
                    } catch (err) {
                        console.error('WebSocket message parse error:', err);
                    }
                };

                ws.onerror = (error) => {
                    console.warn('WebSocket error:', error);
                };

                ws.onclose = () => {
                    console.log('‚ùå WebSocket disconnected. Reconnecting in 5s...');
                    setTimeout(setupWebSocket, 5000);
                };
            } catch (error) {
                console.error('WebSocket setup error:', error);
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // Set active tab button
            const clickedBtn = Array.from(document.querySelectorAll('.tab')).find(b => b.getAttribute('onclick')?.includes(`'${tabName}'`));
            if (clickedBtn) clickedBtn.classList.add('active');

            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'statistics') loadStatistics();
            if (tabName === 'transactions') loadTransactions();
            if (tabName === 'gates') loadPaymentGates();
            if (tabName === 'sepay') loadSepayConfig();
            if (tabName === 'bank-api') loadVietQRStatus();
        }

        // ==================== STATISTICS ====================
        async function loadStatistics() {
            try {
                const [summaryRes, topUsersRes, monthlyRes] = await Promise.all([
                    fetch('/api/transactions/stats/summary'),
                    fetch('/api/transactions/stats/top-users?limit=10'),
                    fetch('/api/transactions/stats/monthly?year=2026')
                ]);

                const summary = await summaryRes.json();
                const topUsers = await topUsersRes.json();
                const monthly = await monthlyRes.json();

                // Update summary cards
                document.getElementById('totalTransactions').textContent = summary.data.total;
                document.getElementById('waitingCount').textContent = summary.data.waiting;
                document.getElementById('paidCount').textContent = summary.data.paid;
                document.getElementById('totalAmount').textContent = formatCurrency(summary.data.totalAmount);
                document.getElementById('successRate').textContent = summary.data.successRate + '%';

                // Render charts
                renderTopUsersChart(topUsers.data);
                renderMonthlyChart(monthly.data);
            } catch (error) {
                console.error('Load statistics error:', error);
            }
        }

        function renderTopUsersChart(data) {
            const ctx = document.getElementById('topUsersChart').getContext('2d');

            if (topUsersChart) topUsersChart.destroy();

            topUsersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(u => u.senderName || u.senderAccount || 'Unknown'),
                    datasets: [{
                        label: 'T·ªïng ti·ªÅn (VNƒê)',
                        data: data.map(u => u.totalAmount),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return formatCurrency(context.parsed.x) + ' VNƒê';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function (value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart(data) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            if (monthlyChart) monthlyChart.destroy();

            const monthNames = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(m => monthNames[m.month - 1]),
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: data.map(m => m.totalAmount),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return formatCurrency(context.parsed.y) + ' VNƒê';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== TRANSACTIONS ====================
        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                allTransactions = data.transactions || [];
                renderTransactions(allTransactions);
            } catch (error) {
                console.error('Load transactions error:', error);
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsTable');

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="icon">üìã</div>
                <h3>Ch∆∞a c√≥ giao d·ªãch n√†o</h3>
              </div>
            </td>
          </tr>
        `;
                return;
            }

            tbody.innerHTML = transactions.map((txn, index) => `
        <tr>
          <td>${index + 1}</td>
          <td><code>${txn.transactionCode}</code></td>
          <td><span class="badge ${getBadgeClass(txn.status)}">${getStatusText(txn.status)}</span></td>
          <td>${txn.senderName || txn.senderAccount || '-'}</td>
          <td><strong>${formatCurrency(txn.amount)} VNƒê</strong></td>
          <td>${formatDateTime(txn.createdAt)}</td>
          <td>
            <button class="btn-icon" onclick="deleteTransaction(${txn.transactionID})" title="X√≥a">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
        }

        function filterTransactions() {
            const search = document.getElementById('searchTransaction').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            let filtered = allTransactions.filter(txn => {
                const matchSearch = !search || txn.transactionCode.toLowerCase().includes(search);
                const matchStatus = !status || txn.status === status;
                return matchSearch && matchStatus;
            });

            renderTransactions(filtered);
        }

        async function deleteTransaction(id) {
            if (!confirm('X√≥a giao d·ªãch n√†y?')) return;

            try {
                const response = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ x√≥a');
                    loadTransactions();
                    loadStatistics();
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // ==================== PAYMENT GATES ====================
        async function loadPaymentGates() {
            try {
                const response = await fetch('/api/payment-gates');
                const data = await response.json();
                allGates = data.gates || [];
                renderPaymentGates(allGates);
            } catch (error) {
                console.error('Load gates error:', error);
            }
        }

        function renderPaymentGates(gates) {
            const grid = document.getElementById('gatesGrid');

            if (!gates || gates.length === 0) {
                grid.innerHTML = `
          <div class="empty-state">
            <div class="icon">üè¶</div>
            <h3>Ch∆∞a c√≥ c·ªïng thanh to√°n n√†o</h3>
            <p>Th√™m c·ªïng thanh to√°n ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n ti·ªÅn</p>
          </div>
        `;
                return;
            }

            grid.innerHTML = gates.map(gate => `
        <div class="gate-card ${gate.isDefault ? 'default' : ''}">
          <div class="gate-header">
            <h3>${gate.gateName}</h3>
            ${gate.isDefault ? '<span class="badge success">M·∫∑c ƒë·ªãnh</span>' : ''}
          </div>
          <div class="gate-body">
            <p><strong>Ng√¢n h√†ng:</strong> ${gate.bankCode}</p>
            <p><strong>STK:</strong> ${gate.accountNumber}</p>
            <p><strong>Ch·ªß TK:</strong> ${gate.accountName}</p>
          </div>
          <div class="gate-actions">
            ${!gate.isDefault ? `<button class="btn btn-sm" onclick="setDefaultGate(${gate.gateID})">‚≠ê ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
            <button class="btn btn-sm btn-danger" onclick="deleteGate(${gate.gateID})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
        }

        function openCreateGate() {
            document.getElementById('gateModalTitle').textContent = 'Th√™m c·ªïng thanh to√°n';
            document.getElementById('gateName').value = '';
            document.getElementById('bankSelect').value = '';
            document.getElementById('bankCode').value = '';
            document.getElementById('accountNumber').value = '';
            document.getElementById('accountName').value = '';
            document.getElementById('isDefault').checked = false;
            resetVerification();
            document.getElementById('gateModal').classList.add('active');
        }

        function closeGateModal() {
            document.getElementById('gateModal').classList.remove('active');
        }


        function fillBankCode() {
            const select = document.getElementById('bankSelect');
            document.getElementById('bankCode').value = select.value;
            // Clear verification if bank changes
            resetVerification();
        }

        function resetVerification() {
            const nameEl = document.getElementById('accountName');
            nameEl.value = '';
            nameEl.readOnly = true;
            document.getElementById('verifyStatus').style.display = 'none';
            isVerified = false;
        }

        let isVerified = false;

        async function verifyAccount() {
            const accountNumber = document.getElementById('accountNumber').value;
            const bankBin = document.getElementById('bankCode').value;
            const statusEl = document.getElementById('verifyStatus');
            const nameEl = document.getElementById('accountName');
            const btn = document.getElementById('btnVerify');

            if (!accountNumber || !bankBin) {
                alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√¢n h√†ng v√† nh·∫≠p s·ªë t√†i kho·∫£n!');
                return;
            }

            try {
                btn.disabled = true;
                btn.textContent = '‚è±Ô∏è ƒêang check...';
                statusEl.style.display = 'block';
                statusEl.textContent = '‚è≥ ƒêang x√°c th·ª±c th√¥ng tin...';
                statusEl.style.color = '#64748b';
                nameEl.readOnly = true;

                const response = await fetch('/api/bank/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountNumber, bankBin })
                });

                const result = await response.json();

                if (result.success && result.accountName) {
                    nameEl.value = result.accountName;
                    statusEl.innerHTML = '‚úÖ <b>X√°c th·ª±c th√†nh c√¥ng!</b>';
                    statusEl.style.color = '#10b981';
                    isVerified = true;
                    nameEl.readOnly = true;
                } else {
                    console.warn('Verification failed:', result.error);
                    statusEl.innerHTML = '‚ö†Ô∏è <b>Kh√¥ng th·ªÉ x√°c th·ª±c t·ª± ƒë·ªông (L·ªói API).</b><br>T√†i kho·∫£n v·∫´n h·ª£p l·ªá, h√£y <u>t·ª± nh·∫≠p t√™n ch·ªß t√†i kho·∫£n</u> b√™n d∆∞·ªõi ƒë·ªÉ ti·∫øp t·ª•c!';
                    statusEl.style.color = '#f59e0b';
                    nameEl.readOnly = false;
                    nameEl.placeholder = 'Nh·∫≠p t√™n ch·ªß t√†i kho·∫£n (V√ç D·ª§: NGUYEN VAN A)';
                    nameEl.focus();
                    isVerified = true; // Mark as processed to allow saving
                }
            } catch (error) {
                console.error('Connection error:', error);
                statusEl.textContent = '‚ö†Ô∏è L·ªói k·∫øt n·ªëi. Vui l√≤ng t·ª± nh·∫≠p t√™n!';
                statusEl.style.color = '#f59e0b';
                nameEl.readOnly = false; // UNLOCK on failure
                isVerified = true;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Ki·ªÉm tra';
            }
        }

        async function savePaymentGate() {
            const data = {
                gateName: document.getElementById('gateName').value,
                bankCode: document.getElementById('bankCode').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountName: document.getElementById('accountName').value,
                isDefault: document.getElementById('isDefault').checked ? 1 : 0
            };

            if (!data.gateName || !data.bankCode || !data.accountNumber || !data.accountName) {
                alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            if (!isVerified) {
                alert('‚ö†Ô∏è B·∫°n c·∫ßn b·∫•m n√∫t "Ki·ªÉm tra" ƒë·ªÉ x√°c th·ª±c t√†i kho·∫£n tr∆∞·ªõc khi l∆∞u!');
                return;
            }

            try {
                const response = await fetch('/api/payment-gates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ l∆∞u c·ªïng thanh to√°n!');
                    closeGateModal();
                    loadPaymentGates();
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        async function setDefaultGate(gateID) {
            try {
                const response = await fetch(`/api/payment-gates/${gateID}/set-default`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ ƒë·∫∑t l√†m m·∫∑c ƒë·ªãnh!');
                    loadPaymentGates();
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        async function deleteGate(gateID) {
            if (!confirm('X√≥a c·ªïng thanh to√°n n√†y?')) return;

            try {
                const response = await fetch(`/api/payment-gates/${gateID}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ x√≥a!');
                    loadPaymentGates();
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // ==================== SEPAY CONFIG ====================
        async function loadSepayConfig() {
            try {
                const response = await fetch('/api/sepay/status');
                const data = await response.json();

                if (data.accountId) {
                    document.getElementById('sepayAccountId').value = data.accountId;
                }
            } catch (error) {
                console.error('Load SEPAY config error:', error);
            }
        }

        async function saveSepayConfig() {
            const data = {
                accountId: document.getElementById('sepayAccountId').value,
                token: document.getElementById('sepayToken').value
            };

            if (!data.accountId || !data.token) {
                alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            try {
                const response = await fetch('/api/sepay/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh SEPAY!');
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        async function testSepayConnection() {
            try {
                const response = await fetch('/api/sepay/test-connection');
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!');
                } else {
                    alert('‚ùå K·∫øt n·ªëi th·∫•t b·∫°i: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        function copyWebhookUrl() {
            const input = document.getElementById('webhookUrl');
            input.select();
            document.execCommand('copy');
            alert('‚úÖ ƒê√£ copy webhook URL!');
        }

        // ==================== UTILITIES ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount || 0);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString('vi-VN');
        }

        function getBadgeClass(status) {
            const classes = {
                'WAITING': 'warning',
                'PAID': 'success',
                'EXPIRED': 'danger'
            };
            return classes[status] || '';
        }

        function getStatusText(status) {
            const texts = {
                'WAITING': 'ƒêang ch·ªù',
                'PAID': 'ƒê√£ thanh to√°n',
                'EXPIRED': 'H·∫øt h·∫°n'
            };
            return texts[status] || status;
        }

        // ==================== VIETQR CONFIG ====================
        async function loadVietQRStatus() {
            try {
                const response = await fetch('/api/bank/vietqr/status');
                const data = await response.json();

                if (data.configured) {
                    document.getElementById('vietqrApiKey').placeholder = 'ƒê√£ c·∫•u h√¨nh: ' + data.apiKey;
                    if (data.clientId) {
                        document.getElementById('vietqrClientId').value = data.clientId;
                    }
                }
            } catch (error) {
                console.error('Load VietQR status error:', error);
            }
        }

        async function saveVietQRCredentials() {
            const data = {
                apiKey: document.getElementById('vietqrApiKey').value,
                clientId: document.getElementById('vietqrClientId').value
            };

            if (!data.apiKey) {
                alert('‚ùå Vui l√≤ng nh·∫≠p API Key!');
                return;
            }

            try {
                const response = await fetch('/api/bank/vietqr/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh VietQR!');
                    loadVietQRStatus();
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }
    </script>
</body>

</html>