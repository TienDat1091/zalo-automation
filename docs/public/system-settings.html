<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√†i ƒë·∫∑t H·ªá th·ªëng - Zalo Automation</title>
    <link rel="stylesheet" href="assets/style_dashboard.css">
    <link rel="stylesheet" href="/assets/unified-header.css?v=4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 64px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .settings-grid .settings-section:first-child {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .page-header h1 {
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-list {
            padding: 16px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #eee;
        }

        .setting-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .setting-item.enabled {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-color: #4caf50;
        }

        .setting-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .setting-info {
            flex: 1;
            min-width: 0;
        }

        .setting-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .setting-desc {
            font-size: 13px;
            color: #666;
        }

        .setting-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        .status-badge.on {
            background: #4caf50;
            color: white;
        }

        .status-badge.off {
            background: #e0e0e0;
            color: #666;
        }

        .config-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .config-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.6;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .info-box {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .info-box.blue {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }

        .info-box.orange {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #e65100;
        }

        .ttl-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .ttl-option:hover {
            background: #f5f5f5;
        }

        .ttl-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Reaction option buttons */
        .reaction-option {
            font-size: 24px;
            width: 44px;
            height: 44px;
            border: 2px solid #eee;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reaction-option:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .reaction-option.selected {
            border-color: #667eea;
            background: #e8f0fe;
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>‚öôÔ∏è C√†i ƒë·∫∑t H·ªá th·ªëng</h1>
        </div>

        <!-- SETTINGS GRID -->
        <div class="settings-grid">
            <!-- AUTO REPLY SECTION -->
            <div class="settings-section">
                <div class="section-header">
                    <span>üí¨</span> T·ª± ƒë·ªông Tr·∫£ l·ªùi
                </div>
                <div class="settings-list" id="autoReplySettings">
                    <div class="loading">ƒêang t·∫£i...</div>
                </div>
            </div>

            <!-- AUTOMATION SECTION -->
            <div class="settings-section">
                <div class="section-header">
                    <span>ü§ñ</span> T·ª± ƒë·ªông h√≥a
                </div>
                <div class="settings-list" id="automationSettings">
                    <div class="loading">ƒêang t·∫£i...</div>
                </div>
            </div>

            <!-- ADVANCED SECTION -->
            <div class="settings-section">
                <div class="section-header">
                    <span>‚ö°</span> N√¢ng cao
                </div>
                <div class="settings-list" id="advancedSettings">
                    <div class="loading">ƒêang t·∫£i...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTO MESSAGE MODAL -->
    <div class="modal-backdrop" id="autoMessageModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 id="autoMessageModalTitle"><span>üí¨</span> C√†i ƒë·∫∑t T·ª± ƒë·ªông tr·∫£ l·ªùi</h2>
                <button class="modal-close" onclick="hideAutoMessageModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue" id="autoMessageDesc">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông tr·∫£ l·ªùi tin nh·∫Øn ƒë·∫øn.
                </div>
                <div class="form-group">
                    <label class="form-label">üí¨ N·ªôi dung t·ª± ƒë·ªông tr·∫£ l·ªùi *</label>
                    <textarea class="form-input" id="autoMessageResponse" rows="5"
                        placeholder="VD: Xin ch√†o! Hi·ªán t·∫°i t√¥i ƒëang b·∫≠n..."></textarea>
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        üí° C√≥ th·ªÉ d√πng bi·∫øn: <code>{name}</code>, <code>{time}</code>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Cooldown (gi√¢y)</label>
                    <input type="number" class="form-input" id="autoMessageCooldown" min="0" value="30">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoMessageEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoMessageModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoMessageSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AUTO FRIEND MODAL -->
    <div class="modal-backdrop" id="autoFriendModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>üë•</span> C√†i ƒë·∫∑t Ch·∫•p nh·∫≠n k·∫øt b·∫°n</h2>
                <button class="modal-close" onclick="hideAutoFriendModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n v√† g·ª≠i tin nh·∫Øn ch√†o m·ª´ng.
                </div>
                <div class="form-group">
                    <label class="form-label">üí¨ Tin nh·∫Øn ch√†o m·ª´ng (t√πy ch·ªçn)</label>
                    <textarea class="form-input" id="autoFriendMessage" rows="4"
                        placeholder="VD: Ch√†o {name}! C·∫£m ∆°n b·∫°n ƒë√£ k·∫øt b·∫°n..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoFriendEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoFriendModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoFriendSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AUTO UNREAD MODAL -->
    <div class="modal-backdrop" id="autoUnreadModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>üîñ</span> C√†i ƒë·∫∑t ƒê√°nh d·∫•u ch∆∞a ƒë·ªçc</h2>
                <button class="modal-close" onclick="hideAutoUnreadModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box orange">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông ƒë√°nh d·∫•u h·ªôi tho·∫°i l√† <strong>Ch∆∞a ƒë·ªçc</strong> sau khi Bot
                    g·ª≠i tin
                    nh·∫Øn. Gi√∫p b·∫°n kh√¥ng b·ªè l·ª° tin nh·∫Øn kh√°ch h√†ng.
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoUnreadEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoUnreadModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoUnreadSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AUTO DELETE MODAL -->
    <div class="modal-backdrop" id="autoDeleteModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>üóëÔ∏è</span> C√†i ƒë·∫∑t T·ª± ƒë·ªông x√≥a tin nh·∫Øn</h2>
                <button class="modal-close" onclick="hideAutoDeleteModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông b·∫≠t <strong>Tin nh·∫Øn t·ª± x√≥a</strong> sau khi k·∫øt b·∫°n th√†nh
                    c√¥ng.
                </div>
                <div class="form-group">
                    <label class="form-label">‚è∞ Th·ªùi gian t·ª± x√≥a</label>
                    <label class="ttl-option">
                        <input type="radio" name="autoDeleteTTL" value="0">
                        <span>‚ùå</span> <span>Kh√¥ng t·ª± x√≥a</span>
                    </label>
                    <label class="ttl-option">
                        <input type="radio" name="autoDeleteTTL" value="86400000" checked>
                        <span>üóìÔ∏è</span> <span>Sau 1 ng√†y</span>
                    </label>
                    <label class="ttl-option">
                        <input type="radio" name="autoDeleteTTL" value="604800000">
                        <span>üìÖ</span> <span>Sau 7 ng√†y</span>
                    </label>
                    <label class="ttl-option">
                        <input type="radio" name="autoDeleteTTL" value="1209600000">
                        <span>üìÖ</span> <span>Sau 14 ng√†y</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoDeleteEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoDeleteModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoDeleteSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AI CONVERSATION MODAL -->
    <div class="modal-backdrop" id="aiConversationModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>ü§ñ</span> C√†i ƒë·∫∑t AI Conversation</h2>
                <button class="modal-close" onclick="hideAiConversationModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> Cho ph√©p tr√≤ chuy·ªán li√™n t·ª•c v·ªõi AI. Ng∆∞·ªùi d√πng g√µ l·ªánh b·∫≠t/t·∫Øt.
                </div>
                <div class="form-group">
                    <label class="form-label">üöÄ L·ªánh b·∫≠t AI</label>
                    <input type="text" class="form-input" id="aiCommandOn" value="/ai">
                </div>
                <div class="form-group">
                    <label class="form-label">‚èπÔ∏è L·ªánh t·∫Øt AI</label>
                    <input type="text" class="form-input" id="aiCommandOff" value="/ai-off">
                </div>
                <div class="form-group">
                    <label class="form-label">üìù System Prompt</label>
                    <textarea class="form-input" id="aiSystemPrompt"
                        rows="3">B·∫°n l√† tr·ª£ l√Ω AI th√¢n thi·ªán. Tr·∫£ l·ªùi ng·∫Øn g·ªçn v√† h·ªØu √≠ch.</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Timeout (ph√∫t)</label>
                    <input type="number" class="form-input" id="aiTimeout" value="30" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="aiEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAiConversationModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAiConversationSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- SELF TRIGGER MODAL -->
    <div class="modal-backdrop" id="selfTriggerModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>‚ö°</span> C√†i ƒë·∫∑t Self-Trigger</h2>
                <button class="modal-close" onclick="hideSelfTriggerModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box orange">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> Khi b·∫°n g√µ l·ªánh (VD: /hi), Bot s·∫Ω t·ª± ƒë·ªông g·ª≠i tin nh·∫Øn ho·∫∑c ch·∫°y k·ªãch
                    b·∫£n cho user ƒë√≥.
                </div>

                <div class="form-group">
                    <label class="form-label">üîë L·ªánh k√≠ch ho·∫°t</label>
                    <input type="text" class="form-input" id="selfTriggerCommand" placeholder="VD: /hi ho·∫∑c /info">
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        Khi b·∫°n g√µ l·ªánh n√†y, Bot s·∫Ω t·ª± ƒë·ªông ph·∫£n h·ªìi theo c·∫•u h√¨nh b√™n d∆∞·ªõi.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">üìã Lo·∫°i ph·∫£n h·ªìi</label>
                    <select class="form-input" id="selfTriggerType" onchange="toggleSelfTriggerType()">
                        <option value="text">üí¨ Tin nh·∫Øn vƒÉn b·∫£n</option>
                        <option value="flow">üîÑ Ch·∫°y k·ªãch b·∫£n (Flow)</option>
                    </select>
                </div>

                <div class="form-group" id="selfTriggerTextGroup">
                    <label class="form-label">üí¨ N·ªôi dung tin nh·∫Øn</label>
                    <textarea class="form-input" id="selfTriggerResponse" rows="3"
                        placeholder="Ch√†o bu·ªïi s√°ng! H√¥m nay b·∫°n c·∫ßn g√¨?"></textarea>
                </div>

                <div class="form-group" id="selfTriggerFlowGroup" style="display:none;">
                    <label class="form-label">üîÑ Ch·ªçn k·ªãch b·∫£n</label>
                    <select class="form-input" id="selfTriggerFlowId">
                        <option value="">-- Ch·ªçn k·ªãch b·∫£n --</option>
                    </select>
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        üí° K·ªãch b·∫£n ƒë∆∞·ª£c t·∫°o trong <a href="trigger-manager.html" target="_blank">Qu·∫£n l√Ω Trigger</a>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="selfTriggerEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideSelfTriggerModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveSelfTriggerSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AUTO FILE MODAL -->
    <div class="modal-backdrop" id="autoFileModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>üìÇ</span> C√†i ƒë·∫∑t Nh·∫≠n di·ªán File</h2>
                <button class="modal-close" onclick="hideAutoFileModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông ph·∫£n h·ªìi khi nh·∫≠n ƒë∆∞·ª£c file/·∫£nh theo ƒë·ªãnh d·∫°ng.
                </div>
                <div class="form-group">
                    <label class="form-label">üìù Quy t·∫Øc ph·∫£n h·ªìi (format: extension: message)</label>
                    <textarea class="form-input" id="autoFileResponse" rows="5"
                        placeholder="xlsx: B·∫°n ƒë√£ g·ª≠i file Excel&#10;pdf: B·∫°n ƒë√£ g·ª≠i file PDF&#10;default: ƒê√£ nh·∫≠n file c·ªßa b·∫°n"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Th·ªùi gian ch·ªù file cu·ªëi c√πng (gi√¢y)</label>
                    <input type="number" class="form-input" id="autoFileDebounce" min="1" value="15" placeholder="15">
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        üí° Sau khi nh·∫≠n file cu·ªëi c√πng, bot s·∫Ω ch·ªù kho·∫£ng th·ªùi gian n√†y r·ªìi m·ªõi ph·∫£n h·ªìi.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoFileEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoFileModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoFileSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- AUTO REACTION MODAL -->
    <div class="modal-backdrop" id="autoReactionModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><span>‚ù§Ô∏è</span> C√†i ƒë·∫∑t T·ª± ƒë·ªông th·∫£ c·∫£m x√∫c</h2>
                <button class="modal-close" onclick="hideAutoReactionModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-box blue">
                    <strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông th·∫£ c·∫£m x√∫c v√†o tin nh·∫Øn ƒë·∫ßu ti√™n v√† cu·ªëi c√πng khi user g·ª≠i
                    tin ƒë·∫øn.
                </div>
                <div class="form-group">
                    <label class="form-label">üíù Ch·ªçn c·∫£m x√∫c</label>
                    <div id="reactionSelector" style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="reaction-option" data-icon="/-heart"
                            onclick="selectReaction(this)">‚ù§Ô∏è</button>
                        <button type="button" class="reaction-option" data-icon="/-strong"
                            onclick="selectReaction(this)">üëç</button>
                        <button type="button" class="reaction-option" data-icon=":>"
                            onclick="selectReaction(this)">üòÜ</button>
                        <button type="button" class="reaction-option" data-icon=":o"
                            onclick="selectReaction(this)">üòÆ</button>
                        <button type="button" class="reaction-option" data-icon=":-("
                            onclick="selectReaction(this)">üò¢</button>
                    </div>
                    <input type="hidden" id="autoReactionIcon" value="/-heart">
                </div>
                <div class="form-group">
                    <label class="form-label">‚è±Ô∏è Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·∫£ (gi√¢y)</label>
                    <input type="number" class="form-input" id="autoReactionCooldown" min="5" value="30"
                        placeholder="30">
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        üí° Tr√°nh spam reaction, m·ªói user ch·ªâ ƒë∆∞·ª£c th·∫£ 1 l·∫ßn trong kho·∫£ng th·ªùi gian n√†y.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">‚è≥ Th·ªùi gian ch·ªù tin nh·∫Øn cu·ªëi (gi√¢y)</label>
                    <input type="number" class="form-input" id="autoReactionDebounce" min="1" value="3" placeholder="3">
                    <div style="font-size:11px; color:#999; margin-top:4px;">
                        üí° Ch·ªù user g·ª≠i xong tin nh·∫Øn cu·ªëi r·ªìi m·ªõi th·∫£ c·∫£m x√∫c.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="autoReactionEnabled" style="margin-right:6px;">
                        K√≠ch ho·∫°t t√≠nh nƒÉng n√†y
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoReactionModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="saveAutoReactionSetup()">üíæ L∆∞u</button>
            </div>
        </div>
    </div>

    <script>
        // Built-in triggers state
        const builtInTriggers = {
            autoReplyUser: {
                id: 'builtin_auto_reply_user',
                name: 'T·ª± ƒë·ªông tr·∫£ l·ªùi (C√° nh√¢n)',
                description: 'T·ª± ƒë·ªông tr·∫£ l·ªùi tin nh·∫Øn 1-1',
                icon: 'üë§',
                enabled: false,
                response: '',
                cooldown: 30000,
                section: 'autoReply'
            },
            autoReplyGroup: {
                id: 'builtin_auto_reply_group',
                name: 'T·ª± ƒë·ªông tr·∫£ l·ªùi (Nh√≥m)',
                description: 'T·ª± ƒë·ªông tr·∫£ l·ªùi tin nh·∫Øn nh√≥m',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                enabled: false,
                response: '',
                cooldown: 30000,
                section: 'autoReply'
            },
            autoAcceptFriend: {
                id: 'builtin_auto_friend',
                name: 'Ch·∫•p nh·∫≠n k·∫øt b·∫°n',
                description: 'T·ª± ƒë·ªông ƒë·ªìng √Ω l·ªùi m·ªùi k·∫øt b·∫°n',
                icon: 'üë•',
                enabled: false,
                welcomeMessage: '',
                section: 'automation'
            },
            autoFile: {
                id: 'builtin_auto_file',
                name: 'Nh·∫≠n di·ªán file',
                description: 'T·ª± ƒë·ªông tr·∫£ l·ªùi khi nh·∫≠n file/·∫£nh',
                icon: 'üìÇ',
                enabled: false,
                response: '',
                debounceTime: 15000,
                section: 'automation'
            },
            autoUnread: {
                id: 'builtin_auto_unread',
                name: 'ƒê√°nh d·∫•u ch∆∞a ƒë·ªçc',
                description: 'ƒê√°nh d·∫•u ch∆∞a ƒë·ªçc sau khi Bot ph·∫£n h·ªìi',
                icon: 'üîñ',
                enabled: false,
                section: 'automation'
            },
            autoDelete: {
                id: 'builtin_auto_delete_messages',
                name: 'T·ª± ƒë·ªông x√≥a tin nh·∫Øn',
                description: 'B·∫≠t tin nh·∫Øn t·ª± x√≥a sau khi k·∫øt b·∫°n',
                icon: 'üóëÔ∏è',
                enabled: false,
                response: '86400000',
                section: 'automation'
            },
            selfTrigger: {
                id: 'builtin_self_trigger',
                name: 'Self-Trigger',
                description: 'Bot ph·∫£n h·ªìi khi b·∫°n t·ª± g√µ l·ªánh',
                icon: '‚ö°',
                enabled: false,
                command: '',
                type: 'text',
                response: '',
                flowId: '',
                section: 'advanced'
            },
            aiConversation: {
                id: 'builtin_ai_conversation',
                name: 'AI Conversation',
                description: 'Tr√≤ chuy·ªán li√™n t·ª•c v·ªõi AI',
                icon: 'ü§ñ',
                enabled: false,
                commandOn: '/ai',
                commandOff: '/ai-off',
                systemPrompt: 'B·∫°n l√† tr·ª£ l√Ω AI th√¢n thi·ªán.',
                timeoutMinutes: 30,
                section: 'advanced'
            },
            autoReaction: {
                id: 'builtin_auto_reaction',
                name: 'T·ª± ƒë·ªông th·∫£ c·∫£m x√∫c',
                description: 'T·ª± ƒë·ªông th·∫£ c·∫£m x√∫c khi nh·∫≠n tin nh·∫Øn',
                icon: '‚ù§Ô∏è',
                enabled: false,
                reactionIcon: '/-heart',
                cooldown: 30000,
                debounceTime: 3000,
                section: 'advanced'
            }
        };

        let ws = null;
        let currentUser = null;

        // WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                ws.send(JSON.stringify({ type: 'get_current_user' }));
                ws.send(JSON.stringify({ type: 'get_builtin_triggers' }));
            };
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
            ws.onmessage = (e) => {
                try {
                    handleMessage(JSON.parse(e.data));
                } catch (err) {
                    console.error(err);
                }
            };
        }

        function handleMessage(data) {
            if (data.type === 'current_user' && data.user) {
                currentUser = data.user;
            }
            if (data.type === 'builtin_triggers' && data.triggers) {
                console.log('‚úÖ Received builtin_triggers from server:', Object.keys(data.triggers));
                console.log('   autoReaction in response?', 'autoReaction' in data.triggers);
                // Update local state from server
                for (const [key, value] of Object.entries(data.triggers)) {
                    if (builtInTriggers[key]) {
                        Object.assign(builtInTriggers[key], value);
                        console.log(`   Updated ${key}:`, value.enabled ? 'ENABLED' : 'disabled');
                    } else {
                        console.warn(`   ‚ö†Ô∏è Unknown trigger key: ${key}`);
                    }
                }
                renderSettings();
            }
            if (data.type === 'builtin_trigger_updated') {
                showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t c√†i ƒë·∫∑t!', 'success');
                // Refresh triggers
                ws.send(JSON.stringify({ type: 'get_builtin_triggers' }));
            }
            // Handle flows response for Self-Trigger
            if (data.type === 'flows_list' || data.type === 'flows') {
                const flows = data.flows || data.data || [];
                const select = document.getElementById('selfTriggerFlowId');
                if (select) {
                    select.innerHTML = '<option value="">-- Ch·ªçn k·ªãch b·∫£n --</option>';
                    flows.forEach(flow => {
                        const opt = document.createElement('option');
                        opt.value = flow.flowId || flow.id;
                        opt.textContent = flow.flowName || flow.name || `Flow ${flow.flowId || flow.id}`;
                        select.appendChild(opt);
                    });
                    // Select the pending flow if exists
                    if (window.pendingSelfTriggerFlowId) {
                        select.value = window.pendingSelfTriggerFlowId;
                        window.pendingSelfTriggerFlowId = null;
                    }
                }
            }
        }

        function renderSettings() {
            // Auto Reply section
            const autoReplyTriggers = Object.values(builtInTriggers).filter(t => t.section === 'autoReply');
            console.log('üìã Auto Reply triggers:', autoReplyTriggers.length, autoReplyTriggers.map(t => t.name));
            document.getElementById('autoReplySettings').innerHTML = autoReplyTriggers.map(renderSettingItem).join('');

            // Automation section
            const automationTriggers = Object.values(builtInTriggers).filter(t => t.section === 'automation');
            console.log('ü§ñ Automation triggers:', automationTriggers.length, automationTriggers.map(t => t.name));
            document.getElementById('automationSettings').innerHTML = automationTriggers.map(renderSettingItem).join('');

            // Advanced section
            const advancedTriggers = Object.values(builtInTriggers).filter(t => t.section === 'advanced');
            console.log('‚ö° Advanced triggers:', advancedTriggers.length, advancedTriggers.map(t => t.name));
            document.getElementById('advancedSettings').innerHTML = advancedTriggers.map(renderSettingItem).join('');
        }

        function renderSettingItem(trigger) {
            return `
        <div class="setting-item ${trigger.enabled ? 'enabled' : ''}" onclick="toggleSetting('${trigger.id}')">
          <div class="setting-icon">${trigger.icon}</div>
          <div class="setting-info">
            <div class="setting-name">${trigger.name}</div>
            <div class="setting-desc">${trigger.description}</div>
          </div>
          <div class="setting-actions">
            <span class="status-badge ${trigger.enabled ? 'on' : 'off'}">${trigger.enabled ? 'B·∫¨T' : 'T·∫ÆT'}</span>
            <button class="config-btn" onclick="event.stopPropagation(); openConfig('${trigger.id}')" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
          </div>
        </div>
      `;
        }

        function toggleSetting(triggerId) {
            const trigger = Object.values(builtInTriggers).find(t => t.id === triggerId);
            if (!trigger) return;

            trigger.enabled = !trigger.enabled;
            renderSettings();

            // Save to server
            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: triggerId,
                data: trigger
            }));
        }

        function openConfig(triggerId) {
            switch (triggerId) {
                case 'builtin_auto_reply_user':
                case 'builtin_auto_reply_group':
                    showAutoMessageSetup(triggerId);
                    break;
                case 'builtin_auto_friend':
                    showAutoFriendModal();
                    break;
                case 'builtin_auto_unread':
                    showAutoUnreadModal();
                    break;
                case 'builtin_auto_delete_messages':
                    showAutoDeleteModal();
                    break;
                case 'builtin_ai_conversation':
                    showAiConversationModal();
                    break;
                case 'builtin_self_trigger':
                    showSelfTriggerModal();
                    break;
                case 'builtin_auto_file':
                    showAutoFileModal();
                    break;
                case 'builtin_auto_reaction':
                    showAutoReactionModal();
                    break;
            }
        }

        // Modal handlers
        function showAutoMessageSetup(triggerId) {
            const trigger = triggerId === 'builtin_auto_reply_user' ?
                builtInTriggers.autoReplyUser : builtInTriggers.autoReplyGroup;
            const isUser = triggerId === 'builtin_auto_reply_user';

            document.getElementById('autoMessageModalTitle').innerHTML =
                `<span>${isUser ? 'üë§' : 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'}</span> C√†i ƒë·∫∑t Tr·∫£ l·ªùi t·ª± ƒë·ªông (${isUser ? 'C√° nh√¢n' : 'Nh√≥m'})`;
            document.getElementById('autoMessageDesc').innerHTML =
                `<strong>üìå Ch·ª©c nƒÉng:</strong> T·ª± ƒë·ªông tr·∫£ l·ªùi tin nh·∫Øn ${isUser ? '1-1' : 't·ª´ nh√≥m'}.`;
            document.getElementById('autoMessageResponse').value = trigger.response || '';
            document.getElementById('autoMessageCooldown').value = Math.floor((trigger.cooldown || 30000) / 1000);
            document.getElementById('autoMessageEnabled').checked = trigger.enabled;
            document.getElementById('autoMessageModal').dataset.triggerId = triggerId;
            document.getElementById('autoMessageModal').classList.add('show');
        }

        function hideAutoMessageModal() {
            document.getElementById('autoMessageModal').classList.remove('show');
        }

        function saveAutoMessageSetup() {
            const triggerId = document.getElementById('autoMessageModal').dataset.triggerId;
            const trigger = triggerId === 'builtin_auto_reply_user' ?
                builtInTriggers.autoReplyUser : builtInTriggers.autoReplyGroup;

            trigger.response = document.getElementById('autoMessageResponse').value.trim();
            trigger.cooldown = parseInt(document.getElementById('autoMessageCooldown').value) * 1000;
            trigger.enabled = document.getElementById('autoMessageEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: triggerId,
                data: trigger
            }));

            hideAutoMessageModal();
            renderSettings();
        }

        function showAutoFriendModal() {
            const trigger = builtInTriggers.autoAcceptFriend;
            document.getElementById('autoFriendMessage').value = trigger.welcomeMessage || '';
            document.getElementById('autoFriendEnabled').checked = trigger.enabled;
            document.getElementById('autoFriendModal').classList.add('show');
        }

        function hideAutoFriendModal() {
            document.getElementById('autoFriendModal').classList.remove('show');
        }

        function saveAutoFriendSetup() {
            const trigger = builtInTriggers.autoAcceptFriend;
            trigger.welcomeMessage = document.getElementById('autoFriendMessage').value.trim();
            trigger.enabled = document.getElementById('autoFriendEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_auto_friend',
                data: trigger
            }));

            hideAutoFriendModal();
            renderSettings();
        }

        function showAutoUnreadModal() {
            document.getElementById('autoUnreadEnabled').checked = builtInTriggers.autoUnread.enabled;
            document.getElementById('autoUnreadModal').classList.add('show');
        }

        function hideAutoUnreadModal() {
            document.getElementById('autoUnreadModal').classList.remove('show');
        }

        function saveAutoUnreadSetup() {
            builtInTriggers.autoUnread.enabled = document.getElementById('autoUnreadEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_auto_unread',
                data: builtInTriggers.autoUnread
            }));

            hideAutoUnreadModal();
            renderSettings();
        }

        function showAutoDeleteModal() {
            const trigger = builtInTriggers.autoDelete;
            const radios = document.getElementsByName('autoDeleteTTL');
            for (const r of radios) {
                r.checked = r.value === (trigger.response || '86400000');
            }
            document.getElementById('autoDeleteEnabled').checked = trigger.enabled;
            document.getElementById('autoDeleteModal').classList.add('show');
        }

        function hideAutoDeleteModal() {
            document.getElementById('autoDeleteModal').classList.remove('show');
        }

        function saveAutoDeleteSetup() {
            const radios = document.getElementsByName('autoDeleteTTL');
            let ttl = '86400000';
            for (const r of radios) {
                if (r.checked) { ttl = r.value; break; }
            }
            builtInTriggers.autoDelete.response = ttl;
            builtInTriggers.autoDelete.enabled = document.getElementById('autoDeleteEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_auto_delete_messages',
                data: builtInTriggers.autoDelete
            }));

            hideAutoDeleteModal();
            renderSettings();
        }

        function showAiConversationModal() {
            const trigger = builtInTriggers.aiConversation;
            document.getElementById('aiCommandOn').value = trigger.commandOn || '/ai';
            document.getElementById('aiCommandOff').value = trigger.commandOff || '/ai-off';
            document.getElementById('aiSystemPrompt').value = trigger.systemPrompt || '';
            document.getElementById('aiTimeout').value = trigger.timeoutMinutes || 30;
            document.getElementById('aiEnabled').checked = trigger.enabled;
            document.getElementById('aiConversationModal').classList.add('show');
        }

        function hideAiConversationModal() {
            document.getElementById('aiConversationModal').classList.remove('show');
        }

        function saveAiConversationSetup() {
            const trigger = builtInTriggers.aiConversation;
            trigger.commandOn = document.getElementById('aiCommandOn').value.trim();
            trigger.commandOff = document.getElementById('aiCommandOff').value.trim();
            trigger.systemPrompt = document.getElementById('aiSystemPrompt').value.trim();
            trigger.timeoutMinutes = parseInt(document.getElementById('aiTimeout').value) || 30;
            trigger.enabled = document.getElementById('aiEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_ai_conversation',
                data: trigger
            }));

            hideAiConversationModal();
            renderSettings();
        }

        function showSelfTriggerModal() {
            const trigger = builtInTriggers.selfTrigger;
            document.getElementById('selfTriggerCommand').value = trigger.command || '';
            document.getElementById('selfTriggerType').value = trigger.type || 'text';
            document.getElementById('selfTriggerResponse').value = trigger.response || '';
            document.getElementById('selfTriggerEnabled').checked = trigger.enabled;

            // Load flows from server
            loadFlowsForSelfTrigger(trigger.flowId);

            toggleSelfTriggerType();
            document.getElementById('selfTriggerModal').classList.add('show');
        }

        function hideSelfTriggerModal() {
            document.getElementById('selfTriggerModal').classList.remove('show');
        }

        function toggleSelfTriggerType() {
            const type = document.getElementById('selfTriggerType').value;
            document.getElementById('selfTriggerTextGroup').style.display = type === 'text' ? 'block' : 'none';
            document.getElementById('selfTriggerFlowGroup').style.display = type === 'flow' ? 'block' : 'none';
        }

        function loadFlowsForSelfTrigger(selectedFlowId) {
            ws.send(JSON.stringify({ type: 'get_flows', filter: 'all' }));

            // Handle response in message handler
            window.pendingSelfTriggerFlowId = selectedFlowId;
        }

        function saveSelfTriggerSetup() {
            const trigger = builtInTriggers.selfTrigger;
            trigger.command = document.getElementById('selfTriggerCommand').value.trim();
            trigger.type = document.getElementById('selfTriggerType').value;
            trigger.response = document.getElementById('selfTriggerResponse').value;
            trigger.flowId = document.getElementById('selfTriggerFlowId').value;
            trigger.enabled = document.getElementById('selfTriggerEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_self_trigger',
                data: trigger
            }));

            hideSelfTriggerModal();
            renderSettings();
        }

        function showAutoFileModal() {
            const trigger = builtInTriggers.autoFile;
            document.getElementById('autoFileResponse').value = trigger.response || '';
            document.getElementById('autoFileDebounce').value = Math.floor((trigger.debounceTime || 15000) / 1000);
            document.getElementById('autoFileEnabled').checked = trigger.enabled;
            document.getElementById('autoFileModal').classList.add('show');
        }

        function hideAutoFileModal() {
            document.getElementById('autoFileModal').classList.remove('show');
        }

        function saveAutoFileSetup() {
            builtInTriggers.autoFile.response = document.getElementById('autoFileResponse').value.trim();
            builtInTriggers.autoFile.debounceTime = parseInt(document.getElementById('autoFileDebounce').value) * 1000 || 15000;
            builtInTriggers.autoFile.enabled = document.getElementById('autoFileEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_auto_file',
                data: builtInTriggers.autoFile
            }));

            hideAutoFileModal();
            renderSettings();
        }

        // ============================================
        // AUTO REACTION MODAL
        // ============================================
        function showAutoReactionModal() {
            const trigger = builtInTriggers.autoReaction;
            document.getElementById('autoReactionIcon').value = trigger.reactionIcon || '/-heart';
            document.getElementById('autoReactionCooldown').value = Math.floor((trigger.cooldown || 30000) / 1000);
            document.getElementById('autoReactionDebounce').value = Math.floor((trigger.debounceTime || 3000) / 1000);
            document.getElementById('autoReactionEnabled').checked = trigger.enabled;

            // Highlight selected reaction
            const buttons = document.querySelectorAll('.reaction-option');
            buttons.forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.icon === trigger.reactionIcon);
            });

            document.getElementById('autoReactionModal').classList.add('show');
        }

        function hideAutoReactionModal() {
            document.getElementById('autoReactionModal').classList.remove('show');
        }

        function selectReaction(btn) {
            document.querySelectorAll('.reaction-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('autoReactionIcon').value = btn.dataset.icon;
        }

        function saveAutoReactionSetup() {
            builtInTriggers.autoReaction.reactionIcon = document.getElementById('autoReactionIcon').value;
            builtInTriggers.autoReaction.cooldown = parseInt(document.getElementById('autoReactionCooldown').value) * 1000 || 30000;
            builtInTriggers.autoReaction.debounceTime = parseInt(document.getElementById('autoReactionDebounce').value) * 1000 || 3000;
            builtInTriggers.autoReaction.enabled = document.getElementById('autoReactionEnabled').checked;

            ws.send(JSON.stringify({
                type: 'update_builtin_trigger',
                triggerId: 'builtin_auto_reaction',
                data: builtInTriggers.autoReaction
            }));

            hideAutoReactionModal();
            renderSettings();
        }

        // Toast notification
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; padding: 12px 24px;
        background: ${type === 'success' ? '#4caf50' : '#f44336'}; color: white;
        border-radius: 8px; z-index: 9999; animation: fadeIn 0.3s;
      `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        console.log('üöÄ System Settings initialized');
        console.log('üì¶ Built-in triggers defined:', Object.keys(builtInTriggers));
        console.log('   autoReaction defined?', 'autoReaction' in builtInTriggers);
        connectWebSocket();
        renderSettings();
    </script>

    <!-- Unified Header -->
    <script src="/assets/unified-header.js?v=4"></script>
</body>

</html>