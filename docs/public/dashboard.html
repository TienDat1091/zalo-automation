<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zalo Messenger</title>
  <link rel="stylesheet" href="assets/style_dashboard.css" />
  <style>
    /* ‚úÖ CSS cho tin nh·∫Øn Auto Reply */
    .message.auto-reply .message-content {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }

    .message.auto-reply .bubble {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }

    .auto-reply-badge {
      display: inline-block;
      background: #2196f3;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* ‚úÖ CSS cho n√∫t ƒë√≠nh k√®m */
    .attach-btn {
      background: #f5f5f5;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .attach-btn:hover {
      background: #e0e0e0;
    }

    /* ‚úÖ CSS cho attachment preview */
    .attachment-preview {
      position: absolute;
      bottom: 70px;
      left: 20px;
      right: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .attachment-preview .preview-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attachment-preview img {
      max-height: 80px;
      max-width: 120px;
      border-radius: 8px;
      object-fit: cover;
    }

    .attachment-preview .file-icon {
      font-size: 32px;
    }

    .attachment-preview .file-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .remove-attachment {
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 14px;
    }

    /* ‚úÖ CSS cho tin nh·∫Øn c√≥ attachment */
    .message-attachment {
      margin-top: 8px;
    }

    .message-attachment img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
    }

    .message-attachment .file-link {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f5f5f5;
      padding: 10px 14px;
      border-radius: 8px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
    }

    .message-attachment .file-link:hover {
      background: #e8e8e8;
    }

    .message-attachment .file-path {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      font-family: monospace;
    }

    /* ‚úÖ CSS cho Notification Bell */
    .notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #0068FF, #0052CC);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 104, 255, 0.3);
      z-index: 1000;
      transition: all 0.2s;
    }

    .notification-bell:hover {
      transform: scale(1.1);
    }

    .notification-bell .icon {
      font-size: 24px;
    }

    .notification-bell .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ‚úÖ CSS cho Notification Panel */
    .notification-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      max-height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      display: block;
    }

    .notification-panel .panel-header {
      background: linear-gradient(135deg, #0068FF, #0052CC);
      color: white;
      padding: 14px 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-panel .clear-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .notification-panel .panel-body {
      max-height: 340px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .notification-item:hover {
      background: #f5f8ff;
    }

    .notification-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .notification-item .info {
      flex: 1;
    }

    .notification-item .name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .notification-item .message {
      color: #666;
      font-size: 13px;
      margin-top: 2px;
    }

    .notification-item .time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px;
      text-align: center;
      color: #999;
    }

    /* Friend Request Modal */
    .fr-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .fr-modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 0;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .fr-header {
      padding: 15px 20px;
      background: #0068FF;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fr-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .fr-close {
      cursor: pointer;
      font-size: 24px;
    }

    .fr-body {
      padding: 0;
      max-height: 480px;
      overflow-y: auto;
    }

    .fr-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      gap: 12px;
    }

    .fr-item:hover {
      background: #f9f9f9;
    }

    .fr-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .message .bubble img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .message-attachment img {
      max-width: 100%;
      height: auto;
    }
  </style>
</head>

<body>
  <!-- üì± Mobile UI Elements -->
  <button class="mobile-toggle" id="mobileToggle" onclick="toggleMobileSidebar()">‚ò∞</button>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

  <div class="container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>Zalo Messenger</h1>
        <div class="user-info" id="userInfo" style="display:none;">
          <img id="userAvatar" src="" alt="Avatar">
          <div id="userName">ƒêang t·∫£i...</div>
          <div id="userUid" style="font-size:12px;"></div>

          <div class="button-group">
            <button class="backup-button" onclick="openStorageInfo()">
              <span>üìä</span> TH·ªêNG K√ä & QU·∫¢N L√ù
            </button>

            </button>

            <button class="storage-button" onclick="openFriendRequestsPanel()">
              <span>ü§ù</span> L·ªúI M·ªúI K·∫æT B·∫†N
            </button>

            <button class="storage-button" onclick="openAutoReplyViewer()">
              <span>ü§ñ</span> C√ÄI ƒê·∫∂T K·ªäCH B·∫¢N
            </button>
          </div>

          <button class="logout-btn" onclick="logout()">
            <span>üö™</span><span>ƒêƒÉng xu·∫•t</span>
          </button>
        </div>
      </div>

      <!-- ‚úÖ DUAL SEARCH TABS -->
      <div class="search-tabs">
        <button class="search-tab active" onclick="FriendTab('friends')">
          üë• B·∫°n b√®
        </button>
      </div>

      <!-- ‚úÖ FRIENDS SEARCH -->
      <div id="friendsSearch" class="search-content active">
        <div class="friends-search-box">
          <input type="text" id="friendsSearchInput" placeholder="üîç T√¨m b·∫°n b√® ho·∫∑c nh·∫≠p SƒêT..." autocomplete="off"
            onkeyup="searchFriends(this.value)">
        </div>
        <div class="search-results-container" id="friendsResults"></div>
      </div>

      <!-- ‚úÖ FRIENDS LIST -->
      <div class="friends-list" id="friendsList">
        <div class="loading-friends">
          <div class="spinner"></div>
          <div>ƒêang t·∫£i danh s√°ch...</div>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header" id="chatHeader" style="display:none;">
        <button class="mobile-back-btn" onclick="closeMobileSidebar()">‚Üê Danh s√°ch</button>
        <img id="chatAvatar" src="" alt="Avatar">
        <div class="info">
          <div class="name" id="chatName">Ch·ªçn b·∫°n b√®</div>
          <div class="uid" id="chatUid"></div>
          <div class="status">ƒêang ho·∫°t ƒë·ªông</div>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="empty-chat">
          <div class="icon">üí¨</div>
          <div>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        </div>
      </div>

      <div class="input-area" id="inputArea" style="display:none; position:relative;">
        <!-- ‚úÖ Preview ƒë√≠nh k√®m - ƒë·∫∑t trong input-area -->
        <div class="attachment-preview" id="attachmentPreview"
          style="display:none; position:absolute; bottom:100%; left:0; right:0; background:white; border:1px solid #e0e0e0; border-radius:8px; padding:8px 12px; margin-bottom:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:flex; align-items:center; gap:10px;">
            <img id="previewImage"
              style="display:none; max-height:60px; max-width:80px; border-radius:6px; object-fit:cover;">
            <div id="previewFile" style="display:none; align-items:center; gap:8px;">
              <span style="font-size:24px;">üìÑ</span>
              <span class="file-name" style="font-size:13px; color:#333;"></span>
            </div>
            <button onclick="removeAttachment()"
              style="margin-left:auto; background:#ff4757; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:12px;">‚úï</button>
          </div>
        </div>

        <button class="emoji-btn" onclick="openEmojiPicker()" title="Ch·ªçn emoji">üòä</button>
        <button class="attach-btn" onclick="document.getElementById('fileInput').click()"
          title="ƒê√≠nh k√®m file/·∫£nh">üìé</button>
        <input type="file" id="fileInput" style="display:none;"
          accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt" onchange="handleFileSelect(event)">
        <textarea id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
        <button type="button" id="sendBtn" onclick="sendMessage()">G·ª≠i</button>
      </div>
    </div>
  </div>

  <!-- üîî Notification Bell -->
  <div class="notification-bell" onclick="toggleNotificationPanel()" id="notificationBell">
    <span class="icon">üîî</span>
    <span class="badge" id="notificationBadge" style="display:none;">0</span>
  </div>

  <!-- üìã Notification Panel -->
  <div class="notification-panel" id="notificationPanel">
    <div class="panel-header">
      <span>üîî Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</span>
      <button class="clear-btn" onclick="clearNotifications()">X√≥a t·∫•t c·∫£</button>
    </div>
    <div class="panel-body" id="notificationList">
      <div class="notification-empty">Ch∆∞a c√≥ ho·∫°t ƒë·ªông m·ªõi</div>
    </div>
  </div>

  <!-- Fr Req Modal -->
  <div id="frModal" class="fr-modal">
    <div class="fr-modal-content">
      <div class="fr-header">
        <h3>L·ªùi m·ªùi k·∫øt b·∫°n</h3>
        <span class="fr-close" onclick="closeFriendRequestsPanel()">&times;</span>
      </div>
      <div class="fr-body" id="frList">
        <div style="padding:20px;text-align:center;color:#666;">ƒêang t·∫£i...</div>
      </div>
    </div>
  </div>

  <script src="assets/websocket-helper.js"></script>
  <script>
    // ========== üîí CLEAN URL - ·∫®n th√¥ng tin nh·∫°y c·∫£m ==========
    (function () {
      // X√≥a query string kh·ªèi URL ngay l·∫≠p t·ª©c
      if (window.location.search) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('üîí URL cleaned - sensitive params removed');
      }
    })();

    // ========== GLOBAL VARIABLES ==========
    const ITEM_HEIGHT = 74;
    const BUFFER_SIZE = 20;

    let currentSearchTab = 'friends';
    let allFriends = [];
    let friends = [];
    let filteredFriends = [];
    let allMessages = new Map();
    let selectedFriend = null;
    let currentUserId = null;
    let currentMessages = [];
    let messageStore = new Map();
    let friendsRendered = false;
    let scrollTop = 0;
    let containerHeight = 0;

    // ========== DATABASE MANAGEMENT ==========
    let dbInstance = null;
    let currentUserUID = null;

    // ========== CLEAR DASHBOARD DATA ==========
    function clearDashboardData() {
      console.log('üßπ Clearing dashboard data for account switch...');

      // Clear friend lists
      friends = [];
      allFriends = [];
      filteredFriends = [];
      friendsRendered = false;

      // Clear messages
      allMessages.clear();
      messageStore.clear();
      currentMessages = [];
      selectedFriend = null;

      // Clear UI
      document.getElementById('friendsList').innerHTML = `
        <div class="loading-friends">
          <div class="spinner"></div>
          <div>ƒêang t·∫£i danh s√°ch...</div>
        </div>
      `;
      document.getElementById('messagesContainer').innerHTML = `
        <div class="empty-chat">
          <div class="icon">üí¨</div>
          <div>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        </div>
      `;

      console.log('‚úÖ Dashboard data cleared');
    }

    // ========== MOVE TO TOP FUNCTION ==========
    function moveConversationToTop(userId) {
      console.log(`‚¨ÜÔ∏è Moving conversation to top: ${userId}`);
      filteredFriends = filteredFriends.filter(f => f.userId !== userId);
      const friend = friends.find(f => f.userId === userId);
      if (friend) {
        filteredFriends.unshift(friend);
        console.log(`‚úÖ Moved to top. Top: ${filteredFriends[0]?.displayName}`);
      }
      renderFriendsVirtual();
    }

    // ========== WEBSOCKET ==========
    const ws = createWebSocket();

    ws.onopen = () => {
      console.log('‚úÖ WebSocket connected');
      ws.send(JSON.stringify({ type: 'get_friends' }));
    };

    ws.onerror = (error) => {
      console.error('‚ùå WebSocket error:', error);
    };

    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);

        if (data.type === 'current_user') {
          const newUserUID = data.user.uid;
          currentUserId = newUserUID; // Update global var

          // üîÑ Check if user changed - clear data if so
          if (currentUserUID && currentUserUID !== newUserUID) {
            console.log(`üîÑ User changed from ${currentUserUID} to ${newUserUID}`);
            clearDashboardData();
          }

          console.log('üë§ Current User:', newUserUID);
          document.getElementById('userName').textContent = data.user.name || "User";
          document.getElementById('userAvatar').src = data.user.avatar || "https://via.placeholder.com/50";
          document.getElementById('userUid').textContent = 'UID: ' + data.user.uid;
          document.getElementById('userInfo').style.display = 'flex';

          initIndexedDB(newUserUID).then(async () => {
            // üìä Try to load cached friends first
            try {
              if (typeof loadFriendsFromIndexedDB === 'function') {
                const cachedFriends = await loadFriendsFromIndexedDB();
                if (cachedFriends && cachedFriends.length > 0) {
                  console.log(`üíæ Using ${cachedFriends.length} cached friends`);
                  friends = cachedFriends;
                  allFriends = [...friends];
                  filteredFriends = [...friends];
                  friendsRendered = true;
                  renderFriendsVirtual();
                }
              }
            } catch (err) {
              console.warn('‚ö†Ô∏è Failed to load cached friends:', err);
            }

            // Still request fresh list from server
            console.log('üîÑ Requesting fresh friends list from server...');
            ws.send(JSON.stringify({ type: 'get_friends' }));
          }).catch(err => {
            console.error('‚ùå Failed to init DB:', err);
          });
        }

        if (data.type === 'friend_requests_response') {
          renderFriendRequests(data.requests, data.error);
        }

        if (data.type === 'friends_list') {
          console.log('üë• Friends:', data.friends?.length);
          friends = data.friends || [];
          allFriends = [...friends];
          filteredFriends = [...friends];

          // üíæ Save friends to IndexedDB
          if (typeof saveFriendsToIndexedDB === 'function') {
            saveFriendsToIndexedDB(friends).catch(err => {
              console.error('Failed to save friends:', err);
            });
          }

          console.log('‚úÖ Rendering friends list immediately...');
          friendsRendered = true;
          renderFriendsVirtual();

          setTimeout(() => {
            if (messageStore.size > 0) {
              console.log('üîÑ Re-sorting with messageStore data...');
              sortFriendsAfterLoad();
            }
          }, 300);
        }

        if (data.type === 'messages_history') {
          if (selectedFriend && data.uid === selectedFriend.userId) {
            console.log(`üì® Received ${data.messages?.length} messages`);

            const uniqueMessages = [];
            const seenMsgIds = new Set();

            for (const msg of (data.messages || [])) {
              const msgId = msg.msgId || msg.id;
              if (!seenMsgIds.has(msgId)) {
                uniqueMessages.push(msg);
                seenMsgIds.add(msgId);
              }
            }

            currentMessages = uniqueMessages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages();
          }
        }

        // ‚úÖ X·ª¨ L√ù sent_ok (bao g·ªìm c·∫£ auto reply)
        if (data.type === 'sent_ok') {
          console.log('‚úÖ sent_ok', data.message?.isAutoReply ? '(Auto Reply)' : '');

          // Clear attachment after file/image send
          if (typeof removeAttachment === 'function' && window.currentAttachment) {
            removeAttachment();
            console.log('üóëÔ∏è Attachment cleared');
          }

          const uid = data.uid || data.message?.threadId || selectedFriend?.userId;
          if (!uid) return;

          const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);

          if (!isDuplicate) {
            if (selectedFriend && uid === selectedFriend.userId) {
              currentMessages.push(data.message);
              renderMessages();
              autoSaveToIndexedDB(uid, data.message);
            }
          }

          const content = data.message.content || data.message.msg || '';
          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });

          localStorage.setItem('lastChatWith', JSON.stringify({
            userId: uid,
            timestamp: data.message.timestamp || Date.now()
          }));

          moveConversationToTop(uid);

          if (!data.message?.isAutoReply) {
            document.getElementById('messageInput').value = '';
          }
          scrollToBottom();
        }

        // ‚úÖ X·ª¨ L√ù new_message (bao g·ªìm c·∫£ auto reply)
        if (data.type === 'new_message') {
          console.log('üì® new_message from:', data.uid, data.message?.isAutoReply ? '(Auto Reply)' : '');

          const content = data.message.content || data.message.msg || '';
          const uid = data.uid;
          const isAutoReply = data.message?.isAutoReply || false;

          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });

          const sender = friends.find(f => f.userId === uid);
          const senderName = sender?.displayName || 'Unknown';
          const senderAvatar = sender?.avatar || '';

          if (selectedFriend && uid === selectedFriend.userId) {
            const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);

            if (!isDuplicate) {
              const msgToAdd = {
                ...data.message,
                isSelf: isAutoReply ? true : false
              };

              currentMessages.push(msgToAdd);
              renderMessages();
              autoSaveToIndexedDB(uid, msgToAdd);
              scrollToBottom();
            }
            moveConversationToTop(uid);
          } else {
            if (!isAutoReply) {
              console.log(`üîî Showing notification from ${senderName}`);
              showNotification(senderName, content.substring(0, 30), uid, senderAvatar);
              // ‚úÖ L∆∞u v√†o notification panel
              addNotificationToPanel(senderName, content, uid, senderAvatar, data.message.timestamp);
            }

            autoSaveToIndexedDB(uid, data.message);
            moveConversationToTop(uid);
          }
        }

        // ‚úÖ X·ª¨ L√ù auto_reply_sent
        if (data.type === 'auto_reply_sent' || data.type === 'auto_reply_default_sent') {
          console.log('ü§ñ Auto Reply ƒë√£ g·ª≠i ƒë·∫øn:', data.toUid);

          const uid = data.toUid;
          const content = data.response || '';

          messageStore.set(uid, {
            lastMessage: content,
            timestamp: Date.now()
          });

          if (selectedFriend && uid === selectedFriend.userId) {
            const autoReplyMsg = {
              msgId: 'auto_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
              content: content,
              timestamp: Date.now(),
              senderId: currentUserId,
              isSelf: true,
              isAutoReply: true
            };

            const isDuplicate = currentMessages.some(m =>
              m.content === content &&
              Math.abs(m.timestamp - autoReplyMsg.timestamp) < 2000
            );

            if (!isDuplicate) {
              currentMessages.push(autoReplyMsg);
              renderMessages();
              scrollToBottom();
              autoSaveToIndexedDB(uid, autoReplyMsg);
            }
          }

          moveConversationToTop(uid);
        }

        // ‚úÖ X·ª¨ L√ù K·∫æT QU·∫¢ T√åM KI·∫æM QUA S·ªê ƒêI·ªÜN THO·∫†I
        if (data.type === 'user_found') {
          console.log('‚úÖ T√¨m th·∫•y user t·ª´ SƒêT:', data.user);
          handlePhoneSearchResult(data.user);
        }

        if (data.type === 'user_not_found') {
          console.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y user t·ª´ SƒêT');
          handlePhoneSearchNotFound();
        }

        if (data.type === 'search_error' || data.type === 'find_user_error') {
          console.error('‚ùå L·ªói t√¨m ki·∫øm SƒêT:', data.error);
          handlePhoneSearchError(data.error);
        }

        if (data.type === 'logged_out') {
          console.log('‚úÖ Logout successful');
          handleLogoutComplete();
        }
      } catch (err) {
        console.error('‚ùå Error:', err);
      }
    };

    // ========== CHAT FUNCTIONS ==========
    function selectFriend(userId, displayName, avatar) {
      console.log(`üí¨ Selecting friend: ${displayName} (${userId})`);

      selectedFriend = { userId, displayName, avatar };

      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('chatAvatar').src = avatar;
      document.getElementById('chatName').textContent = displayName;
      document.getElementById('chatUid').textContent = 'UID: ' + userId;
      document.getElementById('inputArea').style.display = 'flex';

      currentMessages = [];
      document.getElementById('messagesContainer').innerHTML = '<div class="loading-chat"><div class="spinner"></div></div>';

      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log(`üì§ Requesting message history for: ${userId}`);
        ws.send(JSON.stringify({ type: 'get_messages', uid: userId }));
      } else {
        console.warn('‚ö†Ô∏è WebSocket not ready');
      }
    }

    // ‚úÖ C·∫¨P NH·∫¨T renderMessages ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh/file
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      if (!container) return;

      if (currentMessages.length === 0) {
        container.innerHTML = '<div class="empty-chat"><div class="icon">üí¨</div><div>Kh√¥ng c√≥ tin nh·∫Øn</div></div>';
        return;
      }

      let html = '';
      for (const msg of currentMessages) {
        const isSelf = msg.isSelf || msg.senderId === currentUserId;
        const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('vi-VN') : '';
        const content = msg.content || msg.msg || '';
        const isAutoReply = msg.isAutoReply || false;
        const msgType = msg.type || 'text';

        // ‚úÖ Render attachment n·∫øu c√≥
        let attachmentHtml = '';

        if (msgType === 'image' && msg.imageUrl) {
          attachmentHtml = `
            <div class="message-attachment">
              <img src="${escapeHtml(msg.imageUrl)}" alt="·∫¢nh" onclick="window.open('${escapeHtml(msg.imageUrl)}', '_blank')" onerror="this.style.display='none'">
            </div>
          `;
        } else if (msgType === 'file' && msg.fileData) {
          const fileIcon = { pdf: 'üìÑ', word: 'üìù', excel: 'üìä', powerpoint: 'üìΩÔ∏è', archive: 'üì¶', audio: 'üéµ', video: 'üé¨', image: 'üñºÔ∏è' }[msg.fileData.fileType] || 'üìé';
          const fileSize = msg.fileData.fileSize ? formatFileSize(msg.fileData.fileSize) : '';
          attachmentHtml = `
            <div class="message-attachment">
              <a href="${escapeHtml(msg.fileData.fileUrl || '#')}" class="file-link" target="_blank" download>
                <span>${fileIcon}</span>
                <span>${escapeHtml(msg.fileData.fileName || 'File')}</span>
                ${fileSize ? '<span style="color:#888;font-size:11px;">(' + fileSize + ')</span>' : ''}
              </a>
            </div>
          `;
        } else if (msgType === 'gif' && msg.imageUrl) {
          attachmentHtml = `
            <div class="message-attachment">
              <img src="${escapeHtml(msg.imageUrl)}" alt="GIF" style="max-width:200px;border-radius:8px;">
            </div>
          `;
        } else if (msgType === 'sticker') {
          attachmentHtml = '<div class="message-attachment">üòä Sticker</div>';
        }

        html += `
          <div class="message ${isSelf ? 'self' : 'other'} ${isAutoReply ? 'auto-reply' : ''}">
            <div class="message-content">
              ${msgType === 'text' || !attachmentHtml ? escapeHtml(content) : ''}
              ${attachmentHtml}
              ${isAutoReply ? '<span class="auto-reply-badge">ü§ñ Auto</span>' : ''}
              <span class="message-time">${timestamp}</span>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
      scrollToBottom();
    }

    function formatFileSize(bytes) {
      if (!bytes) return '';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeJs(str) {
      return (str || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      if (container) {
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
          console.log(`‚¨áÔ∏è Scrolled to bottom`);
        }, 100);
      }
    }

    function sendMessage() {
      if (!selectedFriend) {
        alert('Vui l√≤ng ch·ªçn b·∫°n b√® tr∆∞·ªõc');
        return;
      }

      // ‚úÖ G·ª≠i attachment n·∫øu c√≥
      if (pendingAttachment) {
        sendFileAttachment();
        // N·∫øu kh√¥ng c√≥ text th√¨ ch·ªâ g·ª≠i attachment
        const input = document.getElementById('messageInput');
        if (!input.value.trim()) {
          input.value = '';
          return;
        }
      }

      const input = document.getElementById('messageInput');
      const text = input.value.trim();

      if (!text) return;

      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log(`üì§ Sending message: "${text}"`);
        ws.send(JSON.stringify({
          type: 'send_message',
          uid: selectedFriend.userId,
          text: text,
          timestamp: Date.now()
        }));
        input.value = '';
      }
    }

    function renderFriendsVirtual() {
      const friendsListEl = document.getElementById('friendsList');
      if (!friendsListEl || filteredFriends.length === 0) {
        console.warn('‚ö†Ô∏è friendsList element not found or empty');
        return;
      }

      let html = '';
      for (const friend of filteredFriends) {
        const isSelected = selectedFriend && selectedFriend.userId === friend.userId;
        const msgData = messageStore.get(friend.userId);
        const lastMsg = msgData?.lastMessage || 'Nh·∫Øn tin...';

        html += `
          <div class="friend-item ${isSelected ? 'selected' : ''}" onclick="selectFriend('${friend.userId}', '${escapeJs(friend.displayName)}', '${friend.avatar}')">
            <img src="${friend.avatar}" alt="Avatar">
            <div class="friend-info">
              <div class="friend-name">${friend.displayName}</div>
              <div class="friend-message">${escapeHtml(lastMsg).substring(0, 30)}...</div>
            </div>
          </div>
        `;
      }

      friendsListEl.innerHTML = html;
      console.log(`‚úÖ Rendered ${filteredFriends.length} friends`);
    }

    // ========== SEARCH FUNCTIONS ==========
    function FriendTab(tab) {
      console.log(`üîÑ Switching to ${tab} search`);
      currentSearchTab = tab;
      document.querySelectorAll('.search-tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.search-content').forEach(el => el.classList.remove('active'));
      document.getElementById(tab === 'friends' ? 'friendsSearch' : 'messagesSearch').classList.add('active');
      document.getElementById('friendsSearchInput').value = '';
      document.getElementById('friendsResults').innerHTML = '';
    }

    // ‚úÖ X·ª¨ L√ù K·∫æT QU·∫¢ T√åM KI·∫æM S·ªê ƒêI·ªÜN THO·∫†I
    function handlePhoneSearchResult(user) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      const displayName = user.display_name || user.zalo_name || 'Ng∆∞·ªùi d√πng Zalo';
      const gender = user.gender === 2 ? 'Nam' : user.gender === 1 ? 'N·ªØ' : '';

      resultsDiv.innerHTML = `
        <div style="padding: 8px 12px; background: #e8f5e9; border-bottom: 1px solid #c8e6c9; font-size: 12px; color: #388e3c;">
          ‚úÖ T√¨m th·∫•y t·ª´ s·ªë ƒëi·ªán tho·∫°i
        </div>
        <div class="search-result-item" onclick="selectFriendFromSearch('${user.uid}', '${escapeJs(displayName)}', '${user.avatar || ''}')">
          <div class="result-friend">
            <img src="${user.avatar || 'https://via.placeholder.com/50'}" 
                 onerror="this.src='https://via.placeholder.com/50'"
                 alt="Avatar"
                 style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
            <div class="result-friend-info" style="flex: 1; margin-left: 10px;">
              <div class="result-friend-name" style="font-weight: 600; color: #333;">${escapeHtml(displayName)}</div>
              <div class="result-friend-uid" style="font-size: 12px; color: #666; margin-top: 2px;">
                ${gender ? gender + ' ‚Ä¢ ' : ''}UID: ${user.uid}
              </div>
            </div>
            <span style="background: #e8f5e9; color: #388e3c; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">T·ª´ SƒêT</span>
          </div>
        </div>
      `;

      console.log('‚úÖ ƒê√£ hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm SƒêT');
    }

    function handlePhoneSearchNotFound() {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #999;">
          <div style="font-size: 32px; margin-bottom: 10px;">üòï</div>
          <div>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y</div>
        </div>
      `;
    }

    function handlePhoneSearchError(error) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #f44336;">
          <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
          <div>L·ªói: ${escapeHtml(error || 'Kh√¥ng th·ªÉ t√¨m ki·∫øm')}</div>
        </div>
      `;
    }

    function selectFriendFromSearch(userId, displayName, avatar) {
      // X√≥a k·∫øt qu·∫£ t√¨m ki·∫øm
      document.getElementById('friendsResults').innerHTML = '';
      document.getElementById('friendsSearchInput').value = '';

      // Reset danh s√°ch
      filteredFriends = [...friends];
      renderFriendsVirtual();

      // Ch·ªçn friend
      selectFriend(userId, displayName, avatar);
    }

    // Enter to send
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('messageInput');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });


    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'V·ª´a xong';
      if (minutes < 60) return `${minutes}p`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;

      const date = new Date(timestamp);
      return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
    }

    // Open trigger manager
    function openAutoReplyViewer() {
      if (!currentUserId) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
        return;
      }
      const url = `/trigger-manager.html?userUID=${currentUserId}&dbName=ZaloChat_${currentUserId}`;
      window.open(url, '_blank');
    }

    // Open storage info
    function openStorageInfo() {
      if (!currentUserId) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
        return;
      }
      const url = `/storage-info.html?userUID=${currentUserId}`;
      window.open(url, '_blank');
    }

    // ========== FILE ATTACHMENT HANDLERS ==========
    let pendingAttachment = null;

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      pendingAttachment = file;
      const preview = document.getElementById('attachmentPreview');
      const previewImage = document.getElementById('previewImage');
      const previewFile = document.getElementById('previewFile');

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          previewImage.style.display = 'block';
          previewFile.style.display = 'none';
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImage.style.display = 'none';
        previewFile.style.display = 'flex';
        previewFile.querySelector('.file-name').textContent = file.name;
        preview.style.display = 'block';
      }
      event.target.value = '';
    }

    function removeAttachment() {
      pendingAttachment = null;
      document.getElementById('attachmentPreview').style.display = 'none';
      document.getElementById('previewImage').src = '';
    }

    function sendFileAttachment() {
      if (!pendingAttachment || !selectedFriend) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        ws.send(JSON.stringify({
          type: pendingAttachment.type.startsWith('image/') ? 'send_chat_image' : 'send_chat_file',
          uid: selectedFriend.userId,
          fileName: pendingAttachment.name,
          fileType: pendingAttachment.type,
          fileSize: pendingAttachment.size,
          data: e.target.result
        }));
        removeAttachment();
      };
      reader.readAsDataURL(pendingAttachment);
    }

    // ========== NOTIFICATION PANEL HANDLERS ==========
    let notifications = JSON.parse(localStorage.getItem('zalo_notifications') || '[]');

    function toggleNotificationPanel() {
      const panel = document.getElementById('notificationPanel');
      panel.classList.toggle('active');
    }

    function addNotificationToPanel(name, message, uid, avatar, timestamp) {
      const notification = {
        id: Date.now(),
        name,
        message,
        uid,
        avatar,
        timestamp: timestamp || Date.now()
      };

      notifications.unshift(notification);
      if (notifications.length > 50) notifications = notifications.slice(0, 50);
      localStorage.setItem('zalo_notifications', JSON.stringify(notifications));

      renderNotificationPanel();
      updateNotificationBadge();
    }

    function renderNotificationPanel() {
      const container = document.getElementById('notificationList');
      if (notifications.length === 0) {
        container.innerHTML = '<div class="notification-empty">Ch∆∞a c√≥ ho·∫°t ƒë·ªông m·ªõi</div>';
        return;
      }

      container.innerHTML = notifications.slice(0, 20).map(n => `
        <div class="notification-item" onclick="goToConversation('${n.uid}', '${escapeJs(n.name)}', '${n.avatar || ''}')">
          <img src="${n.avatar || 'https://via.placeholder.com/40'}" onerror="this.src='https://via.placeholder.com/40'" alt="">
          <div class="info">
            <div class="name">${escapeHtml(n.name)}</div>
            <div class="message">${escapeHtml(n.message?.substring(0, 50) || '')}</div>
            <div class="time">${formatTime(n.timestamp)}</div>
          </div>
        </div>
      `).join('');
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      const count = notifications.filter(n => n.timestamp > (Date.now() - 3600000)).length;
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function clearNotifications() {
      notifications = [];
      localStorage.removeItem('zalo_notifications');
      renderNotificationPanel();
      updateNotificationBadge();
    }

    function goToConversation(uid, name, avatar) {
      document.getElementById('notificationPanel').classList.remove('active');
      selectFriend(uid, name, avatar);
    }

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('notificationPanel');
      const bell = document.getElementById('notificationBell');
      if (!panel.contains(e.target) && !bell.contains(e.target)) {
        panel.classList.remove('active');
      }
    });

    // Initialize notification panel on load
    document.addEventListener('DOMContentLoaded', () => {
      renderNotificationPanel();
      updateNotificationBadge();
    });
    // ========== FRIEND REQUEST UI ==========
    function openFriendRequestsPanel() {
      document.getElementById('frModal').style.display = 'block';
      ws.send(JSON.stringify({ type: 'get_friend_requests' }));
    }
    function closeFriendRequestsPanel() {
      document.getElementById('frModal').style.display = 'none';
    }
    window.onclick = function (event) {
      if (event.target == document.getElementById('frModal')) {
        closeFriendRequestsPanel();
      }
    }

    function renderFriendRequests(requests, error) {
      const list = document.getElementById('frList');
      if (error) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:red;">L·ªói: ${error}</div>`;
        return;
      }
      if (!requests || requests.length === 0) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:#666;">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</div>`;
        return;
      }

      let html = '';
      requests.forEach(req => {
        const name = req.zaloName || req.displayName || req.userId;
        const avatar = req.avatar || 'https://via.placeholder.com/40';
        const msg = req.msg || req.message || 'Xin ch√†o!';
        const time = req.time ? new Date(req.time).toLocaleString() : '';

        html += `
           <div class="fr-item">
             <img src="${avatar}" class="fr-avatar">
             <div style="flex:1;">
               <div style="font-weight:600;font-size:14px;">${name}</div>
               <div style="font-size:12px;color:#666;">${msg}</div>
               <div style="font-size:10px;color:#999;">${time}</div>
             </div>
             <div style="font-size:11px;color:#0068FF;background:#E3F2FD;padding:4px 8px;border-radius:12px;">ƒêang ch·ªù</div>
           </div>
         `;
      });
      list.innerHTML = html;
    }

    // ========== üì± MOBILE RESPONSIVE FUNCTIONS ==========
    // ========== üì± SIDEBAR TOGGLE (Mobile + Desktop) ==========
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const container = document.querySelector('.container');
      const overlay = document.getElementById('mobileOverlay');

      // Check if Mobile (< 768px)
      if (window.innerWidth <= 768) {
        if (sidebar.classList.contains('mobile-active')) {
          closeMobileSidebar();
        } else {
          sidebar.classList.add('mobile-active');
          overlay.classList.add('active');
        }
      }
      // Desktop (> 768px)
      else {
        sidebar.classList.toggle('collapsed');
        container.classList.toggle('sidebar-collapsed');
      }
    }

    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      sidebar.classList.remove('mobile-active');
      overlay.classList.remove('active');
    }

    // Auto-close sidebar when selecting a friend on mobile
    const originalSelectFriend = window.selectFriend;
    if (originalSelectFriend) {
      window.selectFriend = function (...args) {
        originalSelectFriend.apply(this, args);
        // Close sidebar on mobile after selecting friend
        if (window.innerWidth <= 768) {
          closeMobileSidebar();
        }
      };
    }
  </script>
  <script src="IndexedDB.js"></script>
  <script src="chat-function/file-handler.js"></script>
  <script src="chat-function/load_data.js"></script>
  <script src="chat-function/sort.js"></script>
  <script src="chat-function/logout.js"></script>
  <script src="chat-function/search.js"></script>
  <script src="chat-function/notifications.js"></script>
</body>

</html>