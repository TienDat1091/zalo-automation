<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zalo Messenger - Dual Search</title>
  <link rel="stylesheet" href="assets/style_dashboard.css" />
  <style>
    /* âœ… CSS cho tin nháº¯n Auto Reply */
    .message.auto-reply .message-content {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }
    
    .message.auto-reply .bubble {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }
    
    .auto-reply-badge {
      display: inline-block;
      background: #2196f3;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Zalo Messenger</h1>
        <div class="user-info" id="userInfo" style="display:none;">
          <img id="userAvatar" src="" alt="Avatar">
          <div id="userName">Äang táº£i...</div>
          <div id="userUid" style="font-size:12px;"></div>
          
          <div class="button-group">
            <button class="backup-button" onclick="openStorageInfo()">
              <span>ğŸ’¾</span> QUáº¢N LÃ Dá»® LIá»†U
            </button>
            
            <button class="storage-button" onclick="openAutoReplyViewer()">
              <span>ğŸ¤–</span> CÃ€I Äáº¶T Ká»ŠCH Báº¢N
            </button>
          </div>
          
          <button class="logout-btn" onclick="logout()">
            <span>ğŸšª</span><span>ÄÄƒng xuáº¥t</span>
          </button>
        </div>
      </div>

      <!-- âœ… DUAL SEARCH TABS -->
      <div class="search-tabs">
        <button class="search-tab active" onclick="FriendTab('friends')">
          ğŸ‘¥ Báº¡n bÃ¨
        </button>
      </div>

      <!-- âœ… FRIENDS SEARCH -->
      <div id="friendsSearch" class="search-content active">
        <div class="friends-search-box">
          <input 
            type="text" 
            id="friendsSearchInput"
            placeholder="ğŸ” TÃ¬m báº¡n bÃ¨ hoáº·c nháº­p SÄT..." 
            autocomplete="off"
            onkeyup="searchFriends(this.value)"
          >
        </div>
        <div class="search-results-container" id="friendsResults"></div>
      </div>

      <!-- âœ… FRIENDS LIST -->
      <div class="friends-list" id="friendsList">
        <div class="loading-friends">
          <div class="spinner"></div>
          <div>Äang táº£i danh sÃ¡ch...</div>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header" id="chatHeader" style="display:none;">
        <img id="chatAvatar" src="" alt="Avatar">
        <div class="info">
          <div class="name" id="chatName">Chá»n báº¡n bÃ¨</div>
          <div class="uid" id="chatUid"></div>
          <div class="status">Äang hoáº¡t Ä‘á»™ng</div>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="empty-chat">
          <div class="icon">ğŸ’¬</div>
          <div>Chá»n má»™t cuá»™c trÃ² chuyá»‡n Ä‘á»ƒ báº¯t Ä‘áº§u</div>
        </div>
      </div>

      <div class="input-area" id="inputArea" style="display:none;">
        <button class="emoji-btn" onclick="openEmojiPicker()" title="Chá»n emoji">ğŸ˜Š</button>
        <textarea id="messageInput" placeholder="Nháº­p tin nháº¯n..." rows="1"></textarea>
        <button type="button" id="sendBtn" onclick="sendMessage()">Gá»­i</button>
      </div>
    </div>
  </div>

  <script>
    // ========== GLOBAL VARIABLES ==========
    const ITEM_HEIGHT = 74;
    const BUFFER_SIZE = 20;
    
    let currentSearchTab = 'friends';
    let allFriends = [];
    let friends = [];
    let filteredFriends = [];
    let allMessages = new Map();
    let selectedFriend = null;
    let currentUserId = null;
    let currentMessages = [];
    let messageStore = new Map();
    let friendsRendered = false;
    let scrollTop = 0;
    let containerHeight = 0;
    
    // ========== DATABASE MANAGEMENT ==========
    let dbInstance = null;
    let currentUserUID = null;

    // ========== MOVE TO TOP FUNCTION ==========
    function moveConversationToTop(userId) {
      console.log(`â¬†ï¸ Moving conversation to top: ${userId}`);
      filteredFriends = filteredFriends.filter(f => f.userId !== userId);
      const friend = friends.find(f => f.userId === userId);
      if (friend) {
        filteredFriends.unshift(friend);
        console.log(`âœ… Moved to top. Top: ${filteredFriends[0]?.displayName}`);
      }
      renderFriendsVirtual();
    }

    // ========== WEBSOCKET ==========
    const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(wsProtocol + '//' + location.host);
  
    ws.onopen = () => {
      console.log('âœ… WebSocket connected');
      ws.send(JSON.stringify({ type: 'get_friends' }));
    };

    ws.onerror = (error) => {
      console.error('âŒ WebSocket error:', error);
    };

    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);
    
        if (data.type === 'current_user') {
          currentUserId = data.user.uid;
          document.getElementById('userName').textContent = data.user.name || "User";
          document.getElementById('userAvatar').src = data.user.avatar || "https://via.placeholder.com/50";
          document.getElementById('userUid').textContent = 'UID: ' + data.user.uid;
          document.getElementById('userInfo').style.display = 'flex';
          
          initIndexedDB(data.user.uid).catch(err => {
            console.error('âŒ Failed to init DB:', err);
          });
          
          console.log('ğŸ”„ Auto-requesting friends list after login...');
          ws.send(JSON.stringify({ type: 'get_friends' }));
        }
    
        if (data.type === 'friends_list') {
          console.log('ğŸ‘¥ Friends:', data.friends?.length);
          friends = data.friends || [];
          allFriends = [...friends];
          filteredFriends = [...friends];
          
          console.log('âœ… Rendering friends list immediately...');
          friendsRendered = true;
          renderFriendsVirtual();
          
          setTimeout(() => {
            if (messageStore.size > 0) {
              console.log('ğŸ”„ Re-sorting with messageStore data...');
              sortFriendsAfterLoad();
            }
          }, 300);
        }

        if (data.type === 'messages_history') {
          if (selectedFriend && data.uid === selectedFriend.userId) {
            console.log(`ğŸ“¨ Received ${data.messages?.length} messages`);
            
            const uniqueMessages = [];
            const seenMsgIds = new Set();
            
            for (const msg of (data.messages || [])) {
              const msgId = msg.msgId || msg.id;
              if (!seenMsgIds.has(msgId)) {
                uniqueMessages.push(msg);
                seenMsgIds.add(msgId);
              }
            }
            
            currentMessages = uniqueMessages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages();
          }
        }
    
        // âœ… Xá»¬ LÃ sent_ok (bao gá»“m cáº£ auto reply)
        if (data.type === 'sent_ok') {
          console.log('âœ… sent_ok', data.message?.isAutoReply ? '(Auto Reply)' : '');
          
          const uid = data.uid || data.message?.threadId || selectedFriend?.userId;
          if (!uid) return;
          
          const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);
          
          if (!isDuplicate) {
            if (selectedFriend && uid === selectedFriend.userId) {
              currentMessages.push(data.message);
              renderMessages();
              autoSaveToIndexedDB(uid, data.message);
            }
          }
          
          const content = data.message.content || data.message.msg || '';
          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });
          
          localStorage.setItem('lastChatWith', JSON.stringify({
            userId: uid,
            timestamp: data.message.timestamp || Date.now()
          }));
          
          moveConversationToTop(uid);
          
          if (!data.message?.isAutoReply) {
            document.getElementById('messageInput').value = '';
          }
          scrollToBottom();
        }
    
        // âœ… Xá»¬ LÃ new_message (bao gá»“m cáº£ auto reply)
        if (data.type === 'new_message') {
          console.log('ğŸ“¨ new_message from:', data.uid, data.message?.isAutoReply ? '(Auto Reply)' : '');
          
          const content = data.message.content || data.message.msg || '';
          const uid = data.uid;
          const isAutoReply = data.message?.isAutoReply || false;
          
          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });
          
          const sender = friends.find(f => f.userId === uid);
          const senderName = sender?.displayName || 'Unknown';
          const senderAvatar = sender?.avatar || '';
          
          if (selectedFriend && uid === selectedFriend.userId) {
            const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);
            
            if (!isDuplicate) {
              const msgToAdd = {
                ...data.message,
                isSelf: isAutoReply ? true : false
              };
              
              currentMessages.push(msgToAdd);
              renderMessages();
              autoSaveToIndexedDB(uid, msgToAdd);
              scrollToBottom();
            }
            moveConversationToTop(uid);
          } else {
            if (!isAutoReply) {
              console.log(`ğŸ”” Showing notification from ${senderName}`);
              showNotification(senderName, content.substring(0, 30), uid, senderAvatar);
            }
            
            autoSaveToIndexedDB(uid, data.message);
            moveConversationToTop(uid);
          }
        }

        // âœ… Xá»¬ LÃ auto_reply_sent
        if (data.type === 'auto_reply_sent' || data.type === 'auto_reply_default_sent') {
          console.log('ğŸ¤– Auto Reply Ä‘Ã£ gá»­i Ä‘áº¿n:', data.toUid);
          
          const uid = data.toUid;
          const content = data.response || '';
          
          messageStore.set(uid, {
            lastMessage: content,
            timestamp: Date.now()
          });
          
          if (selectedFriend && uid === selectedFriend.userId) {
            const autoReplyMsg = {
              msgId: 'auto_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
              content: content,
              timestamp: Date.now(),
              senderId: currentUserId,
              isSelf: true,
              isAutoReply: true
            };
            
            const isDuplicate = currentMessages.some(m => 
              m.content === content && 
              Math.abs(m.timestamp - autoReplyMsg.timestamp) < 2000
            );
            
            if (!isDuplicate) {
              currentMessages.push(autoReplyMsg);
              renderMessages();
              scrollToBottom();
              autoSaveToIndexedDB(uid, autoReplyMsg);
            }
          }
          
          moveConversationToTop(uid);
        }

        // âœ… Xá»¬ LÃ Káº¾T QUáº¢ TÃŒM KIáº¾M QUA Sá» ÄIá»†N THOáº I
        if (data.type === 'user_found') {
          console.log('âœ… TÃ¬m tháº¥y user tá»« SÄT:', data.user);
          handlePhoneSearchResult(data.user);
        }

        if (data.type === 'user_not_found') {
          console.log('âš ï¸ KhÃ´ng tÃ¬m tháº¥y user tá»« SÄT');
          handlePhoneSearchNotFound();
        }

        if (data.type === 'search_error') {
          console.error('âŒ Lá»—i tÃ¬m kiáº¿m SÄT:', data.error);
          handlePhoneSearchError(data.error);
        }

        if (data.type === 'logged_out') {
          console.log('âœ… Logout successful');
          handleLogoutComplete();
        }
      } catch (err) {
        console.error('âŒ Error:', err);
      }
    };

    // ========== CHAT FUNCTIONS ==========
    function selectFriend(userId, displayName, avatar) {
      console.log(`ğŸ’¬ Selecting friend: ${displayName} (${userId})`);
      
      selectedFriend = { userId, displayName, avatar };
      
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('chatAvatar').src = avatar;
      document.getElementById('chatName').textContent = displayName;
      document.getElementById('chatUid').textContent = 'UID: ' + userId;
      document.getElementById('inputArea').style.display = 'flex';
      
      currentMessages = [];
      document.getElementById('messagesContainer').innerHTML = '<div class="loading-chat"><div class="spinner"></div></div>';
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log(`ğŸ“¤ Requesting message history for: ${userId}`);
        ws.send(JSON.stringify({ type: 'get_messages', uid: userId }));
      } else {
        console.warn('âš ï¸ WebSocket not ready');
      }
    }

    // âœ… Cáº¬P NHáº¬T renderMessages Ä‘á»ƒ hiá»ƒn thá»‹ badge Auto Reply
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      if (currentMessages.length === 0) {
        container.innerHTML = '<div class="empty-chat"><div class="icon">ğŸ’¬</div><div>KhÃ´ng cÃ³ tin nháº¯n</div></div>';
        return;
      }
      
      let html = '';
      for (const msg of currentMessages) {
        const isSelf = msg.isSelf || msg.senderId === currentUserId;
        const timestamp = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('vi-VN') : '';
        const content = msg.content || msg.msg || '';
        const isAutoReply = msg.isAutoReply || false;
        
        html += `
          <div class="message ${isSelf ? 'self' : 'other'} ${isAutoReply ? 'auto-reply' : ''}">
            <div class="message-content">
              ${escapeHtml(content)}
              ${isAutoReply ? '<span class="auto-reply-badge">ğŸ¤– Auto</span>' : ''}
              <span class="message-time">${timestamp}</span>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      scrollToBottom();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeJs(str) {
      return (str || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      if (container) {
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
          console.log(`â¬‡ï¸ Scrolled to bottom`);
        }, 100);
      }
    }

    function sendMessage() {
      if (!selectedFriend) {
        alert('Vui lÃ²ng chá»n báº¡n bÃ¨ trÆ°á»›c');
        return;
      }
      
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log(`ğŸ“¤ Sending message: "${text}"`);
        ws.send(JSON.stringify({
          type: 'send_message',
          uid: selectedFriend.userId,
          text: text,
          timestamp: Date.now()
        }));
      }
    } 

    function renderFriendsVirtual() {
      const friendsListEl = document.getElementById('friendsList');
      if (!friendsListEl || filteredFriends.length === 0) {
        console.warn('âš ï¸ friendsList element not found or empty');
        return;
      }
      
      let html = '';
      for (const friend of filteredFriends) {
        const isSelected = selectedFriend && selectedFriend.userId === friend.userId;
        const msgData = messageStore.get(friend.userId);
        const lastMsg = msgData?.lastMessage || 'Nháº¯n tin...';
        
        html += `
          <div class="friend-item ${isSelected ? 'selected' : ''}" onclick="selectFriend('${friend.userId}', '${escapeJs(friend.displayName)}', '${friend.avatar}')">
            <img src="${friend.avatar}" alt="Avatar">
            <div class="friend-info">
              <div class="friend-name">${friend.displayName}</div>
              <div class="friend-message">${escapeHtml(lastMsg).substring(0, 30)}...</div>
            </div>
          </div>
        `;
      }
  
      friendsListEl.innerHTML = html;
      console.log(`âœ… Rendered ${filteredFriends.length} friends`);
    }

    // ========== SEARCH FUNCTIONS ==========
    function FriendTab(tab) {
      console.log(`ğŸ”„ Switching to ${tab} search`);
      currentSearchTab = tab;
      document.querySelectorAll('.search-tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.search-content').forEach(el => el.classList.remove('active'));
      document.getElementById(tab === 'friends' ? 'friendsSearch' : 'messagesSearch').classList.add('active');
      document.getElementById('friendsSearchInput').value = '';
      document.getElementById('friendsResults').innerHTML = '';  
    }

    // âœ… Xá»¬ LÃ Káº¾T QUáº¢ TÃŒM KIáº¾M Sá» ÄIá»†N THOáº I
    function handlePhoneSearchResult(user) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;
      
      const displayName = user.display_name || user.zalo_name || 'NgÆ°á»i dÃ¹ng Zalo';
      const gender = user.gender === 2 ? 'Nam' : user.gender === 1 ? 'Ná»¯' : '';
      
      resultsDiv.innerHTML = `
        <div style="padding: 8px 12px; background: #e8f5e9; border-bottom: 1px solid #c8e6c9; font-size: 12px; color: #388e3c;">
          âœ… TÃ¬m tháº¥y tá»« sá»‘ Ä‘iá»‡n thoáº¡i
        </div>
        <div class="search-result-item" onclick="selectFriendFromSearch('${user.uid}', '${escapeJs(displayName)}', '${user.avatar || ''}')">
          <div class="result-friend">
            <img src="${user.avatar || 'https://via.placeholder.com/50'}" 
                 onerror="this.src='https://via.placeholder.com/50'"
                 alt="Avatar"
                 style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
            <div class="result-friend-info" style="flex: 1; margin-left: 10px;">
              <div class="result-friend-name" style="font-weight: 600; color: #333;">${escapeHtml(displayName)}</div>
              <div class="result-friend-uid" style="font-size: 12px; color: #666; margin-top: 2px;">
                ${gender ? gender + ' â€¢ ' : ''}UID: ${user.uid}
              </div>
            </div>
            <span style="background: #e8f5e9; color: #388e3c; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">Tá»« SÄT</span>
          </div>
        </div>
      `;
      
      console.log('âœ… ÄÃ£ hiá»ƒn thá»‹ káº¿t quáº£ tÃ¬m kiáº¿m SÄT');
    }

    function handlePhoneSearchNotFound() {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;
      
      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #999;">
          <div style="font-size: 32px; margin-bottom: 10px;">ğŸ˜•</div>
          <div>KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i dÃ¹ng vá»›i sá»‘ Ä‘iá»‡n thoáº¡i nÃ y</div>
        </div>
      `;
    }

    function handlePhoneSearchError(error) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;
      
      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #f44336;">
          <div style="font-size: 32px; margin-bottom: 10px;">âŒ</div>
          <div>Lá»—i: ${escapeHtml(error || 'KhÃ´ng thá»ƒ tÃ¬m kiáº¿m')}</div>
        </div>
      `;
    }

    function selectFriendFromSearch(userId, displayName, avatar) {
      // XÃ³a káº¿t quáº£ tÃ¬m kiáº¿m
      document.getElementById('friendsResults').innerHTML = '';
      document.getElementById('friendsSearchInput').value = '';
      
      // Reset danh sÃ¡ch
      filteredFriends = [...friends];
      renderFriendsVirtual();
      
      // Chá»n friend
      selectFriend(userId, displayName, avatar);
    }

    // Enter to send
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('messageInput');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });


  function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Vá»«a xong';
      if (minutes < 60) return `${minutes}p`;
      if (hours < 24) return `${hours}h`;
      if (days < 7) return `${days}d`;
      
      const date = new Date(timestamp);
      return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
    }

    // Open trigger manager
    function openAutoReplyViewer() {
      if (!currentUserId) {
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
        return;
      }
      const url = `/trigger-manager.html?userUID=${currentUserId}&dbName=ZaloChat_${currentUserId}`;
      window.open(url, '_blank');
    }

    // Open storage info
    function openStorageInfo() {
      if (!currentUserId) {
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
        return;
      }
      const url = `/storage-info.html?userUID=${currentUserId}`;
      window.open(url, '_blank');
    }
  </script>
  <script src="IndexedDB.js"></script>
  <script src="chat-function/load_data.js"></script>
  <script src="chat-function/sort.js"></script>
  <script src="chat-function/logout.js"></script>
  <script src="chat-function/search.js"></script>
  <script src="chat-function/notifications.js"></script>

</body>
</html>