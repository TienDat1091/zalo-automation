<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zalo Messenger</title>
  <link rel="stylesheet" href="assets/style_dashboard.css?v=2" />
  <link rel="stylesheet" href="/assets/unified-header.css?v=4">
  <style>
    .container {
      height: calc(100vh - 64px) !important;
    }

    /* ‚úÖ CSS cho tin nh·∫Øn Auto Reply */
    .message.auto-reply .message-content {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }

    .message.auto-reply .bubble {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
      border-left: 3px solid #2196f3;
      position: relative;
    }

    .auto-reply-badge {
      display: inline-block;
      background: #2196f3;
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* ‚úÖ CSS cho n√∫t ƒë√≠nh k√®m */
    .attach-btn {
      background: #f5f5f5;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .attach-btn:hover {
      background: #e0e0e0;
    }

    /* ‚úÖ CSS cho attachment preview */
    .attachment-preview {
      position: absolute;
      bottom: 70px;
      left: 20px;
      right: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .attachment-preview .preview-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attachment-preview img {
      max-height: 80px;
      max-width: 120px;
      border-radius: 8px;
      object-fit: cover;
    }

    .attachment-preview .file-icon {
      font-size: 32px;
    }

    .attachment-preview .file-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    .remove-attachment {
      background: #ff4757;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 14px;
    }

    /* ‚úÖ CSS cho tin nh·∫Øn c√≥ attachment */
    .message-attachment {
      margin-top: 8px;
    }

    .message-attachment img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      cursor: pointer;
    }

    .message-attachment .file-link {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f5f5f5;
      padding: 10px 14px;
      border-radius: 8px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
    }

    .message-attachment .file-link:hover {
      background: #e8e8e8;
    }

    .message-attachment .file-path {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      font-family: monospace;
    }

    /* ‚úÖ CSS cho Notification Bell */
    .notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #0068FF, #0052CC);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 104, 255, 0.3);
      z-index: 1000;
      transition: all 0.2s;
    }

    .notification-bell:hover {
      transform: scale(1.1);
    }

    .notification-bell .icon {
      font-size: 24px;
    }

    .notification-bell .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ‚úÖ CSS cho Notification Panel */
    .notification-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      max-height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      display: block;
    }

    .notification-panel .panel-header {
      background: linear-gradient(135deg, #0068FF, #0052CC);
      color: white;
      padding: 14px 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-panel .clear-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .notification-panel .panel-body {
      max-height: 340px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .notification-item:hover {
      background: #f5f8ff;
    }

    .notification-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .notification-item .info {
      flex: 1;
    }

    .notification-item .name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .notification-item .message {
      color: #666;
      font-size: 13px;
      margin-top: 2px;
    }

    .notification-item .time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px;
      text-align: center;
      color: #999;
    }

    /* Friend Request Modal */
    .fr-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .fr-modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 0;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .fr-header {
      padding: 15px 20px;
      background: #0068FF;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fr-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .fr-close {
      cursor: pointer;
      font-size: 24px;
    }

    .fr-body {
      padding: 0;
      max-height: 480px;
      overflow-y: auto;
    }

    .fr-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      gap: 12px;
    }

    .fr-item:hover {
      background: #f9f9f9;
    }

    .fr-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .message .bubble img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .message-attachment img {
      max-width: 100%;
      height: auto;
    }

    /* ‚úÖ CSS cho ch·∫ø ƒë·ªô x√≥a b·∫°n b√® */
    .delete-mode-toggle {
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .delete-mode-toggle:hover {
      background: #f0f0f0;
      color: #f44336;
    }

    .delete-mode-toggle.active {
      background: #ffebee;
      color: #f44336;
    }

    .friend-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      display: none;
      margin-right: 10px;
      accent-color: #f44336;
    }

    .delete-mode .friend-checkbox {
      display: block;
    }

    .delete-mode .friend-item {
      padding-left: 8px;
    }

    .delete-selection-bar {
      display: none;
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      padding: 10px 15px;
      text-align: center;
      font-size: 14px;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
    }

    .delete-selection-bar.visible {
      display: flex;
    }

    .delete-selection-bar .delete-btn {
      background: white;
      color: #f44336;
      border: none;
      padding: 6px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .delete-selection-bar .delete-btn:hover {
      background: #ffebee;
    }

    .delete-selection-bar .cancel-btn {
      background: transparent;
      color: white;
      border: 1px solid white;
      padding: 6px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-selection-bar .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .ar-toggle {
      position: absolute;
      /* Using absolute to force visibility */
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-block;
      width: 32px;
      height: 18px;
      z-index: 100;
      flex-shrink: 0;
    }

    .ar-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .ar-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 18px;
    }

    .ar-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.ar-slider {
      background-color: #4CAF50;
    }

    input:checked+.ar-slider:before {
      transform: translateX(14px);
    }
  </style>
</head>

<body>
  <!-- üì± Mobile UI Elements -->
  <!-- <button class="mobile-toggle" id="mobileToggle" onclick="toggleMobileSidebar()">‚ò∞</button> -->
  <!-- <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div> -->

  <div class="container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <!-- <h1>Zalo Messenger</h1> REMOVED - In Unified Header -->
        <div class="user-info" id="userInfo" style="display:none !important;">
          <img id="userAvatar" src="" alt="Avatar">
          <div id="userName">ƒêang t·∫£i...</div>
          <div id="userUid" style="font-size:12px;"></div>

          <!-- ‚úÖ Compact Logout Button -->
          <button class="logout-btn" onclick="logout()"
            style="margin-top:10px; width:100%; padding:8px; border:none; border-radius:8px; background:#ff4757; color:white; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; gap:6px;">
            <span>üö™</span><span>ƒêƒÉng xu·∫•t</span>
          </button>
        </div>

        <!-- ‚úÖ Compact Button Grid (Moved outside #userInfo) -->
        <div class="button-grid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; margin-top:0px;">
          <button onclick="openStorageInfo()" title="Th·ªëng k√™ & Qu·∫£n l√Ω"
            style="padding:10px; border:none; border-radius:8px; background:linear-gradient(135deg, #4CAF50, #2E7D32); color:white; cursor:pointer; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px;">
            <span style="font-size:18px;">üìä</span>
            <span>Th·ªëng k√™</span>
          </button>
          <button onclick="openFriendRequestsPanel()" title="L·ªùi m·ªùi k·∫øt b·∫°n"
            style="padding:10px; border:none; border-radius:8px; background:linear-gradient(135deg, #2196F3, #1565C0); color:white; cursor:pointer; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px;">
            <span style="font-size:18px;">ü§ù</span>
            <span>L·ªùi m·ªùi</span>
          </button>
          <button onclick="openSentFriendRequestsPanel()" title="L·ªùi m·ªùi ƒë√£ g·ª≠i"
            style="padding:10px; border:none; border-radius:8px; background:linear-gradient(135deg, #FF9800, #E65100); color:white; cursor:pointer; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px;">
            <span style="font-size:18px;">üì§</span>
            <span>ƒê√£ g·ª≠i</span>
          </button>
          <button onclick="openAutoReplyViewer()" title="C√†i ƒë·∫∑t k·ªãch b·∫£n"
            style="padding:10px; border:none; border-radius:8px; background:linear-gradient(135deg, #9C27B0, #6A1B9A); color:white; cursor:pointer; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px;">
            <span style="font-size:18px;">ü§ñ</span>
            <span>K·ªãch b·∫£n</span>
          </button>
        </div>
      </div>

      <!-- ‚úÖ DUAL SEARCH TABS (Friends + Groups) -->
      <div class="search-tabs" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:4px;">
          <button class="search-tab active" id="friendsTabBtn" onclick="switchTab('friends')"
            style="padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:12px;">
            üë• B·∫°n b√®
          </button>
          <button class="search-tab" id="groupsTabBtn" onclick="switchTab('groups')"
            style="padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:12px; background:#f0f0f0;">
            üë™ Nh√≥m
          </button>
        </div>
        <button class="delete-mode-toggle" id="deleteModeBtn" onclick="toggleDeleteMode()" title="Ch·∫ø ƒë·ªô x√≥a b·∫°n b√®">
          X√≥a b·∫°n b√®
        </button>
      </div>

      <!-- ‚úÖ DELETE SELECTION BAR -->
      <div class="delete-selection-bar" id="deleteSelectionBar">
        <span id="selectedCount">0 ƒë√£ ch·ªçn</span>
        <div>
          <button class="cancel-btn" onclick="cancelDeleteMode()">H·ªßy</button>
          <button class="delete-btn" onclick="deleteSelectedFriends()">üóëÔ∏è X√≥a</button>
        </div>
      </div>

      <!-- ‚úÖ FRIENDS SEARCH -->
      <div id="friendsSearch" class="search-content active">
        <div class="friends-search-box">
          <input type="text" id="friendsSearchInput" placeholder="üîç T√¨m b·∫°n b√® ho·∫∑c nh·∫≠p SƒêT..." autocomplete="off"
            onkeyup="applyFilters()">
        </div>

        <!-- ‚úÖ AUTO-REPLY FILTER -->
        <div class="filter-box" style="padding: 0 12px 10px 12px; display: flex; align-items: center; gap: 8px;">
          <label style="font-size: 12px; color: #666; white-space: nowrap;">L·ªçc:</label>
          <select id="autoReplyFilter" onchange="applyFilters()"
            style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; background: white; cursor: pointer;">
            <option value="all">To√†n b·ªô b·∫°n b√®</option>
            <option value="on">ƒê√£ B·∫¨T T·ª± ƒë·ªông tr·∫£ l·ªùi</option>
            <option value="off">ƒê√£ T·∫ÆT T·ª± ƒë·ªông tr·∫£ l·ªùi</option>
          </select>
        </div>

        <div class="search-results-container" id="friendsResults"></div>
      </div>

      <!-- ‚úÖ GROUPS CONTAINER (New) -->
      <div id="groupsContainer" class="search-content" style="display:none;">
        <div class="friends-search-box">
          <input type="text" id="groupsSearchInput" placeholder="üîç T√¨m nh√≥m..." autocomplete="off"
            onkeyup="searchGroups(this.value)">
        </div>
        <div class="search-results-container" id="groupsResults">
          <div class="loading-friends">
            <div class="spinner"></div>
            <div>ƒêang t·∫£i danh s√°ch nh√≥m...</div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ FRIENDS LIST -->
      <div class="friends-list" id="friendsList">
        <div class="loading-friends">
          <div class="spinner"></div>
          <div>ƒêang t·∫£i danh s√°ch...</div>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header" id="chatHeader" style="display:none;">
        <button class="mobile-back-btn" onclick="closeMobileSidebar()">‚Üê Danh s√°ch</button>
        <img id="chatAvatar" src="" alt="Avatar">
        <div class="info">
          <div class="name" id="chatName">Ch·ªçn b·∫°n b√®</div>
          <div class="uid" id="chatUid"></div>
          <div class="status">ƒêang ho·∫°t ƒë·ªông</div>
        </div>

        <!-- ‚úÖ Header Auto-Reply Toggle (Moved here) -->
        <div class="header-ar-toggle" title="B·∫≠t/T·∫Øt t·ª± ƒë·ªông tr·∫£ l·ªùi cho ng∆∞·ªùi n√†y"
          style="display:flex; align-items:center; margin-left: 15px;">
          <span style="font-size: 12px; color: #666; margin-right: 6px; white-space: nowrap;">Auto Reply:</span>
          <label class="ar-toggle" style="position:relative; margin:0; top:0; right:0; transform:none;">
            <input type="checkbox" id="headerAutoReplyToggle" onchange="toggleHeaderAutoReply(this.checked)">
            <span class="ar-slider"></span>
          </label>
        </div>
        <!-- ‚úÖ Auto-Delete Chat Button -->
        <div class="chat-actions" style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <div class="auto-delete-dropdown" style="position:relative;">
            <button onclick="toggleAutoDeleteMenu()" class="action-btn" title="T·ª± ƒë·ªông x√≥a tin nh·∫Øn"
              style="background:transparent; border:1px solid #ddd; border-radius:8px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:6px;">
              <span>‚è±Ô∏è</span>
              <span id="autoDeleteLabel" style="font-size:12px; color:#666;">T·ª± x√≥a</span>
            </button>
            <div id="autoDeleteMenu"
              style="display:none; position:absolute; top:100%; right:0; background:white; border:1px solid #e0e0e0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); min-width:220px; z-index:1000; margin-top:4px;">
              <div style="padding:8px 0;">
                <div onclick="setAutoDeleteChat(0)" class="menu-item"
                  style="padding:10px 16px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                  <span>‚ùå</span> Kh√¥ng t·ª± x√≥a
                </div>
                <div onclick="setAutoDeleteChat(86400000)" class="menu-item"
                  style="padding:10px 16px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                  <span>üìÖ</span> Sau 1 ng√†y
                </div>
                <div onclick="setAutoDeleteChat(604800000)" class="menu-item"
                  style="padding:10px 16px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                  <span>üìÜ</span> Sau 7 ng√†y
                </div>
                <div onclick="setAutoDeleteChat(1209600000)" class="menu-item"
                  style="padding:10px 16px; cursor:pointer; display:flex; align-items:center; gap:8px;">
                  <span>üóìÔ∏è</span> Sau 14 ng√†y
                </div>
                <hr style="margin:8px 0; border:none; border-top:1px solid #eee;">
                <div style="padding:8px 16px;">
                  <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">‚è±Ô∏è T√πy ch·ªânh
                    (gi√¢y):</label>
                  <div style="display:flex; gap:6px;">
                    <input type="number" id="customDeleteSeconds" placeholder="VD: 3600" min="0"
                      style="flex:1; padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                    <button onclick="setCustomAutoDelete()"
                      style="padding:6px 12px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">OK</button>
                  </div>
                  <div style="font-size:10px; color:#999; margin-top:4px;">1 gi·ªù = 3600, 1 ng√†y = 86400</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="empty-chat">
          <div class="icon">üí¨</div>
          <div>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        </div>
      </div>

      <div class="input-area" id="inputArea" style="display:none; position:relative;">
        <!-- ‚úÖ Preview ƒë√≠nh k√®m - ƒë·∫∑t trong input-area -->
        <div class="attachment-preview" id="attachmentPreview"
          style="display:none; position:absolute; bottom:100%; left:0; right:0; background:white; border:1px solid #e0e0e0; border-radius:8px; padding:8px 12px; margin-bottom:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
          <div style="display:flex; align-items:center; gap:10px;">
            <img id="previewImage"
              style="display:none; max-height:60px; max-width:80px; border-radius:6px; object-fit:cover;">
            <div id="previewFile" style="display:none; align-items:center; gap:8px;">
              <span style="font-size:24px;">üìÑ</span>
              <span class="file-name" style="font-size:13px; color:#333;"></span>
            </div>
            <button onclick="removeAttachment()"
              style="margin-left:auto; background:#ff4757; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:12px;">‚úï</button>
          </div>
        </div>

        <button class="emoji-btn" onclick="openEmojiPicker()" title="Ch·ªçn emoji">üòä</button>
        <button class="attach-btn" onclick="document.getElementById('fileInput').click()"
          title="ƒê√≠nh k√®m file/·∫£nh">üìé</button>
        <input type="file" id="fileInput" style="display:none;"
          accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt" onchange="handleFileSelect(event)">
        <textarea id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
        <button type="button" id="sendBtn" onclick="sendMessage()">G·ª≠i</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Custom Confirm Modal -->
  <div id="customConfirmModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:none; align-items:center; justify-content:center;">
    <div
      style="background:white; border-radius:12px; padding:24px; max-width:400px; width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <div style="font-size:18px; font-weight:600; margin-bottom:12px;" id="confirmTitle">‚ö†Ô∏è X√°c nh·∫≠n</div>
      <div style="color:#555; margin-bottom:20px; line-height:1.5;" id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</div>
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="closeConfirmModal(false)"
          style="padding:10px 20px; border:1px solid #ddd; background:#f5f5f5; border-radius:8px; cursor:pointer; font-size:14px;">H·ªßy</button>
        <button onclick="closeConfirmModal(true)"
          style="padding:10px 20px; border:none; background:#ff4757; color:white; border-radius:8px; cursor:pointer; font-size:14px;">X√°c
          nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Fr Req Modal -->
  <div id="frModal" class="fr-modal">
    <div class="fr-modal-content">
      <div class="fr-header">
        <h3>L·ªùi m·ªùi k·∫øt b·∫°n</h3>
        <span class="fr-close" onclick="closeFriendRequestsPanel()">&times;</span>
      </div>
      <div class="fr-body" id="frList">
        <div style="padding:20px;text-align:center;color:#666;">ƒêang t·∫£i...</div>
      </div>
    </div>
  </div>

  <!-- Sent Friend Requests Modal -->
  <div id="sentFrModal" class="fr-modal">
    <div class="fr-modal-content">
      <div class="fr-header" style="background:#ff9800;">
        <h3>üì§ L·ªùi m·ªùi ƒë√£ g·ª≠i</h3>
        <span class="fr-close" onclick="closeSentFriendRequestsPanel()">&times;</span>
      </div>
      <div class="fr-body" id="sentFrList">
        <div style="padding:20px;text-align:center;color:#666;">ƒêang t·∫£i...</div>
      </div>
    </div>
  </div>


  <!-- ‚úÖ External Scripts MOVED UP to prevent ReferenceErrors -->
  <script src="assets/websocket-helper.js"></script>
  <script src="/assets/unified-header.js?v=4"></script>
  <script src="chat-function/notifications.js"></script>
  <script src="chat-function/load_data.js"></script>
  <script src="chat-function/conversation-history-handler.js"></script>
  <script src="chat-function/sort.js"></script>
  <script src="chat-function/file-handler.js"></script>
  <script src="IndexedDB.js"></script>
  <script src="chat-function/logout.js"></script>
  <script src="chat-function/search.js"></script>

  <script>
    // ========== üîí CLEAN URL - ·∫®n th√¥ng tin nh·∫°y c·∫£m ==========
    (function () {
      // X√≥a query string kh·ªèi URL ngay l·∫≠p t·ª©c
      if (window.location.search) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('üîí URL cleaned - sensitive params removed');
      }
    })();

    // ========== GLOBAL VARIABLES ==========
    const ITEM_HEIGHT = 74;
    const BUFFER_SIZE = 20;

    let currentSearchTab = 'friends';
    let allFriends = [];
    let friends = [];
    let filteredFriends = [];
    let allMessages = new Map();
    let selectedFriend = null;
    let currentUserId = null;
    let currentMessages = [];
    let messageStore = new Map();
    let friendsRendered = false;
    let scrollTop = 0;
    let containerHeight = 0;

    // ‚úÖ Groups support
    let groups = [];
    let allGroups = [];
    let filteredGroups = [];
    let groupsLoaded = false;

    // ‚úÖ Prevent duplicate friend requests
    let isLoadingFriends = false;
    let friendsRequestDebounce = null;

    // ‚úÖ Auto-Reply Blacklist (Users who have auto-reply DISABLED)
    let autoReplyBlacklist = new Set();
    let isBlacklistLoaded = false;

    // ‚úÖ Custom confirm modal
    let confirmResolve = null;

    function showConfirm(message, title = '‚ö†Ô∏è X√°c nh·∫≠n') {
      return new Promise((resolve) => {
        confirmResolve = resolve;
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
        const modal = document.getElementById('customConfirmModal');
        modal.style.display = 'flex';
      });
    }

    function closeConfirmModal(result) {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (confirmResolve) {
        confirmResolve(result);
        confirmResolve = null;
      }
    }

    function showAlert(message, title = '‚ÑπÔ∏è Th√¥ng b√°o') {
      showToast(message, 'info');
    }

    // ========== NOTIFICATION FUNCTIONS ==========
    let notifications = [];

    function toggleNotificationPanel() {
      const panel = document.getElementById('notificationPanel');
      panel.classList.toggle('active');
    }

    function addNotificationToPanel(name, message, uid, avatar, timestamp) {
      notifications.unshift({
        name: name || 'H·ªá th·ªëng',
        message: message || '',
        uid: uid,
        avatar: avatar || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40"%3E%3Crect fill="%23ddd" width="40" height="40"/%3E%3C/svg%3E',
        timestamp: timestamp || Date.now()
      });

      if (notifications.length > 50) notifications.pop();
      renderNotificationPanel();
      updateNotificationBadge();
    }

    function renderNotificationPanel() {
      const panelBody = document.getElementById('notificationPanelBody');
      if (!panelBody) return;

      if (notifications.length === 0) {
        panelBody.innerHTML = '<div class="notification-empty">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>';
        return;
      }

      panelBody.innerHTML = notifications.map(notif => `
        <div class="notification-item" onclick="selectFriend('${notif.uid}', '${escapeJs(notif.name)}', '${notif.avatar}')">
          <img src="${notif.avatar}" alt="Avatar">
          <div class="info">
            <div class="name">${escapeHtml(notif.name)}</div>
            <div class="message">${escapeHtml(notif.message.substring(0, 60))}${notif.message.length > 60 ? '...' : ''}</div>
            <div class="time">${formatTime(notif.timestamp)}</div>
          </div>
        </div>
      `).join('');
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      badge.textContent = notifications.length;
      badge.style.display = notifications.length > 0 ? 'flex' : 'none';
    }

    function clearNotifications() {
      notifications = [];
      renderNotificationPanel();
      updateNotificationBadge();
    }

    function showNotification(senderName, message, uid, avatar) {
      // Use showNewMessageNotification from notifications.js if available
      if (typeof showNewMessageNotification === 'function') {
        showNewMessageNotification(senderName, message, uid, avatar);
      } else {
        showToast(`üîî ${senderName}: ${message.substring(0, 30)}...`, 'info');
      }
    }

    // ========== ALPHABETICAL SORT FUNCTION ==========
    function sortFriendsAfterLoad() {
      console.log('üî§ Sorting friends alphabetically (A-Z)...');
      if (!friends || friends.length === 0) return;

      friends.sort((a, b) => {
        const nameA = (a.displayName || a.zaloName || '').toLowerCase();
        const nameB = (b.displayName || b.zaloName || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      filteredFriends = [...friends];
      renderFriendsVirtual();
    }

    // ========== DATABASE MANAGEMENT ==========
    let dbInstance = null;
    let currentUserUID = null;

    // ========== CLEAR DASHBOARD DATA ==========
    function clearDashboardData() {
      console.log('üßπ Clearing dashboard data for account switch...');

      // Clear friend lists
      friends = [];
      allFriends = [];
      filteredFriends = [];
      friendsRendered = false;

      // ‚úÖ Clear groups cache
      groups = [];
      allGroups = [];
      filteredGroups = [];
      groupsLoaded = false;

      // Clear messages
      allMessages.clear();
      messageStore.clear();
      currentMessages = [];
      selectedFriend = null;

      // Clear UI
      document.getElementById('friendsList').innerHTML = `
        <div class="loading-friends">
          <div class="spinner"></div>
          <div>ƒêang t·∫£i danh s√°ch...</div>
        </div>
      `;
      document.getElementById('messagesContainer').innerHTML = `
        <div class="empty-chat">
          <div class="icon">üí¨</div>
          <div>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
        </div>
      `;

      // ‚úÖ Clear groups UI
      const groupsResults = document.getElementById('groupsResults');
      if (groupsResults) {
        groupsResults.innerHTML = '<div class="loading-friends"><div class="spinner"></div><div>ƒêang t·∫£i danh s√°ch nh√≥m...</div></div>';
      }

      console.log('‚úÖ Dashboard data cleared');
    }

    // ========== MOVE TO TOP FUNCTION ==========
    function moveConversationToTop(userId) {
      console.log(`‚¨ÜÔ∏è Moving conversation to top: ${userId}`);
      filteredFriends = filteredFriends.filter(f => f.userId !== userId);
      const friend = friends.find(f => f.userId === userId);
      if (friend) {
        filteredFriends.unshift(friend);
        console.log(`‚úÖ Moved to top. Top: ${filteredFriends[0]?.displayName}`);
      }
      renderFriendsVirtual();
    }

    // ========== WEBSOCKET ==========
    const ws = createWebSocket();

    ws.onopen = () => {
      console.log('‚úÖ WebSocket connected');
      ws.send(JSON.stringify({ type: 'get_friends' }));
      ws.send(JSON.stringify({ type: 'get_auto_reply_blacklist' }));
    };

    ws.onerror = (error) => {
      console.error('‚ùå WebSocket error:', error);
    };

    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);

        if (data.type === 'current_user') {
          const newUserUID = data.user.uid;
          currentUserId = newUserUID; // Update global var

          // Request activity logs
          ws.send(JSON.stringify({ type: 'get_activity_logs' }));

          // üîÑ Check if user changed - clear data if so
          if (currentUserUID && currentUserUID !== newUserUID) {
            console.log(`üîÑ User changed from ${currentUserUID} to ${newUserUID}`);
            clearDashboardData();
          }

          console.log('üë§ Current User:', newUserUID);
          document.getElementById('userName').textContent = data.user.name || "User";
          document.getElementById('userAvatar').src = data.user.avatar || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Crect fill='%23ddd' width='50' height='50'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='20'%3Eüë§%3C/text%3E%3C/svg%3E";
          document.getElementById('userUid').textContent = 'UID: ' + data.user.uid;
          document.getElementById('userInfo').style.display = 'flex';

          initIndexedDB(newUserUID).then(async () => {
            // üìä Try to load cached friends first
            try {
              if (typeof loadFriendsFromIndexedDB === 'function') {
                const cachedFriends = await loadFriendsFromIndexedDB();
                if (cachedFriends && cachedFriends.length > 0) {
                  console.log(`üíæ Using ${cachedFriends.length} cached friends`);
                  friends = cachedFriends;
                  allFriends = [...friends];
                  filteredFriends = [...friends];
                  friendsRendered = true;
                  renderFriendsVirtual();
                }
              }
            } catch (err) {
              console.warn('‚ö†Ô∏è Failed to load cached friends:', err);
            }

            // Still request fresh list from server
            console.log('üîÑ Requesting fresh friends list from server...');
            ws.send(JSON.stringify({ type: 'get_friends' }));

            // ‚úÖ Also request groups
            ws.send(JSON.stringify({ type: 'get_groups' }));
          }).catch(err => {
            console.error('‚ùå Failed to init DB:', err);
          });
        }

        if (data.type === 'friend_requests_response') {
          renderFriendRequests(data.requests, data.error);
        }

        if (data.type === 'friends_list') {
          console.log('üë• Friends:', data.friends?.length);
          isLoadingFriends = false; // ‚úÖ Reset loading flag
          friends = data.friends || [];
          allFriends = [...friends];
          filteredFriends = [...friends];

          // üíæ Save friends to IndexedDB
          if (typeof saveFriendsToIndexedDB === 'function') {
            saveFriendsToIndexedDB(friends).catch(err => {
              console.error('Failed to save friends:', err);
            });
          }

          console.log('‚úÖ Rendering friends list immediately...');
          friendsRendered = true;
          renderFriendsVirtual();

          setTimeout(() => {
            if (messageStore.size > 0) {
              console.log('üîÑ Re-sorting with messageStore data...');
              sortFriendsAfterLoad();
            }
          }, 300);
        }

        // ‚úÖ GROUPS LIST HANDLER
        if (data.type === 'groups_list') {
          console.log('üë™ Groups:', data.groups?.length);
          groups = data.groups || [];
          allGroups = [...groups];
          filteredGroups = [...groups];
          groupsLoaded = true;
          renderGroups();
        }

        if (data.type === 'messages_history') {
          if (selectedFriend && data.uid === selectedFriend.userId) {
            console.log(`üì® Received ${data.messages?.length} messages`);

            const uniqueMessages = [];
            const seenMsgIds = new Set();

            for (const msg of (data.messages || [])) {
              const msgId = msg.msgId || msg.id;
              if (!seenMsgIds.has(msgId)) {
                uniqueMessages.push(msg);
                seenMsgIds.add(msgId);
              }
            }

            currentMessages = uniqueMessages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages();
          }
        }

        // ‚úÖ X·ª¨ L√ù sent_ok (bao g·ªìm c·∫£ auto reply)
        if (data.type === 'sent_ok') {
          console.log('‚úÖ sent_ok', data.message?.isAutoReply ? '(Auto Reply)' : '');

          // Clear attachment after file/image send
          if (typeof removeAttachment === 'function' && window.currentAttachment) {
            removeAttachment();
            console.log('üóëÔ∏è Attachment cleared');
          }

          const uid = data.uid || data.message?.threadId || selectedFriend?.userId;
          if (!uid) return;

          const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);

          if (!isDuplicate) {
            if (selectedFriend && uid === selectedFriend.userId) {
              currentMessages.push(data.message);
              renderMessages();
              autoSaveToIndexedDB(uid, data.message);
            }
          }

          const content = data.message.content || data.message.msg || '';
          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });

          localStorage.setItem('lastChatWith', JSON.stringify({
            userId: uid,
            timestamp: data.message.timestamp || Date.now()
          }));

          moveConversationToTop(uid);

          if (!data.message?.isAutoReply) {
            document.getElementById('messageInput').value = '';
          }
          scrollToBottom();
        }

        // ‚úÖ X·ª¨ L√ù new_message (bao g·ªìm c·∫£ auto reply)
        if (data.type === 'typing') {
          if (typeof showTypingIndicator === 'function') {
            showTypingIndicator(data.uid);
          }
        }

        if (data.type === 'new_message') {
          console.log('üì® new_message from:', data.uid, data.message?.isAutoReply ? '(Auto Reply)' : '');

          const content = data.message.content || data.message.msg || '';
          const uid = data.uid;
          const isAutoReply = data.message?.isAutoReply || false;

          messageStore.set(uid, {
            lastMessage: content,
            timestamp: data.message.timestamp || Date.now()
          });

          const sender = friends.find(f => f.userId === uid);
          const senderName = sender?.displayName || 'Unknown';
          const senderAvatar = sender?.avatar || '';

          if (selectedFriend && uid === selectedFriend.userId) {
            const isDuplicate = currentMessages.some(m => m.msgId === data.message.msgId);

            if (!isDuplicate) {
              const msgToAdd = {
                ...data.message,
                isSelf: isAutoReply ? true : false
              };

              currentMessages.push(msgToAdd);
              renderMessages();
              autoSaveToIndexedDB(uid, msgToAdd);
              scrollToBottom();
            }
            moveConversationToTop(uid);
          } else {
            if (!isAutoReply) {
              console.log(`üîî Showing notification from ${senderName}`);
              showNotification(senderName, content.substring(0, 30), uid, senderAvatar);
              // ‚úÖ L∆∞u v√†o notification panel
              addNotificationToPanel(senderName, content, uid, senderAvatar, data.message.timestamp);
            }

            autoSaveToIndexedDB(uid, data.message);
            moveConversationToTop(uid);
          }
        }

        // ‚úÖ X·ª¨ L√ù auto_reply_sent
        if (data.type === 'auto_reply_sent' || data.type === 'auto_reply_default_sent') {
          console.log('ü§ñ Auto Reply ƒë√£ g·ª≠i ƒë·∫øn:', data.toUid);

          const uid = data.toUid;
          const content = data.response || '';

          messageStore.set(uid, {
            lastMessage: content,
            timestamp: Date.now()
          });

          if (selectedFriend && uid === selectedFriend.userId) {
            const autoReplyMsg = {
              msgId: 'auto_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
              content: content,
              timestamp: Date.now(),
              senderId: currentUserId,
              isSelf: true,
              isAutoReply: true
            };

            const isDuplicate = currentMessages.some(m =>
              m.content === content &&
              Math.abs(m.timestamp - autoReplyMsg.timestamp) < 2000
            );

            if (!isDuplicate) {
              currentMessages.push(autoReplyMsg);
              renderMessages();
              scrollToBottom();
              autoSaveToIndexedDB(uid, autoReplyMsg);
            }
          }

          moveConversationToTop(uid);
        }

        // ‚úÖ X·ª¨ L√ù GLOBAL AUTO REPLY STATUS (t·ª´ trigger-manager)
        if (data.type === 'auto_reply_status_changed') {
          console.log('üîÑ Global Auto Reply status changed:', data.enabled);

          if (data.enabled) {
            // When global auto-reply is ON, clear blacklist (enable all users)
            autoReplyBlacklist.clear();
          } else {
            // When global auto-reply is OFF, add all friends to blacklist (disable all)
            friends.forEach(friend => {
              autoReplyBlacklist.add(friend.userId);
            });
          }

          // Re-render friends list to update toggle states
          renderFriendsVirtual();

          // ‚úÖ ALWAYS update header toggle (real-time sync)
          const headerToggle = document.getElementById('headerAutoReplyToggle');
          if (headerToggle) {
            // If a friend is selected, check their specific status
            // Otherwise just use global status
            if (selectedFriend) {
              headerToggle.checked = !autoReplyBlacklist.has(selectedFriend.userId);
            } else {
              headerToggle.checked = data.enabled;
            }
            console.log('üîÑ Header Auto Reply toggle updated:', headerToggle.checked);
          }
        }

        // ‚úÖ X·ª¨ L√ù K·∫æT QU·∫¢ T√åM KI·∫æM QUA S·ªê ƒêI·ªÜN THO·∫†I
        if (data.type === 'user_found') {
          console.log('‚úÖ T√¨m th·∫•y user t·ª´ SƒêT:', data.user);
          handlePhoneSearchResult(data.user);
        }

        if (data.type === 'user_not_found') {
          console.log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y user t·ª´ SƒêT');
          handlePhoneSearchNotFound();
        }

        if (data.type === 'search_error' || data.type === 'find_user_error') {
          console.error('‚ùå L·ªói t√¨m ki·∫øm SƒêT:', data.error);
          handlePhoneSearchError(data.error);
        }

        if (data.type === 'logged_out') {
          console.log('‚úÖ Logout successful');
          handleLogoutComplete();
        }

        // ‚úÖ X·ª¨ L√ù X√ìA B·∫†N B√à
        if (data.type === 'friend_removed') {
          handleFriendRemoved(data);
        }

        if (data.type === 'friends_batch_removed') {
          handleBatchRemoved(data);
        }

        if (data.type === 'remove_friend_error') {
          console.error('‚ùå L·ªói x√≥a b·∫°n b√®:', data.error);
          alert('‚ùå L·ªói x√≥a b·∫°n b√®: ' + data.error);
        }

        // ‚úÖ X·ª¨ L√ù L·ªúI M·ªúI ƒê√É G·ª¨I
        if (data.type === 'sent_friend_requests_response') {
          renderSentFriendRequests(data.requests);
        }

        if (data.type === 'sent_friend_requests_error') {
          renderSentFriendRequests(null, data.error);
        }

        // ‚úÖ X·ª¨ L√ù S·ª∞ KI·ªÜN B·∫†N B√à
        // ‚úÖ X·ª¨ L√ù S·ª∞ KI·ªÜN B·∫†N B√à
        if (data.type === 'friend_event') {
          handleFriendEvent(data);
        }

        // ‚úÖ X·ª¨ L√ù ACTIVITY LOGS
        if (data.type === 'activity_logs') {
          console.log('üìú Activity logs receive:', data.logs.length);
          notifications = data.logs.map(log => {
            // Try to find avatar from friends list
            const friend = friends.find(f => f.userId == log.entityID);
            return {
              id: log.id,
              name: log.entityName || (friend ? friend.displayName : 'H·ªá th·ªëng'),
              message: log.details,
              uid: log.entityID,
              avatar: friend ? friend.avatar : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40"%3E%3Crect fill="%23ddd" width="40" height="40"/%3E%3C/svg%3E',
              timestamp: log.timestamp
            };
          });
          renderNotificationPanel();
          updateNotificationBadge();
        }

        // ‚úÖ X·ª¨ L√ù AUTO-DELETE CHAT RESPONSES
        if (data.type === 'auto_delete_chat_updated') {
          showToast(data.message || '‚úÖ ƒê√£ c√†i ƒë·∫∑t t·ª± x√≥a tin nh·∫Øn', 'success');
        }
        if (data.type === 'auto_delete_chat_error') {
          showToast('‚ùå ' + (data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
        }

        // ‚úÖ MEDIA & SYSTEM LOGS
        if (data.type === 'new_activity_log') {
          const { title, description, type } = data.log;
          addNotificationToPanel(title, description, 'system', null, Date.now());
          // Optional: show toast if urgent
          if (type === 'warning' || type === 'error') showToast(title, 'info');
        }

      } catch (err) {
        console.error('‚ùå Error:', err);
      }
    };

    // ========== CHAT & RENDER FUNCTIONS (MOVED TO EXTERNAL FILES) ==========
    // selectFriend, renderMessages, renderFriendsVirtual, sendMessage, etc.
    // are now loaded from chat-function/*.js

    // Function to handle header toggle
    function toggleHeaderAutoReply(enabled) {
      if (!selectedFriend) return;
      toggleAutoReply(selectedFriend.userId, enabled);
    }

    // Main Toggle Function (Global)
    function toggleAutoReply(userId, enabled) {
      console.log(`üîÑ Toggling Auto-Reply for ${userId}: ${enabled}`);

      // Update local state
      if (enabled) {
        autoReplyBlacklist.delete(userId);
      } else {
        autoReplyBlacklist.add(userId);
      }

      // Send to server
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'toggle_user_auto_reply',
          targetId: userId,
          enabled: enabled
        }));
      }

      // Sync Header Toggle if it's the current user
      if (selectedFriend && selectedFriend.userId === userId) {
        const headerToggle = document.getElementById('headerAutoReplyToggle');
        if (headerToggle) headerToggle.checked = enabled;
      }

      // Sync Sidebar Checkbox
      const sidebarToggles = document.querySelectorAll(`.friend-item[onclick*="${userId}"] input[type="checkbox"]`);
      sidebarToggles.forEach(toggle => {
        toggle.checked = enabled;
      });

      showToast(enabled ? '‚úÖ ƒê√£ B·∫¨T t·ª± ƒë·ªông tr·∫£ l·ªùi' : 'üö´ ƒê√£ T·∫ÆT t·ª± ƒë·ªông tr·∫£ l·ªùi', enabled ? 'success' : 'warning');

      // Update the friend item in the list if it exists
      const friendItem = document.querySelector(`.friend-item[onclick*="${userId}"]`);
      if (friendItem) {
        if (enabled) friendItem.classList.add('auto-reply-on');
        else friendItem.classList.remove('auto-reply-on');
      }
    }

    // ‚úÖ CONSOLIDATED FILTER & SEARCH
    function applyFilters() {
      const query = document.getElementById('friendsSearchInput')?.value || '';
      const filterValue = document.getElementById('autoReplyFilter')?.value || 'all';

      // If it's a phone search, delegate to searchFriends (which handles searchByPhone)
      const isPhone = /^(\+84|84|0)?[0-9]{8,10}$/.test(query.trim());
      if (isPhone && query.trim().length >= 9) {
        if (typeof searchFriends === 'function') {
          searchFriends(query.trim());
          return;
        }
      }

      console.log(`üîç Applying Filters: query="${query}", filter="${filterValue}"`);

      const sourceFriends = (typeof allFriends !== 'undefined' && allFriends) ? allFriends : (typeof friends !== 'undefined' ? friends : []);
      const lowerQuery = query.trim().toLowerCase();

      // Clear search results div if we're doing local list filtering
      const resultsDiv = document.getElementById('friendsResults');
      if (resultsDiv && !isPhone) resultsDiv.innerHTML = '';

      if (typeof filteredFriends !== 'undefined') {
        filteredFriends = sourceFriends.filter(f => {
          // 1. Search filter
          const displayName = f.displayName || '';
          const userId = f.userId || '';
          const searchMatch = !lowerQuery ||
            displayName.toLowerCase().includes(lowerQuery) ||
            userId.toLowerCase().includes(lowerQuery);

          if (!searchMatch) return false;

          // 2. Auto-reply filter
          const isEnabled = !autoReplyBlacklist.has(f.userId);
          if (filterValue === 'on') return isEnabled;
          if (filterValue === 'off') return !isEnabled;

          return true;
        });

        if (typeof renderFriendsVirtual === 'function') {
          renderFriendsVirtual();
        }
      }
    }
    function FriendTab(tab) {
      console.log(`üîÑ Switching to ${tab} search`);
      currentSearchTab = tab;
      document.querySelectorAll('.search-tab').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.search-content').forEach(el => el.classList.remove('active'));
      document.getElementById(tab === 'friends' ? 'friendsSearch' : 'messagesSearch').classList.add('active');
      document.getElementById('friendsSearchInput').value = '';
      document.getElementById('friendsResults').innerHTML = '';
    }

    // ‚úÖ X·ª¨ L√ù K·∫æT QU·∫¢ T√åM KI·∫æM S·ªê ƒêI·ªÜN THO·∫†I
    function handlePhoneSearchResult(user) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      console.log('üîç Processing Search Result:', user);

      // 1. Name Resolution (Priority: display_name > zalo_name > Default)
      // Robust check for non-empty strings
      let displayName = 'Ng∆∞·ªùi d√πng Zalo';
      if (user.display_name && String(user.display_name).trim()) {
        displayName = user.display_name;
      } else if (user.zalo_name && String(user.zalo_name).trim()) {
        displayName = user.zalo_name;
      }

      // 2. Gender Resolution
      // Note: user.gender might be 0 (Male), 1 (Female) - ensure type safety
      let genderText = 'Kh√¥ng r√µ';
      if (user.gender == 0 || user.gender === '0') genderText = 'Nam';
      else if (user.gender == 1 || user.gender === '1') genderText = 'N·ªØ';

      // 3. DOB Resolution (Date of Birth)
      let dobText = '';
      if (user.sdob && user.sdob.trim()) {
        dobText = `‚Ä¢ SN: ${user.sdob}`;
      } else if (user.dob > 0) {
        try {
          const date = new Date(user.dob * 1000); // Assuming seconds
          dobText = `‚Ä¢ SN: ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        } catch (e) { }
      }

      resultsDiv.innerHTML = `
        <div style="padding: 8px 12px; background: #e8f5e9; border-bottom: 1px solid #c8e6c9; font-size: 12px; color: #388e3c;">
          ‚úÖ T√¨m th·∫•y t·ª´ s·ªë ƒëi·ªán tho·∫°i
        </div>
        <div class="search-result-item" onclick="selectFriendFromSearch('${user.uid}', '${escapeJs(displayName)}', '${user.avatar || ''}')">
          <div class="result-friend">
            <img src="${user.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E'}" 
              onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3C/svg%3E'"
              alt="Avatar"
              style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
              <div class="result-friend-info" style="flex: 1; margin-left: 10px;">
                <div class="result-friend-name" style="font-weight: 600; color: #333; font-size: 14px;">${escapeHtml(displayName)}</div>
                <div class="result-friend-uid" style="font-size: 12px; color: #666; margin-top: 4px;">
                  <span style="display:inline-block; background:#f5f5f5; padding: 2px 6px; border-radius: 4px; border: 1px solid #eee;">
                    ${genderText} ${dobText}
                  </span>
                  <div style="margin-top:2px; font-size: 11px; color:#999;">UID: ${user.uid}</div>
                </div>
              </div>
              <span style="background: #e8f5e9; color: #388e3c; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">T·ª´ SƒêT</span>
          </div>
        </div>
      `;

      console.log('‚úÖ ƒê√£ hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm SƒêT (Updated)');
    }

    function handlePhoneSearchNotFound() {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #999;">
          <div style="font-size: 32px; margin-bottom: 10px;">üòï</div>
          <div>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y</div>
        </div>
        `;
    }

    function handlePhoneSearchError(error) {
      const resultsDiv = document.getElementById('friendsResults');
      if (!resultsDiv) return;

      resultsDiv.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #f44336;">
          <div style="font-size: 32px; margin-bottom: 10px;">‚ùå</div>
          <div>L·ªói: ${escapeHtml(error || 'Kh√¥ng th·ªÉ t√¨m ki·∫øm')}</div>
        </div>
        `;
    }

    function selectFriendFromSearch(userId, displayName, avatar) {
      // X√≥a k·∫øt qu·∫£ t√¨m ki·∫øm
      document.getElementById('friendsResults').innerHTML = '';
      document.getElementById('friendsSearchInput').value = '';

      // Reset danh s√°ch
      filteredFriends = [...friends];
      renderFriendsVirtual();

      // Ch·ªçn friend
      selectFriend(userId, displayName, avatar);
    }

    // Enter to send
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('messageInput');
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });


    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'V·ª´a xong';
      if (minutes < 60) return `${minutes} p`;
      if (hours < 24) return `${hours} h`;
      if (days < 7) return `${days} d`;

      const date = new Date(timestamp);
      return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
    }

    // Open trigger manager
    function openAutoReplyViewer() {
      if (!currentUserId) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
        return;
      }
      const url = `/trigger-manager.html?userUID=${currentUserId}&dbName=ZaloChat_${currentUserId}`;
      window.open(url, '_blank');
    }

    // Open storage info
    function openStorageInfo() {
      if (!currentUserId) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
        return;
      }
      const url = `/storage-info.html?userUID=${currentUserId}`;
      window.open(url, '_blank');
    }

    // FILE ATTACHMENT HANDLERS are now managed by file-handler.js 

    // ========== FRIEND REQUEST UI ==========
    function openFriendRequestsPanel() {
      document.getElementById('frModal').style.display = 'block';
      ws.send(JSON.stringify({ type: 'get_friend_requests' }));
    }
    function closeFriendRequestsPanel() {
      document.getElementById('frModal').style.display = 'none';
    }
    window.onclick = function (event) {
      if (event.target == document.getElementById('frModal')) {
        closeFriendRequestsPanel();
      }
    }

    function renderFriendRequests(requests, error) {
      const list = document.getElementById('frList');
      if (error) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:red;">L·ªói: ${error}</div>`;
        return;
      }
      if (!requests || requests.length === 0) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:#666;">Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</div>`;
        return;
      }

      let html = '';
      requests.forEach(req => {
        const name = req.zaloName || req.displayName || req.userId;
        const avatar = req.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%22%23ddd%22 width=%2240%22 height=%2240%22/%3E%3C/svg%3E';
        const msg = req.msg || req.message || 'Xin ch√†o!';
        const time = req.time ? new Date(req.time).toLocaleString() : '';

        html += `
        < div class="fr-item" >
          <img src="${avatar}" class="fr-avatar">
            <div style="flex:1;">
              <div style="font-weight:600;font-size:14px;">${name}</div>
              <div style="font-size:12px;color:#666;">${msg}</div>
              <div style="font-size:10px;color:#999;">${time}</div>
            </div>
            <div style="font-size:11px;color:#0068FF;background:#E3F2FD;padding:4px 8px;border-radius:12px;">ƒêang ch·ªù</div>
          </div>
      `;
      });
      list.innerHTML = html;
    }

    // ========== üì± MOBILE RESPONSIVE FUNCTIONS ==========
    // ========== üì± SIDEBAR TOGGLE (Mobile + Desktop) ==========
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const container = document.querySelector('.container');
      const overlay = document.getElementById('mobileOverlay');

      // Check if Mobile (< 768px)
      if (window.innerWidth <= 768) {
        if (sidebar.classList.contains('mobile-active')) {
          closeMobileSidebar();
        } else {
          sidebar.classList.add('mobile-active');
          overlay.classList.add('active');
        }
      }
      // Desktop (> 768px)
      else {
        sidebar.classList.toggle('collapsed');
        container.classList.toggle('sidebar-collapsed');
      }
    }

    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      sidebar.classList.remove('mobile-active');
      overlay.classList.remove('active');
    }

    // Auto-close sidebar when selecting a friend on mobile
    const originalSelectFriend = window.selectFriend;
    if (originalSelectFriend) {
      window.selectFriend = function (...args) {
        originalSelectFriend.apply(this, args);
        // Close sidebar on mobile after selecting friend
        if (window.innerWidth <= 768) {
          closeMobileSidebar();
        }
      };
    }

    // ========== DELETE FRIENDS MODE ==========
    let isDeleteMode = false;
    let selectedForDelete = new Set();

    function toggleDeleteMode() {
      isDeleteMode = !isDeleteMode;
      const friendsList = document.getElementById('friendsList');
      const btn = document.getElementById('deleteModeBtn');
      const bar = document.getElementById('deleteSelectionBar');

      if (isDeleteMode) {
        friendsList.classList.add('delete-mode');
        btn.classList.add('active');
        bar.classList.add('visible');
        selectedForDelete.clear();
        updateSelectedCount();
        // Re-render to show checkboxes
        if (typeof renderFriendsVirtual === 'function') {
          renderFriendsVirtual();
        }
      } else {
        cancelDeleteMode();
      }
    }

    function cancelDeleteMode() {
      isDeleteMode = false;
      selectedForDelete.clear();
      const friendsList = document.getElementById('friendsList');
      const btn = document.getElementById('deleteModeBtn');
      const bar = document.getElementById('deleteSelectionBar');

      friendsList.classList.remove('delete-mode');
      btn.classList.remove('active');
      bar.classList.remove('visible');
      // Re-render to hide checkboxes
      if (typeof renderFriendsVirtual === 'function') {
        renderFriendsVirtual();
      }
    }

    function toggleFriendSelection(userId, checkbox) {
      if (checkbox.checked) {
        selectedForDelete.add(userId);
      } else {
        selectedForDelete.delete(userId);
      }
      updateSelectedCount();
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = `${selectedForDelete.size} ƒë√£ ch·ªçn`;
    }

    async function deleteSelectedFriends() {
      if (selectedForDelete.size === 0) {
        showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b·∫°n b√® ƒë·ªÉ x√≥a', 'warning');
        return;
      }

      const count = selectedForDelete.size;
      const confirmed = await showConfirm(
        `B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA ${count} b·∫°n b√® ?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`,
        'üóëÔ∏è X√≥a b·∫°n b√®'
      );

      if (!confirmed) {
        return;
      }

      const friendIds = Array.from(selectedForDelete);
      console.log(`üóëÔ∏è Deleting ${friendIds.length} friends: `, friendIds);

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'remove_friends_batch',
          friendIds: friendIds
        }));
      } else {
        showToast('Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }

    // Handle remove friend responses
    function handleFriendRemoved(data) {
      console.log('‚úÖ Friend removed:', data.friendId);
      // Remove from local arrays
      friends = friends.filter(f => f.userId !== data.friendId);
      allFriends = allFriends.filter(f => f.userId !== data.friendId);
      filteredFriends = filteredFriends.filter(f => f.userId !== data.friendId);
      selectedForDelete.delete(data.friendId);
      updateSelectedCount();
      if (typeof renderFriendsVirtual === 'function') {
        renderFriendsVirtual();
      }
    }

    function handleBatchRemoved(data) {
      console.log('‚úÖ Batch removed:', data.success.length, 'friends');
      if (data.success && data.success.length > 0) {
        // Remove from local arrays
        const removedSet = new Set(data.success);
        friends = friends.filter(f => !removedSet.has(f.userId));
        allFriends = allFriends.filter(f => !removedSet.has(f.userId));
        filteredFriends = filteredFriends.filter(f => !removedSet.has(f.userId));
        selectedForDelete.clear();
        updateSelectedCount();
        if (typeof renderFriendsVirtual === 'function') {
          renderFriendsVirtual();
        }
        alert(`‚úÖ ƒê√£ x√≥a ${data.success.length} b·∫°n b√® th√†nh c√¥ng!${data.failed.length > 0 ? `\n‚ö†Ô∏è L·ªói: ${data.failed.length} b·∫°n b√®` : ''} `);
        cancelDeleteMode();
      }
      if (data.failed && data.failed.length > 0) {
        console.error('‚ùå Failed to remove:', data.failed);
      }
    }

    // ========== SENT FRIEND REQUESTS ==========
    function openSentFriendRequestsPanel() {
      document.getElementById('sentFrModal').style.display = 'block';
      document.getElementById('sentFrList').innerHTML = '<div style="padding:30px;text-align:center;"><div class="spinner"></div><div>ƒêang t·∫£i...</div></div>';

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'get_sent_friend_requests' }));
      } else {
        document.getElementById('sentFrList').innerHTML = '<div style="padding:20px;text-align:center;color:#f44336;">‚ùå Ch∆∞a k·∫øt n·ªëi server</div>';
      }
    }

    function closeSentFriendRequestsPanel() {
      document.getElementById('sentFrModal').style.display = 'none';
    }

    function renderSentFriendRequests(requests, error) {
      const container = document.getElementById('sentFrList');

      if (error) {
        container.innerHTML = `< div style = "padding:20px;text-align:center;color:#f44336;" >‚ùå ${escapeHtml(error)}</div > `;
        return;
      }

      if (!requests || requests.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:#888;">üì≠ Ch∆∞a g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n n√†o</div>';
        return;
      }

      let html = '';
      for (const req of requests) {
        const timeAgo = req.time ? formatTimeAgo(req.time * 1000) : '';
        html += `
        < div class="fr-item" >
          <img class="fr-avatar" src="${req.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%22%23ddd%22 width=%2240%22 height=%2240%22/%3E%3C/svg%3E'}"
            onerror="this.onerror=null;" alt="Avatar">
            <div style="flex:1;">
              <div style="font-weight:600;">${escapeHtml(req.displayName || req.zaloName || 'Ng∆∞·ªùi d√πng')}</div>
              <div style="font-size:12px;color:#888;">${req.message ? escapeHtml(req.message) : 'Kh√¥ng c√≥ l·ªùi nh·∫Øn'}</div>
              ${timeAgo ? `<div style="font-size:11px;color:#aaa;">${timeAgo}</div>` : ''}
            </div>
            <div style="font-size:20px;color:#ff9800;" title="ƒêang ch·ªù ch·∫•p nh·∫≠n">‚è≥</div>
          </div>
      `;
      }
      container.innerHTML = html;
    }

    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days} ng√†y tr∆∞·ªõc`;
      if (hours > 0) return `${hours} gi·ªù tr∆∞·ªõc`;
      if (minutes > 0) return `${minutes} ph√∫t tr∆∞·ªõc`;
      return 'V·ª´a xong';
    }

    // ========== FRIEND EVENTS HANDLER ==========
    function handleFriendEvent(event) {
      console.log('üë• Friend Event:', event);
      const { eventType, data } = event;

      // Ensure showToast is available
      if (typeof showToast !== 'function') {
        console.warn('‚ö†Ô∏è showToast not available');
        return;
      }

      switch (eventType) {
        case 'ADD':
          showToast(`üéâ ƒê√£ th√™m b·∫°n m·ªõi: ${data} `, 'success');
          // ‚úÖ RELOAD FRIENDS LIST
          console.log('üîÑ Requesting updated friends list...');
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_friends' }));
          }
          addNotificationToPanel('H·ªá th·ªëng', `üéâ ƒê√£ th√™m b·∫°n m·ªõi: ${data} `, data, '', Date.now());
          // Reload friend list if not already triggered by other means
          // The server sends friends_list_updated usually, or we can reload manually
          break;

        case 'REMOVE':
          showToast(`üëã ƒê√£ h·ªßy k·∫øt b·∫°n v·ªõi: ${data} `, 'warning');
          // ‚úÖ RELOAD FRIENDS LIST
          console.log('üîÑ Requesting updated friends list...');
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'get_friends' }));
          }
          addNotificationToPanel('H·ªá th·ªëng', `üëã ƒê√£ h·ªßy k·∫øt b·∫°n v·ªõi: ${data} `, data, '', Date.now());
          break;

        case 'REQUEST':
          const senderId = data.fromUid || 'Ng∆∞·ªùi d√πng';
          const msg = data.message || 'Xin ch√†o! K·∫øt b·∫°n v·ªõi m√¨nh nh√©!';
          showToast(`üì® L·ªùi m·ªùi k·∫øt b·∫°n m·ªõi t·ª´: ${senderId} `, 'info');
          addNotificationToPanel('L·ªùi m·ªùi k·∫øt b·∫°n', `üì® T·ª´ ${senderId}: ${msg} `, senderId, '', Date.now());
          // Play sound if desired
          break;

        case 'REJECT_REQUEST':
          showToast(`‚ùå L·ªùi m·ªùi k·∫øt b·∫°n b·ªã t·ª´ ch·ªëi`, 'error');
          addNotificationToPanel('H·ªá th·ªëng', `‚ùå L·ªùi m·ªùi k·∫øt b·∫°n t·ªõi ${data?.toUid} b·ªã t·ª´ ch·ªëi`, data?.toUid, '', Date.now());
          break;

        case 'UNDO_REQUEST':
          showToast(`‚Ü©Ô∏è L·ªùi m·ªùi k·∫øt b·∫°n ƒë√£ ƒë∆∞·ª£c thu h·ªìi`, 'info');
          addNotificationToPanel('H·ªá th·ªëng', `‚Ü©Ô∏è L·ªùi m·ªùi k·∫øt b·∫°n t·ª´ ${data?.toUid} ƒë√£ thu h·ªìi`, data?.toUid, '', Date.now());
          break;

        case 'BLOCK':
          showToast(`üö´ ƒê√£ ch·∫∑n ng∆∞·ªùi d√πng: ${data} `, 'warning');
          addNotificationToPanel('H·ªá th·ªëng', `üö´ ƒê√£ ch·∫∑n ng∆∞·ªùi d√πng: ${data} `, data, '', Date.now());
          break;

        case 'UNBLOCK':
          showToast(`‚úÖ ƒê√£ b·ªè ch·∫∑n ng∆∞·ªùi d√πng: ${data} `, 'success');
          addNotificationToPanel('H·ªá th·ªëng', `‚úÖ ƒê√£ b·ªè ch·∫∑n ng∆∞·ªùi d√πng: ${data} `, data, '', Date.now());
          break;

        case 'SEEN_FRIEND_REQUEST':
          showToast(`üëÅÔ∏è ƒê√£ xem l·ªùi m·ªùi k·∫øt b·∫°n`, 'info');
          break;

        case 'PIN_CREATE':
          showToast(`üìå ƒê√£ ghim cu·ªôc tr√≤ chuy·ªán`, 'info');
          break;

        case 'PIN_UNPIN':
          showToast(`üìç ƒê√£ b·ªè ghim cu·ªôc tr√≤ chuy·ªán`, 'info');
          break;

        default:
          console.log('‚ÑπÔ∏è Unhandled friend event:', eventType);
      }
    }

    // ========== AUTO-DELETE CHAT FUNCTIONS ==========
    function toggleAutoDeleteMenu() {
      const menu = document.getElementById('autoDeleteMenu');
      if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.querySelector('.auto-delete-dropdown');
      const menu = document.getElementById('autoDeleteMenu');
      if (dropdown && menu && !dropdown.contains(e.target)) {
        menu.style.display = 'none';
      }
    });

    function setAutoDeleteChat(ttl) {
      if (!selectedFriend || !selectedFriend.userId) {
        showToast('‚ùå Vui l√≤ng ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán', 'error');
        return;
      }

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'update_auto_delete_chat',
          ttl: ttl,
          threadId: selectedFriend.userId,
          threadType: 0 // User
        }));

        // Update UI label
        const labels = {
          0: 'T·ª± x√≥a',
          86400000: '1 ng√†y',
          604800000: '7 ng√†y',
          1209600000: '14 ng√†y'
        };
        document.getElementById('autoDeleteLabel').textContent = labels[ttl] || 'T·ª± x√≥a';

        // Close menu
        document.getElementById('autoDeleteMenu').style.display = 'none';

        showToast(`‚è±Ô∏è ƒêang c√†i ƒë·∫∑t t·ª± x√≥a tin nh·∫Øn...`, 'info');
      } else {
        showToast('‚ùå M·∫•t k·∫øt n·ªëi WebSocket', 'error');
      }
    }

    function setCustomAutoDelete() {
      const input = document.getElementById('customDeleteSeconds');
      const seconds = parseInt(input.value);

      if (isNaN(seconds) || seconds < 0) {
        showToast('‚ùå Vui l√≤ng nh·∫≠p s·ªë gi√¢y h·ª£p l·ªá', 'error');
        return;
      }

      // Convert seconds to milliseconds
      const ttl = seconds * 1000;

      // Update label to show custom value
      if (seconds > 0) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        let label = '';
        if (hours > 0) label += `${hours} h`;
        if (minutes > 0) label += `${minutes} m`;
        if (!label) label = `${seconds} s`;
        document.getElementById('autoDeleteLabel').textContent = label;
      }

      setAutoDeleteChat(ttl);
      input.value = ''; // Clear input
    }

    // ========== GROUP FUNCTIONS ==========
    function switchTab(tab) {
      currentSearchTab = tab;
      const friendsTabBtn = document.getElementById('friendsTabBtn');
      const groupsTabBtn = document.getElementById('groupsTabBtn');
      const friendsSearch = document.getElementById('friendsSearch');
      const friendsList = document.getElementById('friendsList');
      const groupsContainer = document.getElementById('groupsContainer');
      const deleteModeBtn = document.getElementById('deleteModeBtn');

      if (tab === 'friends') {
        friendsTabBtn.classList.add('active');
        friendsTabBtn.style.background = '#2196f3';
        friendsTabBtn.style.color = 'white';
        groupsTabBtn.classList.remove('active');
        groupsTabBtn.style.background = '#f0f0f0';
        groupsTabBtn.style.color = '#333';
        friendsSearch.style.display = 'block';
        friendsList.style.display = 'block';
        groupsContainer.style.display = 'none';
        deleteModeBtn.style.display = 'block';
      } else {
        groupsTabBtn.classList.add('active');
        groupsTabBtn.style.background = '#9c27b0';
        groupsTabBtn.style.color = 'white';
        friendsTabBtn.classList.remove('active');
        friendsTabBtn.style.background = '#f0f0f0';
        friendsTabBtn.style.color = '#333';
        friendsSearch.style.display = 'none';
        friendsList.style.display = 'none';
        groupsContainer.style.display = 'block';
        deleteModeBtn.style.display = 'none';

        // Request groups if not loaded
        if (!groupsLoaded && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'get_groups' }));
        }
      }
    }

    function renderGroups() {
      const container = document.getElementById('groupsResults');
      if (!container) return;

      if (filteredGroups.length === 0) {
        container.innerHTML = '<div class="notification-empty">Kh√¥ng t√¨m th·∫•y nh√≥m n√†o</div>';
        return;
      }

      container.innerHTML = filteredGroups.map(g => `
        <div class="friend-item" onclick="selectGroup('${g.groupId}', '${escapeJs(g.name)}', '${g.avatar}')"
      style="display:flex; align-items:center; padding:12px; cursor:pointer; border-bottom:1px solid #eee;">
          <div style="position:relative;">
            <img src="${g.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%239c27b0%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22%3Eüë™%3C/text%3E%3C/svg%3E'}" 
              style="width:50px; height:50px; border-radius:50%; object-fit:cover;" 
              onerror="this.onerror=null;">
            <span style="position:absolute; bottom:-2px; right:-2px; background:#9c27b0; color:white; font-size:10px; padding:2px 4px; border-radius:8px;">üë™</span>
          </div>
          <div style="margin-left:12px; flex:1;">
            <div style="font-weight:600; color:#333;">${escapeHtml(g.name)}</div>
            <div style="font-size:12px; color:#888;">${g.totalMember || '?'} th√†nh vi√™n</div>
          </div>
        </div>
        `).join('');
    }

    function searchGroups(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        filteredGroups = [...allGroups];
      } else {
        filteredGroups = allGroups.filter(g =>
          g.name.toLowerCase().includes(q) ||
          g.groupId.includes(q)
        );
      }
      renderGroups();
    }

    function selectGroup(groupId, groupName, avatar) {
      // Set selectedFriend with group flag for unified messaging
      selectedFriend = {
        userId: groupId,
        displayName: groupName,
        avatar: avatar,
        isGroup: true
      };

      // Update chat header
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('inputArea').style.display = 'flex';
      document.getElementById('chatAvatar').src = avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%239c27b0%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2220%22%3Eüë™%3C/text%3E%3C/svg%3E';
      document.getElementById('chatName').textContent = groupName || 'Nh√≥m Zalo';
      document.getElementById('chatUid').textContent = 'Group ID: ' + groupId;

      // Clear messages container
      document.getElementById('messagesContainer').innerHTML = '<div class="loading-friends"><div class="spinner"></div><div>ƒêang t·∫£i tin nh·∫Øn nh√≥m...</div></div>';
      currentMessages = [];

      // Request group messages
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'get_messages',
          uid: groupId,
          isGroup: true
        }));
      }

      console.log(`üë™ Selected group: ${groupName} (${groupId})`);
    }


  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.UnifiedHeader) {
        UnifiedHeader.setPageActions(UnifiedHeader.getSharedTogglesHTML());
      }
    });
  </script>

  <!-- üñºÔ∏è Image Viewer Modal -->
  <div id="imageViewerModal" class="image-viewer-modal" style="display:none;">
    <div class="image-viewer-overlay" onclick="closeImageViewer()"></div>
    <div class="image-viewer-content">
      <button class="image-viewer-close" onclick="closeImageViewer()" title="ƒê√≥ng (ESC)">‚úï</button>
      <button class="image-viewer-download" onclick="downloadCurrentImage()" title="T·∫£i xu·ªëng">üì•</button>
      <div class="image-viewer-controls">
        <button onclick="zoomImage(-0.2)" title="Thu nh·ªè">‚àí</button>
        <button onclick="resetZoom()" title="K√≠ch th∆∞·ªõc g·ªëc">100%</button>
        <button onclick="zoomImage(0.2)" title="Ph√≥ng to">+</button>
      </div>
      <img id="viewerImage" src="" alt="Image"
        style="max-width: 90vw; max-height: 90vh; transform-origin: center center;">
    </div>
  </div>

  <style>
    /* Image Viewer Modal */
    .image-viewer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-viewer-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      animation: fadeIn 0.2s ease;
    }

    .image-viewer-content {
      position: relative;
      z-index: 1;
      max-width: 95vw;
      max-height: 95vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-viewer-content img {
      display: block;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s ease;
      cursor: zoom-in;
    }

    .image-viewer-close,
    .image-viewer-download {
      position: fixed;
      top: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: all 0.2s;
    }

    .image-viewer-close {
      right: 20px;
      color: #333;
    }

    .image-viewer-download {
      right: 80px;
      color: #0068FF;
    }

    .image-viewer-close:hover,
    .image-viewer-download:hover {
      transform: scale(1.1);
      background: white;
    }

    .image-viewer-controls {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 30px;
      display: flex;
      gap: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .image-viewer-controls button {
      background: white;
      border: 1px solid #e0e0e0;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .image-viewer-controls button:hover {
      background: #f5f5f5;
      transform: scale(1.1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>

  <script>
    let currentImageScale = 1;
    let currentImageUrl = '';

    function openImageViewer(imageUrl) {
      currentImageUrl = imageUrl;
      currentImageScale = 1;
      document.getElementById('viewerImage').src = imageUrl;
      document.getElementById('viewerImage').style.transform = 'scale(1)';
      document.getElementById('imageViewerModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeImageViewer() {
      document.getElementById('imageViewerModal').style.display = 'none';
      document.body.style.overflow = '';
    }

    function zoomImage(delta) {
      currentImageScale += delta;
      if (currentImageScale < 0.5) currentImageScale = 0.5;
      if (currentImageScale > 3) currentImageScale = 3;
      document.getElementById('viewerImage').style.transform = `scale(${currentImageScale})`;
    }

    function resetZoom() {
      currentImageScale = 1;
      document.getElementById('viewerImage').style.transform = 'scale(1)';
    }

    async function downloadCurrentImage() {
      if (!currentImageUrl) return;

      try {
        const response = await fetch(currentImageUrl);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `zalo_image_${Date.now()}.jpg`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (err) {
        console.error('Download failed:', err);
        alert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('imageViewerModal').style.display === 'flex') {
        closeImageViewer();
      }
    });

    // Add click handler to all chat images
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'IMG' && e.target.closest('.message')) {
        const imageUrl = e.target.src;
        if (imageUrl && !imageUrl.includes('avatar')) {
          openImageViewer(imageUrl);
        }
      }
    });
  </script>
</body>

</html>